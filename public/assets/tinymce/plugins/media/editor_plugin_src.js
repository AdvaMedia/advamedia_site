/**
 * editor_plugin_src.js
 *
 * Copyright 2009, Moxiecode Systems AB
 * Released under LGPL License.
 *
 * License: http://tinymce.moxiecode.com/license
 * Contributing: http://tinymce.moxiecode.com/contributing
 */
(function(){function u(e){var t,n,r;if(e&&!e.splice){n=[];for(r=0;!0;r++){if(!e[r])break;n[r]=e[r]}return n}return e}var e=tinymce.explode("id,name,width,height,style,align,class,hspace,vspace,bgcolor,type"),t=tinymce.makeMap(e.join(",")),n=tinymce.html.Node,r,i,s=tinymce.util.JSON,o;r=[["Flash","d27cdb6e-ae6d-11cf-96b8-444553540000","application/x-shockwave-flash","http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0"],["ShockWave","166b1bca-3f9c-11cf-8075-444553540000","application/x-director","http://download.macromedia.com/pub/shockwave/cabs/director/sw.cab#version=8,5,1,0"],["WindowsMedia","6bf52a52-394a-11d3-b153-00c04f79faa6,22d6f312-b0f6-11d0-94ab-0080c74c7e95,05589fa1-c356-11ce-bf01-00aa0055595a","application/x-mplayer2","http://activex.microsoft.com/activex/controls/mplayer/en/nsmp2inf.cab#Version=5,1,52,701"],["QuickTime","02bf25d5-8c17-4b23-bc80-d3488abddc6b","video/quicktime","http://www.apple.com/qtactivex/qtplugin.cab#version=6,0,2,0"],["RealMedia","cfcdaa03-8be4-11cf-b84b-0020afbbccfa","audio/x-pn-realaudio-plugin","http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0"],["Java","8ad9c840-044e-11d1-b3e9-00805f499d93","application/x-java-applet","http://java.sun.com/products/plugin/autodl/jinstall-1_5_0-windows-i586.cab#Version=1,5,0,0"],["Silverlight","dfeaf541-f3e1-4c24-acac-99c30715084a","application/x-silverlight-2"],["Iframe"],["Video"],["EmbeddedAudio"],["Audio"]],tinymce.create("tinymce.plugins.MediaPlugin",{init:function(t,n){function h(e){return e&&e.nodeName==="IMG"&&t.dom.hasClass(e,"mceItemMedia")}var o=this,u={},a,f,l,c;o.editor=t,o.url=n,i="";for(a=0;a<r.length;a++){c=r[a][0],l={name:c,clsids:tinymce.explode(r[a][1]||""),mimes:tinymce.explode(r[a][2]||""),codebase:r[a][3]};for(f=0;f<l.clsids.length;f++)u["clsid:"+l.clsids[f]]=l;for(f=0;f<l.mimes.length;f++)u[l.mimes[f]]=l;u["mceItem"+c]=l,u[c.toLowerCase()]=l,i+=(i?"|":"")+c}tinymce.each(t.getParam("media_types","video=mp4,m4v,ogv,webm;silverlight=xap;flash=swf,flv;shockwave=dcr;quicktime=mov,qt,mpg,mpeg;shockwave=dcr;windowsmedia=avi,wmv,wm,asf,asx,wmx,wvx;realmedia=rm,ra,ram;java=jar;audio=mp3,ogg").split(";"),function(e){var t,n,r;e=e.split(/=/),n=tinymce.explode(e[1].toLowerCase());for(t=0;t<n.length;t++)r=u[e[0].toLowerCase()],r&&(u[n[t]]=r)}),i=new RegExp("write("+i+")\\(([^)]+)\\)"),o.lookup=u,t.onPreInit.add(function(){t.schema.addValidElements("object[id|style|width|height|classid|codebase|*],param[name|value],embed[id|style|width|height|type|src|*],video[*],audio[*],source[*]"),t.parser.addNodeFilter("object,embed,video,audio,script,iframe",function(e){var t=e.length;while(t--)o.objectToImg(e[t])}),t.serializer.addNodeFilter("img",function(e,t,n){var r=e.length,i;while(r--)i=e[r],(i.attr("class")||"").indexOf("mceItemMedia")!==-1&&o.imgToObject(i,n)})}),t.onInit.add(function(){t.theme&&t.theme.onResolveName&&t.theme.onResolveName.add(function(e,n){n.name==="img"&&t.dom.hasClass(n.node,"mceItemMedia")&&(n.name="media")}),t&&t.plugins.contextmenu&&t.plugins.contextmenu.onContextMenu.add(function(e,t,n){n.nodeName==="IMG"&&n.className.indexOf("mceItemMedia")!==-1&&t.add({title:"media.edit",icon:"media",cmd:"mceMedia"})})}),t.addCommand("mceMedia",function(){var r,i;i=t.selection.getNode(),h(i)&&(r=t.dom.getAttrib(i,"data-mce-json"),r&&(r=s.parse(r),tinymce.each(e,function(e){var n=t.dom.getAttrib(i,e);n&&(r[e]=n)}),r.type=o.getType(i.className).name.toLowerCase())),r||(r={type:"flash",video:{sources:[]},params:{}}),t.windowManager.open({file:n+"/media.htm",width:430+parseInt(t.getLang("media.delta_width",0)),height:500+parseInt(t.getLang("media.delta_height",0)),inline:1},{plugin_url:n,data:r})}),t.addButton("media",{title:"media.desc",cmd:"mceMedia"}),t.onNodeChange.add(function(e,t,n){t.setActive("media",h(n))})},convertUrl:function(e,t){var n=this,r=n.editor,i=r.settings,s=i.url_converter,o=i.url_converter_scope||n;return e?t?r.documentBaseURI.toAbsolute(e):s.call(o,e,"src","object"):e},getInfo:function(){return{longname:"Media",author:"Moxiecode Systems AB",authorurl:"http://tinymce.moxiecode.com",infourl:"http://wiki.moxiecode.com/index.php/TinyMCE:Plugins/media",version:tinymce.majorVersion+"."+tinymce.minorVersion}},dataToImg:function(e,t){var n=this,r=n.editor,i=r.documentBaseURI,o,a,f,l;e.params.src=n.convertUrl(e.params.src,t),a=e.video.attrs,a&&(a.src=n.convertUrl(a.src,t)),a&&(a.poster=n.convertUrl(a.poster,t)),o=u(e.video.sources);if(o)for(l=0;l<o.length;l++)o[l].src=n.convertUrl(o[l].src,t);return f=n.editor.dom.create("img",{id:e.id,style:e.style,align:e.align,hspace:e.hspace,vspace:e.vspace,src:n.editor.theme.url+"/img/trans.gif","class":"mceItemMedia mceItem"+n.getType(e.type).name,"data-mce-json":s.serialize(e,"'")}),f.width=e.width||(e.type=="audio"?"300":"320"),f.height=e.height||(e.type=="audio"?"32":"240"),f},dataToHtml:function(e,t){return this.editor.serializer.serialize(this.dataToImg(e,t),{forced_root_block:"",force_absolute:t})},htmlToData:function(t){var n,r,i;return i={type:"flash",video:{sources:[]},params:{}},n=this.editor.parser.parse(t),r=n.getAll("img")[0],r&&(i=s.parse(r.attr("data-mce-json")),i.type=this.getType(r.attr("class")).name.toLowerCase(),tinymce.each(e,function(e){var t=r.attr(e);t&&(i[e]=t)})),i},getType:function(e){var t,n,r;n=tinymce.explode(e," ");for(t=0;t<n.length;t++){r=this.lookup[n[t]];if(r)return r}},imgToObject:function(t,r){function k(e,t){var n,r,s,u,a;a=o.getParam("flash_video_player_url",i.convertUrl(i.url+"/moxieplayer.swf")),a&&(n=o.documentBaseURI,d.params.src=a,o.getParam("flash_video_player_absvideourl",!0)&&(e=n.toAbsolute(e||"",!0),t=n.toAbsolute(t||"",!0)),s="",r=o.getParam("flash_video_player_flashvars",{url:"$url",poster:"$poster"}),tinymce.each(r,function(n,r){n=n.replace(/\$url/,e||""),n=n.replace(/\$poster/,t||""),n.length>0&&(s+=(s?"&":"")+r+"="+escape(n))}),s.length&&(d.params.flashvars=s),u=o.getParam("flash_video_player_params",{allowfullscreen:!0,allowscriptaccess:!0}),tinymce.each(u,function(e,t){d.params[t]=""+e}))}var i=this,o=i.editor,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C;d=t.attr("data-mce-json");if(!d)return;d=s.parse(d),b=this.getType(t.attr("class")),N=t.attr("data-mce-style"),N||(N=t.attr("style"),N&&(N=o.dom.serializeStyle(o.dom.parseStyle(N,"img"))));if(b.name==="Iframe"){x=new n("iframe",1),tinymce.each(e,function(e){var n=t.attr(e);e=="class"&&n&&(n=n.replace(/mceItem.+ ?/g,"")),n&&n.length>0&&x.attr(e,n)});for(h in d.params)x.attr(h,d.params[h]);x.attr({style:N,src:d.params.src}),t.replace(x);return}if(this.editor.settings.media_use_script){x=(new n("script",1)).attr("type","text/javascript"),p=new n("#text",3),p.value="write"+b.name+"("+s.serialize(tinymce.extend(d.params,{width:t.attr("width"),height:t.attr("height")}))+");",x.append(p),t.replace(x);return}if(b.name==="Video"&&d.video.sources[0]){a=(new n("video",1)).attr(tinymce.extend({id:t.attr("id"),width:t.attr("width"),height:t.attr("height"),style:N},d.video.attrs)),d.video.attrs&&(T=d.video.attrs.poster),m=d.video.sources=u(d.video.sources);for(w=0;w<m.length;w++)/\.mp4$/.test(m[w].src)&&(S=m[w].src);m[0].type||(a.attr("src",m[0].src),m.splice(0,1));for(w=0;w<m.length;w++)v=(new n("source",1)).attr(m[w]),v.shortEnded=!0,a.append(v);S?(k(S,T),b=i.getType("flash")):d.params.src=""}if(b.name==="Audio"&&d.video.sources[0]){C=(new n("audio",1)).attr(tinymce.extend({id:t.attr("id"),width:t.attr("width"),height:t.attr("height"),style:N},d.video.attrs)),d.video.attrs&&(T=d.video.attrs.poster),m=d.video.sources=u(d.video.sources),m[0].type||(C.attr("src",m[0].src),m.splice(0,1));for(w=0;w<m.length;w++)v=(new n("source",1)).attr(m[w]),v.shortEnded=!0,C.append(v);d.params.src=""}if(b.name==="EmbeddedAudio"){l=new n("embed",1),l.shortEnded=!0,l.attr({id:t.attr("id"),width:t.attr("width"),height:t.attr("height"),style:N,type:t.attr("type")});for(h in d.params)l.attr(h,d.params[h]);tinymce.each(e,function(e){d[e]&&e!="type"&&l.attr(e,d[e])}),d.params.src=""}if(d.params.src){/\.flv$/i.test(d.params.src)&&k(d.params.src,""),r&&r.force_absolute&&(d.params.src=o.documentBaseURI.toAbsolute(d.params.src)),f=(new n("object",1)).attr({id:t.attr("id"),width:t.attr("width"),height:t.attr("height"),style:N}),tinymce.each(e,function(e){var t=d[e];e=="class"&&t&&(t=t.replace(/mceItem.+ ?/g,"")),t&&e!="type"&&f.attr(e,t)});for(h in d.params)y=new n("param",1),y.shortEnded=!0,p=d.params[h],h==="src"&&b.name==="WindowsMedia"&&(h="url"),y.attr({name:h,value:p}),f.append(y);if(this.editor.getParam("media_strict",!0))f.attr({data:d.params.src,type:b.mimes[0]});else{f.attr({classid:"clsid:"+b.clsids[0],codebase:b.codebase}),l=new n("embed",1),l.shortEnded=!0,l.attr({id:t.attr("id"),width:t.attr("width"),height:t.attr("height"),style:N,type:b.mimes[0]});for(h in d.params)l.attr(h,d.params[h]);tinymce.each(e,function(e){d[e]&&e!="type"&&l.attr(e,d[e])}),f.append(l)}d.object_html&&(p=new n("#text",3),p.raw=!0,p.value=d.object_html,f.append(p)),a&&a.append(f)}a&&d.video_html&&(p=new n("#text",3),p.raw=!0,p.value=d.video_html,a.append(p)),C&&d.video_html&&(p=new n("#text",3),p.raw=!0,p.value=d.video_html,C.append(p));var L=a||C||f||l;L?t.replace(L):t.remove()},objectToImg:function(r){function D(e){return(new tinymce.html.Serializer({inner:!0,validate:!1})).serialize(e)}function P(e,t){return T[(e.attr(t)||"").toLowerCase()]}function H(e){var t=e.replace(/^.*\.([^.]+)$/,"$1");return T[t.toLowerCase()||""]}var o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T=this.lookup,N,C,k=this.editor.settings.url_converter,L=this.editor.settings.url_converter_scope,A,O,M,_;if(!r.parent)return;if(r.name==="script"){r.firstChild&&(N=i.exec(r.firstChild.value));if(!N)return;x=N[1],S={video:{},params:s.parse(N[2])},p=S.params.width,d=S.params.height}S=S||{video:{},params:{}},l=new n("img",1),l.attr({src:this.editor.theme.url+"/img/trans.gif"}),c=r.name;if(c==="video"||c=="audio"){a=r,o=r.getAll("object")[0],u=r.getAll("embed")[0],p=a.attr("width"),d=a.attr("height"),h=a.attr("id"),S.video={attrs:{},sources:[]},C=S.video.attrs;for(c in a.attributes.map)C[c]=a.attributes.map[c];w=r.attr("src"),w&&S.video.sources.push({src:k.call(L,w,"src",r.name)}),E=a.getAll("source");for(m=0;m<E.length;m++)w=E[m].remove(),S.video.sources.push({src:k.call(L,w.attr("src"),"src","source"),type:w.attr("type"),media:w.attr("media")});C.poster&&(C.poster=k.call(L,C.poster,"poster",r.name))}r.name==="object"&&(o=r,u=r.getAll("embed")[0]),r.name==="embed"&&(u=r),r.name==="iframe"&&(f=r,x="Iframe");if(o){p=p||o.attr("width"),d=d||o.attr("height"),v=v||o.attr("style"),h=h||o.attr("id"),A=A||o.attr("hspace"),O=O||o.attr("vspace"),M=M||o.attr("align"),_=_||o.attr("bgcolor"),S.name=o.attr("name"),b=o.getAll("param");for(m=0;m<b.length;m++)y=b[m],c=y.remove().attr("name"),t[c]||(S.params[c]=y.attr("value"));S.params.src=S.params.src||o.attr("data")}if(u){p=p||u.attr("width"),d=d||u.attr("height"),v=v||u.attr("style"),h=h||u.attr("id"),A=A||u.attr("hspace"),O=O||u.attr("vspace"),M=M||u.attr("align"),_=_||u.attr("bgcolor");for(c in u.attributes.map)!t[c]&&!S.params[c]&&(S.params[c]=u.attributes.map[c])}if(f){p=f.attr("width"),d=f.attr("height"),v=v||f.attr("style"),h=f.attr("id"),A=f.attr("hspace"),O=f.attr("vspace"),M=f.attr("align"),_=f.attr("bgcolor"),tinymce.each(e,function(e){l.attr(e,f.attr(e))});for(c in f.attributes.map)!t[c]&&!S.params[c]&&(S.params[c]=f.attributes.map[c])}S.params.movie&&(S.params.src=S.params.src||S.params.movie,delete S.params.movie),S.params.src&&(S.params.src=k.call(L,S.params.src,"src","object")),a&&(r.name==="video"?x=T.video.name:r.name==="audio"&&(x=T.audio.name)),o&&!x&&(x=(P(o,"clsid")||P(o,"classid")||P(o,"type")||{}).name),u&&!x&&(x=(P(u,"type")||H(S.params.src)||{}).name),u&&x=="EmbeddedAudio"&&(S.params.type=u.attr("type")),r.replace(l),u&&u.remove(),o&&(g=D(o.remove()),g&&(S.object_html=g)),a&&(g=D(a.remove()),g&&(S.video_html=g)),S.hspace=A,S.vspace=O,S.align=M,S.bgcolor=_,l.attr({id:h,"class":"mceItemMedia mceItem"+(x||"Flash"),style:v,width:p||(r.name=="audio"?"300":"320"),height:d||(r.name=="audio"?"32":"240"),hspace:A,vspace:O,align:M,bgcolor:_,"data-mce-json":s.serialize(S,"'")})}}),tinymce.PluginManager.add("media",tinymce.plugins.MediaPlugin)})();