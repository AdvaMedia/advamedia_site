/*!
* This file is part of Aloha Editor Project http://aloha-editor.org
* Copyright Â© 2010-2011 Gentics Software GmbH, aloha@gentics.com
* Contributors http://aloha-editor.org/contribution.php
* Licensed unter the terms of http://www.aloha-editor.org/license.html
*/
/*
* Aloha Editor is free software: you can redistribute it and/or modify
* it under the terms of the GNU Affero General Public License as published by
* the Free Software Foundation, either version 3 of the License, or
* (at your option) any later version.*
*
* Aloha Editor is distributed in the hope that it will be useful,
* but WITHOUT ANY WARRANTY; without even the implied warranty of
* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
* GNU Affero General Public License for more details.
*
* You should have received a copy of the GNU Affero General Public License
* along with this program. If not, see <http://www.gnu.org/licenses/>.
*/
// Ensure GENTICS Namespace
GENTICS=window.GENTICS||{},GENTICS.Utils=GENTICS.Utils||{},define(["aloha/jquery","util/dom","util/class","aloha/console","aloha/rangy-core"],function(e,t,n,r){var i=window.GENTICS,s=window.rangy;return i.Utils.RangeObject=n.extend({_constructor:function(e){typeof e=="object"?(typeof e.startContainer!="undefined"&&(this.startContainer=e.startContainer),typeof e.startOffset!="undefined"&&(this.startOffset=e.startOffset),typeof e.endContainer!="undefined"&&(this.endContainer=e.endContainer),typeof e.endOffset!="undefined"&&(this.endOffset=e.endOffset)):e===!0&&this.initializeFromUserSelection()},startContainer:undefined,startOffset:undefined,endContainer:undefined,endOffset:undefined,deleteContents:function(){t.removeRange(this)},log:function(e){r.deprecated("Utils.RangeObject",'log() is deprecated. use console.log() from module "aloha/console" instead: '+e)},isCollapsed:function(){return!this.endContainer||this.startContainer===this.endContainer&&this.startOffset===this.endOffset},getCommonAncestorContainer:function(){return this.commonAncestorContainer?this.commonAncestorContainer:(this.updateCommonAncestorContainer(),this.commonAncestorContainer)},getContainerParents:function(t,n){var r=n?this.endContainer:this.startContainer,i,s,o;if(!r)return!1;if(typeof t=="undefined"||!t)t=e("body");if(r.nodeType==3)i=e(r).parents();else{i=e(r).parents();for(o=i.length;o>0;--o)i[o]=i[o-1];i[0]=r}return s=i.index(t),s>=0&&(i=i.slice(0,s)),i},getStartContainerParents:function(e){return this.getContainerParents(e,!1)},getEndContainerParents:function(e){return this.getContainerParents(e,!0)},updateCommonAncestorContainer:function(e){if(!e){var t=this.getStartContainerParents(),n=this.getEndContainerParents(),i;if(!(t.length>0&&n.length>0))return r.warn("could not find commonAncestorContainer"),!1;for(i=0;i<t.length;i++)if(n.index(t[i])!=-1){this.commonAncestorContainer=t[i];break}}else this.commonAncestorContainer=e;return r.debug(e?"commonAncestorContainer was set successfully":"commonAncestorContainer was calculated successfully"),!0},getCollapsedIERange:function(e,t){var n=document.body.createTextRange(),r,i,s,o;return o=this.searchElementToLeft(e,t),o.element?(r=document.body.createTextRange(),r.moveToElementText(o.element),n.setEndPoint("StartToEnd",r),o.characters!==0?n.moveStart("character",o.characters):(n.moveStart("character",1),n.moveStart("character",-1))):(i=this.searchElementToRight(e,t),s=e.nodeType==3?e.parentNode:e,r=document.body.createTextRange(),r.moveToElementText(s),n.setEndPoint("StartToStart",r),o.characters!==0&&n.moveStart("character",o.characters)),n.collapse(),n},select:function(){var e,t,n,r,i;r=s.createRange(),r.setStart(this.startContainer,this.startOffset),r.setEnd(this.endContainer,this.endOffset),i=s.getSelection(),i.setSingleRange(r)},searchElementToLeft:function(e,t){var n,r=0;e.nodeType===3?(r=t,n=e.previousSibling):t>0&&(n=e.childNodes[t-1]);while(n&&n.nodeType===3)r+=n.data.length,n=n.previousSibling;return{element:n,characters:r}},searchElementToRight:function(e,t){var n,r=0;e.nodeType===3?(r=e.data.length-t,n=e.nextSibling):t<e.childNodes.length&&(n=e.childNodes[t]);while(n&&n.nodeType===3)r+=n.data.length,n=n.nextSibling;return{element:n,characters:r}},update:function(e){r.debug("now updating rangeObject"),this.initializeFromUserSelection(e),this.updateCommonAncestorContainer()},initializeFromUserSelection:function(e){var t=s.getSelection(),n;if(!t)return!1;if(!t.rangeCount)return!1;n=t.getRangeAt(0);if(!n)return!1;this.startContainer=n.startContainer,this.endContainer=n.endContainer,this.startOffset=n.startOffset,this.endOffset=n.endOffset,this.correctRange();return},correctRange:function(){var e,t,n,r,s;this.clearCaches();if(this.isCollapsed()){if(this.startContainer.nodeType===1){if(this.startOffset>0&&this.startContainer.childNodes[this.startOffset-1].nodeType===3){this.startContainer=this.startContainer.childNodes[this.startOffset-1],this.startOffset=this.startContainer.data.length,this.endContainer=this.startContainer,this.endOffset=this.startOffset;return}if(this.startOffset>0&&this.startContainer.childNodes[this.startOffset-1].nodeType===1){e=i.Utils.Dom.searchAdjacentTextNode(this.startContainer,this.startOffset,!0);if(e){this.startContainer=this.endContainer=e,this.startOffset=this.endOffset=e.data.length;return}e=i.Utils.Dom.searchAdjacentTextNode(this.startContainer,this.startOffset,!1);if(e){this.startContainer=this.endContainer=e,this.startOffset=this.endOffset=0;return}}if(this.startOffset<this.startContainer.childNodes.length&&this.startContainer.childNodes[this.startOffset].nodeType===3){this.startContainer=this.startContainer.childNodes[this.startOffset],this.startOffset=0,this.endContainer=this.startContainer,this.endOffset=0;return}}this.startContainer.nodeType===3&&this.startOffset===0&&(e=i.Utils.Dom.searchAdjacentTextNode(this.startContainer.parentNode,i.Utils.Dom.getIndexInParent(this.startContainer),!0),e&&(this.startContainer=this.endContainer=e,this.startOffset=this.endOffset=e.data.length))}else{if(this.startContainer.nodeType===1)if(this.startOffset<this.startContainer.childNodes.length&&this.startContainer.childNodes[this.startOffset].nodeType===3)this.startContainer=this.startContainer.childNodes[this.startOffset],this.startOffset=0;else if(this.startOffset<this.startContainer.childNodes.length&&this.startContainer.childNodes[this.startOffset].nodeType===1){t=!1,n=this.startContainer.childNodes[this.startOffset];while(t===!1&&n.childNodes&&n.childNodes.length>0)n=n.childNodes[0],n.nodeType===3&&(t=n);t!==!1&&(this.startContainer=t,this.startOffset=0)}this.startContainer.nodeType===3&&this.startOffset===this.startContainer.data.length&&(e=i.Utils.Dom.searchAdjacentTextNode(this.startContainer.parentNode,i.Utils.Dom.getIndexInParent(this.startContainer)+1,!1),e&&(this.startContainer=e,this.startOffset=0));if(this.endContainer.nodeType===3&&this.endOffset===0)if(this.endContainer.previousSibling&&this.endContainer.previousSibling.nodeType===3)this.endContainer=this.endContainer.previousSibling,this.endOffset=this.endContainer.data.length;else if(this.endContainer.previousSibling&&this.endContainer.previousSibling.nodeType===1&&this.endContainer.parentNode){r=this.endContainer.parentNode;for(s=0;s<r.childNodes.length;++s)if(r.childNodes[s]==this.endContainer){this.endOffset=s;break}this.endContainer=r}this.endContainer.nodeType==1&&this.endOffset===0&&this.endContainer.previousSibling&&(this.endContainer.previousSibling.nodeType===3?(this.endContainer=this.endContainer.previousSibling,this.endOffset=this.endContainer.data.length):this.endContainer.previousSibling.nodeType===1&&this.endContainer.previousSibling.childNodes&&this.endContainer.previousSibling.childNodes.length>0&&(this.endContainer=this.endContainer.previousSibling,this.endOffset=this.endContainer.childNodes.length));if(this.endContainer.nodeType==1)if(this.endOffset>0&&this.endContainer.childNodes[this.endOffset-1].nodeType===3)this.endContainer=this.endContainer.childNodes[this.endOffset-1],this.endOffset=this.endContainer.data.length;else if(this.endOffset>0&&this.endContainer.childNodes[this.endOffset-1].nodeType===1){t=!1,n=this.endContainer.childNodes[this.endOffset-1];while(t===!1&&n.childNodes&&n.childNodes.length>0)n=n.childNodes[n.childNodes.length-1],n.nodeType===3&&(t=n);t!==!1&&(this.endContainer=t,this.endOffset=this.endContainer.data.length)}}},clearCaches:function(){this.commonAncestorContainer=undefined},getRangeTree:function(e){return typeof e=="undefined"&&(e=this.getCommonAncestorContainer()),this.inselection=!1,this.recursiveGetRangeTree(e)},recursiveGetRangeTree:function(t){var n=e(t),r=0,s=this,o=[];return n.contents().each(function(e){var n="none",u=!1,a=!1,f=!1,l=!1,c=!1,h=!1,p;s.isCollapsed()&&t===s.startContainer&&s.startOffset===e&&(o[r]=new i.Utils.RangeTree,o[r].type="collapsed",o[r].domobj=undefined,s.inselection=!1,f=!0,r++);if(!s.inselection&&!f)switch(this.nodeType){case 3:this===s.startContainer&&(s.inselection=!0,n=s.startOffset>0?"partial":"full",u=s.startOffset,a=this.length);break;case 1:this===s.startContainer&&s.startOffset===0&&(s.inselection=!0,n="full"),t===s.startContainer&&s.startOffset===e&&(s.inselection=!0,n="full")}if(s.inselection&&!f){n=="none"&&(n="full");switch(this.nodeType){case 3:this===s.endContainer&&(s.inselection=!1,s.endOffset<this.length&&(n="partial"),u===!1&&(u=0),a=s.endOffset);break;case 1:this===s.endContainer&&s.endOffset===0&&(s.inselection=!1)}t===s.endContainer&&s.endOffset<=e&&(s.inselection=!1,n="none")}o[r]=new i.Utils.RangeTree,o[r].domobj=this,o[r].type=n,n=="partial"&&(o[r].startOffset=u,o[r].endOffset=a),o[r].children=s.recursiveGetRangeTree(this);if(o[r].children.length>0){for(p=0;p<o[r].children.length;++p)switch(o[r].children[p].type){case"none":l=!0;break;case"full":h=!0;break;case"partial":c=!0}c||h&&l?o[r].type="partial":h&&!c&&!l&&(o[r].type="full")}r++}),this.isCollapsed()&&t===this.startContainer&&this.startOffset==t.childNodes.length&&(o[r]=new i.Utils.RangeTree,o[r].type="collapsed",o[r].domobj=undefined),o},findMarkup:function(t,n,r){var i=this.getContainerParents(n,r),s=!1;return e.each(i,function(e,n){if(t.apply(n))return s=n,!1}),s},getText:function(){return this.isCollapsed()?"":this.recursiveGetText(this.getRangeTree())},recursiveGetText:function(t){if(!t)return"";var n=this,r="";return e.each(t,function(){this.type=="full"?r+=e(this.domobj).text():this.type=="partial"&&this.domobj.nodeType===3?r+=e(this.domobj).text().substring(this.startOffset,this.endOffset):this.type=="partial"&&this.domobj.nodeType===1&&this.children&&(r+=n.recursiveGetText(this.children))}),r}}),i.Utils.RangeTree=n.extend({domobj:{},type:null,children:[]}),i.Utils.RangeObject});