/*!
* This file is part of Aloha Editor Project http://aloha-editor.org
* Copyright Â© 2010-2011 Gentics Software GmbH, aloha@gentics.com
* Contributors http://aloha-editor.org/contribution.php
* Licensed unter the terms of http://www.aloha-editor.org/license.html
*/
/*
* Aloha Editor is free software: you can redistribute it and/or modify
* it under the terms of the GNU Affero General Public License as published by
* the Free Software Foundation, either version 3 of the License, or
* (at your option) any later version.*
*
* Aloha Editor is distributed in the hope that it will be useful,
* but WITHOUT ANY WARRANTY; without even the implied warranty of
* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
* GNU Affero General Public License for more details.
*
* You should have received a copy of the GNU Affero General Public License
* along with this program. If not, see <http://www.gnu.org/licenses/>.
*/
// Ensure GENTICS Namespace
GENTICS=window.GENTICS||{},GENTICS.Utils=GENTICS.Utils||{},define(["aloha/jquery","util/dom","util/class","aloha/console","aloha/rangy-core"],function(a,b,c,d){var e=window.GENTICS,f=window.rangy;return e.Utils.RangeObject=c.extend({_constructor:function(a){typeof a=="object"?(typeof a.startContainer!="undefined"&&(this.startContainer=a.startContainer),typeof a.startOffset!="undefined"&&(this.startOffset=a.startOffset),typeof a.endContainer!="undefined"&&(this.endContainer=a.endContainer),typeof a.endOffset!="undefined"&&(this.endOffset=a.endOffset)):a===!0&&this.initializeFromUserSelection()},startContainer:undefined,startOffset:undefined,endContainer:undefined,endOffset:undefined,deleteContents:function(){b.removeRange(this)},log:function(a){d.deprecated("Utils.RangeObject",'log() is deprecated. use console.log() from module "aloha/console" instead: '+a)},isCollapsed:function(){return!this.endContainer||this.startContainer===this.endContainer&&this.startOffset===this.endOffset},getCommonAncestorContainer:function(){return this.commonAncestorContainer?this.commonAncestorContainer:(this.updateCommonAncestorContainer(),this.commonAncestorContainer)},getContainerParents:function(b,c){var d=c?this.endContainer:this.startContainer,e,f,g;if(!d)return!1;if(typeof b=="undefined"||!b)b=a("body");if(d.nodeType==3)e=a(d).parents();else{e=a(d).parents();for(g=e.length;g>0;--g)e[g]=e[g-1];e[0]=d}return f=e.index(b),f>=0&&(e=e.slice(0,f)),e},getStartContainerParents:function(a){return this.getContainerParents(a,!1)},getEndContainerParents:function(a){return this.getContainerParents(a,!0)},updateCommonAncestorContainer:function(a){if(!a){var b=this.getStartContainerParents(),c=this.getEndContainerParents(),e;if(!(b.length>0&&c.length>0))return d.warn("could not find commonAncestorContainer"),!1;for(e=0;e<b.length;e++)if(c.index(b[e])!=-1){this.commonAncestorContainer=b[e];break}}else this.commonAncestorContainer=a;return d.debug(a?"commonAncestorContainer was set successfully":"commonAncestorContainer was calculated successfully"),!0},getCollapsedIERange:function(a,b){var c=document.body.createTextRange(),d,e,f,g;return g=this.searchElementToLeft(a,b),g.element?(d=document.body.createTextRange(),d.moveToElementText(g.element),c.setEndPoint("StartToEnd",d),g.characters!==0?c.moveStart("character",g.characters):(c.moveStart("character",1),c.moveStart("character",-1))):(e=this.searchElementToRight(a,b),f=a.nodeType==3?a.parentNode:a,d=document.body.createTextRange(),d.moveToElementText(f),c.setEndPoint("StartToStart",d),g.characters!==0&&c.moveStart("character",g.characters)),c.collapse(),c},select:function(){var a,b,c,d,e;d=f.createRange(),d.setStart(this.startContainer,this.startOffset),d.setEnd(this.endContainer,this.endOffset),e=f.getSelection(),e.setSingleRange(d)},searchElementToLeft:function(a,b){var c,d=0;a.nodeType===3?(d=b,c=a.previousSibling):b>0&&(c=a.childNodes[b-1]);while(c&&c.nodeType===3)d+=c.data.length,c=c.previousSibling;return{element:c,characters:d}},searchElementToRight:function(a,b){var c,d=0;a.nodeType===3?(d=a.data.length-b,c=a.nextSibling):b<a.childNodes.length&&(c=a.childNodes[b]);while(c&&c.nodeType===3)d+=c.data.length,c=c.nextSibling;return{element:c,characters:d}},update:function(a){d.debug("now updating rangeObject"),this.initializeFromUserSelection(a),this.updateCommonAncestorContainer()},initializeFromUserSelection:function(a){var b=f.getSelection(),c;if(!b)return!1;if(!b.rangeCount)return!1;c=b.getRangeAt(0);if(!c)return!1;this.startContainer=c.startContainer,this.endContainer=c.endContainer,this.startOffset=c.startOffset,this.endOffset=c.endOffset,this.correctRange();return},correctRange:function(){var a,b,c,d,f;this.clearCaches();if(this.isCollapsed()){if(this.startContainer.nodeType===1){if(this.startOffset>0&&this.startContainer.childNodes[this.startOffset-1].nodeType===3){this.startContainer=this.startContainer.childNodes[this.startOffset-1],this.startOffset=this.startContainer.data.length,this.endContainer=this.startContainer,this.endOffset=this.startOffset;return}if(this.startOffset>0&&this.startContainer.childNodes[this.startOffset-1].nodeType===1){a=e.Utils.Dom.searchAdjacentTextNode(this.startContainer,this.startOffset,!0);if(a){this.startContainer=this.endContainer=a,this.startOffset=this.endOffset=a.data.length;return}a=e.Utils.Dom.searchAdjacentTextNode(this.startContainer,this.startOffset,!1);if(a){this.startContainer=this.endContainer=a,this.startOffset=this.endOffset=0;return}}if(this.startOffset<this.startContainer.childNodes.length&&this.startContainer.childNodes[this.startOffset].nodeType===3){this.startContainer=this.startContainer.childNodes[this.startOffset],this.startOffset=0,this.endContainer=this.startContainer,this.endOffset=0;return}}this.startContainer.nodeType===3&&this.startOffset===0&&(a=e.Utils.Dom.searchAdjacentTextNode(this.startContainer.parentNode,e.Utils.Dom.getIndexInParent(this.startContainer),!0),a&&(this.startContainer=this.endContainer=a,this.startOffset=this.endOffset=a.data.length))}else{if(this.startContainer.nodeType===1)if(this.startOffset<this.startContainer.childNodes.length&&this.startContainer.childNodes[this.startOffset].nodeType===3)this.startContainer=this.startContainer.childNodes[this.startOffset],this.startOffset=0;else if(this.startOffset<this.startContainer.childNodes.length&&this.startContainer.childNodes[this.startOffset].nodeType===1){b=!1,c=this.startContainer.childNodes[this.startOffset];while(b===!1&&c.childNodes&&c.childNodes.length>0)c=c.childNodes[0],c.nodeType===3&&(b=c);b!==!1&&(this.startContainer=b,this.startOffset=0)}this.startContainer.nodeType===3&&this.startOffset===this.startContainer.data.length&&(a=e.Utils.Dom.searchAdjacentTextNode(this.startContainer.parentNode,e.Utils.Dom.getIndexInParent(this.startContainer)+1,!1),a&&(this.startContainer=a,this.startOffset=0));if(this.endContainer.nodeType===3&&this.endOffset===0)if(this.endContainer.previousSibling&&this.endContainer.previousSibling.nodeType===3)this.endContainer=this.endContainer.previousSibling,this.endOffset=this.endContainer.data.length;else if(this.endContainer.previousSibling&&this.endContainer.previousSibling.nodeType===1&&this.endContainer.parentNode){d=this.endContainer.parentNode;for(f=0;f<d.childNodes.length;++f)if(d.childNodes[f]==this.endContainer){this.endOffset=f;break}this.endContainer=d}this.endContainer.nodeType==1&&this.endOffset===0&&this.endContainer.previousSibling&&(this.endContainer.previousSibling.nodeType===3?(this.endContainer=this.endContainer.previousSibling,this.endOffset=this.endContainer.data.length):this.endContainer.previousSibling.nodeType===1&&this.endContainer.previousSibling.childNodes&&this.endContainer.previousSibling.childNodes.length>0&&(this.endContainer=this.endContainer.previousSibling,this.endOffset=this.endContainer.childNodes.length));if(this.endContainer.nodeType==1)if(this.endOffset>0&&this.endContainer.childNodes[this.endOffset-1].nodeType===3)this.endContainer=this.endContainer.childNodes[this.endOffset-1],this.endOffset=this.endContainer.data.length;else if(this.endOffset>0&&this.endContainer.childNodes[this.endOffset-1].nodeType===1){b=!1,c=this.endContainer.childNodes[this.endOffset-1];while(b===!1&&c.childNodes&&c.childNodes.length>0)c=c.childNodes[c.childNodes.length-1],c.nodeType===3&&(b=c);b!==!1&&(this.endContainer=b,this.endOffset=this.endContainer.data.length)}}},clearCaches:function(){this.commonAncestorContainer=undefined},getRangeTree:function(a){return typeof a=="undefined"&&(a=this.getCommonAncestorContainer()),this.inselection=!1,this.recursiveGetRangeTree(a)},recursiveGetRangeTree:function(b){var c=a(b),d=0,f=this,g=[];return c.contents().each(function(a){var c="none",h=!1,i=!1,j=!1,k=!1,l=!1,m=!1,n;f.isCollapsed()&&b===f.startContainer&&f.startOffset===a&&(g[d]=new e.Utils.RangeTree,g[d].type="collapsed",g[d].domobj=undefined,f.inselection=!1,j=!0,d++);if(!f.inselection&&!j)switch(this.nodeType){case 3:this===f.startContainer&&(f.inselection=!0,c=f.startOffset>0?"partial":"full",h=f.startOffset,i=this.length);break;case 1:this===f.startContainer&&f.startOffset===0&&(f.inselection=!0,c="full"),b===f.startContainer&&f.startOffset===a&&(f.inselection=!0,c="full")}if(f.inselection&&!j){c=="none"&&(c="full");switch(this.nodeType){case 3:this===f.endContainer&&(f.inselection=!1,f.endOffset<this.length&&(c="partial"),h===!1&&(h=0),i=f.endOffset);break;case 1:this===f.endContainer&&f.endOffset===0&&(f.inselection=!1)}b===f.endContainer&&f.endOffset<=a&&(f.inselection=!1,c="none")}g[d]=new e.Utils.RangeTree,g[d].domobj=this,g[d].type=c,c=="partial"&&(g[d].startOffset=h,g[d].endOffset=i),g[d].children=f.recursiveGetRangeTree(this);if(g[d].children.length>0){for(n=0;n<g[d].children.length;++n)switch(g[d].children[n].type){case"none":k=!0;break;case"full":m=!0;break;case"partial":l=!0}l||m&&k?g[d].type="partial":m&&!l&&!k&&(g[d].type="full")}d++}),this.isCollapsed()&&b===this.startContainer&&this.startOffset==b.childNodes.length&&(g[d]=new e.Utils.RangeTree,g[d].type="collapsed",g[d].domobj=undefined),g},findMarkup:function(b,c,d){var e=this.getContainerParents(c,d),f=!1;return a.each(e,function(a,c){if(b.apply(c))return f=c,!1}),f},getText:function(){return this.isCollapsed()?"":this.recursiveGetText(this.getRangeTree())},recursiveGetText:function(b){if(!b)return"";var c=this,d="";return a.each(b,function(){this.type=="full"?d+=a(this.domobj).text():this.type=="partial"&&this.domobj.nodeType===3?d+=a(this.domobj).text().substring(this.startOffset,this.endOffset):this.type=="partial"&&this.domobj.nodeType===1&&this.children&&(d+=c.recursiveGetText(this.children))}),d}}),e.Utils.RangeTree=c.extend({domobj:{},type:null,children:[]}),e.Utils.RangeObject});