/*!
* This file is part of Aloha Editor Project http://aloha-editor.org
* Copyright (c) 2010-2011 Gentics Software GmbH, aloha@gentics.com
* Contributors http://aloha-editor.org/contribution.php 
* Licensed unter the terms of http://www.aloha-editor.org/license.html
*/
/*
* Aloha Editor is free software: you can redistribute it and/or modify
* it under the terms of the GNU Affero General Public License as published by
* the Free Software Foundation, either version 3 of the License, or
* (at your option) any later version.*
*
* Aloha Editor is distributed in the hope that it will be useful,
* but WITHOUT ANY WARRANTY; without even the implied warranty of
* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
* GNU Affero General Public License for more details.
*
* You should have received a copy of the GNU Affero General Public License
* along with this program. If not, see <http://www.gnu.org/licenses/>.
*/
define(["aloha/core","aloha/jquery","aloha/floatingmenu","util/class","util/range","aloha/rangy-core"],function(a,b,c,d,e){function h(a){b.browser.msie&&a.startContainer===a.endContainer&&a.startOffset===a.endOffset&&a.startContainer.nodeType==3&&a.startOffset==a.startContainer.data.length&&a.startContainer.nextSibling&&["OL","UL"].indexOf(a.startContainer.nextSibling.nodeName)!==-1&&(a.startContainer.data[a.startContainer.data.length-1]==" "?a.startOffset=a.endOffset=a.startOffset-1:a.startContainer.data=a.startContainer.data+" ")}function i(a){return h(a),a}var f=window.GENTICS,g=d.extend({_constructor:function(){this.rangeObject={},this.preventSelectionChangedFlag=!1,this.tagHierarchy={textNode:[],abbr:["textNode"],b:["textNode","b","i","em","sup","sub","br","span","img","a","del","ins","u","cite","q","code","abbr","strong"],pre:["textNode","b","i","em","sup","sub","br","span","img","a","del","ins","u","cite","q","code","abbr","code"],blockquote:["textNode","b","i","em","sup","sub","br","span","img","a","del","ins","u","cite","q","code","abbr","p","h1","h2","h3","h4","h5","h6"],ins:["textNode","b","i","em","sup","sub","br","span","img","a","u","p","h1","h2","h3","h4","h5","h6"],ul:["li"],ol:["li"],li:["textNode","b","i","em","sup","sub","br","span","img","ul","ol","h1","h2","h3","h4","h5","h6","del","ins","u","a"],tr:["td","th"],table:["tr"],div:["textNode","b","i","em","sup","sub","br","span","img","ul","ol","table","h1","h2","h3","h4","h5","h6","del","ins","u","p","div","pre","blockquote","a"],h1:["textNode","b","i","em","sup","sub","br","span","img","a","del","ins","u"]},this.tagHierarchy={textNode:this.tagHierarchy.textNode,abbr:this.tagHierarchy.abbr,br:this.tagHierarchy.textNode,img:this.tagHierarchy.textNode,b:this.tagHierarchy.b,strong:this.tagHierarchy.b,code:this.tagHierarchy.b,q:this.tagHierarchy.b,blockquote:this.tagHierarchy.blockquote,cite:this.tagHierarchy.b,i:this.tagHierarchy.b,em:this.tagHierarchy.b,sup:this.tagHierarchy.b,sub:this.tagHierarchy.b,span:this.tagHierarchy.b,del:this.tagHierarchy.del,ins:this.tagHierarchy.ins,u:this.tagHierarchy.b,p:this.tagHierarchy.b,pre:this.tagHierarchy.pre,a:this.tagHierarchy.b,ul:this.tagHierarchy.ul,ol:this.tagHierarchy.ol,li:this.tagHierarchy.li,td:this.tagHierarchy.li,div:this.tagHierarchy.div,h1:this.tagHierarchy.h1,h2:this.tagHierarchy.h1,h3:this.tagHierarchy.h1,h4:this.tagHierarchy.h1,h5:this.tagHierarchy.h1,h6:this.tagHierarchy.h1,table:this.tagHierarchy.table},this.replacingElements={h1:["p","h1","h2","h3","h4","h5","h6","pre","blockquote"]},this.replacingElements={h1:this.replacingElements.h1,h2:this.replacingElements.h1,h3:this.replacingElements.h1,h4:this.replacingElements.h1,h5:this.replacingElements.h1,h6:this.replacingElements.h1,pre:this.replacingElements.h1,p:this.replacingElements.h1,blockquote:this.replacingElements.h1},this.allowedToStealElements={h1:["textNode"]},this.allowedToStealElements={h1:this.allowedToStealElements.h1,h2:this.allowedToStealElements.h1,h3:this.allowedToStealElements.h1,h4:this.allowedToStealElements.h1,h5:this.allowedToStealElements.h1,h6:this.allowedToStealElements.h1,p:this.tagHierarchy.b}},SelectionTree:function(){this.domobj={},this.selection=undefined,this.children=[]},onChange:function(b,c){this.updateSelectionTimeout&&(window.clearTimeout(this.updateSelectionTimeout),this.updateSelectionTimeout=undefined);var d=new a.Selection.SelectionRange(!0);this.updateSelectionTimeout=window.setTimeout(function(){a.Selection._updateSelection(c,d)},5)},preventSelectionChanged:function(){this.preventSelectionChangedFlag=!0},isSelectionChangedPrevented:function(){var a=this.preventSelectionChangedFlag;return this.preventSelectionChangedFlag=!1,a},isSelectionEditable:function(){return this.rangeObject.commonAncestorContainer&&b(this.rangeObject.commonAncestorContainer).contentEditable()},isFloatingMenuVisible:function(){var c=b(a.Selection.rangeObject.commonAncestorContainer).attr("data-aloha-floatingmenu-visible");return c!=="undefined"?c==="true"?!0:!1:!1},updateSelection:function(a){return this._updateSelection(a,null)},_updateSelection:function(d,e){if(d&&d.originalEvent&&d.originalEvent.stopSelectionUpdate===!0)return!1;if(typeof e=="undefined")return!1;this.rangeObject=e||new a.Selection.SelectionRange(!0);if(typeof this.rangeObject!="undefined"&&typeof this.rangeObject.startContainer!="undefined"&&this.rangeObject.endContainer!=="undefined")if(this.rangeObject.startContainer.nodeType===3&&!b(this.rangeObject.startContainer.parentNode).contentEditable()||this.rangeObject.endContainer.nodeType===3&&!b(this.rangeObject.endContainer.parentNode).contentEditable())return a.getSelection().removeAllRanges(),!0;return this.rangeObject.update(),this.isSelectionChangedPrevented()?!0:(d!==undefined&&c.setScope("Aloha.continuoustext"),a.trigger("aloha-selection-changed",[this.rangeObject,d]),!0)},getSelectionTree:function(b){return b?b.commonAncestorContainer?(this.inselection=!1,f.Utils.Dom.doCleanup({merge:!0},b)&&(this.rangeObject.update(),this.rangeObject.select()),this.recursiveGetSelectionTree(b,b.commonAncestorContainer)):(a.Log.error(this,"the rangeObject is missing the commonAncestorContainer"),!1):this.rangeObject.getSelectionTree()},recursiveGetSelectionTree:function(c,d){var e=b(d),f=0,g=this,h=[];return e.contents().each(function(b){var e="none",i=!1,j=!1,k=!1,l,m,n=!1,o=!1,p=!1;c.isCollapsed()&&d===c.startContainer&&c.startOffset==b&&(h[f]=new a.Selection.SelectionTree,h[f].selection="collapsed",h[f].domobj=undefined,g.inselection=!1,k=!0,f++);if(!g.inselection&&!k){var q;try{q=this.nodeType}catch(r){return}switch(q){case 3:this===c.startContainer&&(g.inselection=!0,e=c.startOffset>0?"partial":"full",i=c.startOffset,j=this.length);break;case 1:this===c.startContainer&&c.startOffset===0&&(g.inselection=!0,e="full"),d===c.startContainer&&c.startOffset===b&&(g.inselection=!0,e="full")}}if(g.inselection&&!k){e=="none"&&(e="full");switch(this.nodeType){case 3:this===c.endContainer&&(g.inselection=!1,c.endOffset<this.length&&(e="partial"),i===!1&&(i=0),j=c.endOffset);break;case 1:this===c.endContainer&&c.endOffset===0&&(g.inselection=!1)}d===c.endContainer&&c.endOffset<=b&&(g.inselection=!1,e="none")}h[f]=new a.Selection.SelectionTree,h[f].domobj=this,h[f].selection=e,e=="partial"&&(h[f].startOffset=i,h[f].endOffset=j),h[f].children=g.recursiveGetSelectionTree(c,this),m=h[f].children.length;if(m>0){for(l=0;l<m;++l)switch(h[f].children[l].selection){case"none":n=!0;break;case"full":p=!0;break;case"partial":o=!0}o||p&&n?h[f].selection="partial":p&&!o&&!n&&(h[f].selection="full")}f++}),c.isCollapsed()&&d===c.startContainer&&c.startOffset==d.childNodes.length&&(h[f]=new a.Selection.SelectionTree,h[f].selection="collapsed",h[f].domobj=undefined),h},getRangeObject:function(){return this.rangeObject},isRangeObjectWithinMarkup:function(c,d,e,f,g){var h=d?c.endContainer:c.startContainer,i=this,j=b(h).parents(),k=!1,l=-1;return typeof f!="undefined"&&typeof f!="function"&&a.Log.error(this,"parameter tagComparator is not a function"),typeof f=="undefined"&&(f=function(a,b){return i.standardTextLevelSemanticsComparator(a,b)}),j.length>0&&j.each(function(){if(this===g)return a.Log.debug(i,"reached limit dom obj"),!1;if(f(this,e))return k===!1&&(k=[]),a.Log.debug(i,"reached object equal to markup"),l++,k[l]=this,!0}),k},standardSectionsAndGroupingContentComparator:function(b,c){if(b.nodeType===1){if(c[0].tagName&&a.Selection.replacingElements[b.tagName.toLowerCase()]&&a.Selection.replacingElements[b.tagName.toLowerCase()].indexOf(c[0].tagName.toLowerCase())!=-1)return!0}else a.Log.debug(this,"only element nodes (nodeType == 1) can be compared");return!1},standardTagNameComparator:function(b,c){return b.nodeType===1?b.tagName.toLowerCase()!=c[0].tagName.toLowerCase()?!1:!0:(a.Log.debug(this,"only element nodes (nodeType == 1) can be compared"),!1)},standardTextLevelSemanticsComparator:function(b,c){return b.nodeType===1?b.tagName.toLowerCase()!=c[0].tagName.toLowerCase()?!1:this.standardAttributesComparator(b,c)?!0:!1:(a.Log.debug(this,"only element nodes (nodeType == 1) can be compared"),!1)},standardAttributesComparator:function(b,c){var d,e,f,g,h,i,j,k;b=b.cloneNode(!1);if(b.attributes&&b.attributes.length&&b.attributes.length>0)for(d=0,k=b.attributes.length;d<k;d++)e=b.attributes[d],e.nodeName.toLowerCase()=="class"&&e.nodeValue.length>0&&(f=e.nodeValue,g=f.split(" "));if(c[0].attributes&&c[0].attributes.length&&c[0].attributes.length>0)for(d=0,j=c[0].attributes.length;d<j;d++)e=c[0].attributes[d],e.nodeName.toLowerCase()=="class"&&e.nodeValue.length>0&&(f=e.nodeValue,h=f.split(" "));if(g&&!h||h&&!g)return a.Log.debug(this,"tag comparison for <"+b.tagName.toLowerCase()+"> failed because one element has classes and the other has not"),!1;if(g&&h&&g.length!=h.length)return a.Log.debug(this,"tag comparison for <"+b.tagName.toLowerCase()+"> failed because of a different amount of classes"),!1;if(g&&h&&g.length===h.length&&g.length!==0)for(d=0,i=g.length;d<i;d++)if(!c.hasClass(g[d]))return a.Log.debug(this,"tag comparison for <"+b.tagName.toLowerCase()+"> failed because of different classes"),!1;return!0},changeMarkup:function(c,d,e){var f=d[0].tagName.toLowerCase(),g,h,i,j=this.isRangeObjectWithinMarkup(c,!1,d,e,h),k=this.isRangeObjectWithinMarkup(c,!0,d,e,h),l,m,n,o,p;if(this.replacingElements[f])i=c,c=new this.SelectionRange(c),a.activeEditable?g=a.activeEditable.obj.get(0):g=b("body"),c.update(g),d.isReplacingElement=!0;else if(c.isCollapsed())return a.Log.debug(this,"early returning from applying markup because nothing is currently selected"),!1;a.activeEditable?h=a.activeEditable.obj[0]:h=b("body"),!d.isReplacingElement&&c.startOffset===0&&(n=this.getTextNodeSibling(!1,c.commonAncestorContainer.parentNode,c.startContainer))&&(o=this.isRangeObjectWithinMarkup({startContainer:n,startOffset:0},!1,d,e,h)),!d.isReplacingElement&&c.endOffset===c.endContainer.length&&(l=this.getTextNodeSibling(!0,c.commonAncestorContainer.parentNode,c.endContainer))&&(m=this.isRangeObjectWithinMarkup({startContainer:l,startOffset:0},!1,d,e,h));if(!d.isReplacingElement&&j&&!k)a.Log.info(this,"markup 2 non-markup"),this.prepareForRemoval(c.getSelectionTree(),d,e),b(j).addClass("preparedForRemoval"),this.insertCroppedMarkups(j,c,!1,e);else if(!d.isReplacingElement&&j&&k)a.Log.info(this,"markup 2 markup"),this.prepareForRemoval(c.getSelectionTree(),d,e),this.splitRelevantMarkupObject(j,k,c,e);else if(!d.isReplacingElement&&(!j&&k||m||o))a.Log.info(this,"non-markup 2 markup OR with next2markup"),o&&m?(p=new a.Selection.SelectionRange(c),p.startContainer=b(o[o.length-1]).textNodes()[0],p.startOffset=0,p.endContainer=b(m[m.length-1]).textNodes().last()[0],p.endOffset=p.endContainer.length,p.update(),this.applyMarkup(p.getSelectionTree(),c,d,e),a.Log.info(this,"double extending previous markup(previous and after selection), actually wrapping it ...")):o&&!m&&!k?(this.extendExistingMarkupWithSelection(o,c,!1,e),a.Log.info(this,"extending previous markup")):o&&!m&&k?(p=new a.Selection.SelectionRange(c),p.startContainer=b(o[o.length-1]).textNodes()[0],p.startOffset=0,p.endContainer=b(k[k.length-1]).textNodes().last()[0],p.endOffset=p.endContainer.length,p.update(),this.applyMarkup(p.getSelectionTree(),c,d,e),a.Log.info(this,"double extending previous markup(previous and relevant at the end), actually wrapping it ...")):!o&&m?(this.extendExistingMarkupWithSelection(m,c,!0,e),a.Log.info(this,"extending following markup backwards")):this.extendExistingMarkupWithSelection(k,c,!0,e);else if(d.isReplacingElement||!j&&!k&&!o&&!m)a.Log.info(this,"non-markup 2 non-markup"),this.applyMarkup(c.getSelectionTree(),c,d,e,{setRangeObject2NewMarkup:!0});b(".preparedForRemoval").zap(),c.update(),d.isReplacingElement?i.select():c.select()},areMarkupObjectsAsLongAsRangeObject:function(a,c,d){var e,f,g,h,i;if(d.startOffset!==0)return!1;for(e=0,i=a.length;e<i;e++){f=b(a[e]);if(f.textNodes().first()[0]!==d.startContainer)return!1}for(e=0,h=c.length;e<h;e++){f=b(c[e]),g=f.textNodes().last()[0];if(g!==d.endContainer||g.length!=d.endOffset)return!1}return!0},splitRelevantMarkupObject:function(a,c,d,e){b(a).addClass("preparedForRemoval"),b(c).addClass("preparedForRemoval");if(this.areMarkupObjectsAsLongAsRangeObject(a,c,d))return!0;var f=this.intersectRelevantMarkupObjects(a,c);return f?(this.insertCroppedMarkups([f],d,!1,e),this.insertCroppedMarkups([f],d,!0,e)):(this.insertCroppedMarkups(a,d,!1,e),this.insertCroppedMarkups(c,d,!0,e)),!0},intersectRelevantMarkupObjects:function(a,b){var c=!1,d,e,f,g,h,i;if(!a||!b)return c;h=a.length,i=b.length;for(d=0;d<h;d++){e=a[d];for(f=0;f<i;f++)g=b[f],e===g&&(c=e)}return c},extendExistingMarkupWithSelection:function(a,c,d,e){var f,g,h,i,j,k,l,m;d||(f=!0),d&&(g=!0),h=[];for(i=0,j=a.length;i<j;i++)h[i]=new this.SelectionRange,k=a[i],g&&!f&&(h[i].startContainer=c.startContainer,h[i].startOffset=c.startOffset,l=b(k).textNodes(!0),m=l.length-1,h[i].endContainer=l[m],h[i].endOffset=l[m].length,h[i].update(),this.applyMarkup(h[i].getSelectionTree(),c,this.getClonedMarkup4Wrapping(k),e,{setRangeObject2NewMarkup:!0})),!g&&f&&(l=b(k).textNodes(!0),h[i].startContainer=l[0],h[i].startOffset=0,h[i].endContainer=c.endContainer,h[i].endOffset=c.endOffset,h[i].update(),this.applyMarkup(h[i].getSelectionTree(),c,this.getClonedMarkup4Wrapping(k),e,{setRangeObject2NewMarkup:!0}));return!0},getClonedMarkup4Wrapping:function(a){var c=b(a).clone().removeClass("preparedForRemoval").empty();return c.attr("class").length===0&&c.removeAttr("class"),c},insertCroppedMarkups:function(a,c,d,e){var f,g,h,i,j,k,l;d?g=!0:f=!0,i=[];for(j=0;j<a.length;j++){i[j]=new this.SelectionRange,k=a[j];if(f&&!g){l=b(k).textNodes(!0),i[j].startContainer=l[0],i[j].startOffset=0;if(i[j].startContainer===c.startContainer&&i[j].startOffset===c.startOffset)continue;c.startOffset===0?(i[j].endContainer=this.getTextNodeSibling(!1,k,c.startContainer),i[j].endOffset=i[j].endContainer.length):(i[j].endContainer=c.startContainer,i[j].endOffset=c.startOffset),i[j].update(),this.applyMarkup(i[j].getSelectionTree(),c,this.getClonedMarkup4Wrapping(k),e,{setRangeObject2NextSibling:!0})}!f&&g&&(i[j].startContainer=c.endContainer,i[j].startOffset=c.endOffset,h=b(k).textNodes(!0),i[j].endContainer=h[h.length-1],i[j].endOffset=h[h.length-1].length,i[j].update(),this.applyMarkup(i[j].getSelectionTree(),c,this.getClonedMarkup4Wrapping(k),e,{setRangeObject2PreviousSibling:!0}))}return!0},changeMarkupOnSelection:function(a){this.changeMarkup(this.getRangeObject(),a,this.getStandardTagComparator(a)),f.Utils.Dom.doCleanup({merge:!0},this.rangeObject),this.rangeObject.update(),this.rangeObject.select()},applyMarkup:function(b,c,d,e,f){var g,h,i,j;f=f?f:{},this.prepareForRemoval(b,d,e),g=this.optimizeSelectionTree4Markup(b,d,e),j=!0;for(h=0;h<g.length;h++)i=g[h],i.wrappable?this.wrapMarkupAroundSelectionTree(i.elements,c,d,e,f):(a.Log.debug(this,"dive further into non-wrappable object"),this.applyMarkup(i.element.children,c,d,e,f))},getMarkupType:function(c){var d=b(c)[0].nodeName.toLowerCase();c.outerHtml&&a.Log.debug(this,"Node name detected: "+d+" for: "+c.outerHtml());if(d=="#text")return"textNode";if(this.replacingElements[d])return"sectionOrGroupingContent";if(this.tagHierarchy[d])return"textLevelSemantics";a.Log.warn(this,"unknown markup passed to this.getMarkupType(...): "+c.outerHtml())},getStandardTagComparator:function(a){var b=this,c;switch(this.getMarkupType(a)){case"textNode":c=function(a,b){return!1};break;case"sectionOrGroupingContent":c=function(a,c){return b.standardSectionsAndGroupingContentComparator(a,c)};break;case"textLevelSemantics":default:c=function(a,c){return b.standardTextLevelSemanticsComparator(a,c)}}return c},prepareForRemoval:function(c,d,e){var f=this,g,h;typeof e!="undefined"&&typeof e!="function"&&a.Log.error(this,"parameter tagComparator is not a function"),typeof e=="undefined"&&(e=this.getStandardTagComparator(d));for(g=0;g<c.length;g++)h=c[g],h.domobj&&(h.selection=="full"||h.selection=="partial"&&d.isReplacingElement)&&h.domobj.nodeType===1&&e(h.domobj,d)&&(a.Log.debug(this,"Marking for removal: "+h.domobj.nodeName),b(h.domobj).addClass("preparedForRemoval")),h.selection!="none"&&h.children.length>0&&this.prepareForRemoval(h.children,d,e)},wrapMarkupAroundSelectionTree:function(c,d,e,f,g){var h=[],i=-1,j=!0,k="",l="",m,n,o,p,q,r,s;a.Log.debug(this,"The formatting <"+e[0].tagName+"> will be wrapped around the selection");for(q=0;q<c.length;q++){r=c[q];if(r.domobj&&!this.canTag1WrapTag2(r.domobj.parentNode.tagName.toLowerCase(),e[0].tagName.toLowerCase())){a.Log.info(this,"Skipping the wrapping of <"+e[0].tagName.toLowerCase()+"> because this tag is not allowed inside <"+r.domobj.parentNode.tagName.toLowerCase()+">");continue}if(r.domobj&&r.domobj.nodeType===3&&b.trim(r.domobj.nodeValue).length===0)continue;if(r.domobj&&r.selection=="partial"&&!e.isReplacingElement)if(r.startOffset!==undefined&&r.endOffset===undefined)i++,k+=r.domobj.data.substr(0,r.startOffset),r.domobj.data=r.domobj.data.substr(r.startOffset,r.domobj.data.length-r.startOffset),h[i]=r.domobj;else if(r.endOffset!==undefined&&r.startOffset===undefined)i++,l+=r.domobj.data.substr(r.endOffset,r.domobj.data.length-r.endOffset),r.domobj.data=r.domobj.data.substr(0,r.endOffset),h[i]=r.domobj;else if(r.endOffset!==undefined&&r.startOffset!==undefined){if(r.startOffset==r.endOffset){a.Log.debug(this,"skipping empty selection");continue}i++,k+=r.domobj.data.substr(0,r.startOffset),s=r.domobj.data.substr(r.startOffset,r.endOffset-r.startOffset),l+=r.domobj.data.substr(r.endOffset,r.domobj.data.length-r.endOffset),r.domobj.data=s,h[i]=r.domobj}else a.Log.debug(this,"diving into object"),this.applyMarkup(r.children,d,e,f,g);r.domobj&&(r.selection=="full"||r.selection=="partial"&&e.isReplacingElement)&&(i++,h[i]=r.domobj)}h.length>0&&(h=b(h),b.each(h,function(a,c){b.browser.msie&&c.nodeType==3&&!c.nextSibling&&!c.previousSibling&&c.parentNode&&c.parentNode.nodeName.toLowerCase()=="li"&&(c.data=b.trim(c.data))}),p=h.wrapAll(e).parent(),p.before(k).after(l),g.setRangeObject2NewMarkup&&(o=h.textNodes(),o.index(d.startContainer)!=-1&&(d.startOffset=0),o.index(d.endContainer)!=-1&&(d.endOffset=d.endContainer.length),j=!0),g.setRangeObject2NextSibling&&(m=!0,n=p.textNodes(!0).last()[0],h.index(d.startContainer)!=-1&&(d.startContainer=this.getTextNodeSibling(m,p.parent(),n),d.startOffset=0),h.index(d.endContainer)!=-1&&(d.endContainer=this.getTextNodeSibling(m,p.parent(),n),d.endOffset=d.endOffset-n.length)),g.setRangeObject2PreviousSibling&&(m=!1,n=p.textNodes(!0).first()[0],h.index(d.startContainer)!=-1&&(d.startContainer=this.getTextNodeSibling(m,p.parent(),n),d.startOffset=0),h.index(d.endContainer)!=-1&&(d.endContainer=this.getTextNodeSibling(m,p.parent(),n),d.endOffset=d.endContainer.length)))},getTextNodeSibling:function(a,c,d){var e=b(c).textNodes(!0),f,g;return g=e.index(d),g==-1?!1:(f=g+(a?1:-1),e[f]?e[f]:!1)},optimizeSelectionTree4Markup:function(a,c,d){var e=[],f=0,g=0,h=this,i,j,k,l;typeof d=="undefined"&&(d=function(a,b){return h.standardTextLevelSemanticsComparator(b)});for(i=0;i<a.length;i++)if(a[i].domobj&&a[i].selection!="none")if(c.isReplacingElement&&d(c[0],b(a[i].domobj)))e[f]!==undefined&&f++,e[f]={},e[f].wrappable=!0,e[f].elements=[],e[f].elements[g]=a[i],f++;else if(this.canMarkupBeApplied2ElementAsWhole([a[i]],c)){e[f]===undefined&&(e[f]={},e[f].wrappable=!0,e[f].elements=[]);if(c.isReplacingElement){l=i;for(j=i-1;j>=0;j--){if(!this.canMarkupBeApplied2ElementAsWhole([a[j]],c)||!this.isMarkupAllowedToStealSelectionTreeElement(a[j],c))break;l=j}k=i;for(j=i+1;j<a.length;j++){if(!this.canMarkupBeApplied2ElementAsWhole([a[j]],c)||!this.isMarkupAllowedToStealSelectionTreeElement(a[j],c))break;k=j}g=0;for(j=l;j<=k;j++)e[f].elements[g]=a[j],e[f].elements[g].selection="full",g++;g=0}else e[f].elements[g]=a[i],g++}else e[f]!==undefined&&f++,e[f]={},e[f].wrappable=!1,e[f].element=a[i],g=0,f++;return e},isMarkupAllowedToStealSelectionTreeElement:function(a,b){if(!a.domobj)return!1;var c=a.domobj.nodeName.toLowerCase(),d;return c=c=="#text"?"textNode":c,d=b[0].nodeName.toLowerCase(),this.allowedToStealElements[d]?this.allowedToStealElements[d].indexOf(c)==-1?!1:!0:!1},canMarkupBeApplied2ElementAsWhole:function(a,b){var c,d,e,f;b.jquery&&(c=b[0].tagName),b.tagName&&(c=b.tagName),f=!0;for(d=0;d<a.length;d++){e=a[d];if(e.domobj&&(e.selection!="none"||b.isReplacingElement)){if(!this.canTag1WrapTag2(c,e.domobj.nodeName))return!1;if(e.children.length>0&&!this.canMarkupBeApplied2ElementAsWhole(e.children,b))return!1}}return f},canTag1WrapTag2:function(a,b){a=a=="#text"?"textNode":a.toLowerCase(),b=b=="#text"?"textNode":b.toLowerCase();if(!this.tagHierarchy[a])return!0;if(!this.tagHierarchy[b])return!0;var c=this.tagHierarchy[a],d=c.indexOf(b)!=-1?!0:!1;return d},mayInsertTag:function(b){if(typeof this.rangeObject.unmodifiableMarkupAtStart=="object"){for(var c=0;c<this.rangeObject.unmodifiableMarkupAtStart.length;++c)if(!this.canTag1WrapTag2(this.rangeObject.unmodifiableMarkupAtStart[c].nodeName,b))return!1;return!0}return a.Log.warn(this,"Unable to determine whether tag "+b+" may be inserted"),!0},toString:function(){return"Aloha.Selection"},SelectionRange:f.Utils.RangeObject.extend({_constructor:function(a){this._super(a),a&&(a.commonAncestorContainer&&(this.commonAncestorContainer=a.commonAncestorContainer),a.selectionTree&&(this.selectionTree=a.selectionTree),a.limitObject&&(this.limitObject=a.limitObject),a.markupEffectiveAtStart&&(this.markupEffectiveAtStart=a.markupEffectiveAtStart),a.unmodifiableMarkupAtStart&&(this.unmodifiableMarkupAtStart=a.unmodifiableMarkupAtStart),a.splitObject&&(this.splitObject=a.splitObject))},commonAncestorContainer:undefined,selectionTree:undefined,markupEffectiveAtStart:[],unmodifiableMarkupAtStart:[],limitObject:undefined,splitObject:undefined,select:function(){this._super(),a.Selection.updateSelection()},update:function(a){this.updatelimitObject(),this.updateMarkupEffectiveAtStart(),this.updateCommonAncestorContainer(a),this.selectionTree=undefined},getSelectionTree:function(){return this.selectionTree||(this.selectionTree=a.Selection.getSelectionTree(this)),this.selectionTree},getSelectedSiblings:function(a){var b=this.getSelectionTree();return this.recursionGetSelectedSiblings(a,b)},recursionGetSelectedSiblings:function(a,b){var c=!1,d=!1,e;for(e=0;e<b.length;++e)if(b[e].domobj===a)d=!0,c=[];else if(!d&&b[e].children){c=this.recursionGetSelectedSiblings(a,b[e].children);if(c!==!1)break}else if(d&&b[e].domobj&&b[e].selection!="collapsed"&&b[e].selection!="none")c.push(b[e].domobj);else if(d&&b[e].selection=="none")break;return c},updateMarkupEffectiveAtStart:function(){this.markupEffectiveAtStart=[],this.unmodifiableMarkupAtStart=[];var a=this.getStartContainerParents(),b=!1,c,d,e;for(d=0;d<a.length;d++)e=a[d],!b&&e!==this.limitObject?(this.markupEffectiveAtStart[d]=e,!c&&f.Utils.Dom.isSplitObject(e)&&(c=!0,this.splitObject=e)):(b=!0,this.unmodifiableMarkupAtStart.push(e));c||(this.splitObject=!1);return},updatelimitObject:function(){if(a.editables&&a.editables.length>0){var c=this.getStartContainerParents(),d=a.editables,e,f,g,h;for(e=0;e<c.length;e++){f=c[e];for(g=0;g<d.length;g++){h=d[g].obj[0];if(f===h)return this.limitObject=f,!0}}}return this.limitObject=b("body"),!0},toString:function(a){return a?"Aloha.Selection.SelectionRange {start ["+this.startContainer.nodeValue+"] offset "+this.startOffset+", end ["+this.endContainer.nodeValue+"] offset "+this.endOffset+"}":"Aloha.Selection.SelectionRange"}})}),j=d.extend({_constructor:function(a){this._nativeSelection=a,this.ranges=[],this.preventChange=!1},anchorNode:null,anchorOffset:0,focusNode:null,focusOffset:0,isCollapsed:!1,rangeCount:0,collapse:function(a,b){this._nativeSelection.collapse(a,b)},collapseToStart:function(){throw"NOT_IMPLEMENTED"},extend:function(a,b){},modify:function(a,b,c){},collapseToEnd:function(){throw"NOT_IMPLEMENTED"},selectAllChildren:function(a){throw"NOT_IMPLEMENTED"},deleteFromDocument:function(){throw"NOT_IMPLEMENTED"},getRangeAt:function(a){return i(this._nativeSelection.getRangeAt(a))},addRange:function(b){this._nativeSelection.addRange(b),this._nativeSelection._ranges[0]=i(b),a.Selection.updateSelection()},removeRange:function(a){this._nativeSelection.removeRange()},removeAllRanges:function(){this._nativeSelection.removeAllRanges()},preventedChange:function(a){},isChangedPrevented:function(){},refresh:function(a){},toString:function(){return"Aloha.Selection"},getRangeCount:function(){return this._nativeSelection.rangeCount}});a.getSelection=function(a){var a=a!==document||a!==window?window:a;return new j(window.rangy.getSelection(a))},a.createRange=function(a){return window.rangy.createRange(a)};var k=new g;return a.Selection=k,k});