/*!
* This file is part of Aloha Editor Project http://aloha-editor.org
* Copyright (c) 2010-2011 Gentics Software GmbH, aloha@gentics.com
* Contributors http://aloha-editor.org/contribution.php 
* Licensed unter the terms of http://www.aloha-editor.org/license.html
*/
/*
* Aloha Editor is free software: you can redistribute it and/or modify
* it under the terms of the GNU Affero General Public License as published by
* the Free Software Foundation, either version 3 of the License, or
* (at your option) any later version.*
*
* Aloha Editor is distributed in the hope that it will be useful,
* but WITHOUT ANY WARRANTY; without even the implied warranty of
* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
* GNU Affero General Public License for more details.
*
* You should have received a copy of the GNU Affero General Public License
* along with this program. If not, see <http://www.gnu.org/licenses/>.
*/
define(["aloha/core","aloha/jquery","aloha/floatingmenu","util/class","util/range","aloha/rangy-core"],function(e,t,n,r,i){function u(e){t.browser.msie&&e.startContainer===e.endContainer&&e.startOffset===e.endOffset&&e.startContainer.nodeType==3&&e.startOffset==e.startContainer.data.length&&e.startContainer.nextSibling&&["OL","UL"].indexOf(e.startContainer.nextSibling.nodeName)!==-1&&(e.startContainer.data[e.startContainer.data.length-1]==" "?e.startOffset=e.endOffset=e.startOffset-1:e.startContainer.data=e.startContainer.data+" ")}function a(e){return u(e),e}var s=window.GENTICS,o=r.extend({_constructor:function(){this.rangeObject={},this.preventSelectionChangedFlag=!1,this.tagHierarchy={textNode:[],abbr:["textNode"],b:["textNode","b","i","em","sup","sub","br","span","img","a","del","ins","u","cite","q","code","abbr","strong"],pre:["textNode","b","i","em","sup","sub","br","span","img","a","del","ins","u","cite","q","code","abbr","code"],blockquote:["textNode","b","i","em","sup","sub","br","span","img","a","del","ins","u","cite","q","code","abbr","p","h1","h2","h3","h4","h5","h6"],ins:["textNode","b","i","em","sup","sub","br","span","img","a","u","p","h1","h2","h3","h4","h5","h6"],ul:["li"],ol:["li"],li:["textNode","b","i","em","sup","sub","br","span","img","ul","ol","h1","h2","h3","h4","h5","h6","del","ins","u","a"],tr:["td","th"],table:["tr"],div:["textNode","b","i","em","sup","sub","br","span","img","ul","ol","table","h1","h2","h3","h4","h5","h6","del","ins","u","p","div","pre","blockquote","a"],h1:["textNode","b","i","em","sup","sub","br","span","img","a","del","ins","u"]},this.tagHierarchy={textNode:this.tagHierarchy.textNode,abbr:this.tagHierarchy.abbr,br:this.tagHierarchy.textNode,img:this.tagHierarchy.textNode,b:this.tagHierarchy.b,strong:this.tagHierarchy.b,code:this.tagHierarchy.b,q:this.tagHierarchy.b,blockquote:this.tagHierarchy.blockquote,cite:this.tagHierarchy.b,i:this.tagHierarchy.b,em:this.tagHierarchy.b,sup:this.tagHierarchy.b,sub:this.tagHierarchy.b,span:this.tagHierarchy.b,del:this.tagHierarchy.del,ins:this.tagHierarchy.ins,u:this.tagHierarchy.b,p:this.tagHierarchy.b,pre:this.tagHierarchy.pre,a:this.tagHierarchy.b,ul:this.tagHierarchy.ul,ol:this.tagHierarchy.ol,li:this.tagHierarchy.li,td:this.tagHierarchy.li,div:this.tagHierarchy.div,h1:this.tagHierarchy.h1,h2:this.tagHierarchy.h1,h3:this.tagHierarchy.h1,h4:this.tagHierarchy.h1,h5:this.tagHierarchy.h1,h6:this.tagHierarchy.h1,table:this.tagHierarchy.table},this.replacingElements={h1:["p","h1","h2","h3","h4","h5","h6","pre","blockquote"]},this.replacingElements={h1:this.replacingElements.h1,h2:this.replacingElements.h1,h3:this.replacingElements.h1,h4:this.replacingElements.h1,h5:this.replacingElements.h1,h6:this.replacingElements.h1,pre:this.replacingElements.h1,p:this.replacingElements.h1,blockquote:this.replacingElements.h1},this.allowedToStealElements={h1:["textNode"]},this.allowedToStealElements={h1:this.allowedToStealElements.h1,h2:this.allowedToStealElements.h1,h3:this.allowedToStealElements.h1,h4:this.allowedToStealElements.h1,h5:this.allowedToStealElements.h1,h6:this.allowedToStealElements.h1,p:this.tagHierarchy.b}},SelectionTree:function(){this.domobj={},this.selection=undefined,this.children=[]},onChange:function(t,n){this.updateSelectionTimeout&&(window.clearTimeout(this.updateSelectionTimeout),this.updateSelectionTimeout=undefined);var r=new e.Selection.SelectionRange(!0);this.updateSelectionTimeout=window.setTimeout(function(){e.Selection._updateSelection(n,r)},5)},preventSelectionChanged:function(){this.preventSelectionChangedFlag=!0},isSelectionChangedPrevented:function(){var e=this.preventSelectionChangedFlag;return this.preventSelectionChangedFlag=!1,e},isSelectionEditable:function(){return this.rangeObject.commonAncestorContainer&&t(this.rangeObject.commonAncestorContainer).contentEditable()},isFloatingMenuVisible:function(){var n=t(e.Selection.rangeObject.commonAncestorContainer).attr("data-aloha-floatingmenu-visible");return n!=="undefined"?n==="true"?!0:!1:!1},updateSelection:function(e){return this._updateSelection(e,null)},_updateSelection:function(r,i){if(r&&r.originalEvent&&r.originalEvent.stopSelectionUpdate===!0)return!1;if(typeof i=="undefined")return!1;this.rangeObject=i||new e.Selection.SelectionRange(!0);if(typeof this.rangeObject!="undefined"&&typeof this.rangeObject.startContainer!="undefined"&&this.rangeObject.endContainer!=="undefined")if(this.rangeObject.startContainer.nodeType===3&&!t(this.rangeObject.startContainer.parentNode).contentEditable()||this.rangeObject.endContainer.nodeType===3&&!t(this.rangeObject.endContainer.parentNode).contentEditable())return e.getSelection().removeAllRanges(),!0;return this.rangeObject.update(),this.isSelectionChangedPrevented()?!0:(r!==undefined&&n.setScope("Aloha.continuoustext"),e.trigger("aloha-selection-changed",[this.rangeObject,r]),!0)},getSelectionTree:function(t){return t?t.commonAncestorContainer?(this.inselection=!1,s.Utils.Dom.doCleanup({merge:!0},t)&&(this.rangeObject.update(),this.rangeObject.select()),this.recursiveGetSelectionTree(t,t.commonAncestorContainer)):(e.Log.error(this,"the rangeObject is missing the commonAncestorContainer"),!1):this.rangeObject.getSelectionTree()},recursiveGetSelectionTree:function(n,r){var i=t(r),s=0,o=this,u=[];return i.contents().each(function(t){var i="none",a=!1,f=!1,l=!1,c,h,p=!1,d=!1,v=!1;n.isCollapsed()&&r===n.startContainer&&n.startOffset==t&&(u[s]=new e.Selection.SelectionTree,u[s].selection="collapsed",u[s].domobj=undefined,o.inselection=!1,l=!0,s++);if(!o.inselection&&!l){var m;try{m=this.nodeType}catch(g){return}switch(m){case 3:this===n.startContainer&&(o.inselection=!0,i=n.startOffset>0?"partial":"full",a=n.startOffset,f=this.length);break;case 1:this===n.startContainer&&n.startOffset===0&&(o.inselection=!0,i="full"),r===n.startContainer&&n.startOffset===t&&(o.inselection=!0,i="full")}}if(o.inselection&&!l){i=="none"&&(i="full");switch(this.nodeType){case 3:this===n.endContainer&&(o.inselection=!1,n.endOffset<this.length&&(i="partial"),a===!1&&(a=0),f=n.endOffset);break;case 1:this===n.endContainer&&n.endOffset===0&&(o.inselection=!1)}r===n.endContainer&&n.endOffset<=t&&(o.inselection=!1,i="none")}u[s]=new e.Selection.SelectionTree,u[s].domobj=this,u[s].selection=i,i=="partial"&&(u[s].startOffset=a,u[s].endOffset=f),u[s].children=o.recursiveGetSelectionTree(n,this),h=u[s].children.length;if(h>0){for(c=0;c<h;++c)switch(u[s].children[c].selection){case"none":p=!0;break;case"full":v=!0;break;case"partial":d=!0}d||v&&p?u[s].selection="partial":v&&!d&&!p&&(u[s].selection="full")}s++}),n.isCollapsed()&&r===n.startContainer&&n.startOffset==r.childNodes.length&&(u[s]=new e.Selection.SelectionTree,u[s].selection="collapsed",u[s].domobj=undefined),u},getRangeObject:function(){return this.rangeObject},isRangeObjectWithinMarkup:function(n,r,i,s,o){var u=r?n.endContainer:n.startContainer,a=this,f=t(u).parents(),l=!1,c=-1;return typeof s!="undefined"&&typeof s!="function"&&e.Log.error(this,"parameter tagComparator is not a function"),typeof s=="undefined"&&(s=function(e,t){return a.standardTextLevelSemanticsComparator(e,t)}),f.length>0&&f.each(function(){if(this===o)return e.Log.debug(a,"reached limit dom obj"),!1;if(s(this,i))return l===!1&&(l=[]),e.Log.debug(a,"reached object equal to markup"),c++,l[c]=this,!0}),l},standardSectionsAndGroupingContentComparator:function(t,n){if(t.nodeType===1){if(n[0].tagName&&e.Selection.replacingElements[t.tagName.toLowerCase()]&&e.Selection.replacingElements[t.tagName.toLowerCase()].indexOf(n[0].tagName.toLowerCase())!=-1)return!0}else e.Log.debug(this,"only element nodes (nodeType == 1) can be compared");return!1},standardTagNameComparator:function(t,n){return t.nodeType===1?t.tagName.toLowerCase()!=n[0].tagName.toLowerCase()?!1:!0:(e.Log.debug(this,"only element nodes (nodeType == 1) can be compared"),!1)},standardTextLevelSemanticsComparator:function(t,n){return t.nodeType===1?t.tagName.toLowerCase()!=n[0].tagName.toLowerCase()?!1:this.standardAttributesComparator(t,n)?!0:!1:(e.Log.debug(this,"only element nodes (nodeType == 1) can be compared"),!1)},standardAttributesComparator:function(t,n){var r,i,s,o,u,a,f,l;t=t.cloneNode(!1);if(t.attributes&&t.attributes.length&&t.attributes.length>0)for(r=0,l=t.attributes.length;r<l;r++)i=t.attributes[r],i.nodeName.toLowerCase()=="class"&&i.nodeValue.length>0&&(s=i.nodeValue,o=s.split(" "));if(n[0].attributes&&n[0].attributes.length&&n[0].attributes.length>0)for(r=0,f=n[0].attributes.length;r<f;r++)i=n[0].attributes[r],i.nodeName.toLowerCase()=="class"&&i.nodeValue.length>0&&(s=i.nodeValue,u=s.split(" "));if(o&&!u||u&&!o)return e.Log.debug(this,"tag comparison for <"+t.tagName.toLowerCase()+"> failed because one element has classes and the other has not"),!1;if(o&&u&&o.length!=u.length)return e.Log.debug(this,"tag comparison for <"+t.tagName.toLowerCase()+"> failed because of a different amount of classes"),!1;if(o&&u&&o.length===u.length&&o.length!==0)for(r=0,a=o.length;r<a;r++)if(!n.hasClass(o[r]))return e.Log.debug(this,"tag comparison for <"+t.tagName.toLowerCase()+"> failed because of different classes"),!1;return!0},changeMarkup:function(n,r,i){var s=r[0].tagName.toLowerCase(),o,u,a,f=this.isRangeObjectWithinMarkup(n,!1,r,i,u),l=this.isRangeObjectWithinMarkup(n,!0,r,i,u),c,h,p,d,v;if(this.replacingElements[s])a=n,n=new this.SelectionRange(n),e.activeEditable?o=e.activeEditable.obj.get(0):o=t("body"),n.update(o),r.isReplacingElement=!0;else if(n.isCollapsed())return e.Log.debug(this,"early returning from applying markup because nothing is currently selected"),!1;e.activeEditable?u=e.activeEditable.obj[0]:u=t("body"),!r.isReplacingElement&&n.startOffset===0&&(p=this.getTextNodeSibling(!1,n.commonAncestorContainer.parentNode,n.startContainer))&&(d=this.isRangeObjectWithinMarkup({startContainer:p,startOffset:0},!1,r,i,u)),!r.isReplacingElement&&n.endOffset===n.endContainer.length&&(c=this.getTextNodeSibling(!0,n.commonAncestorContainer.parentNode,n.endContainer))&&(h=this.isRangeObjectWithinMarkup({startContainer:c,startOffset:0},!1,r,i,u));if(!r.isReplacingElement&&f&&!l)e.Log.info(this,"markup 2 non-markup"),this.prepareForRemoval(n.getSelectionTree(),r,i),t(f).addClass("preparedForRemoval"),this.insertCroppedMarkups(f,n,!1,i);else if(!r.isReplacingElement&&f&&l)e.Log.info(this,"markup 2 markup"),this.prepareForRemoval(n.getSelectionTree(),r,i),this.splitRelevantMarkupObject(f,l,n,i);else if(!r.isReplacingElement&&(!f&&l||h||d))e.Log.info(this,"non-markup 2 markup OR with next2markup"),d&&h?(v=new e.Selection.SelectionRange(n),v.startContainer=t(d[d.length-1]).textNodes()[0],v.startOffset=0,v.endContainer=t(h[h.length-1]).textNodes().last()[0],v.endOffset=v.endContainer.length,v.update(),this.applyMarkup(v.getSelectionTree(),n,r,i),e.Log.info(this,"double extending previous markup(previous and after selection), actually wrapping it ...")):d&&!h&&!l?(this.extendExistingMarkupWithSelection(d,n,!1,i),e.Log.info(this,"extending previous markup")):d&&!h&&l?(v=new e.Selection.SelectionRange(n),v.startContainer=t(d[d.length-1]).textNodes()[0],v.startOffset=0,v.endContainer=t(l[l.length-1]).textNodes().last()[0],v.endOffset=v.endContainer.length,v.update(),this.applyMarkup(v.getSelectionTree(),n,r,i),e.Log.info(this,"double extending previous markup(previous and relevant at the end), actually wrapping it ...")):!d&&h?(this.extendExistingMarkupWithSelection(h,n,!0,i),e.Log.info(this,"extending following markup backwards")):this.extendExistingMarkupWithSelection(l,n,!0,i);else if(r.isReplacingElement||!f&&!l&&!d&&!h)e.Log.info(this,"non-markup 2 non-markup"),this.applyMarkup(n.getSelectionTree(),n,r,i,{setRangeObject2NewMarkup:!0});t(".preparedForRemoval").zap(),n.update(),r.isReplacingElement?a.select():n.select()},areMarkupObjectsAsLongAsRangeObject:function(e,n,r){var i,s,o,u,a;if(r.startOffset!==0)return!1;for(i=0,a=e.length;i<a;i++){s=t(e[i]);if(s.textNodes().first()[0]!==r.startContainer)return!1}for(i=0,u=n.length;i<u;i++){s=t(n[i]),o=s.textNodes().last()[0];if(o!==r.endContainer||o.length!=r.endOffset)return!1}return!0},splitRelevantMarkupObject:function(e,n,r,i){t(e).addClass("preparedForRemoval"),t(n).addClass("preparedForRemoval");if(this.areMarkupObjectsAsLongAsRangeObject(e,n,r))return!0;var s=this.intersectRelevantMarkupObjects(e,n);return s?(this.insertCroppedMarkups([s],r,!1,i),this.insertCroppedMarkups([s],r,!0,i)):(this.insertCroppedMarkups(e,r,!1,i),this.insertCroppedMarkups(n,r,!0,i)),!0},intersectRelevantMarkupObjects:function(e,t){var n=!1,r,i,s,o,u,a;if(!e||!t)return n;u=e.length,a=t.length;for(r=0;r<u;r++){i=e[r];for(s=0;s<a;s++)o=t[s],i===o&&(n=i)}return n},extendExistingMarkupWithSelection:function(e,n,r,i){var s,o,u,a,f,l,c,h;r||(s=!0),r&&(o=!0),u=[];for(a=0,f=e.length;a<f;a++)u[a]=new this.SelectionRange,l=e[a],o&&!s&&(u[a].startContainer=n.startContainer,u[a].startOffset=n.startOffset,c=t(l).textNodes(!0),h=c.length-1,u[a].endContainer=c[h],u[a].endOffset=c[h].length,u[a].update(),this.applyMarkup(u[a].getSelectionTree(),n,this.getClonedMarkup4Wrapping(l),i,{setRangeObject2NewMarkup:!0})),!o&&s&&(c=t(l).textNodes(!0),u[a].startContainer=c[0],u[a].startOffset=0,u[a].endContainer=n.endContainer,u[a].endOffset=n.endOffset,u[a].update(),this.applyMarkup(u[a].getSelectionTree(),n,this.getClonedMarkup4Wrapping(l),i,{setRangeObject2NewMarkup:!0}));return!0},getClonedMarkup4Wrapping:function(e){var n=t(e).clone().removeClass("preparedForRemoval").empty();return n.attr("class").length===0&&n.removeAttr("class"),n},insertCroppedMarkups:function(e,n,r,i){var s,o,u,a,f,l,c;r?o=!0:s=!0,a=[];for(f=0;f<e.length;f++){a[f]=new this.SelectionRange,l=e[f];if(s&&!o){c=t(l).textNodes(!0),a[f].startContainer=c[0],a[f].startOffset=0;if(a[f].startContainer===n.startContainer&&a[f].startOffset===n.startOffset)continue;n.startOffset===0?(a[f].endContainer=this.getTextNodeSibling(!1,l,n.startContainer),a[f].endOffset=a[f].endContainer.length):(a[f].endContainer=n.startContainer,a[f].endOffset=n.startOffset),a[f].update(),this.applyMarkup(a[f].getSelectionTree(),n,this.getClonedMarkup4Wrapping(l),i,{setRangeObject2NextSibling:!0})}!s&&o&&(a[f].startContainer=n.endContainer,a[f].startOffset=n.endOffset,u=t(l).textNodes(!0),a[f].endContainer=u[u.length-1],a[f].endOffset=u[u.length-1].length,a[f].update(),this.applyMarkup(a[f].getSelectionTree(),n,this.getClonedMarkup4Wrapping(l),i,{setRangeObject2PreviousSibling:!0}))}return!0},changeMarkupOnSelection:function(e){this.changeMarkup(this.getRangeObject(),e,this.getStandardTagComparator(e)),s.Utils.Dom.doCleanup({merge:!0},this.rangeObject),this.rangeObject.update(),this.rangeObject.select()},applyMarkup:function(t,n,r,i,s){var o,u,a,f;s=s?s:{},this.prepareForRemoval(t,r,i),o=this.optimizeSelectionTree4Markup(t,r,i),f=!0;for(u=0;u<o.length;u++)a=o[u],a.wrappable?this.wrapMarkupAroundSelectionTree(a.elements,n,r,i,s):(e.Log.debug(this,"dive further into non-wrappable object"),this.applyMarkup(a.element.children,n,r,i,s))},getMarkupType:function(n){var r=t(n)[0].nodeName.toLowerCase();n.outerHtml&&e.Log.debug(this,"Node name detected: "+r+" for: "+n.outerHtml());if(r=="#text")return"textNode";if(this.replacingElements[r])return"sectionOrGroupingContent";if(this.tagHierarchy[r])return"textLevelSemantics";e.Log.warn(this,"unknown markup passed to this.getMarkupType(...): "+n.outerHtml())},getStandardTagComparator:function(e){var t=this,n;switch(this.getMarkupType(e)){case"textNode":n=function(e,t){return!1};break;case"sectionOrGroupingContent":n=function(e,n){return t.standardSectionsAndGroupingContentComparator(e,n)};break;case"textLevelSemantics":default:n=function(e,n){return t.standardTextLevelSemanticsComparator(e,n)}}return n},prepareForRemoval:function(n,r,i){var s=this,o,u;typeof i!="undefined"&&typeof i!="function"&&e.Log.error(this,"parameter tagComparator is not a function"),typeof i=="undefined"&&(i=this.getStandardTagComparator(r));for(o=0;o<n.length;o++)u=n[o],u.domobj&&(u.selection=="full"||u.selection=="partial"&&r.isReplacingElement)&&u.domobj.nodeType===1&&i(u.domobj,r)&&(e.Log.debug(this,"Marking for removal: "+u.domobj.nodeName),t(u.domobj).addClass("preparedForRemoval")),u.selection!="none"&&u.children.length>0&&this.prepareForRemoval(u.children,r,i)},wrapMarkupAroundSelectionTree:function(n,r,i,s,o){var u=[],a=-1,f=!0,l="",c="",h,p,d,v,m,g,y;e.Log.debug(this,"The formatting <"+i[0].tagName+"> will be wrapped around the selection");for(m=0;m<n.length;m++){g=n[m];if(g.domobj&&!this.canTag1WrapTag2(g.domobj.parentNode.tagName.toLowerCase(),i[0].tagName.toLowerCase())){e.Log.info(this,"Skipping the wrapping of <"+i[0].tagName.toLowerCase()+"> because this tag is not allowed inside <"+g.domobj.parentNode.tagName.toLowerCase()+">");continue}if(g.domobj&&g.domobj.nodeType===3&&t.trim(g.domobj.nodeValue).length===0)continue;if(g.domobj&&g.selection=="partial"&&!i.isReplacingElement)if(g.startOffset!==undefined&&g.endOffset===undefined)a++,l+=g.domobj.data.substr(0,g.startOffset),g.domobj.data=g.domobj.data.substr(g.startOffset,g.domobj.data.length-g.startOffset),u[a]=g.domobj;else if(g.endOffset!==undefined&&g.startOffset===undefined)a++,c+=g.domobj.data.substr(g.endOffset,g.domobj.data.length-g.endOffset),g.domobj.data=g.domobj.data.substr(0,g.endOffset),u[a]=g.domobj;else if(g.endOffset!==undefined&&g.startOffset!==undefined){if(g.startOffset==g.endOffset){e.Log.debug(this,"skipping empty selection");continue}a++,l+=g.domobj.data.substr(0,g.startOffset),y=g.domobj.data.substr(g.startOffset,g.endOffset-g.startOffset),c+=g.domobj.data.substr(g.endOffset,g.domobj.data.length-g.endOffset),g.domobj.data=y,u[a]=g.domobj}else e.Log.debug(this,"diving into object"),this.applyMarkup(g.children,r,i,s,o);g.domobj&&(g.selection=="full"||g.selection=="partial"&&i.isReplacingElement)&&(a++,u[a]=g.domobj)}u.length>0&&(u=t(u),t.each(u,function(e,n){t.browser.msie&&n.nodeType==3&&!n.nextSibling&&!n.previousSibling&&n.parentNode&&n.parentNode.nodeName.toLowerCase()=="li"&&(n.data=t.trim(n.data))}),v=u.wrapAll(i).parent(),v.before(l).after(c),o.setRangeObject2NewMarkup&&(d=u.textNodes(),d.index(r.startContainer)!=-1&&(r.startOffset=0),d.index(r.endContainer)!=-1&&(r.endOffset=r.endContainer.length),f=!0),o.setRangeObject2NextSibling&&(h=!0,p=v.textNodes(!0).last()[0],u.index(r.startContainer)!=-1&&(r.startContainer=this.getTextNodeSibling(h,v.parent(),p),r.startOffset=0),u.index(r.endContainer)!=-1&&(r.endContainer=this.getTextNodeSibling(h,v.parent(),p),r.endOffset=r.endOffset-p.length)),o.setRangeObject2PreviousSibling&&(h=!1,p=v.textNodes(!0).first()[0],u.index(r.startContainer)!=-1&&(r.startContainer=this.getTextNodeSibling(h,v.parent(),p),r.startOffset=0),u.index(r.endContainer)!=-1&&(r.endContainer=this.getTextNodeSibling(h,v.parent(),p),r.endOffset=r.endContainer.length)))},getTextNodeSibling:function(e,n,r){var i=t(n).textNodes(!0),s,o;return o=i.index(r),o==-1?!1:(s=o+(e?1:-1),i[s]?i[s]:!1)},optimizeSelectionTree4Markup:function(e,n,r){var i=[],s=0,o=0,u=this,a,f,l,c;typeof r=="undefined"&&(r=function(e,t){return u.standardTextLevelSemanticsComparator(t)});for(a=0;a<e.length;a++)if(e[a].domobj&&e[a].selection!="none")if(n.isReplacingElement&&r(n[0],t(e[a].domobj)))i[s]!==undefined&&s++,i[s]={},i[s].wrappable=!0,i[s].elements=[],i[s].elements[o]=e[a],s++;else if(this.canMarkupBeApplied2ElementAsWhole([e[a]],n)){i[s]===undefined&&(i[s]={},i[s].wrappable=!0,i[s].elements=[]);if(n.isReplacingElement){c=a;for(f=a-1;f>=0;f--){if(!this.canMarkupBeApplied2ElementAsWhole([e[f]],n)||!this.isMarkupAllowedToStealSelectionTreeElement(e[f],n))break;c=f}l=a;for(f=a+1;f<e.length;f++){if(!this.canMarkupBeApplied2ElementAsWhole([e[f]],n)||!this.isMarkupAllowedToStealSelectionTreeElement(e[f],n))break;l=f}o=0;for(f=c;f<=l;f++)i[s].elements[o]=e[f],i[s].elements[o].selection="full",o++;o=0}else i[s].elements[o]=e[a],o++}else i[s]!==undefined&&s++,i[s]={},i[s].wrappable=!1,i[s].element=e[a],o=0,s++;return i},isMarkupAllowedToStealSelectionTreeElement:function(e,t){if(!e.domobj)return!1;var n=e.domobj.nodeName.toLowerCase(),r;return n=n=="#text"?"textNode":n,r=t[0].nodeName.toLowerCase(),this.allowedToStealElements[r]?this.allowedToStealElements[r].indexOf(n)==-1?!1:!0:!1},canMarkupBeApplied2ElementAsWhole:function(e,t){var n,r,i,s;t.jquery&&(n=t[0].tagName),t.tagName&&(n=t.tagName),s=!0;for(r=0;r<e.length;r++){i=e[r];if(i.domobj&&(i.selection!="none"||t.isReplacingElement)){if(!this.canTag1WrapTag2(n,i.domobj.nodeName))return!1;if(i.children.length>0&&!this.canMarkupBeApplied2ElementAsWhole(i.children,t))return!1}}return s},canTag1WrapTag2:function(e,t){e=e=="#text"?"textNode":e.toLowerCase(),t=t=="#text"?"textNode":t.toLowerCase();if(!this.tagHierarchy[e])return!0;if(!this.tagHierarchy[t])return!0;var n=this.tagHierarchy[e],r=n.indexOf(t)!=-1?!0:!1;return r},mayInsertTag:function(t){if(typeof this.rangeObject.unmodifiableMarkupAtStart=="object"){for(var n=0;n<this.rangeObject.unmodifiableMarkupAtStart.length;++n)if(!this.canTag1WrapTag2(this.rangeObject.unmodifiableMarkupAtStart[n].nodeName,t))return!1;return!0}return e.Log.warn(this,"Unable to determine whether tag "+t+" may be inserted"),!0},toString:function(){return"Aloha.Selection"},SelectionRange:s.Utils.RangeObject.extend({_constructor:function(e){this._super(e),e&&(e.commonAncestorContainer&&(this.commonAncestorContainer=e.commonAncestorContainer),e.selectionTree&&(this.selectionTree=e.selectionTree),e.limitObject&&(this.limitObject=e.limitObject),e.markupEffectiveAtStart&&(this.markupEffectiveAtStart=e.markupEffectiveAtStart),e.unmodifiableMarkupAtStart&&(this.unmodifiableMarkupAtStart=e.unmodifiableMarkupAtStart),e.splitObject&&(this.splitObject=e.splitObject))},commonAncestorContainer:undefined,selectionTree:undefined,markupEffectiveAtStart:[],unmodifiableMarkupAtStart:[],limitObject:undefined,splitObject:undefined,select:function(){this._super(),e.Selection.updateSelection()},update:function(e){this.updatelimitObject(),this.updateMarkupEffectiveAtStart(),this.updateCommonAncestorContainer(e),this.selectionTree=undefined},getSelectionTree:function(){return this.selectionTree||(this.selectionTree=e.Selection.getSelectionTree(this)),this.selectionTree},getSelectedSiblings:function(e){var t=this.getSelectionTree();return this.recursionGetSelectedSiblings(e,t)},recursionGetSelectedSiblings:function(e,t){var n=!1,r=!1,i;for(i=0;i<t.length;++i)if(t[i].domobj===e)r=!0,n=[];else if(!r&&t[i].children){n=this.recursionGetSelectedSiblings(e,t[i].children);if(n!==!1)break}else if(r&&t[i].domobj&&t[i].selection!="collapsed"&&t[i].selection!="none")n.push(t[i].domobj);else if(r&&t[i].selection=="none")break;return n},updateMarkupEffectiveAtStart:function(){this.markupEffectiveAtStart=[],this.unmodifiableMarkupAtStart=[];var e=this.getStartContainerParents(),t=!1,n,r,i;for(r=0;r<e.length;r++)i=e[r],!t&&i!==this.limitObject?(this.markupEffectiveAtStart[r]=i,!n&&s.Utils.Dom.isSplitObject(i)&&(n=!0,this.splitObject=i)):(t=!0,this.unmodifiableMarkupAtStart.push(i));n||(this.splitObject=!1);return},updatelimitObject:function(){if(e.editables&&e.editables.length>0){var n=this.getStartContainerParents(),r=e.editables,i,s,o,u;for(i=0;i<n.length;i++){s=n[i];for(o=0;o<r.length;o++){u=r[o].obj[0];if(s===u)return this.limitObject=s,!0}}}return this.limitObject=t("body"),!0},toString:function(e){return e?"Aloha.Selection.SelectionRange {start ["+this.startContainer.nodeValue+"] offset "+this.startOffset+", end ["+this.endContainer.nodeValue+"] offset "+this.endOffset+"}":"Aloha.Selection.SelectionRange"}})}),f=r.extend({_constructor:function(e){this._nativeSelection=e,this.ranges=[],this.preventChange=!1},anchorNode:null,anchorOffset:0,focusNode:null,focusOffset:0,isCollapsed:!1,rangeCount:0,collapse:function(e,t){this._nativeSelection.collapse(e,t)},collapseToStart:function(){throw"NOT_IMPLEMENTED"},extend:function(e,t){},modify:function(e,t,n){},collapseToEnd:function(){throw"NOT_IMPLEMENTED"},selectAllChildren:function(e){throw"NOT_IMPLEMENTED"},deleteFromDocument:function(){throw"NOT_IMPLEMENTED"},getRangeAt:function(e){return a(this._nativeSelection.getRangeAt(e))},addRange:function(t){this._nativeSelection.addRange(t),this._nativeSelection._ranges[0]=a(t),e.Selection.updateSelection()},removeRange:function(e){this._nativeSelection.removeRange()},removeAllRanges:function(){this._nativeSelection.removeAllRanges()},preventedChange:function(e){},isChangedPrevented:function(){},refresh:function(e){},toString:function(){return"Aloha.Selection"},getRangeCount:function(){return this._nativeSelection.rangeCount}});e.getSelection=function(e){var e=e!==document||e!==window?window:e;return new f(window.rangy.getSelection(e))},e.createRange=function(e){return window.rangy.createRange(e)};var l=new o;return e.Selection=l,l});