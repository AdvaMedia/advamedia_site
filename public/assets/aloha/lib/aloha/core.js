/*!
* This file is part of Aloha Editor Project http://aloha-editor.org
* Copyright Â© 2010-2011 Gentics Software GmbH, aloha@gentics.com
* Contributors http://aloha-editor.org/contribution.php 
* Licensed unter the terms of http://www.aloha-editor.org/license.html
*/
/*
* Aloha Editor is free software: you can redistribute it and/or modify
* it under the terms of the GNU Affero General Public License as published by
* the Free Software Foundation, either version 3 of the License, or
* (at your option) any later version.*
*
* Aloha Editor is distributed in the hope that it will be useful,
* but WITHOUT ANY WARRANTY; without even the implied warranty of
* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
* GNU Affero General Public License for more details.
*
* You should have received a copy of the GNU Affero General Public License
* along with this program. If not, see <http://www.gnu.org/licenses/>.
*/
define(["aloha/jquery","aloha/pluginmanager"],function(a,b){Aloha.ready(function(){a(".ext-ie6").removeClass("ext-ie6")});var c={};return a.extend(!0,Aloha,{version:"0.10.0",editables:[],activeEditable:null,settings:{},defaults:{},ui:{},OSName:"Unknown",stage:"loadingAloha",loadedPlugins:[],requirePaths:[],init:function(){Aloha.settings=a.extendObjects(!0,{},Aloha.defaults,Aloha.settings),window.rangy&&window.rangy.init(),Aloha.stage="loadPlugins",Aloha.loadPlugins(function(){Aloha.stage="initAloha",Aloha.initAloha(function(){Aloha.stage="initPlugins",Aloha.initPlugins(function(){Aloha.stage="initGui",Aloha.initGui(function(){Aloha.stage="alohaReady",Aloha.trigger("aloha-ready")})})})})},loadPlugins:function(b){var d=this.getPluginsToBeLoaded();if(d.length){var e={},f=[],g=[],h={};a.each(d,function(b,c){var d,i,j,k="";d=c.split("/"),i=d[0],j=d[1],Aloha.settings.basePath&&(k=Aloha.settings.basePath),Aloha.settings.bundles&&Aloha.settings.bundles[i]?k+=Aloha.settings.bundles[i]:k+="../plugins/"+i,f.push(j),e[j]=k+"/"+j+"/lib",h[j]=k+"/"+j,a.each(["nls","css","vendor","res"],function(){e[j+"/"+this]=k+"/"+j+"/"+this}),g.push(j+"/"+j+"-plugin")}),this.loadedPlugins=f,this.requirePaths=e,require({context:"aloha",paths:e,locale:this.settings.locale||this.defaults.locale||"en"},g,b),c=h}else b()},getPluginsToBeLoaded:function(){var b=a("[data-aloha-plugins]").data("aloha-plugins");if(typeof Aloha.settings.plugins!="undefined"&&typeof Aloha.settings.plugins.load!="undefined"){b=Aloha.settings.plugins.load;if(b instanceof Array)return b}return typeof b=="string"&&b!==""?b.replace(/\s+/g,"").split(","):[]},getLoadedPlugins:function(){return this.loadedPlugins},isPluginLoaded:function(b){var c=!1;return a.each(this.loadedPlugins,function(){b.toString()===this.toString()&&(c=!0)}),c},initAloha:function(b){(a.browser.webkit&&parseFloat(a.browser.version)<532.5||a.browser.mozilla&&parseFloat(a.browser.version)<1.9||a.browser.msie&&a.browser.version<7||a.browser.opera&&a.browser.version<11)&&window.console&&window.console.log&&window.console.log("Your browser is not supported."),a("html").mousedown(function(a){Aloha.activeEditable&&!Aloha.isMessageVisible()&&!Aloha.eventHandled&&(Aloha.activeEditable.blur(),Aloha.activeEditable=null)}).mouseup(function(a){Aloha.eventHandled=!1}),Aloha.settings.base=Aloha.getAlohaUrl(),Aloha.Log.init(),Aloha.settings.errorhandling&&(window.onerror=function(a,b,c){return Aloha.Log.error(Aloha,"Error message: "+a+"\nURL: "+b+"\nLine Number: "+c),!0}),navigator.appVersion.indexOf("Win")!=-1&&(Aloha.OSName="Win"),navigator.appVersion.indexOf("Mac")!=-1&&(Aloha.OSName="Mac"),navigator.appVersion.indexOf("X11")!=-1&&(Aloha.OSName="Unix"),navigator.appVersion.indexOf("Linux")!=-1&&(Aloha.OSName="Linux");try{var c;try{c=document.queryCommandSupported("enableObjectResizing")}catch(d){c=!1,Aloha.Log.log("enableObjectResizing is not supported.")}c&&(document.execCommand("enableObjectResizing",!1,!1),Aloha.Log.log("enableObjectResizing disabled."))}catch(d){Aloha.Log.error(d,"Could not disable enableObjectResizing")}b()},initPlugins:function(a){b.init(function(){a()},this.getLoadedPlugins())},initGui:function(a){Aloha.RepositoryManager.init();for(var b=0,c=Aloha.editables.length;b<c;b++)Aloha.editables[b].ready||Aloha.editables[b].init();a()},activateEditable:function(a){for(var b=0,c=Aloha.editables.length;b<c;b++)Aloha.editables[b]!=a&&Aloha.editables[b].isActive&&Aloha.editables[b].blur();Aloha.activeEditable=a},getActiveEditable:function(){return Aloha.activeEditable},deactivateEditable:function(){if(typeof Aloha.activeEditable=="undefined"||Aloha.activeEditable===null)return;Aloha.activeEditable.blur(),Aloha.activeEditable=null},getEditableById:function(b){a("#"+b).get(0).nodeName.toLowerCase()==="textarea"&&(b+="-aloha");for(var c=0,d=Aloha.editables.length;c<d;c++)if(Aloha.editables[c].getId()==b)return Aloha.editables[c];return null},isEditable:function(a){for(var b=0,c=Aloha.editables.length;b<c;b++)if(Aloha.editables[b].originalObj.get(0)===a)return!0;return!1},log:function(a,b,c){typeof Aloha.Log!="undefined"&&Aloha.Log.log(a,b,c)},registerEditable:function(a){Aloha.editables.push(a)},unregisterEditable:function(a){var b=Aloha.editables.indexOf(a);b!=-1&&Aloha.editables.splice(b,1)},toString:function(){return"Aloha"},isModified:function(){for(var a=0;a<Aloha.editables.length;a++)if(Aloha.editables[a].isModified&&Aloha.editables[a].isModified())return!0;return!1},getAlohaUrl:function(b){var c=a("[data-aloha-plugins]"),d=c.length?c[0].src.replace(/\/?aloha.js$/,""):"";return typeof Aloha.settings.baseUrl=="string"&&(d=Aloha.settings.baseUrl),d},getPluginUrl:function(a){var b;return a&&(b=c[a],b&&(b.match("^(/|http[s]?:).*")||(b=Aloha.getAlohaUrl()+"/"+b))),b}}),Aloha});