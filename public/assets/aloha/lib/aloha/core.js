/*!
* This file is part of Aloha Editor Project http://aloha-editor.org
* Copyright Â© 2010-2011 Gentics Software GmbH, aloha@gentics.com
* Contributors http://aloha-editor.org/contribution.php 
* Licensed unter the terms of http://www.aloha-editor.org/license.html
*/
/*
* Aloha Editor is free software: you can redistribute it and/or modify
* it under the terms of the GNU Affero General Public License as published by
* the Free Software Foundation, either version 3 of the License, or
* (at your option) any later version.*
*
* Aloha Editor is distributed in the hope that it will be useful,
* but WITHOUT ANY WARRANTY; without even the implied warranty of
* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
* GNU Affero General Public License for more details.
*
* You should have received a copy of the GNU Affero General Public License
* along with this program. If not, see <http://www.gnu.org/licenses/>.
*/
define(["aloha/jquery","aloha/pluginmanager"],function(e,t){Aloha.ready(function(){e(".ext-ie6").removeClass("ext-ie6")});var n={};return e.extend(!0,Aloha,{version:"0.10.0",editables:[],activeEditable:null,settings:{},defaults:{},ui:{},OSName:"Unknown",stage:"loadingAloha",loadedPlugins:[],requirePaths:[],init:function(){Aloha.settings=e.extendObjects(!0,{},Aloha.defaults,Aloha.settings),window.rangy&&window.rangy.init(),Aloha.stage="loadPlugins",Aloha.loadPlugins(function(){Aloha.stage="initAloha",Aloha.initAloha(function(){Aloha.stage="initPlugins",Aloha.initPlugins(function(){Aloha.stage="initGui",Aloha.initGui(function(){Aloha.stage="alohaReady",Aloha.trigger("aloha-ready")})})})})},loadPlugins:function(t){var r=this.getPluginsToBeLoaded();if(r.length){var i={},s=[],o=[],u={};e.each(r,function(t,n){var r,a,f,l="";r=n.split("/"),a=r[0],f=r[1],Aloha.settings.basePath&&(l=Aloha.settings.basePath),Aloha.settings.bundles&&Aloha.settings.bundles[a]?l+=Aloha.settings.bundles[a]:l+="../plugins/"+a,s.push(f),i[f]=l+"/"+f+"/lib",u[f]=l+"/"+f,e.each(["nls","css","vendor","res"],function(){i[f+"/"+this]=l+"/"+f+"/"+this}),o.push(f+"/"+f+"-plugin")}),this.loadedPlugins=s,this.requirePaths=i,require({context:"aloha",paths:i,locale:this.settings.locale||this.defaults.locale||"en"},o,t),n=u}else t()},getPluginsToBeLoaded:function(){var t=e("[data-aloha-plugins]").data("aloha-plugins");if(typeof Aloha.settings.plugins!="undefined"&&typeof Aloha.settings.plugins.load!="undefined"){t=Aloha.settings.plugins.load;if(t instanceof Array)return t}return typeof t=="string"&&t!==""?t.replace(/\s+/g,"").split(","):[]},getLoadedPlugins:function(){return this.loadedPlugins},isPluginLoaded:function(t){var n=!1;return e.each(this.loadedPlugins,function(){t.toString()===this.toString()&&(n=!0)}),n},initAloha:function(t){(e.browser.webkit&&parseFloat(e.browser.version)<532.5||e.browser.mozilla&&parseFloat(e.browser.version)<1.9||e.browser.msie&&e.browser.version<7||e.browser.opera&&e.browser.version<11)&&window.console&&window.console.log&&window.console.log("Your browser is not supported."),e("html").mousedown(function(e){Aloha.activeEditable&&!Aloha.isMessageVisible()&&!Aloha.eventHandled&&(Aloha.activeEditable.blur(),Aloha.activeEditable=null)}).mouseup(function(e){Aloha.eventHandled=!1}),Aloha.settings.base=Aloha.getAlohaUrl(),Aloha.Log.init(),Aloha.settings.errorhandling&&(window.onerror=function(e,t,n){return Aloha.Log.error(Aloha,"Error message: "+e+"\nURL: "+t+"\nLine Number: "+n),!0}),navigator.appVersion.indexOf("Win")!=-1&&(Aloha.OSName="Win"),navigator.appVersion.indexOf("Mac")!=-1&&(Aloha.OSName="Mac"),navigator.appVersion.indexOf("X11")!=-1&&(Aloha.OSName="Unix"),navigator.appVersion.indexOf("Linux")!=-1&&(Aloha.OSName="Linux");try{var n;try{n=document.queryCommandSupported("enableObjectResizing")}catch(r){n=!1,Aloha.Log.log("enableObjectResizing is not supported.")}n&&(document.execCommand("enableObjectResizing",!1,!1),Aloha.Log.log("enableObjectResizing disabled."))}catch(r){Aloha.Log.error(r,"Could not disable enableObjectResizing")}t()},initPlugins:function(e){t.init(function(){e()},this.getLoadedPlugins())},initGui:function(e){Aloha.RepositoryManager.init();for(var t=0,n=Aloha.editables.length;t<n;t++)Aloha.editables[t].ready||Aloha.editables[t].init();e()},activateEditable:function(e){for(var t=0,n=Aloha.editables.length;t<n;t++)Aloha.editables[t]!=e&&Aloha.editables[t].isActive&&Aloha.editables[t].blur();Aloha.activeEditable=e},getActiveEditable:function(){return Aloha.activeEditable},deactivateEditable:function(){if(typeof Aloha.activeEditable=="undefined"||Aloha.activeEditable===null)return;Aloha.activeEditable.blur(),Aloha.activeEditable=null},getEditableById:function(t){e("#"+t).get(0).nodeName.toLowerCase()==="textarea"&&(t+="-aloha");for(var n=0,r=Aloha.editables.length;n<r;n++)if(Aloha.editables[n].getId()==t)return Aloha.editables[n];return null},isEditable:function(e){for(var t=0,n=Aloha.editables.length;t<n;t++)if(Aloha.editables[t].originalObj.get(0)===e)return!0;return!1},log:function(e,t,n){typeof Aloha.Log!="undefined"&&Aloha.Log.log(e,t,n)},registerEditable:function(e){Aloha.editables.push(e)},unregisterEditable:function(e){var t=Aloha.editables.indexOf(e);t!=-1&&Aloha.editables.splice(t,1)},toString:function(){return"Aloha"},isModified:function(){for(var e=0;e<Aloha.editables.length;e++)if(Aloha.editables[e].isModified&&Aloha.editables[e].isModified())return!0;return!1},getAlohaUrl:function(t){var n=e("[data-aloha-plugins]"),r=n.length?n[0].src.replace(/\/?aloha.js$/,""):"";return typeof Aloha.settings.baseUrl=="string"&&(r=Aloha.settings.baseUrl),r},getPluginUrl:function(e){var t;return e&&(t=n[e],t&&(t.match("^(/|http[s]?:).*")||(t=Aloha.getAlohaUrl()+"/"+t))),t}}),Aloha});