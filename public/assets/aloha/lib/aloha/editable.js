/*!
 * This file is part of Aloha Editor Project http://aloha-editor.org
 * Copyright Â© 2010-2011 Gentics Software GmbH, aloha@gentics.com
 * Contributors http://aloha-editor.org/contribution.php
 * Licensed unter the terms of http://www.aloha-editor.org/license.html
 *
 * Aloha Editor is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * ( at your option ) any later version.*
 *
 * Aloha Editor is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program. If not, see <http://www.gnu.org/licenses/>.
 */
define(["aloha/core","util/class","aloha/jquery","aloha/pluginmanager","aloha/floatingmenu","aloha/selection","aloha/markup","aloha/contenthandlermanager","aloha/console"],function(a,b,c,d,e,f,g,h,i){var j=window.unescape,k=window.GENTICS,l=!1;a.defaults.contentHandler={},a.defaults.contentHandler.initEditable=["sanitize"],a.defaults.contentHandler.getContents=["sanitize"],typeof a.settings.contentHandler=="undefined"&&(a.settings.contentHandler={});var m=function(a){return c(a).html()},n=m;a.Editable=b.extend({_constructor:function(b){b.attr("id")||b.attr("id",k.Utils.guid()),this.obj=b,this.originalObj=b,this.ready=!1,this.sccDelimiters=[":",";",".","!","?",",",j("%u0009"),j("%u0020"),j("%u0008"),j("%u007F"),"Enter"],this.sccIdle=5e3,this.sccDelay=500,this.sccTimerIdle=!1,this.sccTimerDelay=!1,this.keyCodeMap={93:"Apps",18:"Alt",20:"CapsLock",17:"Control",40:"Down",35:"End",13:"Enter",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",36:"Home",45:"Insert",37:"Left",224:"Meta",34:"PageDown",33:"PageUp",19:"Pause",44:"PrintScreen",39:"Right",145:"Scroll",16:"Shift",38:"Up",91:"Win",92:"Win"},this.placeholderClass="aloha-placeholder",a.registerEditable(this),this.init()},init:function(){var b=this;this.settings=a.settings,a.settings&&a.settings.smartContentChange&&(a.settings.smartContentChange.delimiters&&(this.sccDelimiters=a.settings.smartContentChange.delimiters),a.settings.smartContentChange.idle&&(this.sccIdle=a.settings.smartContentChange.idle),a.settings.smartContentChange.delay&&(this.sccDelay=a.settings.smartContentChange.delay));if(!this.check(this.obj)){this.destroy();return}typeof a.settings.contentHandler.initEditable=="undefined"&&(a.settings.contentHandler.initEditable=a.defaults.contentHandler.initEditable);var d=b.obj.html();d=h.handleContent(d,{contenthandler:a.settings.contentHandler.initEditable}),b.obj.html(d),a.bind("aloha-ready",function(){b.obj.addClass("aloha-editable").contentEditable(!0),b.obj.mousedown(function(c){if(!a.eventHandled)return a.eventHandled=!0,b.activate(c)}),b.obj.mouseup(function(b){a.eventHandled=!1}),b.obj.focus(function(a){return b.activate(a)}),b.obj.keydown(function(a){var c=g.preProcessKeyStrokes(a);return b.keyCode=a.which,c||b.smartContentChange(a),c}),b.obj.keypress(function(b){a.activeEditable.smartContentChange(b)}),b.obj.keyup(function(b){if(b.keyCode===27)return a.deactivateEditable(),!1}),b.obj.contentEditableSelectionChange(function(a){return f.onChange(b.obj,a),b.obj}),b.setUnmodified(),b.snapshotContent=b.getContents(),c.browser.mozilla&&b.initEmptyEditable(),b.initPlaceholder(),b.ready=!0,a.trigger("aloha-editable-created",[b])})},isActive:!1,originalContent:null,range:undefined,check:function(){var a=this,b=this.obj,d=b.get(0),e=d.nodeName.toLowerCase(),f=["a","abbr","address","article","aside","b","bdo","blockquote","cite","code","command","del","details","dfn","div","dl","em","footer","h1","h2","h3","h4","h5","h6","header","i","ins","menu","nav","p","pre","q","ruby","section","small","span","strong","sub","sup","var"],g,h;for(g=0;g<f.length;++g)if(e===f[g])return!0;switch(e){case"label":case"button":break;case"textarea":return h=c('<div id="'+this.getId()+'-aloha" class="aloha-textarea" />').insertAfter(b),h.height(b.height()).width(b.width()).html(b.val()),b.hide(),b.parents("form:first").submit(function(){b.val(a.getContents())}),this.obj=h,!0;default:}return!1},initPlaceholder:function(){a.settings.placeholder&&this.isEmpty()&&this.addPlaceholder()},isEmpty:function(){var a=c.trim(this.getContents()),b=a==="<br>"?!0:!1;return a.length===0||b},initEmptyEditable:function(){var a=this.obj;this.empty(this.getContents())&&c(a).prepend('<br class="aloha-cleanme" />')},addPlaceholder:function(){var b=c("<div>"),d=c("<span>"),e,f=this.obj;k.Utils.Dom.allowsNesting(f[0],b[0])?e=b:e=d,c(f).append(e.addClass(this.placeholderClass)),c.each(a.settings.placeholder,function(a,b){f.is(a)&&e.html(b)}),c("br",f).remove()},removePlaceholder:function(a,b){var d=this.placeholderClass,e;if(b===!0){e=f.getRangeObject();if(!e.select)return;e.startContainer=e.endContainer=a.get(0),e.startOffset=e.endOffset=0,e.select(),window.setTimeout(function(){c("."+d,a).remove()},20)}else c("."+d,a).remove()},destroy:function(){this===a.getActiveEditable()&&(this.blur(),e.hide());switch(this.originalObj.get(0).nodeName.toLowerCase()){case"label":case"button":break;case"textarea":this.originalObj.val(this.getContents()),this.obj.remove(),this.originalObj.show();break;default:}this.ready=!1,this.removePlaceholder(this.obj),this.obj.removeClass("aloha-editable").contentEditable(!1).unbind("mousedown click dblclick focus keydown keypress keyup"),a.trigger("aloha-editable-destroyed",[this]),a.unregisterEditable(this)},setUnmodified:function(){this.originalContent=this.getContents()},isModified:function(){return this.originalContent!==this.getContents()},toString:function(){return"Aloha.Editable"},isDisabled:function(){return!this.obj.contentEditable()||this.obj.contentEditable()==="false"},disable:function(){return this.isDisabled()||this.obj.contentEditable(!1)},enable:function(){return this.isDisabled()&&this.obj.contentEditable(!0)},activate:function(b){var c=a.getActiveEditable();if(l){l=!1;return}if(b&&b.type==="focus"&&c!==null&&c.obj.parent().get(0)===b.currentTarget)return;if(this.isActive||this.isDisabled())return;this.obj.addClass("aloha-editable-active"),a.activateEditable(this),l=!0,this.removePlaceholder(this.obj,!0),l=!1,this.isActive=!0,a.trigger("aloha-editable-activated",{oldActive:c,editable:this})},blur:function(){this.obj.blur(),this.isActive=!1,this.initPlaceholder(),this.obj.removeClass("aloha-editable-active"),a.trigger("aloha-editable-deactivated",{editable:this}),a.activeEditable.smartContentChange({type:"blur"},null)},empty:function(a){return null===a||c.trim(a)===""||a==="<br/>"},getContents:function(a){var b=this.obj.clone(!1);return b.find(".aloha-cleanme").remove(),this.removePlaceholder(b),d.makeClean(b),a?b.contents():n(b[0])},setContents:function(b,c){var d=null;return a.getActiveEditable()===this&&(a.deactivateEditable(),d=this),this.obj.html(b),null!==d&&d.activate(),this.smartContentChange({type:"set-contents"}),c?this.obj.contents():n(this.obj[0])},getId:function(){return this.obj.attr("id")},smartContentChange:function(b){var d=this,e=null,f,g;if(b&&(b.metaKey||b.crtlKey||b.altKey))return!1;b&&b.originalEvent&&(f=new RegExp("U\\+(\\w{4})"),g=f.exec(b.originalEvent.keyIdentifier),b.originalEvent.keyIdentifier&&!1?(g!==null&&(e=j("%u"+g[1])),e===null&&(e=b.originalEvent.keyIdentifier)):e=this.keyCodeMap[this.keyCode]||String.fromCharCode(b.which)||"unknown"),c.inArray(e,this.sccDelimiters)>=0?(clearTimeout(this.sccTimerIdle),clearTimeout(this.sccTimerDelay),this.sccTimerDelay=setTimeout(function(){a.trigger("aloha-smart-content-changed",{editable:d,keyIdentifier:b.originalEvent.keyIdentifier,keyCode:b.keyCode,"char":e,triggerType:"keypress",snapshotContent:d.getSnapshotContent()}),i.debug("Aloha.Editable","smartContentChanged: event type keypress triggered")},this.sccDelay)):b&&b.type==="paste"?a.trigger("aloha-smart-content-changed",{editable:d,keyIdentifier:null,keyCode:null,"char":null,triggerType:"paste",snapshotContent:d.getSnapshotContent()}):b&&b.type==="blur"?a.trigger("aloha-smart-content-changed",{editable:d,keyIdentifier:null,keyCode:null,"char":null,triggerType:"blur",snapshotContent:d.getSnapshotContent()}):e!==null&&(clearTimeout(this.sccTimerDelay),clearTimeout(this.sccTimerIdle),this.sccTimerIdle=setTimeout(function(){a.trigger("aloha-smart-content-changed",{editable:d,keyIdentifier:null,keyCode:null,"char":null,triggerType:"idle",snapshotContent:d.getSnapshotContent()})},this.sccIdle))},getSnapshotContent:function(){var a=this.snapshotContent;return this.snapshotContent=this.getContents(),a}}),a.Editable.setContentSerializer=function(a){n=a}});