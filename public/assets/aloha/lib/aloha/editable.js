/*!
 * This file is part of Aloha Editor Project http://aloha-editor.org
 * Copyright Â© 2010-2011 Gentics Software GmbH, aloha@gentics.com
 * Contributors http://aloha-editor.org/contribution.php
 * Licensed unter the terms of http://www.aloha-editor.org/license.html
 *
 * Aloha Editor is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * ( at your option ) any later version.*
 *
 * Aloha Editor is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program. If not, see <http://www.gnu.org/licenses/>.
 */
define(["aloha/core","util/class","aloha/jquery","aloha/pluginmanager","aloha/floatingmenu","aloha/selection","aloha/markup","aloha/contenthandlermanager","aloha/console"],function(e,t,n,r,i,s,o,u,a){var f=window.unescape,l=window.GENTICS,c=!1;e.defaults.contentHandler={},e.defaults.contentHandler.initEditable=["sanitize"],e.defaults.contentHandler.getContents=["sanitize"],typeof e.settings.contentHandler=="undefined"&&(e.settings.contentHandler={});var h=function(e){return n(e).html()},p=h;e.Editable=t.extend({_constructor:function(t){t.attr("id")||t.attr("id",l.Utils.guid()),this.obj=t,this.originalObj=t,this.ready=!1,this.sccDelimiters=[":",";",".","!","?",",",f("%u0009"),f("%u0020"),f("%u0008"),f("%u007F"),"Enter"],this.sccIdle=5e3,this.sccDelay=500,this.sccTimerIdle=!1,this.sccTimerDelay=!1,this.keyCodeMap={93:"Apps",18:"Alt",20:"CapsLock",17:"Control",40:"Down",35:"End",13:"Enter",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",36:"Home",45:"Insert",37:"Left",224:"Meta",34:"PageDown",33:"PageUp",19:"Pause",44:"PrintScreen",39:"Right",145:"Scroll",16:"Shift",38:"Up",91:"Win",92:"Win"},this.placeholderClass="aloha-placeholder",e.registerEditable(this),this.init()},init:function(){var t=this;this.settings=e.settings,e.settings&&e.settings.smartContentChange&&(e.settings.smartContentChange.delimiters&&(this.sccDelimiters=e.settings.smartContentChange.delimiters),e.settings.smartContentChange.idle&&(this.sccIdle=e.settings.smartContentChange.idle),e.settings.smartContentChange.delay&&(this.sccDelay=e.settings.smartContentChange.delay));if(!this.check(this.obj)){this.destroy();return}typeof e.settings.contentHandler.initEditable=="undefined"&&(e.settings.contentHandler.initEditable=e.defaults.contentHandler.initEditable);var r=t.obj.html();r=u.handleContent(r,{contenthandler:e.settings.contentHandler.initEditable}),t.obj.html(r),e.bind("aloha-ready",function(){t.obj.addClass("aloha-editable").contentEditable(!0),t.obj.mousedown(function(n){if(!e.eventHandled)return e.eventHandled=!0,t.activate(n)}),t.obj.mouseup(function(t){e.eventHandled=!1}),t.obj.focus(function(e){return t.activate(e)}),t.obj.keydown(function(e){var n=o.preProcessKeyStrokes(e);return t.keyCode=e.which,n||t.smartContentChange(e),n}),t.obj.keypress(function(t){e.activeEditable.smartContentChange(t)}),t.obj.keyup(function(t){if(t.keyCode===27)return e.deactivateEditable(),!1}),t.obj.contentEditableSelectionChange(function(e){return s.onChange(t.obj,e),t.obj}),t.setUnmodified(),t.snapshotContent=t.getContents(),n.browser.mozilla&&t.initEmptyEditable(),t.initPlaceholder(),t.ready=!0,e.trigger("aloha-editable-created",[t])})},isActive:!1,originalContent:null,range:undefined,check:function(){var e=this,t=this.obj,r=t.get(0),i=r.nodeName.toLowerCase(),s=["a","abbr","address","article","aside","b","bdo","blockquote","cite","code","command","del","details","dfn","div","dl","em","footer","h1","h2","h3","h4","h5","h6","header","i","ins","menu","nav","p","pre","q","ruby","section","small","span","strong","sub","sup","var"],o,u;for(o=0;o<s.length;++o)if(i===s[o])return!0;switch(i){case"label":case"button":break;case"textarea":return u=n('<div id="'+this.getId()+'-aloha" class="aloha-textarea" />').insertAfter(t),u.height(t.height()).width(t.width()).html(t.val()),t.hide(),t.parents("form:first").submit(function(){t.val(e.getContents())}),this.obj=u,!0;default:}return!1},initPlaceholder:function(){e.settings.placeholder&&this.isEmpty()&&this.addPlaceholder()},isEmpty:function(){var e=n.trim(this.getContents()),t=e==="<br>"?!0:!1;return e.length===0||t},initEmptyEditable:function(){var e=this.obj;this.empty(this.getContents())&&n(e).prepend('<br class="aloha-cleanme" />')},addPlaceholder:function(){var t=n("<div>"),r=n("<span>"),i,s=this.obj;l.Utils.Dom.allowsNesting(s[0],t[0])?i=t:i=r,n(s).append(i.addClass(this.placeholderClass)),n.each(e.settings.placeholder,function(e,t){s.is(e)&&i.html(t)}),n("br",s).remove()},removePlaceholder:function(e,t){var r=this.placeholderClass,i;if(t===!0){i=s.getRangeObject();if(!i.select)return;i.startContainer=i.endContainer=e.get(0),i.startOffset=i.endOffset=0,i.select(),window.setTimeout(function(){n("."+r,e).remove()},20)}else n("."+r,e).remove()},destroy:function(){this===e.getActiveEditable()&&(this.blur(),i.hide());switch(this.originalObj.get(0).nodeName.toLowerCase()){case"label":case"button":break;case"textarea":this.originalObj.val(this.getContents()),this.obj.remove(),this.originalObj.show();break;default:}this.ready=!1,this.removePlaceholder(this.obj),this.obj.removeClass("aloha-editable").contentEditable(!1).unbind("mousedown click dblclick focus keydown keypress keyup"),e.trigger("aloha-editable-destroyed",[this]),e.unregisterEditable(this)},setUnmodified:function(){this.originalContent=this.getContents()},isModified:function(){return this.originalContent!==this.getContents()},toString:function(){return"Aloha.Editable"},isDisabled:function(){return!this.obj.contentEditable()||this.obj.contentEditable()==="false"},disable:function(){return this.isDisabled()||this.obj.contentEditable(!1)},enable:function(){return this.isDisabled()&&this.obj.contentEditable(!0)},activate:function(t){var n=e.getActiveEditable();if(c){c=!1;return}if(t&&t.type==="focus"&&n!==null&&n.obj.parent().get(0)===t.currentTarget)return;if(this.isActive||this.isDisabled())return;this.obj.addClass("aloha-editable-active"),e.activateEditable(this),c=!0,this.removePlaceholder(this.obj,!0),c=!1,this.isActive=!0,e.trigger("aloha-editable-activated",{oldActive:n,editable:this})},blur:function(){this.obj.blur(),this.isActive=!1,this.initPlaceholder(),this.obj.removeClass("aloha-editable-active"),e.trigger("aloha-editable-deactivated",{editable:this}),e.activeEditable.smartContentChange({type:"blur"},null)},empty:function(e){return null===e||n.trim(e)===""||e==="<br/>"},getContents:function(e){var t=this.obj.clone(!1);return t.find(".aloha-cleanme").remove(),this.removePlaceholder(t),r.makeClean(t),e?t.contents():p(t[0])},setContents:function(t,n){var r=null;return e.getActiveEditable()===this&&(e.deactivateEditable(),r=this),this.obj.html(t),null!==r&&r.activate(),this.smartContentChange({type:"set-contents"}),n?this.obj.contents():p(this.obj[0])},getId:function(){return this.obj.attr("id")},smartContentChange:function(t){var r=this,i=null,s,o;if(t&&(t.metaKey||t.crtlKey||t.altKey))return!1;t&&t.originalEvent&&(s=new RegExp("U\\+(\\w{4})"),o=s.exec(t.originalEvent.keyIdentifier),t.originalEvent.keyIdentifier&&!1?(o!==null&&(i=f("%u"+o[1])),i===null&&(i=t.originalEvent.keyIdentifier)):i=this.keyCodeMap[this.keyCode]||String.fromCharCode(t.which)||"unknown"),n.inArray(i,this.sccDelimiters)>=0?(clearTimeout(this.sccTimerIdle),clearTimeout(this.sccTimerDelay),this.sccTimerDelay=setTimeout(function(){e.trigger("aloha-smart-content-changed",{editable:r,keyIdentifier:t.originalEvent.keyIdentifier,keyCode:t.keyCode,"char":i,triggerType:"keypress",snapshotContent:r.getSnapshotContent()}),a.debug("Aloha.Editable","smartContentChanged: event type keypress triggered")},this.sccDelay)):t&&t.type==="paste"?e.trigger("aloha-smart-content-changed",{editable:r,keyIdentifier:null,keyCode:null,"char":null,triggerType:"paste",snapshotContent:r.getSnapshotContent()}):t&&t.type==="blur"?e.trigger("aloha-smart-content-changed",{editable:r,keyIdentifier:null,keyCode:null,"char":null,triggerType:"blur",snapshotContent:r.getSnapshotContent()}):i!==null&&(clearTimeout(this.sccTimerDelay),clearTimeout(this.sccTimerIdle),this.sccTimerIdle=setTimeout(function(){e.trigger("aloha-smart-content-changed",{editable:r,keyIdentifier:null,keyCode:null,"char":null,triggerType:"idle",snapshotContent:r.getSnapshotContent()})},this.sccIdle))},getSnapshotContent:function(){var e=this.snapshotContent;return this.snapshotContent=this.getContents(),e}}),e.Editable.setContentSerializer=function(e){p=e}});