/*!
* This file is part of Aloha Editor Project http://aloha-editor.org
* Copyright (c) 2010-2011 Gentics Software GmbH, aloha@gentics.com
* Contributors http://aloha-editor.org/contribution.php 
* Licensed unter the terms of http://www.aloha-editor.org/license.html
*/
/*
* Aloha Editor is free software: you can redistribute it and/or modify
* it under the terms of the GNU Affero General Public License as published by
* the Free Software Foundation, either version 3 of the License, or
* (at your option) any later version.*
*
* Aloha Editor is distributed in the hope that it will be useful,
* but WITHOUT ANY WARRANTY; without even the implied warranty of
* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
* GNU Affero General Public License for more details.
*
* You should have received a copy of the GNU Affero General Public License
* along with this program. If not, see <http://www.gnu.org/licenses/>.
*/
/**
 * @todo: - Make the sidebars resizable using drag handles
 *		  - Make overlayPage setting settable from external config
 */
define(["aloha/core","aloha/jquery","aloha/selection"],function(e,t,n,r){function f(e,t){return e.replace(/\{([a-z0-9\-\_]+)\}/ig,function(e,n,r,i){var s=t[n]||e;return typeof s=="function"?s():s})}function l(e){return typeof e=="string"?f(e,a):e}function c(){var e=[],n=o;return t.each(arguments,function(){e.push("."+(this==""?n:n+"-"+this))}),t.trim(e.join(" "))}function h(){var e=[],n=o;return t.each(arguments,function(){e.push(this==""?n:n+"-"+this)}),t.trim(e.join(" "))}var i=t,s=void 0,o="aloha-sidebar",u=+(new Date),a={bar:h("bar"),handle:h("handle"),inner:h("inner"),panels:h("panels"),"config-btn":h("config-btn"),"handle-icon":h("handle-icon"),"panel-content":h("panel-content"),"panel-content-inner":h("panel-content-inner"),"panel-content-inner-text":h("panel-content-inner-text"),"panel-title":h("panel-title"),"panel-title-arrow":h("panel-title-arrow"),"panel-title-text":h("panel-title-text")};t.easing.easeOutExpo||t.extend(t.easing,{easeOutExpo:function(e,t,n,r,i){return t==i?n+r:r*(-Math.pow(2,-10*t/i)+1)+n},easeOutElastic:function(e,t,n,r,i){var s=Math,o=1.70158,u=0,a=r;if(!t)return n;if((t/=i)==1)return n+r;u||(u=i*.3);if(a<s.abs(r)){a=r;var o=u/4}else var o=u/(2*s.PI)*s.asin(r/a);return a*s.pow(2,-10*t)*s.sin((t*i-o)*2*s.PI/u)+r+n}});var p=function(r){var i=this;this.id=h(++u),this.panels={},this.container=t(l('<div class="{bar}"><div class="{handle}"><span class="{handle-icon}"></span></div><div class="{inner}"><ul class="{panels}"></ul></div></div>')),this.width=300,this.opened=!1,this.isOpen=!1,this.settings={rotateIcons:!t.browser.msie,overlayPage:!0},t(function(){(typeof e.settings.sidebar=="undefined"||!e.settings.sidebar.disabled)&&i.init(r)})};t.extend(p.prototype,{init:function(e){var n=this,r;typeof e=="object"&&(r=e.panels,delete e.panels),t.extend(this,e),typeof r=="object"&&t.each(r,function(){n.addPanel(this,!0)});var i=this.container;this.position=="right"&&i.addClass(h("right")),i.hide().appendTo(t("body")).click(function(){n.barClicked.apply(n,arguments)}).find(c("panels")).width(this.width),i.width(this.width),this.width=i.width(),t(window).resize(function(){n.updateHeight()}),this.updateHeight(),this.roundCorners(),this.initToggler(),this.container.css(this.position=="right"?"marginRight":"marginLeft",-this.width),this.opened&&this.open(0),this.toggleHandleIcon(this.isOpen),this.subscribeToEvents(),t(window).resize(function(){n.correctHeight()}),this.correctHeight()},show:function(){return this.container.css("display","block"),this},hide:function(){return this.container.css("display","none"),this},checkActivePanels:function(e){var n=[];if(typeof e!="undefined"&&typeof e.markupEffectiveAtStart!="undefined"){var r=e.markupEffectiveAtStart.length;for(var i=0;i<r;++i)n.push(t(e.markupEffectiveAtStart[i]))}var s=this;t.each(this.panels,function(){s.showActivePanel(this,n)}),this.correctHeight()},subscribeToEvents:function(){var t=this,n=this.container;e.bind("aloha-selection-changed",function(e,n){t.checkActivePanels(n)}),n.mousedown(function(t){t.originalEvent.stopSelectionUpdate=!0,e.eventHandled=!0}),n.mouseup(function(t){t.originalEvent.stopSelectionUpdate=!0,e.eventHandled=!1}),e.bind("aloha-editable-deactivated",function(e,n){t.checkActivePanels()})},correctHeight:function(){var e=this.container.find(c("inner")).height()-30,n=[];t.each(this.panels,function(){this.isActive&&n.push(this)});if(n.length==0)return;var r=e-(n[0].title.outerHeight()+10)*n.length,i,s,o,u,a,f=0,l=Math;while(n.length>0&&r>0){r+=f,f=0,a=[];for(var h=n.length-1;h>=0;--h)i=n[h],o=i.content.find(c("panel-content-inner")),s=l.min(o.height("auto").height(),l.floor(r/(h+1))),o.height(s),r-=s,u=o.find(c("panel-content-inner-text")),u.height()>s?(a.push(i),f+=s,o.css({"overflow-x":"hidden","overflow-y":"scroll"})):o.css("overflow-y","hidden"),i.expanded&&i.expand();n=a}},showActivePanel:function(e,n){n.push(null);var r=n.length,i=0,s=e.content.parent("li"),o=e.activeOn,u=t();for(var a=0;a<r;++a)o(n[a])&&(++i,n[a]&&t.merge(u,n[a]));i?e.activate(u):e.deactivate(),this.roundCorners()},initToggler:function(){var n=this,r=this.container,i=r.find(c("handle-icon")),s=h("toggled"),o,u=this.position=="right";this.opened&&this.rotateHandleArrow(u?0:180,0),t(function(){typeof e.settings.sidebar!="undefined"&&e.settings.sidebar.handle&&e.settings.sidebar.handle.top&&(t(r.find(c("handle"))).get(0).style.top=e.settings.sidebar.handle.top)}),r.find(c("handle")).click(function(){o&&clearInterval(o),i.stop().css("marginLeft",4),n.isOpen?(t(this).removeClass(s),n.close(),n.isOpen=!1):(t(this).addClass(s),n.open(),n.isOpen=!0)}).hover(function(){var e=n.isOpen?-1:1;o&&clearInterval(o),i.stop(),t(this).stop().animate(u?{marginLeft:"-="+e*5}:{marginRight:"-="+e*5},200),o=setInterval(function(){e*=-1,i.animate(u?{left:"-="+e*4}:{right:"-="+e*4},300)},300)},function(){o&&clearInterval(o),i.stop().css(u?"left":"right",5),t(this).stop().animate(u?{marginLeft:0}:{marginRight:0},600,"easeOutElastic")})},roundCorners:function(){var e=this.container,t=e.find(c("panels>li:not(","deactivated)")),n=h("panel-top"),r=h("panel-bottom");e.find(c("panel-top,","panel-bottom")).removeClass(n).removeClass(r),t.first().find(c("panel-title")).addClass(n),t.last().find(c("panel-content")).addClass(r)},updateHeight:function(){var e=t(window).height();this.container.height(e).find(c("inner")).height(e)},barClicked:function(e){this.handleBarclick(t(e.target))},handleBarclick:function(e){e.hasClass(h("panel-title"))?this.togglePanel(e):e.hasClass(h("panel-content"))||e.hasClass(h("handle"))||e.hasClass(h("bar"))||this.handleBarclick(e.parent())},getPanelById:function(e){return this.panels[e]},getPanelByElement:function(e){var t=e[0].tagName=="LI"?e:e.parent("li");return this.getPanelById(t[0].id)},togglePanel:function(e){this.getPanelByElement(e).toggle()},rotateHandleIcon:function(e,t){var n=this.container.find(c("handle-icon"));n.animate({angle:e},{duration:typeof t=="number"||typeof t=="string"?t:500,easing:"easeOutExpo",step:function(e,t){n.css({"-o-transform":"rotate("+e+"deg)","-webkit-transform":"rotate("+e+"deg)","-moz-transform":"rotate("+e+"deg)","-ms-transform":"rotate("+e+"deg)"})}})},toggleHandleIcon:function(e){var t=this.position=="right"^e;if(this.settings.rotateIcons)this.rotateHandleIcon(t?180:0,0);else{var n=this.container.find(c("handle-icon"));t?n.addClass(h("handle-icon-left")):n.removeClass(h("handle-icon-left"))}},open:function(e,n){if(this.isOpen)return this;var r=this.position=="right",i=r?{marginRight:0}:{marginLeft:0};return this.toggleHandleIcon(!0),this.container.animate(i,typeof e=="number"||typeof e=="string"?e:500,"easeOutExpo"),this.settings.overlayPage||t("body").animate(r?{marginRight:"+="+this.width}:{marginLeft:"+="+this.width},500,"easeOutExpo"),this.isOpen=!0,t("body").trigger(h("opened"),this),this},close:function(e,n){if(!this.isOpen)return this;var r=this.position=="right",i=r?{marginRight:-this.width}:{marginLeft:-this.width};return this.toggleHandleIcon(!1),this.container.animate(i,typeof e=="number"||typeof e=="string"?e:500,"easeOutExpo"),this.settings.overlayPage||t("body").animate(r?{marginRight:"-="+this.width}:{marginLeft:"-="+this.width},500,"easeOutExpo"),this.isOpen=!1,this},activatePanel:function(e,t){return typeof e=="string"&&(e=this.getPanelById(e)),e&&e.activate(t),this.roundCorners(),this},expandPanel:function(e,t){return typeof e=="string"&&(e=this.getPanelById(e)),e&&e.expand(t),this},collapsePanel:function(e,t){return typeof e=="string"&&(e=this.getPanelById(e)),e&&e.collapse(t),this},addPanel:function(e,t){return e instanceof d||(e.width||(e.width=this.width),e.sidebar=this,e=new d(e)),this.panels[e.id]=e,this.container.find(c("panels")).append(e.element),t!==!0&&this.roundCorners(),this.checkActivePanels(n.getRangeObject()),e}});var d=function(n){this.id=null,this.folds={},this.button=null,this.title=t(l('						 			<div class="{panel-title}">							 				<span class="{panel-title-arrow}"></span>		 				<span class="{panel-title-text}">Untitled</span> 			</div>												 		')),this.content=t(l('								<div class="{panel-content}">									<div class="{panel-content-inner}">								<div class="{panel-content-inner-text}">					</div>													</div>													</div>													')),this.element=null,this.expanded=!1,this.effectiveElement=null,this.isActive=!0,this.init(n)};t.extend(d.prototype,{init:function(e){this.setTitle(e.title).setContent(e.content),delete e.title,delete e.content,t.extend(this,e),this.id||(this.id=h(++u));var n=this.element=t('<li id="'+this.id+'">').append(this.title,this.content);this.expanded&&this.content.height("auto"),this.toggleTitleIcon(this.expanded),this.coerceActiveOn(),this.title.attr("unselectable","on").css("-moz-user-select","none").each(function(){this.onselectstart=function(){return!1}}),typeof this.onInit=="function"&&this.onInit.apply(this)},toggleTitleIcon:function(e){if(this.sidebar.settings.rotateIcons)this.rotateTitleIcon(e?90:0);else{var t=this.title.find(c("panel-title-arrow"));e?t.addClass(h("panel-title-arrow-down")):t.removeClass(h("panel-title-arrow-down"))}},coerceActiveOn:function(){if(typeof this.activeOn!="function"){var e=this.activeOn;this.activeOn=function(){var t=typeof e,n;return t=="boolean"?n=function(){return e}:t=="undefined"?n=function(){return!0}:t=="string"?n=function(t){return t?t.is(e):!1}:n=function(){return!1},n}()}},activate:function(e){this.isActive=!0,this.content.parent("li").show().removeClass(h("deactivated")),this.effectiveElement=e,typeof this.onActivate=="function"&&this.onActivate.call(this,e)},deactivate:function(){this.isActive=!1,this.content.parent("li").hide().addClass(h("deactivated")),this.effectiveElement=null},toggle:function(){this.expanded?this.collapse():this.expand()},expand:function(e){var t=this,n=this.content,r=n.height(),i=n.height("auto").height();return n.height(r).stop().animate({height:i},500,"easeOutExpo",function(){typeof e=="function"&&e.call(t)}),this.element.removeClass("collapsed"),this.toggleTitleIcon(!0),this.expanded=!0,this},collapse:function(e,t){var n=this;return this.element.addClass("collapsed"),this.content.stop().animate({height:5},250,"easeOutExpo",function(){typeof t=="function"&&t.call(n)}),this.toggleTitleIcon(!1),this.expanded=!1,this},setTitle:function(e){return this.title.find(c("panel-title-text")).html(e),this},setContent:function(e){if(!e||e=="")e="&nbsp;";return this.content.find(c("panel-content-inner-text")).html(e),this},rotateTitleIcon:function(e,t){var n=this.title.find(c("panel-title-arrow"));n.animate({angle:e},{duration:typeof t=="number"?t:500,easing:"easeOutExpo",step:function(e,t){n.css({"-o-transform":"rotate("+e+"deg)","-webkit-transform":"rotate("+e+"deg)","-moz-transform":"rotate("+e+"deg)","-ms-transform":"rotate("+e+"deg)"})}})},renderEffectiveParents:function(e,n){var r=e.first(),i=[],s=[],o=this.activeOn,u,a;while(r.length>0&&!r.is(".aloha-editable")){if(o(r)){s.push("<span>"+r[0].tagName.toLowerCase()+"</span>"),u=s.length,a=[];while(u--)a.push(s[u]);i.push(f('<div class="aloha-sidebar-panel-parent"><div class="aloha-sidebar-panel-parent-path">{path}</div><div class="aloha-sidebar-panel-parent-content aloha-sidebar-opened">{content}</div></div>',{path:a.join(""),content:typeof n=="function"?n(r):"----"}))}r=r.parent()}this.setContent(i.join("")),t(".aloha-sidebar-panel-parent-path").click(function(){var e=t(this).parent().find(".aloha-sidebar-panel-parent-content");e.hasClass("aloha-sidebar-opened")?e.hide().removeClass("aloha-sidebar-opened"):e.show().addClass("aloha-sidebar-opened")}),this.content.height("auto").find(".aloha-sidebar-panel-content-inner").height("auto")}});var v=new p({position:"left",width:250}),m=new p({position:"right",width:250});return e.Sidebar={left:v,right:m},e.Sidebar});