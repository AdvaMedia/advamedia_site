/*!
* This file is part of Aloha Editor Project http://aloha-editor.org
* Copyright Â© 2010-2011 Gentics Software GmbH, aloha@gentics.com
* Contributors http://aloha-editor.org/contribution.php
* Licensed unter the terms of http://www.aloha-editor.org/license.html
*/
/*
* Aloha Editor is free software: you can redistribute it and/or modify
* it under the terms of the GNU Affero General Public License as published by
* the Free Software Foundation, either version 3 of the License, or
* (at your option) any later version.*
*
* Aloha Editor is distributed in the hope that it will be useful,
* but WITHOUT ANY WARRANTY; without even the implied warranty of
* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
* GNU Affero General Public License for more details.
*
* You should have received a copy of the GNU Affero General Public License
* along with this program. If not, see <http://www.gnu.org/licenses/>.
*/
define(["aloha/core","util/class","aloha/jquery","aloha/ecma5shims"],function(e,t,n,r){function o(e){return"BR"===e.nodeName}function u(e){return"false"===n(e).attr("contenteditable")}function a(e){return e&&3===e.nodeType}function f(e){return e?a(e)?e.length:e.childNodes.length:0}function l(e){return e?e.nextSibling?a(e.nextSibling)&&!h(e.nextSibling)?l(e.nextSibling):o(e.nextSibling)&&e.nextSibling===e.parentNode.lastChild?l(e.nextSibling):""===e.nextSibling.innerHTML&&!u(e.nextSibling)?l(e.nextSibling):e.nextSibling:e.parentNode?l(e.parentNode):null:null}function c(e){return e?e.previousSibling?a(e.previousSibling)&&!h(e.previousSibling)?c(e.previousSibling):""===e.previousSibling.innerHTML&&!u(e.previousSibling)?c(e.previouSibling):e.previousSibling:e.parentNode?c(e.parentNode):null:null}function h(e){return 0<e.data.replace(/\s+/g,"").length}function p(e,t){return 0===t||t<=e.data.length-e.data.replace(/^\s+/,"").length}function d(e){return e.parent().hasClass("aloha-editable")}function v(e,t){var n=f(e);if(n===t)return!0;var r=a(e);return r&&e.data.replace(/\s+$/,"").length===t?!0:1===n&&!r?o(e.childNodes[0]):!1}function m(e){return n(e).stop(!0).css({opacity:0}).fadeIn(0).delay(100).fadeIn(function(){n(e).css({opacity:1})}),e}function g(t,r){var o=new i.Utils.RangeObject,a=r?c(t):l(t);if(!a||u(a)){var h=n("<div>&nbsp;</div>");r?n(t).before(h):n(t).after(h),o.startContainer=o.endContainer=h[0],o.startOffset=o.endOffset=0,w(o),window.$_alohaPlaceholder=h}else o.startContainer=o.endContainer=a,o.startOffset=o.endOffset=r?f(a):s?1:0,w(o);o.select(),e.trigger("aloha-block-selected",t),e.Selection.preventSelectionChanged()}function y(e,t){return s?r.compareDocumentPosition(e,t)&16:0<n(e).find(t).length}function b(e){var t=e.startContainer,n=e.endContainer,r=window.$_alohaPlaceholder;return r.is(t)||r.is(n)||y(r[0],t)||y(r[0],n)}function w(e){window.$_alohaPlaceholder&&!b(e)&&(0===window.$_alohaPlaceholder.html().replace(/^(&nbsp;)*$/,"").length&&window.$_alohaPlaceholder.remove(),window.$_alohaPlaceholder=null)}var i=window.GENTICS,s=!!(n.browser.msie&&9>parseInt(n.browser.version,10));return e.Markup=t.extend({keyHandlers:{},addKeyHandler:function(e,t){this.keyHandlers[e]||(this.keyHandlers[e]=[]),this.keyHandlers[e].push(t)},insertBreak:function(){var t=e.Selection.rangeObject,r,s,o;t.isCollapsed()||this.removeSelectedMarkup(),o=n("<br/>"),i.Utils.Dom.insertIntoDOM(o,t,e.activeEditable.obj),s=i.Utils.Dom.searchAdjacentTextNode(o.parent().get(0),i.Utils.Dom.getIndexInParent(o.get(0))+1,!1),s&&(nonWSIndex=s.data.search(/\S/),nonWSIndex>0&&(s.data=s.data.substring(nonWSIndex))),t.startContainer=t.endContainer=o.get(0).parentNode,t.startOffset=t.endOffset=i.Utils.Dom.getIndexInParent(o.get(0))+1,t.correctRange(),t.clearCaches(),t.select()},preProcessKeyStrokes:function(t){if(t.type!=="keydown")return!1;var n=e.Selection.rangeObject,r,i;if(this.keyHandlers[t.keyCode]){r=this.keyHandlers[t.keyCode];for(i=0;i<r.length;++i)if(!r[i](t))return!1}return t.keyCode===37||t.keyCode===39?this.processCursor(n,t.keyCode)?(w(e.Selection.rangeObject),!0):!1:t.keyCode===8?(t.preventDefault(),e.execCommand("delete",!1),!1):t.keyCode===46?(e.execCommand("forwarddelete",!1),!1):t.keyCode===13?t.shiftKey?(e.execCommand("insertlinebreak",!1),!1):(e.execCommand("insertparagraph",!1),!1):!0},processCursor:function(e,t){if(!e.isCollapsed())return!0;var r=e.startContainer;if(!r)return!0;var i;if(s){var o=n(r).parents("[contenteditable=false]"),h=o.length>0;if(h){if(!d(o))return!0;i=o[0]}}if(!i){var m=37===t||38===t,y=e.startOffset;if(a(r)){if(m){var b=s&&1===y;if(!b&&!p(r,y))return!0}else if(!v(r,y))return!0}else r=r.childNodes[y===f(r)?y-1:y];i=m?c(r):l(r)}return u(i)?(g(i,m),!1):!0},processShiftEnter:function(e){this.insertHTMLBreak(e.getSelectionTree(),e)},processEnter:function(e){e.splitObject?this.splitRangeObject(e):this.insertHTMLBreak(e.getSelectionTree(),e)},insertHTMLCode:function(t){var r=e.Selection.rangeObject;this.insertHTMLBreak(r.getSelectionTree(),r,n(t))},insertHTMLBreak:function(t,r,s){var o,u,a,f,l,c,h,p,d;s=s?s:n("<br/>");for(o=0,u=t.length;o<u;++o){a=t[o],f=a.domobj?n(a.domobj):undefined;if(a.selection!=="none")if(a.selection=="collapsed")o>0?(l=n(t[o-1].domobj),l.after(s)):(c=n(t[1].domobj),c.before(s)),r.startContainer=r.endContainer=s[0].parentNode,r.startOffset=r.endOffset=i.Utils.Dom.getIndexInParent(s[0])+1,r.correctRange();else if(a.domobj&&a.domobj.nodeType===3){a.domobj.nextSibling&&a.domobj.nextSibling.nodeType==1&&e.Selection.replacingElements[a.domobj.nextSibling.nodeName.toLowerCase()]&&f.after("<br/>");if(this.needEndingBreak()){d=a.domobj;while(d)if(d.nextSibling)d=!1;else{d=d.parentNode;if(i.Utils.Dom.isBlockLevelElement(d)||i.Utils.Dom.isListElement(d))break;d===r.limitObject&&(d=!1)}d&&n(d).append('<br class="aloha-cleanme" />')}f.between(s,a.startOffset),p=0,h=s[0];while(h)h=h.previousSibling,++p;r.startContainer=s[0].parentNode,r.endContainer=s[0].parentNode,r.startOffset=p,r.endOffset=p,r.correctRange()}else a.domobj&&a.domobj.nodeType===1&&(f.parent().find("br.aloha-ephemera").length===0&&(n(r.limitObject).find("br.aloha-ephemera").remove(),n(r.commonAncestorContainer).append(this.getFillUpElement(r.splitObject))),f.after(s),r.startContainer=r.commonAncestorContainer,r.endContainer=r.startContainer,r.startOffset=o+2,r.endOffset=o+2,r.update())}r.select()},needEndingBreak:function(){return!n.browser.msie},getSelectedText:function(){var t=e.Selection.rangeObject;return t.isCollapsed()?!1:this.getFromSelectionTree(t.getSelectionTree(),!0)},getFromSelectionTree:function(e,t){var r="",i,s,o,u;for(i=0,s=e.length;i<s;i++)o=e[i],o.selection=="partial"?o.domobj.nodeType===3?r+=o.domobj.data.substring(o.startOffset,o.endOffset):o.domobj.nodeType===1&&o.children&&(t?r+=this.getFromSelectionTree(o.children,t):(u=n(o.domobj).clone(!1).empty(),u.html(this.getFromSelectionTree(o.children,t)),r+=u.outerHTML())):o.selection=="full"&&(o.domobj.nodeType===3?r+=n(o.domobj).text():o.domobj.nodeType===1&&o.children&&(r+=t?n(o.domobj).text():n(o.domobj).outerHTML()));return r},getSelectedMarkup:function(){var t=e.Selection.rangeObject;return t.isCollapsed()?null:this.getFromSelectionTree(t.getSelectionTree(),!1)},removeSelectedMarkup:function(){var t=e.Selection.rangeObject,n;if(t.isCollapsed())return;n=new e.Selection.SelectionRange,this.removeFromSelectionTree(t.getSelectionTree(),n),n.update(),i.Utils.Dom.doCleanup({merge:!0,removeempty:!0},e.Selection.rangeObject),e.Selection.rangeObject=n,n.correctRange(),n.update(),n.select(),e.Selection.updateSelection()},removeFromSelectionTree:function(e,t){var r,s,o,u,a,f;for(o=0,f=e.length;o<f;o++)u=e[o],u.selection=="partial"?u.domobj.nodeType===3?(s="",u.startOffset>0&&(s+=u.domobj.data.substring(0,u.startOffset)),u.endOffset<u.domobj.data.length&&(s+=u.domobj.data.substring(u.endOffset,u.domobj.data.length)),u.domobj.data=s,t.startContainer||(t.startContainer=t.endContainer=u.domobj,t.startOffset=t.endOffset=u.startOffset)):u.domobj.nodeType===1&&u.children&&(this.removeFromSelectionTree(u.children,t),r?r.nodeName==u.domobj.nodeName&&(n(r).append(n(u.domobj).contents()),n(u.domobj).remove()):r=u.domobj):u.selection=="full"&&(t.startContainer||(a=i.Utils.Dom.searchAdjacentTextNode(u.domobj.parentNode,i.Utils.Dom.getIndexInParent(u.domobj)+1,!1,{blocklevel:!1}),a?(t.startContainer=t.endContainer=a,t.startOffset=t.endOffset=0):(t.startContainer=t.endContainer=u.domobj.parentNode,t.startOffset=t.endOffset=i.Utils.Dom.getIndexInParent(u.domobj)+1)),n(u.domobj).remove())},splitRangeObject:function(t,r){var s=n(t.splitObject),o,u,a;t.update(t.splitObject),o=t.getSelectionTree(),a=this.getSplitFollowUpContainer(t),this.splitRangeObjectHelper(o,t,a),a.hasClass("preparedForRemoval")&&a.removeClass("preparedForRemoval"),u=this.getInsertAfterObject(t,a),n(a).insertAfter(u),t.splitObject.nodeName.toLowerCase()==="li"&&!e.Selection.standardTextLevelSemanticsComparator(t.splitObject,a)&&n(t.splitObject).remove(),t.startContainer=null;var f=a.contents();f.length>0&&f.get(0).nodeType==1&&f.get(0).nodeName.toLowerCase()==="br"&&(t.startContainer=a.get(0)),t.startContainer||(t.startContainer=a.textNodes(!0,!0).first().get(0)),t.startContainer||(t.startContainer=a.textNodes(!1).first().parent().get(0)),t.startContainer?(t.endContainer=t.startContainer,t.startOffset=0,t.endOffset=0):(t.startContainer=t.endContainer=a.parent().get(0),t.startOffset=t.endOffset=i.Utils.Dom.getIndexInParent(a.get(0))),t.update(),t.select()},getInsertAfterObject:function(t,r){var i,s,o;for(s=0;s<t.markupEffectiveAtStart.length;s++){o=t.markupEffectiveAtStart[s],o===t.splitObject&&(i=!0);if(!i)continue;if(e.Selection.canTag1WrapTag2(n(o).parent()[0].nodeName,r[0].nodeName))return o}return!1},getFillUpElement:function(e){return n.browser.msie?!1:n('<br class="aloha-cleanme"/>')},removeElementContentWhitespaceObj:function(e){var t=0,n=[],r,i,s;for(r=0;r<e.length;++r)i=e[r],i.isElementContentWhitespace&&(n[n.length]=r);for(r=0;r<n.length;++r)s=n[r],e.splice(s-t,1),++t},splitRangeObjectHelper:function(t,r,s,o){s||e.Log.warn(this,"no followUpContainer, no inBetweenMarkup, nothing to do...");var u=this.getFillUpElement(r.splitObject),a=n(r.splitObject),f=!1,l,c,h,p,d,v,m;if(t.length>0){d=s.contents(),d.length!==t.length&&this.removeElementContentWhitespaceObj(d);for(c=0,m=t.length;c<m;++c){l=t[c];if(l.selection==="none"&&f===!1||l.domobj&&l.domobj.nodeType===3&&l===t[t.length-1]&&l.startOffset===l.domobj.data.length){s.textNodes().length>1||l.domobj.nodeType===1&&l.children.length===0?d.eq(c).remove():i.Utils.Dom.isSplitObject(s[0])?u?s.html(u):s.empty():(s.empty(),s.addClass("preparedForRemoval"));continue}l.selection!=="none"?(l.domobj&&l.domobj.nodeType===3&&l.startOffset!==undefined&&(h=l.domobj.data,l.startOffset>0?l.domobj.data=h.substr(0,l.startOffset):t.length>1?n(l.domobj).remove():(v=n(l.domobj).parent(),i.Utils.Dom.isSplitObject(v[0])?u?v.html(u):v.empty():v.remove()),h.length-l.startOffset>0?d[c].data=h.substr(l.startOffset,h.length):d.length>1?d.eq(c).remove():i.Utils.Dom.isBlockLevelElement(s[0])?u?s.html(u):s.empty():(s.empty(),s.addClass("preparedForRemoval"))),f=!0,l.children.length>0&&this.splitRangeObjectHelper(l.children,r,d.eq(c),o)):l.selection==="none"&&f===!0&&(p=n(l.domobj).remove())}}else e.Log.error(this,"can not split splitObject due to an empty selection tree");a.find("br.aloha-ephemera:gt(0)").remove(),s.find("br.aloha-ephemera:gt(0)").remove(),a.find(".preparedForRemoval").remove(),s.find(".preparedForRemoval").remove(),a.contents().length===0&&i.Utils.Dom.isSplitObject(a[0])&&u&&a.html(u),s.contents().length===0&&i.Utils.Dom.isSplitObject(s[0])&&u&&s.html(u)},getSplitFollowUpContainer:function(e){var t=e.splitObject.nodeName.toLowerCase(),r,i,s;switch(t){case"h1":case"h2":case"h3":case"h4":case"h5":case"h6":s=n(e.splitObject).textNodes(":not(.aloha-cleanme)").last()[0];if(s&&e.startContainer===s&&e.startOffset===s.length)return r=n("<p></p>"),i=n(e.splitObject).clone().contents(),r.append(i),r;break;case"li":if(e.startContainer.nodeName.toLowerCase()==="br"&&n(e.startContainer).hasClass("aloha-ephemera"))return r=n("<p></p>"),i=n(e.splitObject).clone().contents(),r.append(i),r;if(!e.splitObject.nextSibling&&n.trim(n(e.splitObject).text()).length===0)return r=n("<p></p>"),r}return n(e.splitObject).clone()},transformDomObject:function(e,t,r){var i=n(e),s=n("<"+t+"></"+t+">"),o;if(i[0].attributes)for(o=0;o<i[0].attributes.length;++o)s.attr(i[0].attributes[o].nodeName,i[0].attributes[o].nodeValue);return i[0].style&&i[0].style.cssText&&(s[0].style.cssText=i[0].style.cssText),i.contents().appendTo(s),i.replaceWith(s),r&&(r.startContainer==e&&(r.startContainer=s.get(0)),r.endContainer==e&&(r.endContainer=s.get(0))),s},toString:function(){return"Aloha.Markup"}}),e.Markup=new e.Markup,e.Markup});