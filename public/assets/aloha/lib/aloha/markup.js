/*!
* This file is part of Aloha Editor Project http://aloha-editor.org
* Copyright Â© 2010-2011 Gentics Software GmbH, aloha@gentics.com
* Contributors http://aloha-editor.org/contribution.php
* Licensed unter the terms of http://www.aloha-editor.org/license.html
*/
/*
* Aloha Editor is free software: you can redistribute it and/or modify
* it under the terms of the GNU Affero General Public License as published by
* the Free Software Foundation, either version 3 of the License, or
* (at your option) any later version.*
*
* Aloha Editor is distributed in the hope that it will be useful,
* but WITHOUT ANY WARRANTY; without even the implied warranty of
* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
* GNU Affero General Public License for more details.
*
* You should have received a copy of the GNU Affero General Public License
* along with this program. If not, see <http://www.gnu.org/licenses/>.
*/
define(["aloha/core","util/class","aloha/jquery","aloha/ecma5shims"],function(a,b,c,d){function g(a){return"BR"===a.nodeName}function h(a){return"false"===c(a).attr("contenteditable")}function i(a){return a&&3===a.nodeType}function j(a){return a?i(a)?a.length:a.childNodes.length:0}function k(a){return a?a.nextSibling?i(a.nextSibling)&&!m(a.nextSibling)?k(a.nextSibling):g(a.nextSibling)&&a.nextSibling===a.parentNode.lastChild?k(a.nextSibling):""===a.nextSibling.innerHTML&&!h(a.nextSibling)?k(a.nextSibling):a.nextSibling:a.parentNode?k(a.parentNode):null:null}function l(a){return a?a.previousSibling?i(a.previousSibling)&&!m(a.previousSibling)?l(a.previousSibling):""===a.previousSibling.innerHTML&&!h(a.previousSibling)?l(a.previouSibling):a.previousSibling:a.parentNode?l(a.parentNode):null:null}function m(a){return 0<a.data.replace(/\s+/g,"").length}function n(a,b){return 0===b||b<=a.data.length-a.data.replace(/^\s+/,"").length}function o(a){return a.parent().hasClass("aloha-editable")}function p(a,b){var c=j(a);if(c===b)return!0;var d=i(a);return d&&a.data.replace(/\s+$/,"").length===b?!0:1===c&&!d?g(a.childNodes[0]):!1}function q(a){return c(a).stop(!0).css({opacity:0}).fadeIn(0).delay(100).fadeIn(function(){c(a).css({opacity:1})}),a}function r(b,d){var g=new e.Utils.RangeObject,i=d?l(b):k(b);if(!i||h(i)){var m=c("<div>&nbsp;</div>");d?c(b).before(m):c(b).after(m),g.startContainer=g.endContainer=m[0],g.startOffset=g.endOffset=0,u(g),window.$_alohaPlaceholder=m}else g.startContainer=g.endContainer=i,g.startOffset=g.endOffset=d?j(i):f?1:0,u(g);g.select(),a.trigger("aloha-block-selected",b),a.Selection.preventSelectionChanged()}function s(a,b){return f?d.compareDocumentPosition(a,b)&16:0<c(a).find(b).length}function t(a){var b=a.startContainer,c=a.endContainer,d=window.$_alohaPlaceholder;return d.is(b)||d.is(c)||s(d[0],b)||s(d[0],c)}function u(a){window.$_alohaPlaceholder&&!t(a)&&(0===window.$_alohaPlaceholder.html().replace(/^(&nbsp;)*$/,"").length&&window.$_alohaPlaceholder.remove(),window.$_alohaPlaceholder=null)}var e=window.GENTICS,f=!!(c.browser.msie&&9>parseInt(c.browser.version,10));return a.Markup=b.extend({keyHandlers:{},addKeyHandler:function(a,b){this.keyHandlers[a]||(this.keyHandlers[a]=[]),this.keyHandlers[a].push(b)},insertBreak:function(){var b=a.Selection.rangeObject,d,f,g;b.isCollapsed()||this.removeSelectedMarkup(),g=c("<br/>"),e.Utils.Dom.insertIntoDOM(g,b,a.activeEditable.obj),f=e.Utils.Dom.searchAdjacentTextNode(g.parent().get(0),e.Utils.Dom.getIndexInParent(g.get(0))+1,!1),f&&(nonWSIndex=f.data.search(/\S/),nonWSIndex>0&&(f.data=f.data.substring(nonWSIndex))),b.startContainer=b.endContainer=g.get(0).parentNode,b.startOffset=b.endOffset=e.Utils.Dom.getIndexInParent(g.get(0))+1,b.correctRange(),b.clearCaches(),b.select()},preProcessKeyStrokes:function(b){if(b.type!=="keydown")return!1;var c=a.Selection.rangeObject,d,e;if(this.keyHandlers[b.keyCode]){d=this.keyHandlers[b.keyCode];for(e=0;e<d.length;++e)if(!d[e](b))return!1}return b.keyCode===37||b.keyCode===39?this.processCursor(c,b.keyCode)?(u(a.Selection.rangeObject),!0):!1:b.keyCode===8?(b.preventDefault(),a.execCommand("delete",!1),!1):b.keyCode===46?(a.execCommand("forwarddelete",!1),!1):b.keyCode===13?b.shiftKey?(a.execCommand("insertlinebreak",!1),!1):(a.execCommand("insertparagraph",!1),!1):!0},processCursor:function(a,b){if(!a.isCollapsed())return!0;var d=a.startContainer;if(!d)return!0;var e;if(f){var g=c(d).parents("[contenteditable=false]"),m=g.length>0;if(m){if(!o(g))return!0;e=g[0]}}if(!e){var q=37===b||38===b,s=a.startOffset;if(i(d)){if(q){var t=f&&1===s;if(!t&&!n(d,s))return!0}else if(!p(d,s))return!0}else d=d.childNodes[s===j(d)?s-1:s];e=q?l(d):k(d)}return h(e)?(r(e,q),!1):!0},processShiftEnter:function(a){this.insertHTMLBreak(a.getSelectionTree(),a)},processEnter:function(a){a.splitObject?this.splitRangeObject(a):this.insertHTMLBreak(a.getSelectionTree(),a)},insertHTMLCode:function(b){var d=a.Selection.rangeObject;this.insertHTMLBreak(d.getSelectionTree(),d,c(b))},insertHTMLBreak:function(b,d,f){var g,h,i,j,k,l,m,n,o;f=f?f:c("<br/>");for(g=0,h=b.length;g<h;++g){i=b[g],j=i.domobj?c(i.domobj):undefined;if(i.selection!=="none")if(i.selection=="collapsed")g>0?(k=c(b[g-1].domobj),k.after(f)):(l=c(b[1].domobj),l.before(f)),d.startContainer=d.endContainer=f[0].parentNode,d.startOffset=d.endOffset=e.Utils.Dom.getIndexInParent(f[0])+1,d.correctRange();else if(i.domobj&&i.domobj.nodeType===3){i.domobj.nextSibling&&i.domobj.nextSibling.nodeType==1&&a.Selection.replacingElements[i.domobj.nextSibling.nodeName.toLowerCase()]&&j.after("<br/>");if(this.needEndingBreak()){o=i.domobj;while(o)if(o.nextSibling)o=!1;else{o=o.parentNode;if(e.Utils.Dom.isBlockLevelElement(o)||e.Utils.Dom.isListElement(o))break;o===d.limitObject&&(o=!1)}o&&c(o).append('<br class="aloha-cleanme" />')}j.between(f,i.startOffset),n=0,m=f[0];while(m)m=m.previousSibling,++n;d.startContainer=f[0].parentNode,d.endContainer=f[0].parentNode,d.startOffset=n,d.endOffset=n,d.correctRange()}else i.domobj&&i.domobj.nodeType===1&&(j.parent().find("br.aloha-ephemera").length===0&&(c(d.limitObject).find("br.aloha-ephemera").remove(),c(d.commonAncestorContainer).append(this.getFillUpElement(d.splitObject))),j.after(f),d.startContainer=d.commonAncestorContainer,d.endContainer=d.startContainer,d.startOffset=g+2,d.endOffset=g+2,d.update())}d.select()},needEndingBreak:function(){return!c.browser.msie},getSelectedText:function(){var b=a.Selection.rangeObject;return b.isCollapsed()?!1:this.getFromSelectionTree(b.getSelectionTree(),!0)},getFromSelectionTree:function(a,b){var d="",e,f,g,h;for(e=0,f=a.length;e<f;e++)g=a[e],g.selection=="partial"?g.domobj.nodeType===3?d+=g.domobj.data.substring(g.startOffset,g.endOffset):g.domobj.nodeType===1&&g.children&&(b?d+=this.getFromSelectionTree(g.children,b):(h=c(g.domobj).clone(!1).empty(),h.html(this.getFromSelectionTree(g.children,b)),d+=h.outerHTML())):g.selection=="full"&&(g.domobj.nodeType===3?d+=c(g.domobj).text():g.domobj.nodeType===1&&g.children&&(d+=b?c(g.domobj).text():c(g.domobj).outerHTML()));return d},getSelectedMarkup:function(){var b=a.Selection.rangeObject;return b.isCollapsed()?null:this.getFromSelectionTree(b.getSelectionTree(),!1)},removeSelectedMarkup:function(){var b=a.Selection.rangeObject,c;if(b.isCollapsed())return;c=new a.Selection.SelectionRange,this.removeFromSelectionTree(b.getSelectionTree(),c),c.update(),e.Utils.Dom.doCleanup({merge:!0,removeempty:!0},a.Selection.rangeObject),a.Selection.rangeObject=c,c.correctRange(),c.update(),c.select(),a.Selection.updateSelection()},removeFromSelectionTree:function(a,b){var d,f,g,h,i,j;for(g=0,j=a.length;g<j;g++)h=a[g],h.selection=="partial"?h.domobj.nodeType===3?(f="",h.startOffset>0&&(f+=h.domobj.data.substring(0,h.startOffset)),h.endOffset<h.domobj.data.length&&(f+=h.domobj.data.substring(h.endOffset,h.domobj.data.length)),h.domobj.data=f,b.startContainer||(b.startContainer=b.endContainer=h.domobj,b.startOffset=b.endOffset=h.startOffset)):h.domobj.nodeType===1&&h.children&&(this.removeFromSelectionTree(h.children,b),d?d.nodeName==h.domobj.nodeName&&(c(d).append(c(h.domobj).contents()),c(h.domobj).remove()):d=h.domobj):h.selection=="full"&&(b.startContainer||(i=e.Utils.Dom.searchAdjacentTextNode(h.domobj.parentNode,e.Utils.Dom.getIndexInParent(h.domobj)+1,!1,{blocklevel:!1}),i?(b.startContainer=b.endContainer=i,b.startOffset=b.endOffset=0):(b.startContainer=b.endContainer=h.domobj.parentNode,b.startOffset=b.endOffset=e.Utils.Dom.getIndexInParent(h.domobj)+1)),c(h.domobj).remove())},splitRangeObject:function(b,d){var f=c(b.splitObject),g,h,i;b.update(b.splitObject),g=b.getSelectionTree(),i=this.getSplitFollowUpContainer(b),this.splitRangeObjectHelper(g,b,i),i.hasClass("preparedForRemoval")&&i.removeClass("preparedForRemoval"),h=this.getInsertAfterObject(b,i),c(i).insertAfter(h),b.splitObject.nodeName.toLowerCase()==="li"&&!a.Selection.standardTextLevelSemanticsComparator(b.splitObject,i)&&c(b.splitObject).remove(),b.startContainer=null;var j=i.contents();j.length>0&&j.get(0).nodeType==1&&j.get(0).nodeName.toLowerCase()==="br"&&(b.startContainer=i.get(0)),b.startContainer||(b.startContainer=i.textNodes(!0,!0).first().get(0)),b.startContainer||(b.startContainer=i.textNodes(!1).first().parent().get(0)),b.startContainer?(b.endContainer=b.startContainer,b.startOffset=0,b.endOffset=0):(b.startContainer=b.endContainer=i.parent().get(0),b.startOffset=b.endOffset=e.Utils.Dom.getIndexInParent(i.get(0))),b.update(),b.select()},getInsertAfterObject:function(b,d){var e,f,g;for(f=0;f<b.markupEffectiveAtStart.length;f++){g=b.markupEffectiveAtStart[f],g===b.splitObject&&(e=!0);if(!e)continue;if(a.Selection.canTag1WrapTag2(c(g).parent()[0].nodeName,d[0].nodeName))return g}return!1},getFillUpElement:function(a){return c.browser.msie?!1:c('<br class="aloha-cleanme"/>')},removeElementContentWhitespaceObj:function(a){var b=0,c=[],d,e,f;for(d=0;d<a.length;++d)e=a[d],e.isElementContentWhitespace&&(c[c.length]=d);for(d=0;d<c.length;++d)f=c[d],a.splice(f-b,1),++b},splitRangeObjectHelper:function(b,d,f,g){f||a.Log.warn(this,"no followUpContainer, no inBetweenMarkup, nothing to do...");var h=this.getFillUpElement(d.splitObject),i=c(d.splitObject),j=!1,k,l,m,n,o,p,q;if(b.length>0){o=f.contents(),o.length!==b.length&&this.removeElementContentWhitespaceObj(o);for(l=0,q=b.length;l<q;++l){k=b[l];if(k.selection==="none"&&j===!1||k.domobj&&k.domobj.nodeType===3&&k===b[b.length-1]&&k.startOffset===k.domobj.data.length){f.textNodes().length>1||k.domobj.nodeType===1&&k.children.length===0?o.eq(l).remove():e.Utils.Dom.isSplitObject(f[0])?h?f.html(h):f.empty():(f.empty(),f.addClass("preparedForRemoval"));continue}k.selection!=="none"?(k.domobj&&k.domobj.nodeType===3&&k.startOffset!==undefined&&(m=k.domobj.data,k.startOffset>0?k.domobj.data=m.substr(0,k.startOffset):b.length>1?c(k.domobj).remove():(p=c(k.domobj).parent(),e.Utils.Dom.isSplitObject(p[0])?h?p.html(h):p.empty():p.remove()),m.length-k.startOffset>0?o[l].data=m.substr(k.startOffset,m.length):o.length>1?o.eq(l).remove():e.Utils.Dom.isBlockLevelElement(f[0])?h?f.html(h):f.empty():(f.empty(),f.addClass("preparedForRemoval"))),j=!0,k.children.length>0&&this.splitRangeObjectHelper(k.children,d,o.eq(l),g)):k.selection==="none"&&j===!0&&(n=c(k.domobj).remove())}}else a.Log.error(this,"can not split splitObject due to an empty selection tree");i.find("br.aloha-ephemera:gt(0)").remove(),f.find("br.aloha-ephemera:gt(0)").remove(),i.find(".preparedForRemoval").remove(),f.find(".preparedForRemoval").remove(),i.contents().length===0&&e.Utils.Dom.isSplitObject(i[0])&&h&&i.html(h),f.contents().length===0&&e.Utils.Dom.isSplitObject(f[0])&&h&&f.html(h)},getSplitFollowUpContainer:function(a){var b=a.splitObject.nodeName.toLowerCase(),d,e,f;switch(b){case"h1":case"h2":case"h3":case"h4":case"h5":case"h6":f=c(a.splitObject).textNodes(":not(.aloha-cleanme)").last()[0];if(f&&a.startContainer===f&&a.startOffset===f.length)return d=c("<p></p>"),e=c(a.splitObject).clone().contents(),d.append(e),d;break;case"li":if(a.startContainer.nodeName.toLowerCase()==="br"&&c(a.startContainer).hasClass("aloha-ephemera"))return d=c("<p></p>"),e=c(a.splitObject).clone().contents(),d.append(e),d;if(!a.splitObject.nextSibling&&c.trim(c(a.splitObject).text()).length===0)return d=c("<p></p>"),d}return c(a.splitObject).clone()},transformDomObject:function(a,b,d){var e=c(a),f=c("<"+b+"></"+b+">"),g;if(e[0].attributes)for(g=0;g<e[0].attributes.length;++g)f.attr(e[0].attributes[g].nodeName,e[0].attributes[g].nodeValue);return e[0].style&&e[0].style.cssText&&(f[0].style.cssText=e[0].style.cssText),e.contents().appendTo(f),e.replaceWith(f),d&&(d.startContainer==a&&(d.startContainer=f.get(0)),d.endContainer==a&&(d.endContainer=f.get(0))),f},toString:function(){return"Aloha.Markup"}}),a.Markup=new a.Markup,a.Markup});