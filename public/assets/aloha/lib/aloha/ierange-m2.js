/*!
 * This file is part of Aloha Editor
 * Author & Copyright (c) 2010 Gentics Software GmbH, aloha@gentics.com
 * Licensed unter the terms of http://www.aloha-editor.com/license.html
 */
(function(a,b){var c=a.alohaQuery||a.jQuery,d=c,e,f,g,h,i,j;document.attachEvent&&document.selection&&(e={findChildPosition:function(a){for(var b=0;a=a.previousSibling;b++)continue;return b},isDataNode:function(a){return a&&a.nodeValue!==null&&a.data!==null},isAncestorOf:function(a,b){return!e.isDataNode(a)&&(a.contains(e.isDataNode(b)?b.parentNode:b)||b.parentNode==a)},isAncestorOrSelf:function(a,b){return e.isAncestorOf(a,b)||a==b},findClosestAncestor:function(a,b){if(e.isAncestorOf(a,b))while(b&&b.parentNode!=a)b=b.parentNode;return b},getNodeLength:function(a){return e.isDataNode(a)?a.length:a.childNodes.length},splitDataNode:function(a,b){if(!e.isDataNode(a))return!1;var c=a.cloneNode(!1);a.deleteData(b,a.length),c.deleteData(0,b),a.parentNode.insertBefore(c,a.nextSibling)}},f={convertToDOMRange:function(a,b){var c,d;return d=function(a,c,d){var e=b.createElement("a"),f=c.duplicate(),g;f.collapse(d),g=f.parentElement();do g.insertBefore(e,e.previousSibling),f.moveToElementText(e);while(f.compareEndPoints(d?"StartToStart":"StartToEnd",c)>0&&e.previousSibling);f.compareEndPoints(d?"StartToStart":"StartToEnd",c)==-1&&e.nextSibling?(f.setEndPoint(d?"EndToStart":"EndToEnd",c),a[d?"setStart":"setEnd"](e.nextSibling,f.text.length)):a[d?"setStartBefore":"setEndBefore"](e),e.parentNode.removeChild(e)},c=new h(b),d(c,a,!0),d(c,a,!1),c},convertFromDOMRange:function(a){function b(a,b,c){var d=b[c?"startContainer":"endContainer"],f=b[c?"startOffset":"endOffset"],g=0,h=e.isDataNode(d)?d:d.childNodes[f],i=e.isDataNode(d)?d.parentNode:d,j,k;if(d.nodeType==3||d.nodeType==4)g=f;j=b._document.createElement("a"),i.insertBefore(j,h),k=b._document.body.createTextRange(),k.moveToElementText(j),j.parentNode.removeChild(j),a.setEndPoint(c?"StartToStart":"EndToStart",k),a[c?"moveStart":"moveEnd"]("character",g)}var c=a._document.body.createTextRange();return b(c,a,!0),b(c,a,!1),c}},h=function(a){this._document=a,this.startContainer=this.endContainer=a.body,this.endOffset=e.getNodeLength(a.body)},h.START_TO_START=0,h.START_TO_END=1,h.END_TO_END=2,h.END_TO_START=3,h.prototype={startContainer:null,startOffset:0,endContainer:null,endOffset:0,commonAncestorContainer:null,collapsed:!1,_document:null,_refreshProperties:function(){this.collapsed=this.startContainer==this.endContainer&&this.startOffset==this.endOffset;var a=this.startContainer;while(a&&a!=this.endContainer&&!e.isAncestorOf(a,this.endContainer))a=a.parentNode;this.commonAncestorContainer=a},setStart:function(a,b){this.startContainer=a,this.startOffset=b,this._refreshProperties()},setEnd:function(a,b){this.endContainer=a,this.endOffset=b,this._refreshProperties()},setStartBefore:function(a){this.setStart(a.parentNode,e.findChildPosition(a))},setStartAfter:function(a){this.setStart(a.parentNode,e.findChildPosition(a)+1)},setEndBefore:function(a){this.setEnd(a.parentNode,e.findChildPosition(a))},setEndAfter:function(a){this.setEnd(a.parentNode,e.findChildPosition(a)+1)},selectNode:function(a){this.setStartBefore(a),this.setEndAfter(a)},selectNodeContents:function(a){this.setStart(a,0),this.setEnd(a,e.getNodeLength(a))},collapse:function(a){a?this.setEnd(this.startContainer,this.startOffset):this.setStart(this.endContainer,this.endOffset)},cloneContents:function(){return function a(b){for(var c,d=document.createDocumentFragment();c=b.next();)c=c.cloneNode(!b.hasPartialSubtree()),b.hasPartialSubtree()&&c.appendChild(a(b.getSubtreeIterator())),d.appendChild(c);return d}(new i(this))},extractContents:function(){var a=this.cloneRange();return this.startContainer!=this.commonAncestorContainer&&this.setStartAfter(e.findClosestAncestor(this.commonAncestorContainer,this.startContainer)),this.collapse(!0),function b(a){for(var c,d=document.createDocumentFragment();c=a.next();)a.hasPartialSubtree()?c=c.cloneNode(!1):a.remove(),a.hasPartialSubtree()&&c.appendChild(b(a.getSubtreeIterator())),d.appendChild(c);return d}(new i(a))},deleteContents:function(){var a=this.cloneRange();this.startContainer!=this.commonAncestorContainer&&this.setStartAfter(e.findClosestAncestor(this.commonAncestorContainer,this.startContainer)),this.collapse(!0),function b(a){while(a.next())a.hasPartialSubtree()?b(a.getSubtreeIterator()):a.remove()}(new i(a))},insertNode:function(a){e.isDataNode(this.startContainer)?(e.splitDataNode(this.startContainer,this.startOffset),this.startContainer.parentNode.insertBefore(a,this.startContainer.nextSibling)):this.startContainer.insertBefore(a,this.startContainer.childNodes[this.startOffset]),this.setStart(this.startContainer,this.startOffset)},surroundContents:function(a){var b=this.extractContents();this.insertNode(a),a.appendChild(b),this.selectNode(a)},compareBoundaryPoints:function(a,b){var c,d,e,f;switch(a){case h.START_TO_START:case h.START_TO_END:c=this.startContainer,d=this.startOffset;break;case h.END_TO_END:case h.END_TO_START:c=this.endContainer,d=this.endOffset}switch(a){case h.START_TO_START:case h.END_TO_START:e=b.startContainer,f=b.startOffset;break;case h.START_TO_END:case h.END_TO_END:e=b.endContainer,f=b.endOffset}return c.sourceIndex<e.sourceIndex?-1:c.sourceIndex==e.sourceIndex?d<f?-1:d==f?0:1:1},cloneRange:function(){var a=new h(this._document);return a.setStart(this.startContainer,this.startOffset),a.setEnd(this.endContainer,this.endOffset),a},detach:function(){},toString:function(){return f.convertFromDOMRange(this).text},createContextualFragment:function(a){var b=(e.isDataNode(this.startContainer)?this.startContainer.parentNode:this.startContainer).cloneNode(!1),c;b.innerHTML=a;for(c=this._document.createDocumentFragment();b.firstChild;)c.appendChild(b.firstChild);return c}},i=function(a){this.range=a;if(a.collapsed)return;var b=a.commonAncestorContainer;this._next=a.startContainer==b&&!e.isDataNode(a.startContainer)?a.startContainer.childNodes[a.startOffset]:e.findClosestAncestor(b,a.startContainer),this._end=a.endContainer==b&&!e.isDataNode(a.endContainer)?a.endContainer.childNodes[a.endOffset]:e.findClosestAncestor(b,a.endContainer).nextSibling},i.prototype={range:null,_current:null,_next:null,_end:null,hasNext:function(){return!!this._next},next:function(){var a=this._current=this._next;return this._next=this._current&&this._current.nextSibling!=this._end?this._current.nextSibling:null,e.isDataNode(this._current)&&(this.range.endContainer==this._current&&(a=a.cloneNode(!0)).deleteData(this.range.endOffset,a.length-this.range.endOffset),this.range.startContainer==this._current&&(a=a.cloneNode(!0)).deleteData(0,this.range.startOffset)),a},remove:function(){var a,b;!e.isDataNode(this._current)||this.range.startContainer!=this._current&&this.range.endContainer!=this._current?this._current.parentNode.removeChild(this._current):(b=this.range.startContainer==this._current?this.range.startOffset:0,a=this.range.endContainer==this._current?this.range.endOffset:this._current.length,this._current.deleteData(b,a-b))},hasPartialSubtree:function(){return!e.isDataNode(this._current)&&(e.isAncestorOrSelf(this._current,this.range.startContainer)||e.isAncestorOrSelf(this._current,this.range.endContainer))},getSubtreeIterator:function(){var a=new h(this.range._document);return a.selectNodeContents(this._current),e.isAncestorOrSelf(this._current,this.range.startContainer)&&a.setStart(this.range.startContainer,this.range.startOffset),e.isAncestorOrSelf(this._current,this.range.endContainer)&&a.setEnd(this.range.endContainer,this.range.endOffset),new i(a)}},j=function(a){this._document=a;var b=this;a.attachEvent("onselectionchange",function(){b._selectionChangeHandler()})},j.prototype={rangeCount:0,_document:null,_selectionChangeHandler:function(){this.rangeCount=this._selectionExists(this._document.selection.createRange())?1:0},_selectionExists:function(a){return a.compareEndPoints("StartToEnd",a)!==0||a.parentElement().isContentEditable},addRange:function(a){var b=this._document.selection.createRange(),c=f.convertFromDOMRange(a);this._selectionExists(b)?(c.compareEndPoints("StartToStart",b)==-1&&(c.compareEndPoints("StartToEnd",b)>-1&&c.compareEndPoints("EndToEnd",b)==-1?b.setEndPoint("StartToStart",c):c.compareEndPoints("EndToStart",b)<1&&c.compareEndPoints("EndToEnd",b)>-1&&b.setEndPoint("EndToEnd",c)),b.select()):c.select()},removeAllRanges:function(){this._document.selection.empty()},getRangeAt:function(a){var b=this._document.selection.createRange();return this._selectionExists(b)?f.convertToDOMRange(b,this._document):null},toString:function(){return this._document.selection.createRange().text}},document.createRange=function(){return new h(document)},g=new j(document),a.getSelection=function(){return g})})(window);