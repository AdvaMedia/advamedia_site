/*!
 * This file is part of Aloha Editor
 * Author & Copyright (c) 2010 Gentics Software GmbH, aloha@gentics.com
 * Licensed unter the terms of http://www.aloha-editor.com/license.html
 */
(function(e,t){var n=e.alohaQuery||e.jQuery,r=n,i,s,o,u,a,f;document.attachEvent&&document.selection&&(i={findChildPosition:function(e){for(var t=0;e=e.previousSibling;t++)continue;return t},isDataNode:function(e){return e&&e.nodeValue!==null&&e.data!==null},isAncestorOf:function(e,t){return!i.isDataNode(e)&&(e.contains(i.isDataNode(t)?t.parentNode:t)||t.parentNode==e)},isAncestorOrSelf:function(e,t){return i.isAncestorOf(e,t)||e==t},findClosestAncestor:function(e,t){if(i.isAncestorOf(e,t))while(t&&t.parentNode!=e)t=t.parentNode;return t},getNodeLength:function(e){return i.isDataNode(e)?e.length:e.childNodes.length},splitDataNode:function(e,t){if(!i.isDataNode(e))return!1;var n=e.cloneNode(!1);e.deleteData(t,e.length),n.deleteData(0,t),e.parentNode.insertBefore(n,e.nextSibling)}},s={convertToDOMRange:function(e,t){var n,r;return r=function(e,n,r){var i=t.createElement("a"),s=n.duplicate(),o;s.collapse(r),o=s.parentElement();do o.insertBefore(i,i.previousSibling),s.moveToElementText(i);while(s.compareEndPoints(r?"StartToStart":"StartToEnd",n)>0&&i.previousSibling);s.compareEndPoints(r?"StartToStart":"StartToEnd",n)==-1&&i.nextSibling?(s.setEndPoint(r?"EndToStart":"EndToEnd",n),e[r?"setStart":"setEnd"](i.nextSibling,s.text.length)):e[r?"setStartBefore":"setEndBefore"](i),i.parentNode.removeChild(i)},n=new u(t),r(n,e,!0),r(n,e,!1),n},convertFromDOMRange:function(e){function t(e,t,n){var r=t[n?"startContainer":"endContainer"],s=t[n?"startOffset":"endOffset"],o=0,u=i.isDataNode(r)?r:r.childNodes[s],a=i.isDataNode(r)?r.parentNode:r,f,l;if(r.nodeType==3||r.nodeType==4)o=s;f=t._document.createElement("a"),a.insertBefore(f,u),l=t._document.body.createTextRange(),l.moveToElementText(f),f.parentNode.removeChild(f),e.setEndPoint(n?"StartToStart":"EndToStart",l),e[n?"moveStart":"moveEnd"]("character",o)}var n=e._document.body.createTextRange();return t(n,e,!0),t(n,e,!1),n}},u=function(e){this._document=e,this.startContainer=this.endContainer=e.body,this.endOffset=i.getNodeLength(e.body)},u.START_TO_START=0,u.START_TO_END=1,u.END_TO_END=2,u.END_TO_START=3,u.prototype={startContainer:null,startOffset:0,endContainer:null,endOffset:0,commonAncestorContainer:null,collapsed:!1,_document:null,_refreshProperties:function(){this.collapsed=this.startContainer==this.endContainer&&this.startOffset==this.endOffset;var e=this.startContainer;while(e&&e!=this.endContainer&&!i.isAncestorOf(e,this.endContainer))e=e.parentNode;this.commonAncestorContainer=e},setStart:function(e,t){this.startContainer=e,this.startOffset=t,this._refreshProperties()},setEnd:function(e,t){this.endContainer=e,this.endOffset=t,this._refreshProperties()},setStartBefore:function(e){this.setStart(e.parentNode,i.findChildPosition(e))},setStartAfter:function(e){this.setStart(e.parentNode,i.findChildPosition(e)+1)},setEndBefore:function(e){this.setEnd(e.parentNode,i.findChildPosition(e))},setEndAfter:function(e){this.setEnd(e.parentNode,i.findChildPosition(e)+1)},selectNode:function(e){this.setStartBefore(e),this.setEndAfter(e)},selectNodeContents:function(e){this.setStart(e,0),this.setEnd(e,i.getNodeLength(e))},collapse:function(e){e?this.setEnd(this.startContainer,this.startOffset):this.setStart(this.endContainer,this.endOffset)},cloneContents:function(){return function e(t){for(var n,r=document.createDocumentFragment();n=t.next();)n=n.cloneNode(!t.hasPartialSubtree()),t.hasPartialSubtree()&&n.appendChild(e(t.getSubtreeIterator())),r.appendChild(n);return r}(new a(this))},extractContents:function(){var e=this.cloneRange();return this.startContainer!=this.commonAncestorContainer&&this.setStartAfter(i.findClosestAncestor(this.commonAncestorContainer,this.startContainer)),this.collapse(!0),function t(e){for(var n,r=document.createDocumentFragment();n=e.next();)e.hasPartialSubtree()?n=n.cloneNode(!1):e.remove(),e.hasPartialSubtree()&&n.appendChild(t(e.getSubtreeIterator())),r.appendChild(n);return r}(new a(e))},deleteContents:function(){var e=this.cloneRange();this.startContainer!=this.commonAncestorContainer&&this.setStartAfter(i.findClosestAncestor(this.commonAncestorContainer,this.startContainer)),this.collapse(!0),function t(e){while(e.next())e.hasPartialSubtree()?t(e.getSubtreeIterator()):e.remove()}(new a(e))},insertNode:function(e){i.isDataNode(this.startContainer)?(i.splitDataNode(this.startContainer,this.startOffset),this.startContainer.parentNode.insertBefore(e,this.startContainer.nextSibling)):this.startContainer.insertBefore(e,this.startContainer.childNodes[this.startOffset]),this.setStart(this.startContainer,this.startOffset)},surroundContents:function(e){var t=this.extractContents();this.insertNode(e),e.appendChild(t),this.selectNode(e)},compareBoundaryPoints:function(e,t){var n,r,i,s;switch(e){case u.START_TO_START:case u.START_TO_END:n=this.startContainer,r=this.startOffset;break;case u.END_TO_END:case u.END_TO_START:n=this.endContainer,r=this.endOffset}switch(e){case u.START_TO_START:case u.END_TO_START:i=t.startContainer,s=t.startOffset;break;case u.START_TO_END:case u.END_TO_END:i=t.endContainer,s=t.endOffset}return n.sourceIndex<i.sourceIndex?-1:n.sourceIndex==i.sourceIndex?r<s?-1:r==s?0:1:1},cloneRange:function(){var e=new u(this._document);return e.setStart(this.startContainer,this.startOffset),e.setEnd(this.endContainer,this.endOffset),e},detach:function(){},toString:function(){return s.convertFromDOMRange(this).text},createContextualFragment:function(e){var t=(i.isDataNode(this.startContainer)?this.startContainer.parentNode:this.startContainer).cloneNode(!1),n;t.innerHTML=e;for(n=this._document.createDocumentFragment();t.firstChild;)n.appendChild(t.firstChild);return n}},a=function(e){this.range=e;if(e.collapsed)return;var t=e.commonAncestorContainer;this._next=e.startContainer==t&&!i.isDataNode(e.startContainer)?e.startContainer.childNodes[e.startOffset]:i.findClosestAncestor(t,e.startContainer),this._end=e.endContainer==t&&!i.isDataNode(e.endContainer)?e.endContainer.childNodes[e.endOffset]:i.findClosestAncestor(t,e.endContainer).nextSibling},a.prototype={range:null,_current:null,_next:null,_end:null,hasNext:function(){return!!this._next},next:function(){var e=this._current=this._next;return this._next=this._current&&this._current.nextSibling!=this._end?this._current.nextSibling:null,i.isDataNode(this._current)&&(this.range.endContainer==this._current&&(e=e.cloneNode(!0)).deleteData(this.range.endOffset,e.length-this.range.endOffset),this.range.startContainer==this._current&&(e=e.cloneNode(!0)).deleteData(0,this.range.startOffset)),e},remove:function(){var e,t;!i.isDataNode(this._current)||this.range.startContainer!=this._current&&this.range.endContainer!=this._current?this._current.parentNode.removeChild(this._current):(t=this.range.startContainer==this._current?this.range.startOffset:0,e=this.range.endContainer==this._current?this.range.endOffset:this._current.length,this._current.deleteData(t,e-t))},hasPartialSubtree:function(){return!i.isDataNode(this._current)&&(i.isAncestorOrSelf(this._current,this.range.startContainer)||i.isAncestorOrSelf(this._current,this.range.endContainer))},getSubtreeIterator:function(){var e=new u(this.range._document);return e.selectNodeContents(this._current),i.isAncestorOrSelf(this._current,this.range.startContainer)&&e.setStart(this.range.startContainer,this.range.startOffset),i.isAncestorOrSelf(this._current,this.range.endContainer)&&e.setEnd(this.range.endContainer,this.range.endOffset),new a(e)}},f=function(e){this._document=e;var t=this;e.attachEvent("onselectionchange",function(){t._selectionChangeHandler()})},f.prototype={rangeCount:0,_document:null,_selectionChangeHandler:function(){this.rangeCount=this._selectionExists(this._document.selection.createRange())?1:0},_selectionExists:function(e){return e.compareEndPoints("StartToEnd",e)!==0||e.parentElement().isContentEditable},addRange:function(e){var t=this._document.selection.createRange(),n=s.convertFromDOMRange(e);this._selectionExists(t)?(n.compareEndPoints("StartToStart",t)==-1&&(n.compareEndPoints("StartToEnd",t)>-1&&n.compareEndPoints("EndToEnd",t)==-1?t.setEndPoint("StartToStart",n):n.compareEndPoints("EndToStart",t)<1&&n.compareEndPoints("EndToEnd",t)>-1&&t.setEndPoint("EndToEnd",n)),t.select()):n.select()},removeAllRanges:function(){this._document.selection.empty()},getRangeAt:function(e){var t=this._document.selection.createRange();return this._selectionExists(t)?s.convertToDOMRange(t,this._document):null},toString:function(){return this._document.selection.createRange().text}},document.createRange=function(){return new u(document)},o=new f(document),e.getSelection=function(){return o})})(window);