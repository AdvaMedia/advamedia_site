/*!
* This file is part of Aloha Editor Project http://aloha-editor.org
* Copyright (c) 2010-2011 Gentics Software GmbH, aloha@gentics.com
* Contributors http://aloha-editor.org/contribution.php 
* Licensed unter the terms of http://www.aloha-editor.org/license.html
*/
/*
* Aloha Editor is free software: you can redistribute it and/or modify
* it under the terms of the GNU Affero General Public License as published by
* the Free Software Foundation, either version 3 of the License, or
* (at your option) any later version.*
*
* Aloha Editor is distributed in the hope that it will be useful,
* but WITHOUT ANY WARRANTY; without even the implied warranty of
* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
* GNU Affero General Public License for more details.
*
* You should have received a copy of the GNU Affero General Public License
* along with this program. If not, see <http://www.gnu.org/licenses/>.
*/
define(["aloha/core","aloha/jquery","aloha/ext","util/class","aloha/console","vendor/jquery.store"],function(a,b,c,d,e){function j(c){if(!a.activeEditable)return;var d=c.obj,e=a.activeEditable.obj.offset(),f=c.behaviour==="topalign",g=c.behaviour==="append",h=c.pinned&&parseInt(d.css("left"),10)!=e.left+c.horizontalOffset;if(f&&h||g)return;var i=d.height(),j=b(document).scrollTop(),k=e.top-i+c.marginTop-c.topalignOffset;j>k?e.top=f?j+c.marginTop:c.marginTop:j<=k&&(e.top-=i+(f?c.marginTop+c.topalignOffset:0)),c.floatTo(e)}var f=window.GENTICS,g=d.extend({_constructor:function(a){this.label=a,this.groups=[],this.groupMap={},this.visible=!0},getGroup:function(a){var b=this.groupMap[a];return typeof b=="undefined"&&(b=new h,this.groupMap[a]=b,this.groups.push(b)),b},getExtComponent:function(){var a=this;return this.extPanel||(this.extPanel=new c.Panel({tbar:[],title:this.label,style:"margin-top:0px",bodyStyle:"display:none",autoScroll:!0})),b.each(this.groups,function(b,c){c.extButtonGroup||a.extPanel.getTopToolbar().add(c.getExtComponent())}),this.extPanel},doLayout:function(){var c=this;return a.Log.isDebugEnabled()&&a.Log.debug(this,"doLayout called for tab "+this.label),this.visible=!1,b.each(this.groups,function(a,b){c.visible|=b.doLayout()}),a.Log.isDebugEnabled()&&a.Log.debug(this,"tab "+this.label+(this.visible?" is ":" is not ")+"visible now"),this.visible}}),h=d.extend({_constructor:function(){this.buttons=[],this.fields=[]},addButton:function(b){if(b.button instanceof a.ui.AttributeField){if(!(this.fields.length<2))throw new Error("Too much fields in this group");this.fields.push(b)}else typeof b.button!="undefined"&&this.buttons.push(b)},getExtComponent:function(){var a=this,d,e=[],f=0,g=0,h,i,j;if(typeof this.extButtonGroup=="undefined"){this.fields.length>1&&(g=1),b.each(this.buttons,function(a,b){f+=b.button.size=="small"?1:2}),g+=Math.ceil(f/2),h=this.buttons.length,i=0,j=Math.ceil(this.buttons.length/2)-this.buttons.length%2,this.fields.length>0&&(a.buttons.push(this.fields[0]),e.push(this.fields[0].button.getExtConfigProperties()));while(--h>=j)e.push(this.buttons[i++].button.getExtConfigProperties());++h,this.fields.length>1&&(a.buttons.push(this.fields[1]),e.push(this.fields[1].button.getExtConfigProperties()));while(--h>=0)e.push(this.buttons[i++].button.getExtConfigProperties());this.extButtonGroup=new c.ButtonGroup({columns:g,items:e}),b.each(this.buttons,function(b,c){c.button.extButton=a.extButtonGroup.findById(c.button.id);if(c.button.listenerQueue&&c.button.listenerQueue.length>0)for(;;){d=c.button.listenerQueue.shift();if(!d)break;c.button.extButton.addListener(d.eventName,d.handler,d.scope,d.options)}c.button.extButton.setObjectTypeFilter&&(c.button.objectTypeFilter&&(c.button.extButton.noQuery=!1),c.button.objectTypeFilter=="all"&&(c.button.objectTypeFilter=null),c.button.extButton.setObjectTypeFilter(c.button.objectTypeFilter),c.button.displayField&&(c.button.extButton.displayField=c.button.displayField),c.button.tpl&&(c.button.extButton.tpl=c.button.tpl))})}return this.extButtonGroup},doLayout:function(){var a=!1,c=this;return b.each(this.buttons,function(b,d){if(typeof d.button!="undefined"){var e=c.extButtonGroup.findById(d.button.id),f=d.button.isVisible()&&d.scopeVisible;if(!e)return;f&&e.hidden?e.show():!f&&e&&!e.hidden&&e.hide(),a|=f}}),a&&this.extButtonGroup.hidden?this.extButtonGroup.show():!a&&!this.extButtonGroup.hidden&&this.extButtonGroup.hide(),a}}),i={top:null,left:null},k=d.extend({scopes:{"Aloha.empty":{name:"Aloha.empty",extendedScopes:[],buttons:[]},"Aloha.global":{name:"Aloha.global",extendedScopes:["Aloha.empty"],buttons:[]},"Aloha.continuoustext":{name:"Aloha.continuoustext",extendedScopes:["Aloha.global"],buttons:[]}},tabs:[],tabMap:{},initialized:!1,allButtons:[],top:100,left:100,pinned:!1,window:b(window),behaviour:"float",element:"floatingmenu",topalignOffset:0,horizontalOffset:0,marginTop:10,draggable:!0,pin:!1,buttonsAdded:[],fromConfig:!1,init:function(){a.settings.floatingmenu&&(typeof a.settings.floatingmenu.draggable=="boolean"&&(this.draggable=a.settings.floatingmenu.draggable),typeof a.settings.floatingmenu.behaviour=="string"&&(this.behaviour=a.settings.floatingmenu.behaviour),typeof a.settings.floatingmenu.topalignOffset!="undefined"&&(this.topalignOffset=parseInt(a.settings.floatingmenu.topalignOffset,10)),typeof a.settings.floatingmenu.horizontalOffset!="undefined"&&(this.horizontalOffset=parseInt(a.settings.floatingmenu.horizontalOffset,10)),typeof a.settings.floatingmenu.marginTop=="number"&&(this.marginTop=parseInt(a.settings.floatingmenu.marginTop,10)),typeof a.settings.floatingmenu.element=="string"&&(this.element=a.settings.floatingmenu.element),typeof a.settings.floatingmenu.pin=="boolean"&&(this.pin=a.settings.floatingmenu.pin),typeof a.settings.floatingmenu.width!="undefined"&&(this.width=parseInt(a.settings.floatingmenu.width,10))),b.storage=new b.store,this.currentScope="Aloha.global";var c=this;this.window.unload(function(){c.pinned?(b.storage.set("Aloha.FloatingMenu.pinned","true"),b.storage.set("Aloha.FloatingMenu.top",c.top),b.storage.set("Aloha.FloatingMenu.left",c.left),a.Log.isInfoEnabled()&&a.Log.info(this,"stored FloatingMenu pinned position {"+c.left+", "+c.top+"}")):(b.storage.del("Aloha.FloatingMenu.pinned"),b.storage.del("Aloha.FloatingMenu.top"),b.storage.del("Aloha.FloatingMenu.left")),c.userActivatedTab&&b.storage.set("Aloha.FloatingMenu.activeTab",c.userActivatedTab)}).resize(function(){if(c.behaviour==="float")if(c.pinned)c.fixPinnedPosition(),c.refreshShadow(),c.extTabPanel.setPosition(c.left,c.top);else{var b=c.calcFloatTarget(a.Selection.getRangeObject());b&&c.floatTo(b)}}),a.bind("aloha-ready",function(){c.generateComponent(),c.initialized=!0}),typeof a.settings.toolbar=="object"&&(this.fromConfig=!0)},obj:null,shadow:null,panelBody:null,width:400,initTabsAndGroups:function(){var c=this;if(!this.fromConfig)return;b.each(a.settings.toolbar.tabs,function(a,d){var f=c.tabMap[a];typeof f=="undefined"&&(f=new g(a),c.tabs.push(f),c.tabMap[a]=f),b.each(d,function(d,g){var h=f.getGroup(d),i;b.each(g,function(f,g){if(b.inArray(g,c.buttonsAdded)!==-1){e.warn("Skipping button {"+g+"}. A button can't be added "+"to the floating menu twice. Config key: {Aloha.settings.toolbar."+a+"."+d+"}");return}for(i=0;i<c.allButtons.length;i++)if(g===c.allButtons[i].button.name){h.addButton(c.allButtons[i]),c.buttonsAdded.push(c.allButtons[i].button.name);break}})})})},generateComponent:function(){var d=this,e;this.initTabsAndGroups(),c.QuickTips.init(),c.apply(c.QuickTips.getQuickTip(),{minWidth:10});if(!this.extTabPanel){var f=!1;d.draggable&&(f={insertProxy:!1,onDrag:function(a){var b=this.proxy.getEl();this.x=b.getLeft(!0),this.y=b.getTop(!0),this.panel.shadow.hide()},endDrag:function(a){var c=d.pinned?this.y-b(document).scrollTop():this.y;d.left=this.x,d.top=c,i.left=d.left,i.top=d.top,this.panel.setPosition(this.x,c),d.refreshShadow(),this.panel.shadow.show()}}),this.extTabPanel=new c.TabPanel({activeTab:0,width:d.width,plain:!1,draggable:f,floating:{shadow:!1},defaults:{autoScroll:!0},layoutOnTabChange:!0,shadow:!1,cls:"aloha-floatingmenu ext-root",listeners:{tabchange:{fn:function(c,e){e.title!=d.autoActivatedTab?(a.Log.isDebugEnabled()&&a.Log.debug(d,"User selected tab "+e.title),d.userActivatedTab=e.title):a.Log.isDebugEnabled()&&a.Log.debug(d,"Tab "+e.title+" was activated automatically"),d.autoActivatedTab=undefined,b.each(d.allButtons,function(a,b){typeof b.button!="undefined"&&typeof b.button.extButton!="undefined"&&b.button.extButton!==null&&typeof b.button.extButton.setActiveDOMElement=="function"&&typeof b.button.extButton.activeDOMElement!="undefined"&&b.button.extButton.setActiveDOMElement(b.button.extButton.activeDOMElement)}),d.extTabPanel.isVisible()&&(d.extTabPanel.shadow.show(),d.refreshShadow())}}},enableTabScroll:!0})}b.each(this.tabs,function(b,c){try{d.extTabPanel.add(c.getExtComponent())}catch(e){a.Log.error(d,"Error while inserting tab: "+e)}}),this.extTabPanel.shadow||(this.extTabPanel.shadow=b('<div id="aloha-floatingmenu-shadow" class="aloha-shadow">&#160;</div>').hide(),b("body").append(this.extTabPanel.shadow)),e=this.extTabPanel.add({title:"&#160;"}),this.extTabPanel.render(document.body),b(e.tabEl).addClass("aloha-floatingmenu-pin").html("&#160;").mousedown(function(a){d.togglePin(),a.stopPropagation()}),this.panelBody=b("div.aloha-floatingmenu div.x-tab-panel-bwrap"),this.doLayout(),this.obj=b(this.extTabPanel.getEl().dom),b.storage.get("Aloha.FloatingMenu.pinned")=="true"&&(this.top=parseInt(b.storage.get("Aloha.FloatingMenu.top"),10),this.left=parseInt(b.storage.get("Aloha.FloatingMenu.left"),10),this.fixPinnedPosition(),a.Log.isInfoEnabled()&&a.Log.info(this,"restored FloatingMenu pinned position {"+this.left+", "+this.top+"}"),this.refreshShadow()),b.storage.get("Aloha.FloatingMenu.activeTab")&&(this.userActivatedTab=b.storage.get("Aloha.FloatingMenu.activeTab")),this.extTabPanel.setPosition(this.left,this.top),this.obj.mousedown(function(b){b.originalEvent.stopSelectionUpdate=!0,a.eventHandled=!0}),this.obj.mouseup(function(b){b.originalEvent.stopSelectionUpdate=!0,a.eventHandled=!1}),b(window).scroll(function(){j(d)}),d.draggable||b(".aloha-floatingmenu").hover(function(){b(this).css({background:"none"}),b(".aloha-floatingmenu-pin").hide()});if(this.behaviour==="float")a.bind("aloha-selection-changed",function(a,b){if(!d.pinned){var c=d.calcFloatTarget(b);c&&d.floatTo(c)}});else if(this.behaviour==="append"){var g=b("#"+d.element),h=g.offset();if(!h)return a.Log.warn(d,"Invalid element HTML ID for floating menu: "+d.element),!1;this.floatTo(h),this.pin&&this.togglePin(!0),a.bind("aloha-editable-activated",function(a,b){if(d.pinned)return;d.floatTo(h)})}else this.behaviour==="topalign"&&(this.togglePin(!1),a.bind("aloha-editable-activated",function(a,c){if(d.pinned)return;var e=c.editable.obj,f=90,g=e.offset(),h=g.top-f<b(document).scrollTop();h?(g.top=e.height()<f?g.top+e.height():b(document).scrollTop(),g.top+=d.marginTop):g.top-=f+d.topalignOffset,g.left+=d.horizontalOffset;var i=10,j=g.left+d.width+i-b(window).width();j>0&&(g.left-=j),d.floatTo(g)}))},fixPinnedPosition:function(){if(!this.pinned)return;this.top<30?this.top=30:this.top>this.window.height()-this.extTabPanel.getHeight()&&(this.top=this.window.height()-this.extTabPanel.getHeight()),this.left<0?this.left=0:this.left>this.window.width()-this.extTabPanel.getWidth()&&(this.left=this.window.width()-this.extTabPanel.getWidth())},refreshShadow:function(a){if(this.panelBody){var b={top:this.top+24,left:this.left};if(typeof a=="undefined"||!a)b.width=this.panelBody.width()+"px",b.height=this.panelBody.height()+"px";this.extTabPanel.shadow.css(b)}},togglePin:function(a){var c=b(".aloha-floatingmenu-pin");typeof a=="boolean"&&(this.pinned=!a),this.pinned?(c.removeClass("aloha-floatingmenu-pinned"),this.top=this.obj.offset().top,this.obj.removeClass("fixed").css({top:this.top}),this.extTabPanel.shadow.removeClass("fixed"),this.refreshShadow(),this.pinned=!1):(c.addClass("aloha-floatingmenu-pinned"),this.top=this.obj.offset().top-this.window.scrollTop(),this.obj.addClass("fixed").css({top:this.top}),this.extTabPanel.shadow.addClass("fixed"),this.refreshShadow(),this.pinned=!0)},createScope:function(a,b){typeof b=="undefined"?b=["Aloha.empty"]:typeof b=="string"&&(b=[b]),this.scopes[a]||(this.scopes[a]={name:a,extendedScopes:b,buttons:[]})},addButton:function(b,c,d,f){var h=this.scopes[b],i,j,k;c.name||e.warn("Added button with iconClass {"+c.iconClass+'} which has no property "name"');if(typeof h=="undefined")return a.Log.error("Can't add button to given scope since the scope has not yet been initialized.",b),!1;i={button:c,scopeVisible:!1},this.allButtons.push(i),h.buttons.push(i),this.fromConfig||(j=this.tabMap[d],typeof j=="undefined"&&(j=new g(d),this.tabs.push(j),this.tabMap[d]=j),k=j.getGroup(f),k.addButton(i)),this.initialized&&this.generateComponent()},doLayout:function(){a.Log.isDebugEnabled()&&a.Log.debug(this,"doLayout called for FloatingMenu, scope is "+this.currentScope);if(typeof this.extTabPanel=="undefined")return!1;var c=this,d=!1,e=this.extTabPanel.getActiveTab(),f=!1,g=!1,h=!1,i;b.each(this.tabs,function(b,i){i.extPanel==e&&(f=i);var j=i.visible;i.doLayout()?(g=!0,j||(a.Log.isDebugEnabled()&&a.Log.debug(c,"showing tab strip for tab "+i.label),c.extTabPanel.unhideTabStripItem(i.extPanel)),d||(d=i),c.userActivatedTab==i.extPanel.title&&i.extPanel!=e&&(h=i)):j&&(a.Log.isDebugEnabled()&&a.Log.debug(c,"hiding tab strip for tab "+i.label),c.extTabPanel.hideTabStripItem(i.extPanel))}),h?(a.Log.isDebugEnabled()&&a.Log.debug(this,"Setting active tab to "+h.label),this.extTabPanel.setActiveTab(h.extPanel)):typeof f=="object"&&typeof d=="object"&&(f.visible||(a.Log.isDebugEnabled()&&a.Log.debug(this,"Setting active tab to "+d.label),this.autoActivatedTab=d.extPanel.title,this.extTabPanel.setActiveTab(d.extPanel))),g&&this.extTabPanel.hidden?(this.extTabPanel.show(),this.refreshShadow(),this.extTabPanel.shadow.show(),this.extTabPanel.setPosition(this.left,this.top)):!g&&!this.extTabPanel.hidden&&(i=this.extTabPanel.getPosition(!0),this.left=i[0]<0?100:i[0],this.top=i[1]<0?100:i[1],this.extTabPanel.hide(),this.extTabPanel.shadow.hide()),this.extTabPanel.doLayout()},setScope:function(a){var c=this.scopes[a];typeof c!="undefined"&&this.currentScope!=a&&(this.currentScope=a,b.each(this.allButtons,function(a,b){b.scopeVisible=!1}),this.setButtonScopeVisibility(c),this.doLayout())},setButtonScopeVisibility:function(a){var c=this;b.each(a.buttons,function(a,b){b.scopeVisible=!0}),b.each(a.extendedScopes,function(a,b){var d=c.scopes[b];typeof d=="object"&&c.setButtonScopeVisibility(d)})},nextFloatTargetObj:function(a,b){if(!a||a==b)return a;switch(a.nodeName.toLowerCase()){case"h1":case"h2":case"h3":case"h4":case"h5":case"h6":case"p":case"div":case"td":case"pre":case"ul":case"ol":return a;default:return this.nextFloatTargetObj(a.parentNode,b)}},calcFloatTarget:function(c){var d,e,g,h,i,j,k,l;if(!a.activeEditable||typeof c.getCommonAncestorContainer=="undefined")return!1;for(d=0,g=a.editables.length;d<g;d++)if(a.editables[d].obj.get(0)==c.limitObject&&a.editables[d].isDisabled())return!1;return i=this.nextFloatTargetObj(c.getCommonAncestorContainer(),c.limitObject),i?(j=b(i),k=f.Utils.Position.Scroll.top,!j||!j.offset()?!1:(l=j.offset().top-this.obj.height()-50,l<k&&(l+=80+f.Utils.Position.ScrollCorrection.top),l>this.window.height()+this.window.scrollTop()?!1:(h=a.activeEditable.obj.offset().left,e=b(document).width(),e-this.width<h&&(h=e-this.width-f.Utils.Position.ScrollCorrection.left),{left:h,top:l}))):!1},floatTo:function(a){if(this.pinned)return;var b=this,c=this.obj.offset(),d,e;i.left===null?(d=c.left,e=c.top):(d=i.left,e=i.top);if(d!=a.left||e!=a.top)this.obj.offset({left:d,top:e}),this.obj.animate({top:a.top,left:a.left},{queue:!1,step:function(a,c){c.prop==="top"?b.top=c.now:c.prop==="left"&&(b.left=c.now),b.refreshShadow(!1)},complete:function(){i.left=b.left,i.top=b.top}})},hide:function(){this.obj&&this.obj.hide(),this.shadow&&this.shadow.hide()},activateTabOfButton:function(a){var b=null;for(var c=0;c<this.tabs.length&&!b;c++){var d=this.tabs[c];for(var e=0;e<d.groups.length&&!b;e++){var f=d.groups[e];for(var g=0;g<f.buttons.length&&!b;g++){var h=f.buttons[g];if(h.button.name==a){b=d;break}}}}b&&(this.userActivatedTab=b.label,this.doLayout())}}),l=new k;return l.init(),a.bind("aloha-editable-deactivated",function(){l.setScope("Aloha.empty")}),a.bind("aloha-selection-changed",function(){!a.Selection.isSelectionEditable()&&!a.Selection.isFloatingMenuVisible()&&l.setScope("Aloha.empty")}),l});