/*!
* This file is part of Aloha Editor Project http://aloha-editor.org
* Copyright (c) 2010-2011 Gentics Software GmbH, aloha@gentics.com
* Contributors http://aloha-editor.org/contribution.php 
* Licensed unter the terms of http://www.aloha-editor.org/license.html
*/
/*
* Aloha Editor is free software: you can redistribute it and/or modify
* it under the terms of the GNU Affero General Public License as published by
* the Free Software Foundation, either version 3 of the License, or
* (at your option) any later version.*
*
* Aloha Editor is distributed in the hope that it will be useful,
* but WITHOUT ANY WARRANTY; without even the implied warranty of
* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
* GNU Affero General Public License for more details.
*
* You should have received a copy of the GNU Affero General Public License
* along with this program. If not, see <http://www.gnu.org/licenses/>.
*/
define(["aloha/core","aloha/jquery","aloha/ext","util/class","aloha/console","vendor/jquery.store"],function(e,t,n,r,i){function f(n){if(!e.activeEditable)return;var r=n.obj,i=e.activeEditable.obj.offset(),s=n.behaviour==="topalign",o=n.behaviour==="append",u=n.pinned&&parseInt(r.css("left"),10)!=i.left+n.horizontalOffset;if(s&&u||o)return;var a=r.height(),f=t(document).scrollTop(),l=i.top-a+n.marginTop-n.topalignOffset;f>l?i.top=s?f+n.marginTop:n.marginTop:f<=l&&(i.top-=a+(s?n.marginTop+n.topalignOffset:0)),n.floatTo(i)}var s=window.GENTICS,o=r.extend({_constructor:function(e){this.label=e,this.groups=[],this.groupMap={},this.visible=!0},getGroup:function(e){var t=this.groupMap[e];return typeof t=="undefined"&&(t=new u,this.groupMap[e]=t,this.groups.push(t)),t},getExtComponent:function(){var e=this;return this.extPanel||(this.extPanel=new n.Panel({tbar:[],title:this.label,style:"margin-top:0px",bodyStyle:"display:none",autoScroll:!0})),t.each(this.groups,function(t,n){n.extButtonGroup||e.extPanel.getTopToolbar().add(n.getExtComponent())}),this.extPanel},doLayout:function(){var n=this;return e.Log.isDebugEnabled()&&e.Log.debug(this,"doLayout called for tab "+this.label),this.visible=!1,t.each(this.groups,function(e,t){n.visible|=t.doLayout()}),e.Log.isDebugEnabled()&&e.Log.debug(this,"tab "+this.label+(this.visible?" is ":" is not ")+"visible now"),this.visible}}),u=r.extend({_constructor:function(){this.buttons=[],this.fields=[]},addButton:function(t){if(t.button instanceof e.ui.AttributeField){if(!(this.fields.length<2))throw new Error("Too much fields in this group");this.fields.push(t)}else typeof t.button!="undefined"&&this.buttons.push(t)},getExtComponent:function(){var e=this,r,i=[],s=0,o=0,u,a,f;if(typeof this.extButtonGroup=="undefined"){this.fields.length>1&&(o=1),t.each(this.buttons,function(e,t){s+=t.button.size=="small"?1:2}),o+=Math.ceil(s/2),u=this.buttons.length,a=0,f=Math.ceil(this.buttons.length/2)-this.buttons.length%2,this.fields.length>0&&(e.buttons.push(this.fields[0]),i.push(this.fields[0].button.getExtConfigProperties()));while(--u>=f)i.push(this.buttons[a++].button.getExtConfigProperties());++u,this.fields.length>1&&(e.buttons.push(this.fields[1]),i.push(this.fields[1].button.getExtConfigProperties()));while(--u>=0)i.push(this.buttons[a++].button.getExtConfigProperties());this.extButtonGroup=new n.ButtonGroup({columns:o,items:i}),t.each(this.buttons,function(t,n){n.button.extButton=e.extButtonGroup.findById(n.button.id);if(n.button.listenerQueue&&n.button.listenerQueue.length>0)for(;;){r=n.button.listenerQueue.shift();if(!r)break;n.button.extButton.addListener(r.eventName,r.handler,r.scope,r.options)}n.button.extButton.setObjectTypeFilter&&(n.button.objectTypeFilter&&(n.button.extButton.noQuery=!1),n.button.objectTypeFilter=="all"&&(n.button.objectTypeFilter=null),n.button.extButton.setObjectTypeFilter(n.button.objectTypeFilter),n.button.displayField&&(n.button.extButton.displayField=n.button.displayField),n.button.tpl&&(n.button.extButton.tpl=n.button.tpl))})}return this.extButtonGroup},doLayout:function(){var e=!1,n=this;return t.each(this.buttons,function(t,r){if(typeof r.button!="undefined"){var i=n.extButtonGroup.findById(r.button.id),s=r.button.isVisible()&&r.scopeVisible;if(!i)return;s&&i.hidden?i.show():!s&&i&&!i.hidden&&i.hide(),e|=s}}),e&&this.extButtonGroup.hidden?this.extButtonGroup.show():!e&&!this.extButtonGroup.hidden&&this.extButtonGroup.hide(),e}}),a={top:null,left:null},l=r.extend({scopes:{"Aloha.empty":{name:"Aloha.empty",extendedScopes:[],buttons:[]},"Aloha.global":{name:"Aloha.global",extendedScopes:["Aloha.empty"],buttons:[]},"Aloha.continuoustext":{name:"Aloha.continuoustext",extendedScopes:["Aloha.global"],buttons:[]}},tabs:[],tabMap:{},initialized:!1,allButtons:[],top:100,left:100,pinned:!1,window:t(window),behaviour:"float",element:"floatingmenu",topalignOffset:0,horizontalOffset:0,marginTop:10,draggable:!0,pin:!1,buttonsAdded:[],fromConfig:!1,init:function(){e.settings.floatingmenu&&(typeof e.settings.floatingmenu.draggable=="boolean"&&(this.draggable=e.settings.floatingmenu.draggable),typeof e.settings.floatingmenu.behaviour=="string"&&(this.behaviour=e.settings.floatingmenu.behaviour),typeof e.settings.floatingmenu.topalignOffset!="undefined"&&(this.topalignOffset=parseInt(e.settings.floatingmenu.topalignOffset,10)),typeof e.settings.floatingmenu.horizontalOffset!="undefined"&&(this.horizontalOffset=parseInt(e.settings.floatingmenu.horizontalOffset,10)),typeof e.settings.floatingmenu.marginTop=="number"&&(this.marginTop=parseInt(e.settings.floatingmenu.marginTop,10)),typeof e.settings.floatingmenu.element=="string"&&(this.element=e.settings.floatingmenu.element),typeof e.settings.floatingmenu.pin=="boolean"&&(this.pin=e.settings.floatingmenu.pin),typeof e.settings.floatingmenu.width!="undefined"&&(this.width=parseInt(e.settings.floatingmenu.width,10))),t.storage=new t.store,this.currentScope="Aloha.global";var n=this;this.window.unload(function(){n.pinned?(t.storage.set("Aloha.FloatingMenu.pinned","true"),t.storage.set("Aloha.FloatingMenu.top",n.top),t.storage.set("Aloha.FloatingMenu.left",n.left),e.Log.isInfoEnabled()&&e.Log.info(this,"stored FloatingMenu pinned position {"+n.left+", "+n.top+"}")):(t.storage.del("Aloha.FloatingMenu.pinned"),t.storage.del("Aloha.FloatingMenu.top"),t.storage.del("Aloha.FloatingMenu.left")),n.userActivatedTab&&t.storage.set("Aloha.FloatingMenu.activeTab",n.userActivatedTab)}).resize(function(){if(n.behaviour==="float")if(n.pinned)n.fixPinnedPosition(),n.refreshShadow(),n.extTabPanel.setPosition(n.left,n.top);else{var t=n.calcFloatTarget(e.Selection.getRangeObject());t&&n.floatTo(t)}}),e.bind("aloha-ready",function(){n.generateComponent(),n.initialized=!0}),typeof e.settings.toolbar=="object"&&(this.fromConfig=!0)},obj:null,shadow:null,panelBody:null,width:400,initTabsAndGroups:function(){var n=this;if(!this.fromConfig)return;t.each(e.settings.toolbar.tabs,function(e,r){var s=n.tabMap[e];typeof s=="undefined"&&(s=new o(e),n.tabs.push(s),n.tabMap[e]=s),t.each(r,function(r,o){var u=s.getGroup(r),a;t.each(o,function(s,o){if(t.inArray(o,n.buttonsAdded)!==-1){i.warn("Skipping button {"+o+"}. A button can't be added "+"to the floating menu twice. Config key: {Aloha.settings.toolbar."+e+"."+r+"}");return}for(a=0;a<n.allButtons.length;a++)if(o===n.allButtons[a].button.name){u.addButton(n.allButtons[a]),n.buttonsAdded.push(n.allButtons[a].button.name);break}})})})},generateComponent:function(){var r=this,i;this.initTabsAndGroups(),n.QuickTips.init(),n.apply(n.QuickTips.getQuickTip(),{minWidth:10});if(!this.extTabPanel){var s=!1;r.draggable&&(s={insertProxy:!1,onDrag:function(e){var t=this.proxy.getEl();this.x=t.getLeft(!0),this.y=t.getTop(!0),this.panel.shadow.hide()},endDrag:function(e){var n=r.pinned?this.y-t(document).scrollTop():this.y;r.left=this.x,r.top=n,a.left=r.left,a.top=r.top,this.panel.setPosition(this.x,n),r.refreshShadow(),this.panel.shadow.show()}}),this.extTabPanel=new n.TabPanel({activeTab:0,width:r.width,plain:!1,draggable:s,floating:{shadow:!1},defaults:{autoScroll:!0},layoutOnTabChange:!0,shadow:!1,cls:"aloha-floatingmenu ext-root",listeners:{tabchange:{fn:function(n,i){i.title!=r.autoActivatedTab?(e.Log.isDebugEnabled()&&e.Log.debug(r,"User selected tab "+i.title),r.userActivatedTab=i.title):e.Log.isDebugEnabled()&&e.Log.debug(r,"Tab "+i.title+" was activated automatically"),r.autoActivatedTab=undefined,t.each(r.allButtons,function(e,t){typeof t.button!="undefined"&&typeof t.button.extButton!="undefined"&&t.button.extButton!==null&&typeof t.button.extButton.setActiveDOMElement=="function"&&typeof t.button.extButton.activeDOMElement!="undefined"&&t.button.extButton.setActiveDOMElement(t.button.extButton.activeDOMElement)}),r.extTabPanel.isVisible()&&(r.extTabPanel.shadow.show(),r.refreshShadow())}}},enableTabScroll:!0})}t.each(this.tabs,function(t,n){try{r.extTabPanel.add(n.getExtComponent())}catch(i){e.Log.error(r,"Error while inserting tab: "+i)}}),this.extTabPanel.shadow||(this.extTabPanel.shadow=t('<div id="aloha-floatingmenu-shadow" class="aloha-shadow">&#160;</div>').hide(),t("body").append(this.extTabPanel.shadow)),i=this.extTabPanel.add({title:"&#160;"}),this.extTabPanel.render(document.body),t(i.tabEl).addClass("aloha-floatingmenu-pin").html("&#160;").mousedown(function(e){r.togglePin(),e.stopPropagation()}),this.panelBody=t("div.aloha-floatingmenu div.x-tab-panel-bwrap"),this.doLayout(),this.obj=t(this.extTabPanel.getEl().dom),t.storage.get("Aloha.FloatingMenu.pinned")=="true"&&(this.top=parseInt(t.storage.get("Aloha.FloatingMenu.top"),10),this.left=parseInt(t.storage.get("Aloha.FloatingMenu.left"),10),this.fixPinnedPosition(),e.Log.isInfoEnabled()&&e.Log.info(this,"restored FloatingMenu pinned position {"+this.left+", "+this.top+"}"),this.refreshShadow()),t.storage.get("Aloha.FloatingMenu.activeTab")&&(this.userActivatedTab=t.storage.get("Aloha.FloatingMenu.activeTab")),this.extTabPanel.setPosition(this.left,this.top),this.obj.mousedown(function(t){t.originalEvent.stopSelectionUpdate=!0,e.eventHandled=!0}),this.obj.mouseup(function(t){t.originalEvent.stopSelectionUpdate=!0,e.eventHandled=!1}),t(window).scroll(function(){f(r)}),r.draggable||t(".aloha-floatingmenu").hover(function(){t(this).css({background:"none"}),t(".aloha-floatingmenu-pin").hide()});if(this.behaviour==="float")e.bind("aloha-selection-changed",function(e,t){if(!r.pinned){var n=r.calcFloatTarget(t);n&&r.floatTo(n)}});else if(this.behaviour==="append"){var o=t("#"+r.element),u=o.offset();if(!u)return e.Log.warn(r,"Invalid element HTML ID for floating menu: "+r.element),!1;this.floatTo(u),this.pin&&this.togglePin(!0),e.bind("aloha-editable-activated",function(e,t){if(r.pinned)return;r.floatTo(u)})}else this.behaviour==="topalign"&&(this.togglePin(!1),e.bind("aloha-editable-activated",function(e,n){if(r.pinned)return;var i=n.editable.obj,s=90,o=i.offset(),u=o.top-s<t(document).scrollTop();u?(o.top=i.height()<s?o.top+i.height():t(document).scrollTop(),o.top+=r.marginTop):o.top-=s+r.topalignOffset,o.left+=r.horizontalOffset;var a=10,f=o.left+r.width+a-t(window).width();f>0&&(o.left-=f),r.floatTo(o)}))},fixPinnedPosition:function(){if(!this.pinned)return;this.top<30?this.top=30:this.top>this.window.height()-this.extTabPanel.getHeight()&&(this.top=this.window.height()-this.extTabPanel.getHeight()),this.left<0?this.left=0:this.left>this.window.width()-this.extTabPanel.getWidth()&&(this.left=this.window.width()-this.extTabPanel.getWidth())},refreshShadow:function(e){if(this.panelBody){var t={top:this.top+24,left:this.left};if(typeof e=="undefined"||!e)t.width=this.panelBody.width()+"px",t.height=this.panelBody.height()+"px";this.extTabPanel.shadow.css(t)}},togglePin:function(e){var n=t(".aloha-floatingmenu-pin");typeof e=="boolean"&&(this.pinned=!e),this.pinned?(n.removeClass("aloha-floatingmenu-pinned"),this.top=this.obj.offset().top,this.obj.removeClass("fixed").css({top:this.top}),this.extTabPanel.shadow.removeClass("fixed"),this.refreshShadow(),this.pinned=!1):(n.addClass("aloha-floatingmenu-pinned"),this.top=this.obj.offset().top-this.window.scrollTop(),this.obj.addClass("fixed").css({top:this.top}),this.extTabPanel.shadow.addClass("fixed"),this.refreshShadow(),this.pinned=!0)},createScope:function(e,t){typeof t=="undefined"?t=["Aloha.empty"]:typeof t=="string"&&(t=[t]),this.scopes[e]||(this.scopes[e]={name:e,extendedScopes:t,buttons:[]})},addButton:function(t,n,r,s){var u=this.scopes[t],a,f,l;n.name||i.warn("Added button with iconClass {"+n.iconClass+'} which has no property "name"');if(typeof u=="undefined")return e.Log.error("Can't add button to given scope since the scope has not yet been initialized.",t),!1;a={button:n,scopeVisible:!1},this.allButtons.push(a),u.buttons.push(a),this.fromConfig||(f=this.tabMap[r],typeof f=="undefined"&&(f=new o(r),this.tabs.push(f),this.tabMap[r]=f),l=f.getGroup(s),l.addButton(a)),this.initialized&&this.generateComponent()},doLayout:function(){e.Log.isDebugEnabled()&&e.Log.debug(this,"doLayout called for FloatingMenu, scope is "+this.currentScope);if(typeof this.extTabPanel=="undefined")return!1;var n=this,r=!1,i=this.extTabPanel.getActiveTab(),s=!1,o=!1,u=!1,a;t.each(this.tabs,function(t,a){a.extPanel==i&&(s=a);var f=a.visible;a.doLayout()?(o=!0,f||(e.Log.isDebugEnabled()&&e.Log.debug(n,"showing tab strip for tab "+a.label),n.extTabPanel.unhideTabStripItem(a.extPanel)),r||(r=a),n.userActivatedTab==a.extPanel.title&&a.extPanel!=i&&(u=a)):f&&(e.Log.isDebugEnabled()&&e.Log.debug(n,"hiding tab strip for tab "+a.label),n.extTabPanel.hideTabStripItem(a.extPanel))}),u?(e.Log.isDebugEnabled()&&e.Log.debug(this,"Setting active tab to "+u.label),this.extTabPanel.setActiveTab(u.extPanel)):typeof s=="object"&&typeof r=="object"&&(s.visible||(e.Log.isDebugEnabled()&&e.Log.debug(this,"Setting active tab to "+r.label),this.autoActivatedTab=r.extPanel.title,this.extTabPanel.setActiveTab(r.extPanel))),o&&this.extTabPanel.hidden?(this.extTabPanel.show(),this.refreshShadow(),this.extTabPanel.shadow.show(),this.extTabPanel.setPosition(this.left,this.top)):!o&&!this.extTabPanel.hidden&&(a=this.extTabPanel.getPosition(!0),this.left=a[0]<0?100:a[0],this.top=a[1]<0?100:a[1],this.extTabPanel.hide(),this.extTabPanel.shadow.hide()),this.extTabPanel.doLayout()},setScope:function(e){var n=this.scopes[e];typeof n!="undefined"&&this.currentScope!=e&&(this.currentScope=e,t.each(this.allButtons,function(e,t){t.scopeVisible=!1}),this.setButtonScopeVisibility(n),this.doLayout())},setButtonScopeVisibility:function(e){var n=this;t.each(e.buttons,function(e,t){t.scopeVisible=!0}),t.each(e.extendedScopes,function(e,t){var r=n.scopes[t];typeof r=="object"&&n.setButtonScopeVisibility(r)})},nextFloatTargetObj:function(e,t){if(!e||e==t)return e;switch(e.nodeName.toLowerCase()){case"h1":case"h2":case"h3":case"h4":case"h5":case"h6":case"p":case"div":case"td":case"pre":case"ul":case"ol":return e;default:return this.nextFloatTargetObj(e.parentNode,t)}},calcFloatTarget:function(n){var r,i,o,u,a,f,l,c;if(!e.activeEditable||typeof n.getCommonAncestorContainer=="undefined")return!1;for(r=0,o=e.editables.length;r<o;r++)if(e.editables[r].obj.get(0)==n.limitObject&&e.editables[r].isDisabled())return!1;return a=this.nextFloatTargetObj(n.getCommonAncestorContainer(),n.limitObject),a?(f=t(a),l=s.Utils.Position.Scroll.top,!f||!f.offset()?!1:(c=f.offset().top-this.obj.height()-50,c<l&&(c+=80+s.Utils.Position.ScrollCorrection.top),c>this.window.height()+this.window.scrollTop()?!1:(u=e.activeEditable.obj.offset().left,i=t(document).width(),i-this.width<u&&(u=i-this.width-s.Utils.Position.ScrollCorrection.left),{left:u,top:c}))):!1},floatTo:function(e){if(this.pinned)return;var t=this,n=this.obj.offset(),r,i;a.left===null?(r=n.left,i=n.top):(r=a.left,i=a.top);if(r!=e.left||i!=e.top)this.obj.offset({left:r,top:i}),this.obj.animate({top:e.top,left:e.left},{queue:!1,step:function(e,n){n.prop==="top"?t.top=n.now:n.prop==="left"&&(t.left=n.now),t.refreshShadow(!1)},complete:function(){a.left=t.left,a.top=t.top}})},hide:function(){this.obj&&this.obj.hide(),this.shadow&&this.shadow.hide()},activateTabOfButton:function(e){var t=null;for(var n=0;n<this.tabs.length&&!t;n++){var r=this.tabs[n];for(var i=0;i<r.groups.length&&!t;i++){var s=r.groups[i];for(var o=0;o<s.buttons.length&&!t;o++){var u=s.buttons[o];if(u.button.name==e){t=r;break}}}}t&&(this.userActivatedTab=t.label,this.doLayout())}}),c=new l;return c.init(),e.bind("aloha-editable-deactivated",function(){c.setScope("Aloha.empty")}),e.bind("aloha-selection-changed",function(){!e.Selection.isSelectionEditable()&&!e.Selection.isFloatingMenuVisible()&&c.setScope("Aloha.empty")}),c});