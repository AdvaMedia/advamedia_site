/*!
* This file is part of Aloha Editor Project http://aloha-editor.org
* Copyright (c) 2010-2011 Gentics Software GmbH, aloha@gentics.com
* Contributors http://aloha-editor.org/contribution.php
* Licensed unter the terms of http://www.aloha-editor.org/license.html
*/
/*
* Aloha Editor is free software: you can redistribute it and/or modify
* it under the terms of the GNU Affero General Public License as published by
* the Free Software Foundation, either version 3 of the License, or
* (at your option) any later version.*
*
* Aloha Editor is distributed in the hope that it will be useful,
* but WITHOUT ANY WARRANTY; without even the implied warranty of
* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
* GNU Affero General Public License for more details.
*
* You should have received a copy of the GNU Affero General Public License
* along with this program. If not, see <http://www.gnu.org/licenses/>.
*/
define(["aloha/core","util/class","aloha/jquery","aloha/console"],function(e,t,n,r){return e.RepositoryManager=t.extend({repositories:[],settings:{},init:function(){var t=this.repositories,r=0,i=t.length,s;e.settings&&e.settings.repositories&&(this.settings=e.settings.repositories),this.settings.timeout=this.settings.timeout||5e3;for(;r<i;++r)s=t[r],s.settings||(s.settings={}),this.settings[s.repositoryId]&&n.extend(s.settings,this.settings[s.repositoryId]),s.init()},register:function(e){this.getRepository(e.repositoryId)?r.warn(this,"A repository with name { "+e.repositoryId+" } already registerd. Ignoring this."):this.repositories.push(e)},getRepository:function(e){var t=this.repositories,n=0,r=t.length;for(;n<r;++n)if(t[n].repositoryId===e)return t[n];return null},query:function(e,t){var r=this,i,s=[],o={numItems:0,hasMoreItems:!1},u=[],a=0,f,l,c,h=function(e,i){if(a===0)return;var u=e?e.length:0;if(u){if(!e[0].repositoryId){var l=this.repositoryId,c;for(c=0;c<u;++c)e[c].repositoryId=l}n.merge(s,e)}i&&o?(n.isNumeric(i.numItems)&&n.isNumeric(o.numItems)?o.numItems+=i.numItems:o.numItems=undefined,n.isBoolean(i.hasMoreItems)&&n.isBoolean(o.hasMoreItems)?o.hasMoreItems=o.hasMoreItems||i.hasMoreItems:o.hasMoreItems=undefined):o=undefined,--a===0&&r.queryCallback(t,s,o,f)},p=parseInt(e.timeout,10)||this.settings.timeout;f=setTimeout(function(){a=0,r.queryCallback(t,s,o,f)},p),e.repositoryId?u.push(this.getRepository(e.repositoryId)):u=this.repositories,c=u.length;var d=[];for(l=0;l<c;++l)i=u[l],typeof i.query=="function"&&(++a,d.push(i));c=d.length;for(l=0;l<c;++l)i=d[l],i.query(e,function(){h.apply(i,arguments)});a===0&&this.queryCallback(t,s,o,f)},queryCallback:function(e,t,n,r){r&&(clearTimeout(r),r=undefined);var i={items:t,results:t.length};n&&(i.numItems=n.numItems,i.hasMoreItems=n.hasMoreItems),e.call(this,i)},getChildren:function(t,r){var i=this,s,o=[],u=[],a=0,f,l,c,h=function(e){if(a===0)return;n.merge(o,e),--a===0&&i.getChildrenCallback(r,o,f)};if(t.inFolderId==="aloha"){var p=t.repositoryFilter,d=p&&p.length;c=this.repositories.length;for(l=0;l<c;++l)s=this.repositories[l],(!d||n.inArray(s.repositoryId,p)>-1)&&u.push(new e.RepositoryFolder({id:s.repositoryId,name:s.repositoryName,repositoryId:s.repositoryId,type:"repository",hasMoreItems:!0}));i.getChildrenCallback(r,u,null);return}u=this.repositories;var v=parseInt(t.timeout,10)||this.settings.timeout;f=setTimeout(function(){a=0,i.getChildrenCallback(r,o,f)},v),c=u.length;for(l=0;l<c;++l)s=u[l],typeof s.getChildren=="function"&&(++a,s.getChildren(t,function(){h.apply(s,arguments)}));a===0&&this.getChildrenCallback(r,o,f)},getChildrenCallback:function(e,t,n){n&&(clearTimeout(n),n=undefined),e.call(this,t)},makeClean:function(e){var t=this,n={},i=0,s=t.repositories.length;e.find("[data-gentics-aloha-repository="+this.prefix+"]").each(function(){for(;i<s;++i)n.makeClean(e);r.debug(t,"Passing contents of HTML Element with id { "+this.attr("id")+" } for cleaning to repository { "+n.repositoryId+" }"),n.makeClean(this)})},markObject:function(e,t){if(!e)return;if(t){var i=this.getRepository(t.repositoryId);i?(n(e).attr({"data-gentics-aloha-repository":t.repositoryId,"data-gentics-aloha-object-id":t.id}),i.markObject(e,t)):r.error(this,"Trying to apply a repository { "+t.name+" } to an object, but item has no repositoryId.")}else n(e).removeAttr("data-gentics-aloha-repository").removeAttr("data-gentics-aloha-object-id")},getObject:function(e,t){var r=this,i=n(e),s=this.getRepository(i.attr("data-gentics-aloha-repository")),o=i.attr("data-gentics-aloha-object-id");s&&o&&(this.itemCache=this.itemCache||[],this.itemCache[s.repositoryId]=this.itemCache[s.repositoryId]||[],this.itemCache[s.repositoryId][o]?t.call(this,[this.itemCache[s.repositoryId][o]]):s.getObjectById(o,function(e){r.itemCache[s.repositoryId][o]=e[0],t.call(this,e)}))},toString:function(){return"repositorymanager"}}),e.RepositoryManager=new e.RepositoryManager,e.RepositoryManager});