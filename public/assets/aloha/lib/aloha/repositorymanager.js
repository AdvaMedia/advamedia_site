/*!
* This file is part of Aloha Editor Project http://aloha-editor.org
* Copyright (c) 2010-2011 Gentics Software GmbH, aloha@gentics.com
* Contributors http://aloha-editor.org/contribution.php
* Licensed unter the terms of http://www.aloha-editor.org/license.html
*/
/*
* Aloha Editor is free software: you can redistribute it and/or modify
* it under the terms of the GNU Affero General Public License as published by
* the Free Software Foundation, either version 3 of the License, or
* (at your option) any later version.*
*
* Aloha Editor is distributed in the hope that it will be useful,
* but WITHOUT ANY WARRANTY; without even the implied warranty of
* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
* GNU Affero General Public License for more details.
*
* You should have received a copy of the GNU Affero General Public License
* along with this program. If not, see <http://www.gnu.org/licenses/>.
*/
define(["aloha/core","util/class","aloha/jquery","aloha/console"],function(a,b,c,d){return a.RepositoryManager=b.extend({repositories:[],settings:{},init:function(){var b=this.repositories,d=0,e=b.length,f;a.settings&&a.settings.repositories&&(this.settings=a.settings.repositories),this.settings.timeout=this.settings.timeout||5e3;for(;d<e;++d)f=b[d],f.settings||(f.settings={}),this.settings[f.repositoryId]&&c.extend(f.settings,this.settings[f.repositoryId]),f.init()},register:function(a){this.getRepository(a.repositoryId)?d.warn(this,"A repository with name { "+a.repositoryId+" } already registerd. Ignoring this."):this.repositories.push(a)},getRepository:function(a){var b=this.repositories,c=0,d=b.length;for(;c<d;++c)if(b[c].repositoryId===a)return b[c];return null},query:function(a,b){var d=this,e,f=[],g={numItems:0,hasMoreItems:!1},h=[],i=0,j,k,l,m=function(a,e){if(i===0)return;var h=a?a.length:0;if(h){if(!a[0].repositoryId){var k=this.repositoryId,l;for(l=0;l<h;++l)a[l].repositoryId=k}c.merge(f,a)}e&&g?(c.isNumeric(e.numItems)&&c.isNumeric(g.numItems)?g.numItems+=e.numItems:g.numItems=undefined,c.isBoolean(e.hasMoreItems)&&c.isBoolean(g.hasMoreItems)?g.hasMoreItems=g.hasMoreItems||e.hasMoreItems:g.hasMoreItems=undefined):g=undefined,--i===0&&d.queryCallback(b,f,g,j)},n=parseInt(a.timeout,10)||this.settings.timeout;j=setTimeout(function(){i=0,d.queryCallback(b,f,g,j)},n),a.repositoryId?h.push(this.getRepository(a.repositoryId)):h=this.repositories,l=h.length;var o=[];for(k=0;k<l;++k)e=h[k],typeof e.query=="function"&&(++i,o.push(e));l=o.length;for(k=0;k<l;++k)e=o[k],e.query(a,function(){m.apply(e,arguments)});i===0&&this.queryCallback(b,f,g,j)},queryCallback:function(a,b,c,d){d&&(clearTimeout(d),d=undefined);var e={items:b,results:b.length};c&&(e.numItems=c.numItems,e.hasMoreItems=c.hasMoreItems),a.call(this,e)},getChildren:function(b,d){var e=this,f,g=[],h=[],i=0,j,k,l,m=function(a){if(i===0)return;c.merge(g,a),--i===0&&e.getChildrenCallback(d,g,j)};if(b.inFolderId==="aloha"){var n=b.repositoryFilter,o=n&&n.length;l=this.repositories.length;for(k=0;k<l;++k)f=this.repositories[k],(!o||c.inArray(f.repositoryId,n)>-1)&&h.push(new a.RepositoryFolder({id:f.repositoryId,name:f.repositoryName,repositoryId:f.repositoryId,type:"repository",hasMoreItems:!0}));e.getChildrenCallback(d,h,null);return}h=this.repositories;var p=parseInt(b.timeout,10)||this.settings.timeout;j=setTimeout(function(){i=0,e.getChildrenCallback(d,g,j)},p),l=h.length;for(k=0;k<l;++k)f=h[k],typeof f.getChildren=="function"&&(++i,f.getChildren(b,function(){m.apply(f,arguments)}));i===0&&this.getChildrenCallback(d,g,j)},getChildrenCallback:function(a,b,c){c&&(clearTimeout(c),c=undefined),a.call(this,b)},makeClean:function(a){var b=this,c={},e=0,f=b.repositories.length;a.find("[data-gentics-aloha-repository="+this.prefix+"]").each(function(){for(;e<f;++e)c.makeClean(a);d.debug(b,"Passing contents of HTML Element with id { "+this.attr("id")+" } for cleaning to repository { "+c.repositoryId+" }"),c.makeClean(this)})},markObject:function(a,b){if(!a)return;if(b){var e=this.getRepository(b.repositoryId);e?(c(a).attr({"data-gentics-aloha-repository":b.repositoryId,"data-gentics-aloha-object-id":b.id}),e.markObject(a,b)):d.error(this,"Trying to apply a repository { "+b.name+" } to an object, but item has no repositoryId.")}else c(a).removeAttr("data-gentics-aloha-repository").removeAttr("data-gentics-aloha-object-id")},getObject:function(a,b){var d=this,e=c(a),f=this.getRepository(e.attr("data-gentics-aloha-repository")),g=e.attr("data-gentics-aloha-object-id");f&&g&&(this.itemCache=this.itemCache||[],this.itemCache[f.repositoryId]=this.itemCache[f.repositoryId]||[],this.itemCache[f.repositoryId][g]?b.call(this,[this.itemCache[f.repositoryId][g]]):f.getObjectById(g,function(a){d.itemCache[f.repositoryId][g]=a[0],b.call(this,a)}))},toString:function(){return"repositorymanager"}}),a.RepositoryManager=new a.RepositoryManager,a.RepositoryManager});