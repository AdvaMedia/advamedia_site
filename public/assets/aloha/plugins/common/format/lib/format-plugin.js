/*!
* Aloha Editor
* Author & Copyright (c) 2010 Gentics Software GmbH
* aloha-sales@gentics.com
* Licensed unter the terms of http://www.aloha-editor.com/license.html
*/
define(["aloha","aloha/plugin","aloha/jquery","aloha/floatingmenu","i18n!format/nls/i18n","i18n!aloha/nls/i18n","aloha/console","css!format/css/format.css"],function(e,t,n,r,i,s){var o=window.GENTICS;return t.create("format",{languages:["en","de","fr","eo","fi","ru","it","pl"],config:["strong","em","b","i","s","sub","sup","p","h1","h2","h3","h4","h5","h6","pre","removeFormat"],init:function(){var t=this;this.initButtons(),e.bind("aloha-editable-activated",function(e,n){t.applyButtonConfig(n.editable.obj)})},applyButtonConfig:function(e){var t=this.getEditableConfig(e),r,i,s;for(r in this.buttons)n.inArray(r,t)!=-1?this.buttons[r].button.show():this.buttons[r].button.hide();s=this.multiSplitItems.length;for(i=0;i<s;i++)n.inArray(this.multiSplitItems[i].name,t)!=-1?this.multiSplitButton.showItem(this.multiSplitItems[i].name):this.multiSplitButton.hideItem(this.multiSplitItems[i].name)},initButtons:function(){var t="Aloha.continuoustext",u=this;this.buttons={},this.multiSplitItems=[],n.each(this.config,function(a,f){switch(f){case"u":case"em":case"strong":case"b":case"i":case"cite":case"q":case"code":case"abbr":case"del":case"s":case"sub":case"sup":u.buttons[f]={button:new e.ui.Button({name:f,iconClass:"aloha-button aloha-button-"+f,size:"small",onclick:function(){var t=n("<"+f+"></"+f+">"),r=e.Selection.rangeObject,i,s=n(".aloha-cell-selected");if(s.length>0){var u=0;return s.each(function(){var e=n(this).find("div"),t=e.find(f);t.length>0&&(t.contents().unwrap(),u++),e.contents().wrap("<"+f+"></"+f+">")}),u==s.length&&s.find(f).contents().unwrap(),!1}return i=r.findMarkup(function(){return this.nodeName.toLowerCase()==t.get(0).nodeName.toLowerCase()},e.activeEditable.obj),i?r.isCollapsed()?o.Utils.Dom.removeFromDOM(i,r,!0):o.Utils.Dom.removeMarkup(r,t,e.activeEditable.obj):(r.isCollapsed()&&o.Utils.Dom.extendToWord(r),o.Utils.Dom.addMarkup(r,t)),r.select(),!1},tooltip:i.t("button."+f+".tooltip"),toggle:!0}),markup:n("<"+f+"></"+f+">")},r.addButton(t,u.buttons[f].button,s.t("floatingmenu.tab.format"),1);break;case"p":case"h1":case"h2":case"h3":case"h4":case"h5":case"h6":case"pre":u.multiSplitItems.push({name:f,tooltip:i.t("button."+f+".tooltip"),iconClass:"aloha-button "+i.t("aloha-button-"+f),markup:n("<"+f+"></"+f+">"),click:function(){var t=n(".aloha-cell-selected");if(t.length>0){var r=0;return t.each(function(){var e=n(this).find("div"),t=e.find(f);t.length>0&&(t.contents().unwrap(),r++),e.contents().wrap("<"+f+"></"+f+">")}),r==t.length&&t.find(f).contents().unwrap(),!1}e.Selection.changeMarkupOnSelection(n("<"+f+"></"+f+">"))}});break;case"removeFormat":u.multiSplitItems.push({name:f,text:i.t("button."+f+".text"),tooltip:i.t("button."+f+".tooltip"),iconClass:"aloha-button aloha-button-"+f,wide:!0,click:function(){u.removeFormat()}});break;default:e.log("warn",this,'Button "'+f+'" is not defined')}}),this.multiSplitItems.length>0&&(this.multiSplitButton=new e.ui.MultiSplitButton({name:"phrasing",items:this.multiSplitItems}),r.addButton(t,this.multiSplitButton,s.t("floatingmenu.tab.format"),3)),e.bind("aloha-selection-changed",function(t,r){var i=!1,s,o,a,f,l;n.each(u.buttons,function(t,n){i=!1;for(a=0;a<r.markupEffectiveAtStart.length;a++)s=r.markupEffectiveAtStart[a],e.Selection.standardTextLevelSemanticsComparator(s,n.markup)&&(n.button.setPressed(!0),i=!0);i||n.button.setPressed(!1)});if(u.multiSplitItems.length>0){o=!1;for(a=0;a<r.markupEffectiveAtStart.length&&!o;a++){s=r.markupEffectiveAtStart[a];for(f=0;f<u.multiSplitItems.length&&!o;f++){l=u.multiSplitItems[f];if(!l.markup)continue;e.Selection.standardTextLevelSemanticsComparator(s,l.markup)&&(u.multiSplitButton.setActiveItem(l.name),o=!0)}}o||u.multiSplitButton.setActiveItem(null)}})},removeFormat:function(){var t=["strong","em","b","i","cite","q","code","abbr","del","sub","sup"],r=e.Selection.rangeObject,i;this.settings.removeFormats&&(t=this.settings.removeFormats);if(r.isCollapsed())return;for(i=0;i<t.length;i++)o.Utils.Dom.removeMarkup(r,n("<"+t[i]+"></"+t[i]+">"),e.activeEditable.obj);r.select()},toString:function(){return"format"}})});