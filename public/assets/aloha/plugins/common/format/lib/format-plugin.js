/*!
* Aloha Editor
* Author & Copyright (c) 2010 Gentics Software GmbH
* aloha-sales@gentics.com
* Licensed unter the terms of http://www.aloha-editor.com/license.html
*/
define(["aloha","aloha/plugin","aloha/jquery","aloha/floatingmenu","i18n!format/nls/i18n","i18n!aloha/nls/i18n","aloha/console","css!format/css/format.css"],function(a,b,c,d,e,f){var g=window.GENTICS;return b.create("format",{languages:["en","de","fr","eo","fi","ru","it","pl"],config:["strong","em","b","i","s","sub","sup","p","h1","h2","h3","h4","h5","h6","pre","removeFormat"],init:function(){var b=this;this.initButtons(),a.bind("aloha-editable-activated",function(a,c){b.applyButtonConfig(c.editable.obj)})},applyButtonConfig:function(a){var b=this.getEditableConfig(a),d,e,f;for(d in this.buttons)c.inArray(d,b)!=-1?this.buttons[d].button.show():this.buttons[d].button.hide();f=this.multiSplitItems.length;for(e=0;e<f;e++)c.inArray(this.multiSplitItems[e].name,b)!=-1?this.multiSplitButton.showItem(this.multiSplitItems[e].name):this.multiSplitButton.hideItem(this.multiSplitItems[e].name)},initButtons:function(){var b="Aloha.continuoustext",h=this;this.buttons={},this.multiSplitItems=[],c.each(this.config,function(i,j){switch(j){case"u":case"em":case"strong":case"b":case"i":case"cite":case"q":case"code":case"abbr":case"del":case"s":case"sub":case"sup":h.buttons[j]={button:new a.ui.Button({name:j,iconClass:"aloha-button aloha-button-"+j,size:"small",onclick:function(){var b=c("<"+j+"></"+j+">"),d=a.Selection.rangeObject,e,f=c(".aloha-cell-selected");if(f.length>0){var h=0;return f.each(function(){var a=c(this).find("div"),b=a.find(j);b.length>0&&(b.contents().unwrap(),h++),a.contents().wrap("<"+j+"></"+j+">")}),h==f.length&&f.find(j).contents().unwrap(),!1}return e=d.findMarkup(function(){return this.nodeName.toLowerCase()==b.get(0).nodeName.toLowerCase()},a.activeEditable.obj),e?d.isCollapsed()?g.Utils.Dom.removeFromDOM(e,d,!0):g.Utils.Dom.removeMarkup(d,b,a.activeEditable.obj):(d.isCollapsed()&&g.Utils.Dom.extendToWord(d),g.Utils.Dom.addMarkup(d,b)),d.select(),!1},tooltip:e.t("button."+j+".tooltip"),toggle:!0}),markup:c("<"+j+"></"+j+">")},d.addButton(b,h.buttons[j].button,f.t("floatingmenu.tab.format"),1);break;case"p":case"h1":case"h2":case"h3":case"h4":case"h5":case"h6":case"pre":h.multiSplitItems.push({name:j,tooltip:e.t("button."+j+".tooltip"),iconClass:"aloha-button "+e.t("aloha-button-"+j),markup:c("<"+j+"></"+j+">"),click:function(){var b=c(".aloha-cell-selected");if(b.length>0){var d=0;return b.each(function(){var a=c(this).find("div"),b=a.find(j);b.length>0&&(b.contents().unwrap(),d++),a.contents().wrap("<"+j+"></"+j+">")}),d==b.length&&b.find(j).contents().unwrap(),!1}a.Selection.changeMarkupOnSelection(c("<"+j+"></"+j+">"))}});break;case"removeFormat":h.multiSplitItems.push({name:j,text:e.t("button."+j+".text"),tooltip:e.t("button."+j+".tooltip"),iconClass:"aloha-button aloha-button-"+j,wide:!0,click:function(){h.removeFormat()}});break;default:a.log("warn",this,'Button "'+j+'" is not defined')}}),this.multiSplitItems.length>0&&(this.multiSplitButton=new a.ui.MultiSplitButton({name:"phrasing",items:this.multiSplitItems}),d.addButton(b,this.multiSplitButton,f.t("floatingmenu.tab.format"),3)),a.bind("aloha-selection-changed",function(b,d){var e=!1,f,g,i,j,k;c.each(h.buttons,function(b,c){e=!1;for(i=0;i<d.markupEffectiveAtStart.length;i++)f=d.markupEffectiveAtStart[i],a.Selection.standardTextLevelSemanticsComparator(f,c.markup)&&(c.button.setPressed(!0),e=!0);e||c.button.setPressed(!1)});if(h.multiSplitItems.length>0){g=!1;for(i=0;i<d.markupEffectiveAtStart.length&&!g;i++){f=d.markupEffectiveAtStart[i];for(j=0;j<h.multiSplitItems.length&&!g;j++){k=h.multiSplitItems[j];if(!k.markup)continue;a.Selection.standardTextLevelSemanticsComparator(f,k.markup)&&(h.multiSplitButton.setActiveItem(k.name),g=!0)}}g||h.multiSplitButton.setActiveItem(null)}})},removeFormat:function(){var b=["strong","em","b","i","cite","q","code","abbr","del","sub","sup"],d=a.Selection.rangeObject,e;this.settings.removeFormats&&(b=this.settings.removeFormats);if(d.isCollapsed())return;for(e=0;e<b.length;e++)g.Utils.Dom.removeMarkup(d,c("<"+b[e]+"></"+b[e]+">"),a.activeEditable.obj);d.select()},toString:function(){return"format"}})});