/*!
 * Aloha Editor
 * Author & Copyright (c) 2010 Gentics Software GmbH
 * aloha-sales@gentics.com
 * Licensed unter the terms of http://www.aloha-editor.com/license.html
 *
 * Aloha Link Plugin
 * -----------------
 * This plugin provides an interface to allow the user to insert, edit and
 * remove links within an active editable.
 * It presents its user interface in the Floating menu, in a Sidebar panel.
 * Clicking on any links inside the editable activates the this plugin's
 * floating menu scope.
 *
 * @todo Consider whether it would be better to have the target options in the
 *       sidebar panel be a selection box rather than radio buttons.
 */
define(["aloha","aloha/plugin","aloha/jquery","aloha/floatingmenu","i18n!link/nls/i18n","i18n!aloha/nls/i18n","aloha/console","link/../extra/linklist","css!link/css/link.css"],function(a,b,c,d,e,f,g){var h=window.GENTICS,i="aloha-link",j="",k;return b.create("link",{languages:["en","de","fr","ru","pl"],config:["a"],targetregex:"",target:"",cssclassregex:"",cssclass:"",objectTypeFilter:[],onHrefChange:null,ignoreNextSelectionChangedEvent:!1,hrefUpdateInt:null,init:function(){var b=this;typeof this.settings.targetregex!="undefined"&&(this.targetregex=this.settings.targetregex),typeof this.settings.target!="undefined"&&(this.target=this.settings.target),typeof this.settings.cssclassregex!="undefined"&&(this.cssclassregex=this.settings.cssclassregex),typeof this.settings.cssclass!="undefined"&&(this.cssclass=this.settings.cssclass),typeof this.settings.objectTypeFilter!="undefined"&&(this.objectTypeFilter=this.settings.objectTypeFilter),typeof this.settings.onHrefChange!="undefined"&&(this.onHrefChange=this.settings.onHrefChange),this.createButtons(),this.subscribeEvents(),this.bindInteractions(),a.ready(function(){b.initSidebar(a.Sidebar.right)})},nsSel:function(){var a=[],b=i;return c.each(arguments,function(){a.push("."+(this==""?b:b+"-"+this))}),a.join(" ").trim()},nsClass:function(){var a=[],b=i;return c.each(arguments,function(){a.push(this==""?b:b+"-"+this)}),a.join(" ").trim()},initSidebar:function(a){var b=this;b.sidebar=a,a.addPanel({id:b.nsClass("sidebar-panel-target"),title:e.t("floatingmenu.tab.link"),content:"",expanded:!0,activeOn:"a, link",onInit:function(){var a=this,d=this.setContent('<div class="'+b.nsClass("target-container")+'"><fieldset><legend>'+e.t("link.target.legend")+'</legend><ul><li><input type="radio" name="targetGroup" class="'+b.nsClass("radioTarget")+'" value="_self" /><span>'+e.t("link.target.self")+"</span></li>"+'<li><input type="radio" name="targetGroup" class="'+b.nsClass("radioTarget")+'" value="_blank" /><span>'+e.t("link.target.blank")+"</span></li>"+'<li><input type="radio" name="targetGroup" class="'+b.nsClass("radioTarget")+'" value="_parent" /><span>'+e.t("link.target.parent")+"</span></li>"+'<li><input type="radio" name="targetGroup" class="'+b.nsClass("radioTarget")+'" value="_top" /><span>'+e.t("link.target.top")+"</span></li>"+'<li><input type="radio" name="targetGroup" class="'+b.nsClass("radioTarget")+'" value="framename" /><span>'+e.t("link.target.framename")+"</span></li>"+'<li><input type="text" class="'+b.nsClass("framename")+'" /></li></ul></fieldset></div>'+'<div class="'+b.nsClass("title-container")+'" ><fieldset><legend>'+e.t("link.title.legend")+'</legend><input type="text" class="'+b.nsClass("linkTitle")+'" /></fieldset></div>').content;c(b.nsSel("framename")).live("keyup",function(){c(a.effective).attr("target",c(this).val().replace('"',"&quot;").replace("'","&#39;"))}),c(b.nsSel("radioTarget")).live("change",function(){c(this).val()=="framename"?c(b.nsSel("framename")).slideDown():(c(b.nsSel("framename")).slideUp().val(""),c(a.effective).attr("target",c(this).val()))}),c(b.nsSel("linkTitle")).live("keyup",function(){c(a.effective).attr("title",c(this).val().replace('"',"&quot;").replace("'","&#39;"))})},onActivate:function(a){var d=this;d.effective=a;if(c(d.effective).attr("target")!=null){var e=!0;c(b.nsSel("framename")).hide().val(""),c(b.nsSel("radioTarget")).each(function(){c(this).removeAttr("checked"),c(this).val()===c(d.effective).attr("target")&&(e=!1,c(this).attr("checked","checked"))}),e&&(c(b.nsSel('radioTarget[value="framename"]')).attr("checked","checked"),c(b.nsSel("framename")).val(c(d.effective).attr("target")).show())}else c(b.nsSel("radioTarget")).first().attr("checked","checked"),c(d.effective).attr("target",c(b.nsSel("radioTarget")).first().val());var d=this;d.effective=a,c(b.nsSel("linkTitle")).val(c(d.effective).attr("title"))}}),a.show()},subscribeEvents:function(){var b=this;a.bind("aloha-editable-created",function(a,c){c.obj.keydown(function(a){if(a.metaKey&&a.which==76)return b.findLinkMarkup()?(d.activateTabOfButton("href"),b.hrefField.focus()):b.insertLink(),!1}),c.obj.find("a").each(function(a){b.addLinkEventHandlers(this)})}),a.bind("aloha-selection-changed",function(e,f){var g,h;if(!b.ignoreNextSelectionChangedEvent&&a.Selection.isSelectionEditable()&&a.activeEditable!=null){g=b.getEditableConfig(a.activeEditable.obj);if(c.inArray("a",g)==-1){b.formatLinkButton.hide(),b.insertLinkButton.hide();return}b.formatLinkButton.show(),b.insertLinkButton.show(),h=b.findLinkMarkup(f);if(h){b.toggleLinkScope(!0);var i=d.userActivatedTab;d.activateTabOfButton("href"),i&&(d.userActivatedTab=i),b.hrefField.setTargetObject(h,"href"),c("#"+b.hrefField.extButton.id).length==0&&(b.hrefUpdateInt!==null&&clearInterval(b.hrefUpdateInt),b.hrefUpdateInt=setInterval(function(){c("#"+b.hrefField.extButton.id).length>0&&(b.hrefField.setTargetObject(h,"href"),clearInterval(b.hrefUpdateInt))},200)),a.trigger("aloha-link-selected")}else b.toggleLinkScope(!1),b.hrefField.setTargetObject(null),a.trigger("aloha-link-unselected")}b.ignoreNextSelectionChangedEvent=!1})},toggleLinkScope:function(a){a?(this.insertLinkButton.hide(),this.hrefField.show(),this.removeLinkButton.show(),this.formatLinkButton.setPressed(!0)):(this.insertLinkButton.show(),this.hrefField.hide(),this.removeLinkButton.hide(),this.formatLinkButton.setPressed(!1))},addLinkEventHandlers:function(b){var d=this;c(b).mouseenter(function(c){a.Log.debug(d,"mouse over link."),d.mouseOverLink=b,d.updateMousePointer()}),c(b).mouseleave(function(b){a.Log.debug(d,"mouse left link."),d.mouseOverLink=null,d.updateMousePointer()}),c(b).click(function(b){if(b.metaKey)return a.activeEditable.blur(),setTimeout(function(){location.href=b.target},0),b.stopPropagation(),!1})},createButtons:function(){var b=this;this.formatLinkButton=new a.ui.Button({name:"a",iconClass:"aloha-button aloha-button-a",size:"small",onclick:function(){b.formatLink()},tooltip:e.t("button.addlink.tooltip"),toggle:!0}),d.addButton("Aloha.continuoustext",this.formatLinkButton,f.t("floatingmenu.tab.format"),1),this.insertLinkButton=new a.ui.Button({name:"insertLink",iconClass:"aloha-button aloha-button-a",size:"small",onclick:function(){b.insertLink(!1)},tooltip:e.t("button.addlink.tooltip"),toggle:!1}),d.addButton("Aloha.continuoustext",this.insertLinkButton,f.t("floatingmenu.tab.insert"),1),this.hrefField=new a.ui.AttributeField({name:"href",width:320,valueField:"url",cls:"aloha-link-href-field"}),this.hrefField.setTemplate("<span><b>{name}</b><br/>{url}</span>"),this.hrefField.setObjectTypeFilter(this.objectTypeFilter),d.addButton("Aloha.continuoustext",this.hrefField,e.t("floatingmenu.tab.link"),1),this.removeLinkButton=new a.ui.Button({name:"removeLink",iconClass:"aloha-button aloha-button-a-remove",size:"small",onclick:function(){b.removeLink()},tooltip:e.t("button.removelink.tooltip")}),d.addButton("Aloha.continuoustext",this.removeLinkButton,e.t("floatingmenu.tab.link"),1)},bindInteractions:function(){var b=this;this.hrefField.addListener("keyup",function(e,f){b.showComboList();if(f.keyCode==27){var g=b.hrefField.getQueryValue();g[0]!="/"&&g[0]!="#"&&!g.match(/^.*\.([a-z]){2,4}$/i)&&!g.match(/^htt.*/i)&&(b.hrefField.setValue(b.hrefField.getValue()),b.hideComboList())}b.hrefChange();if(f.keyCode==13){var h=a.Selection.getRangeObject();b.ignoreNextSelectionChangedEvent=!0,h.startContainer=h.endContainer,h.startOffset=h.endOffset,h.select(),b.ignoreNextSelectionChangedEvent=!0;var i=c(b.hrefField.extButton.el.dom).attr("value");(i=="http://"||i=="")&&b.removeLink(!1),setTimeout(function(){d.setScope("Aloha.continuoustext")},100),b.preventAutoSuggestionBoxFromExpanding()}else{k=c(b.hrefField.extButton.el.dom).attr("value");if(j!=k){j=k;var l=b.hrefField.extButton.store.data;l.items=[],l.key=[],l.length=0,b.hrefField.extButton.store.lastQuery=null}}}),c(document).keydown(function(c){a.Log.debug(b,"Meta key down."),b.metaKey=c.metaKey,b.updateMousePointer()}).keyup(function(c){a.Log.debug(b,"Meta key up."),b.metaKey=c.metaKey,b.updateMousePointer()})},updateMousePointer:function(){this.metaKey&&this.mouseOverLink?(a.Log.debug(this,"set pointer"),c(this.mouseOverLink).removeClass("aloha-link-text"),c(this.mouseOverLink).addClass("aloha-link-pointer")):(c(this.mouseOverLink).removeClass("aloha-link-pointer"),c(this.mouseOverLink).addClass("aloha-link-text"))},findLinkMarkup:function(b){return typeof b=="undefined"&&(b=a.Selection.getRangeObject()),a.activeEditable?b.findMarkup(function(){return this.nodeName.toLowerCase()=="a"},a.activeEditable.obj):null},formatLink:function(){a.activeEditable&&(this.findLinkMarkup(a.Selection.getRangeObject())?this.removeLink():this.insertLink())},insertLink:function(b){var f=this,g=a.Selection.getRangeObject(),i,j;if(!g.startContainer||!g.endContainer)return;if(this.findLinkMarkup(g))return;d.activateTabOfButton("href"),g.isCollapsed()&&b!==!1&&h.Utils.Dom.extendToWord(g),g.isCollapsed()?(i=e.t("newlink.defaulttext"),j=c('<a href="" class="aloha-new-link">'+i+"</a>"),h.Utils.Dom.insertIntoDOM(j,g,c(a.activeEditable.obj)),g.startContainer=g.endContainer=j.contents().get(0),g.startOffset=0,g.endOffset=i.length):(j=c('<a href="" class="aloha-new-link"></a>'),h.Utils.Dom.addMarkup(g,j,!1)),a.activeEditable.obj.find("a.aloha-new-link").each(function(a){f.addLinkEventHandlers(this),c(this).removeClass("aloha-new-link")}),g.select(),this.hrefField.focus(),this.hrefField.extButton.el&&c(this.hrefField.extButton.el.dom).attr("value","http://").select(),this.hrefChange()},removeLink:function(b){var c=a.Selection.getRangeObject(),e=this.findLinkMarkup();this.hrefField.setItem(null),e&&(h.Utils.Dom.removeFromDOM(e,c,!0),c.startContainer=c.endContainer,c.startOffset=c.endOffset,c.select(),(typeof b=="undefined"||b===!0)&&d.setScope("Aloha.continuoustext"))},hrefChange:function(){var b=this;this.target!=""&&this.hrefField.setAttribute("target",this.target,this.targetregex,this.hrefField.getQueryValue()),this.hrefField.setAttribute("class",this.cssclass,this.cssclassregex,this.hrefField.getQueryValue()),a.trigger("aloha-link-href-change",{obj:b.hrefField.getTargetObject(),href:b.hrefField.getQueryValue(),item:b.hrefField.getItem()}),typeof this.onHrefChange=="function"&&this.onHrefChange.call(this,this.hrefField.getTargetObject(),this.hrefField.getQueryValue(),this.hrefField.getItem())},preventAutoSuggestionBoxFromExpanding:function(){this.hrefField.extButton.hasFocus=!1},showComboList:function(){c(".x-layer x-combo-list,.x-combo-list-inner,.x-combo-list").show()},hideComboList:function(){c(".x-layer x-combo-list,.x-combo-list-inner,.x-combo-list").hide()},makeClean:function(a){a.find("a").each(function(){c(this).removeClass("aloha-link-pointer").removeClass("aloha-link-text")})}})});