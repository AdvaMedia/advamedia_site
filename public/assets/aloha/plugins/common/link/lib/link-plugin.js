/*!
 * Aloha Editor
 * Author & Copyright (c) 2010 Gentics Software GmbH
 * aloha-sales@gentics.com
 * Licensed unter the terms of http://www.aloha-editor.com/license.html
 *
 * Aloha Link Plugin
 * -----------------
 * This plugin provides an interface to allow the user to insert, edit and
 * remove links within an active editable.
 * It presents its user interface in the Floating menu, in a Sidebar panel.
 * Clicking on any links inside the editable activates the this plugin's
 * floating menu scope.
 *
 * @todo Consider whether it would be better to have the target options in the
 *       sidebar panel be a selection box rather than radio buttons.
 */
define(["aloha","aloha/plugin","aloha/jquery","aloha/floatingmenu","i18n!link/nls/i18n","i18n!aloha/nls/i18n","aloha/console","link/../extra/linklist","css!link/css/link.css"],function(e,t,n,r,i,s,o){var u=window.GENTICS,a="aloha-link",f="",l;return t.create("link",{languages:["en","de","fr","ru","pl"],config:["a"],targetregex:"",target:"",cssclassregex:"",cssclass:"",objectTypeFilter:[],onHrefChange:null,ignoreNextSelectionChangedEvent:!1,hrefUpdateInt:null,init:function(){var t=this;typeof this.settings.targetregex!="undefined"&&(this.targetregex=this.settings.targetregex),typeof this.settings.target!="undefined"&&(this.target=this.settings.target),typeof this.settings.cssclassregex!="undefined"&&(this.cssclassregex=this.settings.cssclassregex),typeof this.settings.cssclass!="undefined"&&(this.cssclass=this.settings.cssclass),typeof this.settings.objectTypeFilter!="undefined"&&(this.objectTypeFilter=this.settings.objectTypeFilter),typeof this.settings.onHrefChange!="undefined"&&(this.onHrefChange=this.settings.onHrefChange),this.createButtons(),this.subscribeEvents(),this.bindInteractions(),e.ready(function(){t.initSidebar(e.Sidebar.right)})},nsSel:function(){var e=[],t=a;return n.each(arguments,function(){e.push("."+(this==""?t:t+"-"+this))}),e.join(" ").trim()},nsClass:function(){var e=[],t=a;return n.each(arguments,function(){e.push(this==""?t:t+"-"+this)}),e.join(" ").trim()},initSidebar:function(e){var t=this;t.sidebar=e,e.addPanel({id:t.nsClass("sidebar-panel-target"),title:i.t("floatingmenu.tab.link"),content:"",expanded:!0,activeOn:"a, link",onInit:function(){var e=this,r=this.setContent('<div class="'+t.nsClass("target-container")+'"><fieldset><legend>'+i.t("link.target.legend")+'</legend><ul><li><input type="radio" name="targetGroup" class="'+t.nsClass("radioTarget")+'" value="_self" /><span>'+i.t("link.target.self")+"</span></li>"+'<li><input type="radio" name="targetGroup" class="'+t.nsClass("radioTarget")+'" value="_blank" /><span>'+i.t("link.target.blank")+"</span></li>"+'<li><input type="radio" name="targetGroup" class="'+t.nsClass("radioTarget")+'" value="_parent" /><span>'+i.t("link.target.parent")+"</span></li>"+'<li><input type="radio" name="targetGroup" class="'+t.nsClass("radioTarget")+'" value="_top" /><span>'+i.t("link.target.top")+"</span></li>"+'<li><input type="radio" name="targetGroup" class="'+t.nsClass("radioTarget")+'" value="framename" /><span>'+i.t("link.target.framename")+"</span></li>"+'<li><input type="text" class="'+t.nsClass("framename")+'" /></li></ul></fieldset></div>'+'<div class="'+t.nsClass("title-container")+'" ><fieldset><legend>'+i.t("link.title.legend")+'</legend><input type="text" class="'+t.nsClass("linkTitle")+'" /></fieldset></div>').content;n(t.nsSel("framename")).live("keyup",function(){n(e.effective).attr("target",n(this).val().replace('"',"&quot;").replace("'","&#39;"))}),n(t.nsSel("radioTarget")).live("change",function(){n(this).val()=="framename"?n(t.nsSel("framename")).slideDown():(n(t.nsSel("framename")).slideUp().val(""),n(e.effective).attr("target",n(this).val()))}),n(t.nsSel("linkTitle")).live("keyup",function(){n(e.effective).attr("title",n(this).val().replace('"',"&quot;").replace("'","&#39;"))})},onActivate:function(e){var r=this;r.effective=e;if(n(r.effective).attr("target")!=null){var i=!0;n(t.nsSel("framename")).hide().val(""),n(t.nsSel("radioTarget")).each(function(){n(this).removeAttr("checked"),n(this).val()===n(r.effective).attr("target")&&(i=!1,n(this).attr("checked","checked"))}),i&&(n(t.nsSel('radioTarget[value="framename"]')).attr("checked","checked"),n(t.nsSel("framename")).val(n(r.effective).attr("target")).show())}else n(t.nsSel("radioTarget")).first().attr("checked","checked"),n(r.effective).attr("target",n(t.nsSel("radioTarget")).first().val());var r=this;r.effective=e,n(t.nsSel("linkTitle")).val(n(r.effective).attr("title"))}}),e.show()},subscribeEvents:function(){var t=this;e.bind("aloha-editable-created",function(e,n){n.obj.keydown(function(e){if(e.metaKey&&e.which==76)return t.findLinkMarkup()?(r.activateTabOfButton("href"),t.hrefField.focus()):t.insertLink(),!1}),n.obj.find("a").each(function(e){t.addLinkEventHandlers(this)})}),e.bind("aloha-selection-changed",function(i,s){var o,u;if(!t.ignoreNextSelectionChangedEvent&&e.Selection.isSelectionEditable()&&e.activeEditable!=null){o=t.getEditableConfig(e.activeEditable.obj);if(n.inArray("a",o)==-1){t.formatLinkButton.hide(),t.insertLinkButton.hide();return}t.formatLinkButton.show(),t.insertLinkButton.show(),u=t.findLinkMarkup(s);if(u){t.toggleLinkScope(!0);var a=r.userActivatedTab;r.activateTabOfButton("href"),a&&(r.userActivatedTab=a),t.hrefField.setTargetObject(u,"href"),n("#"+t.hrefField.extButton.id).length==0&&(t.hrefUpdateInt!==null&&clearInterval(t.hrefUpdateInt),t.hrefUpdateInt=setInterval(function(){n("#"+t.hrefField.extButton.id).length>0&&(t.hrefField.setTargetObject(u,"href"),clearInterval(t.hrefUpdateInt))},200)),e.trigger("aloha-link-selected")}else t.toggleLinkScope(!1),t.hrefField.setTargetObject(null),e.trigger("aloha-link-unselected")}t.ignoreNextSelectionChangedEvent=!1})},toggleLinkScope:function(e){e?(this.insertLinkButton.hide(),this.hrefField.show(),this.removeLinkButton.show(),this.formatLinkButton.setPressed(!0)):(this.insertLinkButton.show(),this.hrefField.hide(),this.removeLinkButton.hide(),this.formatLinkButton.setPressed(!1))},addLinkEventHandlers:function(t){var r=this;n(t).mouseenter(function(n){e.Log.debug(r,"mouse over link."),r.mouseOverLink=t,r.updateMousePointer()}),n(t).mouseleave(function(t){e.Log.debug(r,"mouse left link."),r.mouseOverLink=null,r.updateMousePointer()}),n(t).click(function(t){if(t.metaKey)return e.activeEditable.blur(),setTimeout(function(){location.href=t.target},0),t.stopPropagation(),!1})},createButtons:function(){var t=this;this.formatLinkButton=new e.ui.Button({name:"a",iconClass:"aloha-button aloha-button-a",size:"small",onclick:function(){t.formatLink()},tooltip:i.t("button.addlink.tooltip"),toggle:!0}),r.addButton("Aloha.continuoustext",this.formatLinkButton,s.t("floatingmenu.tab.format"),1),this.insertLinkButton=new e.ui.Button({name:"insertLink",iconClass:"aloha-button aloha-button-a",size:"small",onclick:function(){t.insertLink(!1)},tooltip:i.t("button.addlink.tooltip"),toggle:!1}),r.addButton("Aloha.continuoustext",this.insertLinkButton,s.t("floatingmenu.tab.insert"),1),this.hrefField=new e.ui.AttributeField({name:"href",width:320,valueField:"url",cls:"aloha-link-href-field"}),this.hrefField.setTemplate("<span><b>{name}</b><br/>{url}</span>"),this.hrefField.setObjectTypeFilter(this.objectTypeFilter),r.addButton("Aloha.continuoustext",this.hrefField,i.t("floatingmenu.tab.link"),1),this.removeLinkButton=new e.ui.Button({name:"removeLink",iconClass:"aloha-button aloha-button-a-remove",size:"small",onclick:function(){t.removeLink()},tooltip:i.t("button.removelink.tooltip")}),r.addButton("Aloha.continuoustext",this.removeLinkButton,i.t("floatingmenu.tab.link"),1)},bindInteractions:function(){var t=this;this.hrefField.addListener("keyup",function(i,s){t.showComboList();if(s.keyCode==27){var o=t.hrefField.getQueryValue();o[0]!="/"&&o[0]!="#"&&!o.match(/^.*\.([a-z]){2,4}$/i)&&!o.match(/^htt.*/i)&&(t.hrefField.setValue(t.hrefField.getValue()),t.hideComboList())}t.hrefChange();if(s.keyCode==13){var u=e.Selection.getRangeObject();t.ignoreNextSelectionChangedEvent=!0,u.startContainer=u.endContainer,u.startOffset=u.endOffset,u.select(),t.ignoreNextSelectionChangedEvent=!0;var a=n(t.hrefField.extButton.el.dom).attr("value");(a=="http://"||a=="")&&t.removeLink(!1),setTimeout(function(){r.setScope("Aloha.continuoustext")},100),t.preventAutoSuggestionBoxFromExpanding()}else{l=n(t.hrefField.extButton.el.dom).attr("value");if(f!=l){f=l;var c=t.hrefField.extButton.store.data;c.items=[],c.key=[],c.length=0,t.hrefField.extButton.store.lastQuery=null}}}),n(document).keydown(function(n){e.Log.debug(t,"Meta key down."),t.metaKey=n.metaKey,t.updateMousePointer()}).keyup(function(n){e.Log.debug(t,"Meta key up."),t.metaKey=n.metaKey,t.updateMousePointer()})},updateMousePointer:function(){this.metaKey&&this.mouseOverLink?(e.Log.debug(this,"set pointer"),n(this.mouseOverLink).removeClass("aloha-link-text"),n(this.mouseOverLink).addClass("aloha-link-pointer")):(n(this.mouseOverLink).removeClass("aloha-link-pointer"),n(this.mouseOverLink).addClass("aloha-link-text"))},findLinkMarkup:function(t){return typeof t=="undefined"&&(t=e.Selection.getRangeObject()),e.activeEditable?t.findMarkup(function(){return this.nodeName.toLowerCase()=="a"},e.activeEditable.obj):null},formatLink:function(){e.activeEditable&&(this.findLinkMarkup(e.Selection.getRangeObject())?this.removeLink():this.insertLink())},insertLink:function(t){var s=this,o=e.Selection.getRangeObject(),a,f;if(!o.startContainer||!o.endContainer)return;if(this.findLinkMarkup(o))return;r.activateTabOfButton("href"),o.isCollapsed()&&t!==!1&&u.Utils.Dom.extendToWord(o),o.isCollapsed()?(a=i.t("newlink.defaulttext"),f=n('<a href="" class="aloha-new-link">'+a+"</a>"),u.Utils.Dom.insertIntoDOM(f,o,n(e.activeEditable.obj)),o.startContainer=o.endContainer=f.contents().get(0),o.startOffset=0,o.endOffset=a.length):(f=n('<a href="" class="aloha-new-link"></a>'),u.Utils.Dom.addMarkup(o,f,!1)),e.activeEditable.obj.find("a.aloha-new-link").each(function(e){s.addLinkEventHandlers(this),n(this).removeClass("aloha-new-link")}),o.select(),this.hrefField.focus(),this.hrefField.extButton.el&&n(this.hrefField.extButton.el.dom).attr("value","http://").select(),this.hrefChange()},removeLink:function(t){var n=e.Selection.getRangeObject(),i=this.findLinkMarkup();this.hrefField.setItem(null),i&&(u.Utils.Dom.removeFromDOM(i,n,!0),n.startContainer=n.endContainer,n.startOffset=n.endOffset,n.select(),(typeof t=="undefined"||t===!0)&&r.setScope("Aloha.continuoustext"))},hrefChange:function(){var t=this;this.target!=""&&this.hrefField.setAttribute("target",this.target,this.targetregex,this.hrefField.getQueryValue()),this.hrefField.setAttribute("class",this.cssclass,this.cssclassregex,this.hrefField.getQueryValue()),e.trigger("aloha-link-href-change",{obj:t.hrefField.getTargetObject(),href:t.hrefField.getQueryValue(),item:t.hrefField.getItem()}),typeof this.onHrefChange=="function"&&this.onHrefChange.call(this,this.hrefField.getTargetObject(),this.hrefField.getQueryValue(),this.hrefField.getItem())},preventAutoSuggestionBoxFromExpanding:function(){this.hrefField.extButton.hasFocus=!1},showComboList:function(){n(".x-layer x-combo-list,.x-combo-list-inner,.x-combo-list").show()},hideComboList:function(){n(".x-layer x-combo-list,.x-combo-list-inner,.x-combo-list").hide()},makeClean:function(e){e.find("a").each(function(){n(this).removeClass("aloha-link-pointer").removeClass("aloha-link-text")})}})});