/*!
* Aloha Editor
* Author & Copyright (c) 2010 Gentics Software GmbH
* aloha-sales@gentics.com
* Licensed unter the terms of http://www.aloha-editor.com/license.html
*/
define(["aloha","aloha/jquery","aloha/plugin","aloha/floatingmenu","i18n!list/nls/i18n","i18n!aloha/nls/i18n","aloha/engine"],function(e,t,n,r,s,o,u){function l(n){if(8!=n.keyCode&&46!=n.keyCode)return!1;var r=e.getSelection().getRangeAt(0),i=r.startContainer,s=t(i).closest("ul, ol");if(!s.length)return!1;var o=s.parent().closest("ul, ol");if(!o.length)return!1;var u=e.getSelection().getAllRanges(),a=!1;o.each(function(){a=a||c(t(this))});if(a){e.getSelection().setRanges(u);for(var f=0;f<u.length;f++)u[f].detach()}return a}function c(n){var r=!1;return n.children("ul, ol").each(function(){e.Log.debug("performing list-nesting cleanup"),t(this).prev("li").append(this).length||t(this).parent().prepend(document.createElement("li")).append(this),r=!0}),r}var a=window.GENTICS,f=n.create("list",{languages:["en","de","fr","eo","fi","ru","it"],config:["ul","ol"],transformableElements:{p:!0,h1:!0,h2:!0,h3:!0,h4:!0,h5:!0,h6:!0,ul:!0,ol:!0},init:function(){var n=this;this.createUnorderedListButton=new e.ui.Button({name:"ul",iconClass:"aloha-button aloha-button-ul",size:"small",tooltip:s.t("button.createulist.tooltip"),toggle:!0,onclick:function(e,t){n.transformList(!1)}}),r.addButton("Aloha.continuoustext",this.createUnorderedListButton,o.t("floatingmenu.tab.format"),1),this.createOrderedListButton=new e.ui.Button({name:"ol",iconClass:"aloha-button aloha-button-ol",size:"small",tooltip:s.t("button.createolist.tooltip"),toggle:!0,onclick:function(e,t){n.transformList(!0)}}),r.addButton("Aloha.continuoustext",this.createOrderedListButton,o.t("floatingmenu.tab.format"),1),r.createScope("Aloha.List","Aloha.continuoustext"),this.indentListButton=new e.ui.Button({name:"indent-list",iconClass:"aloha-button aloha-button-indent-list",size:"small",tooltip:s.t("button.indentlist.tooltip"),toggle:!1,onclick:function(e,t){n.indentList()}}),r.addButton("Aloha.continuoustext",this.indentListButton,s.t("floatingmenu.tab.list"),1),this.outdentListButton=new e.ui.Button({name:"outdent-list",iconClass:"aloha-button aloha-button-outdent-list",size:"small",tooltip:s.t("button.outdentlist.tooltip"),toggle:!1,onclick:function(e,t){n.outdentList()}}),r.addButton("Aloha.continuoustext",this.outdentListButton,s.t("floatingmenu.tab.list"),1),e.bind("aloha-selection-changed",function(i,s){var o,u;n.outdentListButton.hide(),n.indentListButton.hide(),n.createUnorderedListButton.setPressed(!1),n.createOrderedListButton.setPressed(!1);for(o=0;o<s.markupEffectiveAtStart.length;o++){u=s.markupEffectiveAtStart[o];if(e.Selection.standardTagNameComparator(u,t("<ul></ul>"))){n.createUnorderedListButton.setPressed(!0),n.outdentListButton.show(),n.indentListButton.show();break}if(e.Selection.standardTagNameComparator(u,t("<ol></ol>"))){n.createOrderedListButton.setPressed(!0),n.outdentListButton.show(),n.indentListButton.show();break}}e.activeEditable&&n.applyButtonConfig(e.activeEditable.obj),r.doLayout()}),e.Markup.addKeyHandler(9,function(e){return n.processTab(e)})},applyButtonConfig:function(n){var r=this.getEditableConfig(n);e.Selection.rangeObject.unmodifiableMarkupAtStart[0]&&(t.inArray("ul",r)!=-1&&e.Selection.canTag1WrapTag2(e.Selection.rangeObject.unmodifiableMarkupAtStart[0].nodeName,"ul")!=-1?this.createUnorderedListButton.show():this.createUnorderedListButton.hide(),t.inArray("ol",r)!=-1&&e.Selection.canTag1WrapTag2(e.Selection.rangeObject.unmodifiableMarkupAtStart[0].nodeName,"ol")!=-1?this.createOrderedListButton.show():this.createOrderedListButton.hide())},processTab:function(e){return e.keyCode===9?e.shiftKey?this.outdentList():this.indentList():!0},getStartingDomObjectToTransform:function(){var t=e.Selection.rangeObject,n,r;for(n=0;n<t.markupEffectiveAtStart.length;n++){r=t.markupEffectiveAtStart[n];if(this.transformableElements[r.nodeName.toLowerCase()])return r}return!1},getNearestSelectedListItem:function(){var t=e.Selection.rangeObject,n,r;for(n=0;n<t.markupEffectiveAtStart.length;n++){r=t.markupEffectiveAtStart[n];if(a.Utils.Dom.isListElement(r))return r}return!1},transformList:function(n){var r=this.getStartingDomObjectToTransform(),i,s,o,u,f,l,c,h,p;this.outdentListButton.show(),this.indentListButton.show();if(!r){e.Selection.changeMarkupOnSelection(t("<p></p>")),r=this.getStartingDomObjectToTransform();if(!r){if(e.Selection.rangeObject.startContainer.contentEditable){u=n?t("<ol></ol>"):t("<ul></ul>"),o=t("<li></li>"),u.append(o);var d=o.get(0),v=e.getActiveEditable().obj;d.appendChild(document.createTextNode("")),v.append(u),v.focus();var m=e.createRange(),g=e.getSelection();m.setStart(d.firstChild,0),m.setEnd(d.firstChild,0),g.removeAllRanges(),g.addRange(m),e.Selection.updateSelection();return}e.Log.error(this,"Could not transform selection into a list");return}}p=r.nodeName.toLowerCase();if(p=="ul"&&!n)u=t(r),l=u.parent(),l.length>0&&a.Utils.Dom.isListElement(l.get(0))?l.get(0).nodeName.toLowerCase()==="li"?(l.after(u.children()),u.remove()):u.children().unwrap():(h=t(r),t.each(h.children("li"),function(t,n){c=e.Markup.transformDomObject(n,"p",e.Selection.rangeObject),c.after(c.children("ol,ul"))}),h.children().unwrap());else if(p=="ul"&&n)e.Markup.transformDomObject(r,"ol",e.Selection.rangeObject),this.mergeAdjacentLists(t(r));else if(p=="ol"&&!n)e.Markup.transformDomObject(r,"ul",e.Selection.rangeObject),this.mergeAdjacentLists(t(r));else if(p=="ol"&&n)u=t(r),l=u.parent(),l.length>0&&a.Utils.Dom.isListElement(l.get(0))?l.get(0).nodeName.toLowerCase()==="li"?(l.after(u.children()),u.remove()):u.children().unwrap():(h=t(r),t.each(h.children("li"),function(t,n){c=e.Markup.transformDomObject(n,"p",e.Selection.rangeObject),c.after(c.children("ol,ul"))}),h.children().unwrap());else{f=e.Selection.rangeObject.getSelectedSiblings(r),u=n?t("<ol></ol>"):t("<ul></ul>"),o=t("<li></li>"),u.append(o),t(r).contents().appendTo(o),t(r).replaceWith(u),e.Selection.rangeObject.startContainer==r&&(e.Selection.rangeObject.startContainer=o.get(0)),e.Selection.rangeObject.endContainer==r&&(e.Selection.rangeObject.endContainer=o.get(0));var y=o;if(f){i=!1;for(s=0;s<f.length;++s)if(a.Utils.Dom.isBlockLevelElement(f[s]))i&&(i=!1),o=e.Markup.transformDomObject(f[s],"li",e.Selection.rangeObject),u.append(o),y=o;else{if(f[s].nodeType==3&&t.trim(f[s].data).length===0)continue;i||(i=t("<li></li>"),u.append(i),y=i),i.append(f[s])}}this.mergeAdjacentLists(u);var d=y.get(0);if(a.Utils.Dom.isEmpty(d)){var m=e.createRange(),g=e.getSelection();d.appendChild(document.createTextNode("")),m.selectNodeContents(d.lastChild),g.removeAllRanges(),g.addRange(m),e.Selection.updateSelection()}}this.refreshSelection()},indentList:function(){var n=this.getNearestSelectedListItem(),r,i,s,o,u;if(n){u=t(n).prev("li");if(u.length===0)return!1;o=t(n).parent(),s=e.Selection.rangeObject.getSelectedSiblings(n),i=t(n).parent().clone(!1).empty(),i.append(n),u.append(i);if(s)for(r=0;r<s.length;++r)i.append(t(s[r]));return this.mergeAdjacentLists(i,!0),this.refreshSelection(),!1}return!0},outdentList:function(){var n=this.getNearestSelectedListItem(),r,i,s,o,u,f,l,c;if(n){s=t(n),o=s.parent(),u=o.parents("ul,ol"),f=o.parent("li");if(u.length>0&&a.Utils.Dom.isListElement(u.get(0))){l=e.Selection.rangeObject.getSelectedSiblings(n),l&&l.length>0?c=t(l[l.length-1]):c=s,c.nextAll("li").length>0&&(i=o.clone(!1).empty(),i.append(c.nextAll()),c.append(i)),f.length>0?f.after(s):o.before(s);if(l&&l.length>0)for(r=l.length-1;r>=0;--r)s.after(t(l[r]));o.contents("li").length===0&&o.remove(),f.length>0&&f.contents().length===0&&f.remove(),this.refreshSelection()}return!1}return!0},refreshSelection:function(){e.Selection.rangeObject.update(),e.Selection.rangeObject.select(),e.Selection.updateSelection()},mergeAdjacentLists:function(e,n){var r=e.get(0),i;while(r.previousSibling&&r.previousSibling.nodeType===1&&this.isMergable(r.previousSibling,r,n))r=r.previousSibling;e=t(r);while(r.nextSibling&&(r.nextSibling.nodeType===1&&this.isMergable(r.nextSibling,r,n)||r.nextSibling.nodeType===3&&t.trim(r.nextSibling.data).length===0))i=t(r.nextSibling),r.nextSibling.nodeType==1&&i.contents().appendTo(e),i.remove()},isMergable:function(e,t,n){return n?e.nodeName.toLowerCase()=="ul"||e.nodeName.toLowerCase()=="ol":e.nodeName==t.nodeName}});return u.commands.insertorderedlist={action:function(t,n){f.transformList(!0),n&&e.Selection.rangeObject&&(n.startContainer=e.Selection.rangeObject.startContainer,n.startOffset=e.Selection.rangeObject.startOffset,n.endContainer=e.Selection.rangeObject.endContainer,n.endOffset=e.Selection.rangeObject.endOffset)},indeterm:function(){},state:function(){for(i=0;i<rangeObject.markupEffectiveAtStart.length;i++){effectiveMarkup=rangeObject.markupEffectiveAtStart[i];if(e.Selection.standardTagNameComparator(effectiveMarkup,t("<ul></ul>")))return!1;if(e.Selection.standardTagNameComparator(effectiveMarkup,t("<ol></ol>")))return!0}return!1}},u.commands.insertunorderedlist={action:function(t,n){f.transformList(!1),n&&e.Selection.rangeObject&&(n.startContainer=e.Selection.rangeObject.startContainer,n.startOffset=e.Selection.rangeObject.startOffset,n.endContainer=e.Selection.rangeObject.endContainer,n.endOffset=e.Selection.rangeObject.endOffset)},indeterm:function(){},state:function(){for(i=0;i<rangeObject.markupEffectiveAtStart.length;i++){effectiveMarkup=rangeObject.markupEffectiveAtStart[i];if(e.Selection.standardTagNameComparator(effectiveMarkup,t("<ul></ul>")))return!0;if(e.Selection.standardTagNameComparator(effectiveMarkup,t("<ol></ol>")))return!1}return!1}},u.commands.indent={action:function(t,n){f.indentList(),n&&e.Selection.rangeObject&&(n.startContainer=e.Selection.rangeObject.startContainer,n.startOffset=e.Selection.rangeObject.startOffset,n.endContainer=e.Selection.rangeObject.endContainer,n.endOffset=e.Selection.rangeObject.endOffset)},indeterm:function(){},state:function(){return!1}},u.commands.outdent={action:function(t,n){f.outdentList(),n&&e.Selection.rangeObject&&(n.startContainer=e.Selection.rangeObject.startContainer,n.startOffset=e.Selection.rangeObject.startOffset,n.endContainer=e.Selection.rangeObject.endContainer,n.endOffset=e.Selection.rangeObject.endOffset)},indeterm:function(){},state:function(){return!1}},f});