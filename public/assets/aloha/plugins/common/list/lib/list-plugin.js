/*!
* Aloha Editor
* Author & Copyright (c) 2010 Gentics Software GmbH
* aloha-sales@gentics.com
* Licensed unter the terms of http://www.aloha-editor.com/license.html
*/
define(["aloha","aloha/jquery","aloha/plugin","aloha/floatingmenu","i18n!list/nls/i18n","i18n!aloha/nls/i18n","aloha/engine"],function(a,b,c,d,e,f,g){function k(c){if(8!=c.keyCode&&46!=c.keyCode)return!1;var d=a.getSelection().getRangeAt(0),e=d.startContainer,f=b(e).closest("ul, ol");if(!f.length)return!1;var g=f.parent().closest("ul, ol");if(!g.length)return!1;var h=a.getSelection().getAllRanges(),i=!1;g.each(function(){i=i||l(b(this))});if(i){a.getSelection().setRanges(h);for(var j=0;j<h.length;j++)h[j].detach()}return i}function l(c){var d=!1;return c.children("ul, ol").each(function(){a.Log.debug("performing list-nesting cleanup"),b(this).prev("li").append(this).length||b(this).parent().prepend(document.createElement("li")).append(this),d=!0}),d}var h=window.GENTICS,j=c.create("list",{languages:["en","de","fr","eo","fi","ru","it"],config:["ul","ol"],transformableElements:{p:!0,h1:!0,h2:!0,h3:!0,h4:!0,h5:!0,h6:!0,ul:!0,ol:!0},init:function(){var c=this;this.createUnorderedListButton=new a.ui.Button({name:"ul",iconClass:"aloha-button aloha-button-ul",size:"small",tooltip:e.t("button.createulist.tooltip"),toggle:!0,onclick:function(a,b){c.transformList(!1)}}),d.addButton("Aloha.continuoustext",this.createUnorderedListButton,f.t("floatingmenu.tab.format"),1),this.createOrderedListButton=new a.ui.Button({name:"ol",iconClass:"aloha-button aloha-button-ol",size:"small",tooltip:e.t("button.createolist.tooltip"),toggle:!0,onclick:function(a,b){c.transformList(!0)}}),d.addButton("Aloha.continuoustext",this.createOrderedListButton,f.t("floatingmenu.tab.format"),1),d.createScope("Aloha.List","Aloha.continuoustext"),this.indentListButton=new a.ui.Button({name:"indent-list",iconClass:"aloha-button aloha-button-indent-list",size:"small",tooltip:e.t("button.indentlist.tooltip"),toggle:!1,onclick:function(a,b){c.indentList()}}),d.addButton("Aloha.continuoustext",this.indentListButton,e.t("floatingmenu.tab.list"),1),this.outdentListButton=new a.ui.Button({name:"outdent-list",iconClass:"aloha-button aloha-button-outdent-list",size:"small",tooltip:e.t("button.outdentlist.tooltip"),toggle:!1,onclick:function(a,b){c.outdentList()}}),d.addButton("Aloha.continuoustext",this.outdentListButton,e.t("floatingmenu.tab.list"),1),a.bind("aloha-selection-changed",function(e,f){var g,h;c.outdentListButton.hide(),c.indentListButton.hide(),c.createUnorderedListButton.setPressed(!1),c.createOrderedListButton.setPressed(!1);for(g=0;g<f.markupEffectiveAtStart.length;g++){h=f.markupEffectiveAtStart[g];if(a.Selection.standardTagNameComparator(h,b("<ul></ul>"))){c.createUnorderedListButton.setPressed(!0),c.outdentListButton.show(),c.indentListButton.show();break}if(a.Selection.standardTagNameComparator(h,b("<ol></ol>"))){c.createOrderedListButton.setPressed(!0),c.outdentListButton.show(),c.indentListButton.show();break}}a.activeEditable&&c.applyButtonConfig(a.activeEditable.obj),d.doLayout()}),a.Markup.addKeyHandler(9,function(a){return c.processTab(a)})},applyButtonConfig:function(c){var d=this.getEditableConfig(c);a.Selection.rangeObject.unmodifiableMarkupAtStart[0]&&(b.inArray("ul",d)!=-1&&a.Selection.canTag1WrapTag2(a.Selection.rangeObject.unmodifiableMarkupAtStart[0].nodeName,"ul")!=-1?this.createUnorderedListButton.show():this.createUnorderedListButton.hide(),b.inArray("ol",d)!=-1&&a.Selection.canTag1WrapTag2(a.Selection.rangeObject.unmodifiableMarkupAtStart[0].nodeName,"ol")!=-1?this.createOrderedListButton.show():this.createOrderedListButton.hide())},processTab:function(a){return a.keyCode===9?a.shiftKey?this.outdentList():this.indentList():!0},getStartingDomObjectToTransform:function(){var b=a.Selection.rangeObject,c,d;for(c=0;c<b.markupEffectiveAtStart.length;c++){d=b.markupEffectiveAtStart[c];if(this.transformableElements[d.nodeName.toLowerCase()])return d}return!1},getNearestSelectedListItem:function(){var b=a.Selection.rangeObject,c,d;for(c=0;c<b.markupEffectiveAtStart.length;c++){d=b.markupEffectiveAtStart[c];if(h.Utils.Dom.isListElement(d))return d}return!1},transformList:function(c){var d=this.getStartingDomObjectToTransform(),e,f,g,i,j,k,l,m,n;this.outdentListButton.show(),this.indentListButton.show();if(!d){a.Selection.changeMarkupOnSelection(b("<p></p>")),d=this.getStartingDomObjectToTransform();if(!d){if(a.Selection.rangeObject.startContainer.contentEditable){i=c?b("<ol></ol>"):b("<ul></ul>"),g=b("<li></li>"),i.append(g);var o=g.get(0),p=a.getActiveEditable().obj;o.appendChild(document.createTextNode("")),p.append(i),p.focus();var q=a.createRange(),r=a.getSelection();q.setStart(o.firstChild,0),q.setEnd(o.firstChild,0),r.removeAllRanges(),r.addRange(q),a.Selection.updateSelection();return}a.Log.error(this,"Could not transform selection into a list");return}}n=d.nodeName.toLowerCase();if(n=="ul"&&!c)i=b(d),k=i.parent(),k.length>0&&h.Utils.Dom.isListElement(k.get(0))?k.get(0).nodeName.toLowerCase()==="li"?(k.after(i.children()),i.remove()):i.children().unwrap():(m=b(d),b.each(m.children("li"),function(b,c){l=a.Markup.transformDomObject(c,"p",a.Selection.rangeObject),l.after(l.children("ol,ul"))}),m.children().unwrap());else if(n=="ul"&&c)a.Markup.transformDomObject(d,"ol",a.Selection.rangeObject),this.mergeAdjacentLists(b(d));else if(n=="ol"&&!c)a.Markup.transformDomObject(d,"ul",a.Selection.rangeObject),this.mergeAdjacentLists(b(d));else if(n=="ol"&&c)i=b(d),k=i.parent(),k.length>0&&h.Utils.Dom.isListElement(k.get(0))?k.get(0).nodeName.toLowerCase()==="li"?(k.after(i.children()),i.remove()):i.children().unwrap():(m=b(d),b.each(m.children("li"),function(b,c){l=a.Markup.transformDomObject(c,"p",a.Selection.rangeObject),l.after(l.children("ol,ul"))}),m.children().unwrap());else{j=a.Selection.rangeObject.getSelectedSiblings(d),i=c?b("<ol></ol>"):b("<ul></ul>"),g=b("<li></li>"),i.append(g),b(d).contents().appendTo(g),b(d).replaceWith(i),a.Selection.rangeObject.startContainer==d&&(a.Selection.rangeObject.startContainer=g.get(0)),a.Selection.rangeObject.endContainer==d&&(a.Selection.rangeObject.endContainer=g.get(0));var s=g;if(j){e=!1;for(f=0;f<j.length;++f)if(h.Utils.Dom.isBlockLevelElement(j[f]))e&&(e=!1),g=a.Markup.transformDomObject(j[f],"li",a.Selection.rangeObject),i.append(g),s=g;else{if(j[f].nodeType==3&&b.trim(j[f].data).length===0)continue;e||(e=b("<li></li>"),i.append(e),s=e),e.append(j[f])}}this.mergeAdjacentLists(i);var o=s.get(0);if(h.Utils.Dom.isEmpty(o)){var q=a.createRange(),r=a.getSelection();o.appendChild(document.createTextNode("")),q.selectNodeContents(o.lastChild),r.removeAllRanges(),r.addRange(q),a.Selection.updateSelection()}}this.refreshSelection()},indentList:function(){var c=this.getNearestSelectedListItem(),d,e,f,g,h;if(c){h=b(c).prev("li");if(h.length===0)return!1;g=b(c).parent(),f=a.Selection.rangeObject.getSelectedSiblings(c),e=b(c).parent().clone(!1).empty(),e.append(c),h.append(e);if(f)for(d=0;d<f.length;++d)e.append(b(f[d]));return this.mergeAdjacentLists(e,!0),this.refreshSelection(),!1}return!0},outdentList:function(){var c=this.getNearestSelectedListItem(),d,e,f,g,i,j,k,l;if(c){f=b(c),g=f.parent(),i=g.parents("ul,ol"),j=g.parent("li");if(i.length>0&&h.Utils.Dom.isListElement(i.get(0))){k=a.Selection.rangeObject.getSelectedSiblings(c),k&&k.length>0?l=b(k[k.length-1]):l=f,l.nextAll("li").length>0&&(e=g.clone(!1).empty(),e.append(l.nextAll()),l.append(e)),j.length>0?j.after(f):g.before(f);if(k&&k.length>0)for(d=k.length-1;d>=0;--d)f.after(b(k[d]));g.contents("li").length===0&&g.remove(),j.length>0&&j.contents().length===0&&j.remove(),this.refreshSelection()}return!1}return!0},refreshSelection:function(){a.Selection.rangeObject.update(),a.Selection.rangeObject.select(),a.Selection.updateSelection()},mergeAdjacentLists:function(a,c){var d=a.get(0),e;while(d.previousSibling&&d.previousSibling.nodeType===1&&this.isMergable(d.previousSibling,d,c))d=d.previousSibling;a=b(d);while(d.nextSibling&&(d.nextSibling.nodeType===1&&this.isMergable(d.nextSibling,d,c)||d.nextSibling.nodeType===3&&b.trim(d.nextSibling.data).length===0))e=b(d.nextSibling),d.nextSibling.nodeType==1&&e.contents().appendTo(a),e.remove()},isMergable:function(a,b,c){return c?a.nodeName.toLowerCase()=="ul"||a.nodeName.toLowerCase()=="ol":a.nodeName==b.nodeName}});return g.commands.insertorderedlist={action:function(b,c){j.transformList(!0),c&&a.Selection.rangeObject&&(c.startContainer=a.Selection.rangeObject.startContainer,c.startOffset=a.Selection.rangeObject.startOffset,c.endContainer=a.Selection.rangeObject.endContainer,c.endOffset=a.Selection.rangeObject.endOffset)},indeterm:function(){},state:function(){for(i=0;i<rangeObject.markupEffectiveAtStart.length;i++){effectiveMarkup=rangeObject.markupEffectiveAtStart[i];if(a.Selection.standardTagNameComparator(effectiveMarkup,b("<ul></ul>")))return!1;if(a.Selection.standardTagNameComparator(effectiveMarkup,b("<ol></ol>")))return!0}return!1}},g.commands.insertunorderedlist={action:function(b,c){j.transformList(!1),c&&a.Selection.rangeObject&&(c.startContainer=a.Selection.rangeObject.startContainer,c.startOffset=a.Selection.rangeObject.startOffset,c.endContainer=a.Selection.rangeObject.endContainer,c.endOffset=a.Selection.rangeObject.endOffset)},indeterm:function(){},state:function(){for(i=0;i<rangeObject.markupEffectiveAtStart.length;i++){effectiveMarkup=rangeObject.markupEffectiveAtStart[i];if(a.Selection.standardTagNameComparator(effectiveMarkup,b("<ul></ul>")))return!0;if(a.Selection.standardTagNameComparator(effectiveMarkup,b("<ol></ol>")))return!1}return!1}},g.commands.indent={action:function(b,c){j.indentList(),c&&a.Selection.rangeObject&&(c.startContainer=a.Selection.rangeObject.startContainer,c.startOffset=a.Selection.rangeObject.startOffset,c.endContainer=a.Selection.rangeObject.endContainer,c.endOffset=a.Selection.rangeObject.endOffset)},indeterm:function(){},state:function(){return!1}},g.commands.outdent={action:function(b,c){j.outdentList(),c&&a.Selection.rangeObject&&(c.startContainer=a.Selection.rangeObject.startContainer,c.startOffset=a.Selection.rangeObject.startOffset,c.endContainer=a.Selection.rangeObject.endContainer,c.endOffset=a.Selection.rangeObject.endOffset)},indeterm:function(){},state:function(){return!1}},j});