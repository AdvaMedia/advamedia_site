/*!
* Aloha Editor
* Author & Copyright (c) 2010 Gentics Software GmbH
* aloha-sales@gentics.com
* Licensed unter the terms of http://www.aloha-editor.com/license.html
*/
define(["aloha","aloha/jquery","aloha/plugin","aloha/floatingmenu","i18n!abbr/nls/i18n","i18n!aloha/nls/i18n"],function(e,t,n,r,i,s){var o=window.GENTICS;return n.create("abbr",{languages:["en","de"],config:["abbr"],init:function(){this.createButtons(),this.subscribeEvents(),this.bindInteractions()},createButtons:function(){var t=this;this.formatAbbrButton=new e.ui.Button({name:"abbr",iconClass:"aloha-button aloha-button-abbr",size:"small",onclick:function(){t.formatAbbr()},tooltip:i.t("button.abbr.tooltip"),toggle:!0}),r.addButton("Aloha.continuoustext",this.formatAbbrButton,s.t("floatingmenu.tab.format"),1),this.insertAbbrButton=new e.ui.Button({name:"insertAbbr",iconClass:"aloha-button aloha-button-abbr",size:"small",onclick:function(){t.insertAbbr(!1)},tooltip:i.t("button.addabbr.tooltip"),toggle:!1}),r.addButton("Aloha.continuoustext",this.insertAbbrButton,s.t("floatingmenu.tab.insert"),1),r.createScope("abbr","Aloha.continuoustext"),this.abbrField=new e.ui.AttributeField({width:320,name:"abbrText"}),r.addButton("abbr",this.abbrField,i.t("floatingmenu.tab.abbr"),1)},bindInteractions:function(){var t=this;this.abbrField.addListener("blur",function(e,n){this.getValue()==""&&t.removeAbbr()});for(var n=0;n<e.editables.length;n++)e.editables[n].obj.keydown(function(e){if(e.metaKey&&e.which==71)return t.findAbbrMarkup()?(r.activateTabOfButton("abbrText"),t.abbrField.focus()):t.insertAbbr(),e.stopPropagation(),e.preventDefault(),!1})},subscribeEvents:function(){var n=this;e.bind("aloha-selection-changed",function(i,s){if(e.activeEditable){var o=n.getEditableConfig(e.activeEditable.obj);if(t.inArray("abbr",o)==-1){n.formatAbbrButton.hide(),n.insertAbbrButton.hide();return}n.formatAbbrButton.show(),n.insertAbbrButton.show();var u=n.findAbbrMarkup(s);u?(n.insertAbbrButton.hide(),n.formatAbbrButton.setPressed(!0),r.setScope("abbr"),n.abbrField.setTargetObject(u,"title")):(n.formatAbbrButton.setPressed(!1),n.abbrField.setTargetObject(null))}})},findAbbrMarkup:function(t){if(typeof t=="undefined")var t=e.Selection.getRangeObject();return e.activeEditable?t.findMarkup(function(){return this.nodeName.toLowerCase()=="abbr"},e.activeEditable.obj):null},formatAbbr:function(){var t=e.Selection.getRangeObject();e.activeEditable&&(this.findAbbrMarkup(t)?this.removeAbbr():this.insertAbbr())},insertAbbr:function(n){var s=e.Selection.getRangeObject();if(this.findAbbrMarkup(s))return;r.activateTabOfButton("abbrText"),s.isCollapsed()&&n!=0&&o.Utils.Dom.extendToWord(s);if(s.isCollapsed()){var u=i.t("newabbr.defaulttext"),a=t('<abbr title="">'+u+"</abbr>");o.Utils.Dom.insertIntoDOM(a,s,t(e.activeEditable.obj)),s.startContainer=s.endContainer=a.contents().get(0),s.startOffset=0,s.endOffset=u.length}else{var a=t('<abbr title=""></abbr>');o.Utils.Dom.addMarkup(s,a,!1)}s.select(),this.abbrField.focus()},removeAbbr:function(){var t=e.Selection.getRangeObject(),n=this.findAbbrMarkup();n&&(o.Utils.Dom.removeFromDOM(n,t,!0),t.select())},makeClean:function(e){},toString:function(){return"abbr"}})});