/*!
* Aloha Editor
* Author & Copyright (c) 2010 Gentics Software GmbH
* aloha-sales@gentics.com
* Licensed unter the terms of http://www.aloha-editor.com/license.html
*/
define(["aloha","aloha/jquery","aloha/plugin","aloha/floatingmenu","i18n!abbr/nls/i18n","i18n!aloha/nls/i18n"],function(a,b,c,d,e,f){var g=window.GENTICS;return c.create("abbr",{languages:["en","de"],config:["abbr"],init:function(){this.createButtons(),this.subscribeEvents(),this.bindInteractions()},createButtons:function(){var b=this;this.formatAbbrButton=new a.ui.Button({name:"abbr",iconClass:"aloha-button aloha-button-abbr",size:"small",onclick:function(){b.formatAbbr()},tooltip:e.t("button.abbr.tooltip"),toggle:!0}),d.addButton("Aloha.continuoustext",this.formatAbbrButton,f.t("floatingmenu.tab.format"),1),this.insertAbbrButton=new a.ui.Button({name:"insertAbbr",iconClass:"aloha-button aloha-button-abbr",size:"small",onclick:function(){b.insertAbbr(!1)},tooltip:e.t("button.addabbr.tooltip"),toggle:!1}),d.addButton("Aloha.continuoustext",this.insertAbbrButton,f.t("floatingmenu.tab.insert"),1),d.createScope("abbr","Aloha.continuoustext"),this.abbrField=new a.ui.AttributeField({width:320,name:"abbrText"}),d.addButton("abbr",this.abbrField,e.t("floatingmenu.tab.abbr"),1)},bindInteractions:function(){var b=this;this.abbrField.addListener("blur",function(a,c){this.getValue()==""&&b.removeAbbr()});for(var c=0;c<a.editables.length;c++)a.editables[c].obj.keydown(function(a){if(a.metaKey&&a.which==71)return b.findAbbrMarkup()?(d.activateTabOfButton("abbrText"),b.abbrField.focus()):b.insertAbbr(),a.stopPropagation(),a.preventDefault(),!1})},subscribeEvents:function(){var c=this;a.bind("aloha-selection-changed",function(e,f){if(a.activeEditable){var g=c.getEditableConfig(a.activeEditable.obj);if(b.inArray("abbr",g)==-1){c.formatAbbrButton.hide(),c.insertAbbrButton.hide();return}c.formatAbbrButton.show(),c.insertAbbrButton.show();var h=c.findAbbrMarkup(f);h?(c.insertAbbrButton.hide(),c.formatAbbrButton.setPressed(!0),d.setScope("abbr"),c.abbrField.setTargetObject(h,"title")):(c.formatAbbrButton.setPressed(!1),c.abbrField.setTargetObject(null))}})},findAbbrMarkup:function(b){if(typeof b=="undefined")var b=a.Selection.getRangeObject();return a.activeEditable?b.findMarkup(function(){return this.nodeName.toLowerCase()=="abbr"},a.activeEditable.obj):null},formatAbbr:function(){var b=a.Selection.getRangeObject();a.activeEditable&&(this.findAbbrMarkup(b)?this.removeAbbr():this.insertAbbr())},insertAbbr:function(c){var f=a.Selection.getRangeObject();if(this.findAbbrMarkup(f))return;d.activateTabOfButton("abbrText"),f.isCollapsed()&&c!=0&&g.Utils.Dom.extendToWord(f);if(f.isCollapsed()){var h=e.t("newabbr.defaulttext"),i=b('<abbr title="">'+h+"</abbr>");g.Utils.Dom.insertIntoDOM(i,f,b(a.activeEditable.obj)),f.startContainer=f.endContainer=i.contents().get(0),f.startOffset=0,f.endOffset=h.length}else{var i=b('<abbr title=""></abbr>');g.Utils.Dom.addMarkup(f,i,!1)}f.select(),this.abbrField.focus()},removeAbbr:function(){var b=a.Selection.getRangeObject(),c=this.findAbbrMarkup();c&&(g.Utils.Dom.removeFromDOM(c,b,!0),b.select())},makeClean:function(a){},toString:function(){return"abbr"}})});