define(["aloha","aloha/jquery","table/table-plugin-utils","table/table-cell","i18n!table/nls/i18n"],function(e,t,n,r,i){function o(e){return{top:e.top[0],right:e.right[0]+1,bottom:e.bottom[0]+1,left:e.left[0]}}function u(e,t,r){var i=!0;if(-1!==n.indexOfAnyBut(t.top,t.top[0])||-1!==n.indexOfAnyBut(t.right,t.right[0])||-1!==n.indexOfAnyBut(t.bottom,t.bottom[0])||-1!==n.indexOfAnyBut(t.left,t.left[0]))i=!1;else{var s=o(t);n.walkGridInsideRect(e,s,function(e){if(!r(e))return i=!1,!1})}return i}var s=function(e){this.table=e};return s.prototype.selectionType=undefined,s.prototype.selectedCells=new Array,s.prototype.selectedColumnIdxs=new Array,s.prototype.selectedRowIdxs=new Array,s.prototype.cellSelectionMode=!1,s.prototype.baseCellPosition=null,s.prototype.lastSelectionRange=null,s.prototype.selectColumns=function(e){this.unselectCells();var r=this.table.getRows();r.shift();var i=n.makeGrid(r);for(var s=0;s<e.length;s++){if(-1!==t.inArray(e[s],this.selectedColumnIdxs))continue;this.selectedColumnIdxs.push(e[s]);for(var o=0;o<i.length;o++){var u=i[o][e[s]];n.containsDomCell(u)&&(t(u.cell).addClass(this.table.get("classCellSelected")),this.selectedCells.push(u.cell))}}this.selectionType="column"},s.prototype.selectRows=function(e){this.unselectCells();var n=this.table.getRows();e.sort(function(e,t){return e-t});for(var r=0;r<e.length;r++)if(n[e[r]]){for(var i=0;i<this.selectedRowIdxs.length;i++)if(e[r]==this.selectedRowIdxs[i])return;this.selectedRowIdxs.push(e[r]);for(var s=1;s<n[e[r]].cells.length;s++)this.selectedCells.push(n[e[r]].cells[s]),t(n[e[r]].cells[s]).addClass(this.table.get("classCellSelected"))}this.selectionType="row"},s.prototype.selectAll=function(){var e=t.map(this.table.getRows(),function(e,t){return t});e.shift(),this.selectRows(e)},s.prototype.notifyCellsSelected=function(){e.trigger("aloha-table-selection-changed")},s.prototype._notifyCellsUnselected=function(){e.trigger("aloha-table-selection-changed")},s.prototype.isHeader=function(){if(this.selectedCells.length==0)return!1;for(var e=0;e<this.selectedCells.length;e++)if(!this.selectedCells[e]||this.selectedCells[e].nodeName.toLowerCase()!="th")return!1;return!0},s.prototype.unselectCells=function(){var e;if(this.cellSelectionMode)return;if(this.selectedCells.length>0){e=this.table.getRows();for(var n=0;n<e.length;n++)for(var r=1;r<e[n].cells.length;r++)t(e[n].cells[r]).removeClass(this.table.get("classCellSelected"));this.selectedCells=new Array,this.selectedColumnIdxs=new Array,this.selectedRowIdxs=new Array,this.selectionType="cell",this._notifyCellsUnselected()}},s.prototype.selectionIndex=function(e){for(var t=0;t<this.selectedCells.length;t++)if(this.selectedCells[t]===e)return t;return-1},s.prototype.mergeCells=function(){var s=this.selectedCells;if(0===s.length)return;var a=function(e){return-1!=t.inArray(e.cell,s)},f=n.makeGrid(this.table.getRows()),l=n.makeContour(f,a);if(!u(f,l,a)){e.showMessage(new e.Message({title:i.t("Table"),text:i.t("table.mergeCells.notRectangular"),type:e.Message.Type.ALERT}));return}var c=o(l),h=t(f[c.top][c.left].cell),p=t(r.getContainer(h.get(0)));n.walkGridInsideRect(f,c,function(e,n,i){if(n-e.spannedX===c.left&&i-e.spannedY===c.top)return;var s=e.cell,o=t(r.getContainer(s)).contents();for(var u=0;u<o.length;u++)if("string"!=typeof o[u]||""!==t.trim(o[u])){p.append(" "),p.append(o);break}t(s).remove()}),h.attr({rowspan:c.bottom-c.top,colspan:c.right-c.left}),this.selectedCells=[h.get(0)],this.cellSelectionMode=!1,this.baseCellPosition=null,this.lastSelectionRange=null,this.selectionType="cell",e.trigger("aloha-table-selection-changed")},s.prototype.splitCells=function(){var r=this,i=this.selectedCells;i.length>0&&(t(i).each(function(){n.splitCell(this,function(){return r.table.newActiveCell().obj})}),this.cellSelectionMode=!1,this.baseCellPosition=null,this.lastSelectionRange=null,this.selectionType="cell",e.trigger("aloha-table-selection-changed"))},s.prototype.cellsAreMergeable=function(){var e=this.selectedCells;if(e.length<2)return!1;var r=function(n){return-1!=t.inArray(n.cell,e)},i=n.makeGrid(this.table.getRows()),s=n.makeContour(i,r);return u(i,s,r)?!0:!1},s.prototype.cellsAreSplitable=function(){var e=0;return this.selectedCells.length>0?(t(this.selectedCells).each(function(){var t=this,r=n.colspan(t),i=n.rowspan(t);(r>1||i>1)&&e++}),e>0?!0:!1):!1},s});