define(["aloha/jquery","table/table-plugin-utils"],function(a,b){var c=function(b,c){null==b&&(b="<td>&nbsp;</td>"),b=a(b).get(0),this.obj=a(b),this.tableObj=c,c.cells.push(this)};return c.prototype.tableObj=undefined,c.prototype.obj=undefined,c.prototype.wrapper=undefined,c.prototype.hasFocus=!1,c.prototype.activate=function(){this.obj.wrapInner("<div/>");var a=this.obj.children("div").eq(0);a.contentEditable(!0),a.addClass("aloha-table-cell-editable");var b=this;return a.bind("focus",function(a){a.currentTarget&&(a.currentTarget.indexOf=function(){return-1}),b._editableFocus(a)}),a.bind("mousedown",function(a){a.currentTarget&&(a.currentTarget.indexOf=function(){return-1}),b._editableMouseDown(a),b._startCellSelection()}),a.bind("blur",function(a){b._editableBlur(a)}),a.bind("keyup",function(a){b._editableKeyUp(a)}),a.bind("keydown",function(a){b._editableKeyDown(a)}),a.bind("mouseover",function(a){b._selectCellRange()}),a.contentEditableSelectionChange(function(b){return Aloha.Selection.onChange(a,b),a}),this.obj.bind("mousedown",function(a){setTimeout(function(){b.wrapper.trigger("focus")},1),b.tableObj.selection.unselectCells(),b._startCellSelection(),a.stopPropagation()}),this.obj.get(0)&&(this.obj.get(0).onselectstart=function(a){return!1}),this.wrapper=this.obj.children(),this.wrapper.get(0)&&(this.wrapper.get(0).onselectstart=function(){window.event.cancelBubble=!0},this.wrapper.get(0).ondragstart=function(){return!1}),this},c.prototype.deactivate=function(){var b=a(this.obj.children(".aloha-table-cell-editable"));b.length&&(b.parent().append(b.contents()),b.remove(),this.obj.unbind("click"),a.trim(this.obj.attr("class"))==""&&this.obj.removeAttr("class"))},c.prototype.toString=function(){return"TableCell"},c.prototype._editableFocus=function(a){this.hasFocus||(this.tableObj.focus(),this.obj.addClass("aloha-table-cell_active"),this.hasFocus=!0,this._selectAll(this.wrapper.get(0)),this.tableObj.selection.selectionType="cell")},c.prototype._editableBlur=function(a){this.hasFocus=!1,this.obj.removeClass("aloha-table-cell_active")},c.prototype._virtualX=function(){var a=this.tableObj.obj.children().children("tr"),c=this.obj.parent().index(),d=this.obj.index();return b.cellIndexToGridColumn(a,c,d)},c.prototype._virtualY=function(){return this.obj.parent("tr").index()},c.prototype._startCellSelection=function(){if(!this.tableObj.selection.cellSelectionMode){this.tableObj.selection.unselectCells(),this.tableObj.selection.cellSelectionMode=!0;var b=this;a("body").bind("mouseup.cellselection",function(){b._endCellSelection()}),this.tableObj.selection.baseCellPosition=[this._virtualY(),this._virtualX()]}},c.prototype._endCellSelection=function(){this.tableObj.selection.cellSelectionMode&&(this.tableObj.selection.cellSelectionMode=!1,this.tableObj.selection.baseCellPosition=null,this.tableObj.selection.lastSelectionRange=null,this.tableObj.selection.selectionType="cell",a("body").unbind("mouseup.cellselection"))},c.prototype._getSelectedRect=function(){var a=this._virtualX(),b=this._virtualY(),c=this.tableObj.selection.baseCellPosition,d=c[1];d>a&&(d=a,a=c[1]);var e=c[0];return e>b&&(e=b,b=c[0]),{top:e,right:a,bottom:b,left:d}},c.prototype._selectCellRange=function(){if(!this.tableObj.selection.cellSelectionMode)return;var c=this._getSelectedRect(),d=this.tableObj,e=d.obj.children().children("tr"),f=b.makeGrid(e);d.selection.selectedCells=[];var g=d.get("classCellSelected");b.walkGrid(f,function(e,f,h){b.containsDomCell(e)&&(h>=c.top&&h<=c.bottom&&f>=c.left&&f<=c.right?(a(e.cell).addClass(g),d.selection.selectedCells.push(e.cell)):a(e.cell).removeClass(g))}),d.selection.notifyCellsSelected()},c.prototype._selectAll=function(b){var c=b.jquery?b.get(0):b;if(!a.browser.msie){var d=window.getSelection();if(d.setBaseAndExtent)d.setBaseAndExtent(c,0,c,Math.max(0,c.innerText.length-1));else{window.opera&&c.innerHTML.substring(c.innerHTML.length-4)=="<BR>"&&(c.innerHTML=c.innerHTML+"&#160;");var e=document.createRange();e.selectNodeContents(c),d.removeAllRanges(),d.addRange(e)}}else if(document.getSelection){var d=document.getSelection(),e=document.createRange();e.selectNodeContents(c),d.removeAllRanges(),d.addRange(e)}else if(document.selection){var e=document.body.createTextRange();e.moveToElementText(c),e.select()}},c.prototype._editableMouseDown=function(a){this.tableObj.selection.unselectCells(),this.tableObj.hasFocus&&a.stopPropagation()},c.prototype._editableKeyUp=function(a){},c.prototype._editableKeyDown=function(a){var b=9;this._checkForEmptyEvent(a);if(this.obj[0]===this.tableObj.obj.find("tr:last td:last")[0]&&b==a.keyCode&&!a.altKey&&!a.shiftKey&&!a.ctrlKey){this.tableObj.addRow(this.obj.parent().index()+1),this.tableObj.cells[this.tableObj.cells.length-1]._selectAll(this.wrapper.get(0)),a.stopPropagation();return}},c.prototype._checkForEmptyEvent=function(b){var c=a(this.wrapper),d=c.text();if(c.children().length>0)return;d===""&&(this.wrapper.text("Â "),this.wrapper.get(0).blur(),this.wrapper.get(0).focus())},c.getContainer=function(b){return a(b.firstChild).hasClass("aloha-table-cell-editable")?b.firstChild:b},c});