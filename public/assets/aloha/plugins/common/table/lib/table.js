/**
 * Place selection outside of table.
 * Select a column and delete it.
 * Now try and click another column.
 * You get and index out of bounds error caused
 * the fact that the selection is gone
 */
/**
 * Aloha Table Plugin
 * ------------------
 * This plugin provides advanced support for manipulating tables in Aloha
 * Editables.
 * Nested tables are not support. If nested tables are pasted into the
 * editable, they will simply be left alone.
 * Each (non-nested) table in the editable will have a corresponding Aloha
 * Table instance created for it, which will maintain internal state, and
 * information related to its DOM element.
 *
 * @todo: - selectRow/selectColumn should take into account the helper row/column.
 *			ie: selectRow(0) and selectColumn(0), should be zero indexed
 */
define(["aloha","aloha/jquery","aloha/floatingmenu","i18n!table/nls/i18n","table/table-cell","table/table-selection","table/table-plugin-utils"],function(e,t,n,r,i,s,o){function l(e){var n=e.obj,r,i,s=e.getRows(),u=s.length,a,f,l,c=0,h=[],p,d;for(r=0;r<u;r++)i=t(s[r]),a=i.children("td, th"),f=a.length,l=o.cellIndexToGridColumn(s,r,f-1)+1,d=parseInt(a.last().attr("colspan"),10),d!=0&&(isNaN(d)||(d==1&&a.last().removeAttr("colspan"),l+=d-1)),h.push(l),l>c&&(c=l);for(r=0;r<u;r++)p=c-h[r],p>0&&t(s[r]).append((new Array(p+1)).join("<td></td>"))}function c(e,t){var n=-1,r=null;if("before"===e)r=t.selectedCells[0];else if("after"===e){var i=t.selectedCells.length-1;r=t.selectedCells[i]}return r&&r.nodeType==1&&(n=r.parentNode.rowIndex),n}var u=void 0,a=window.GENTICS,f=function(e,n){this.obj=t(e),l(this),this.obj.attr("id")||this.obj.attr("id",a.Utils.guid()),this.tablePlugin=n,this.selection=new s(this),this.refresh()};return t.extend(f.prototype,{obj:u,tableWrapper:u,cells:u,numRows:u,numCols:u,isActive:!1,hasFocus:!1,parentEditable:u,mousedown:!1,clickedColumnId:-1,clickedRowId:-1,columnsToSelect:[],rowsToSelect:[],fmPluginId:u}),f.prototype.refresh=function(){this.numCols=this.countVirtualCols();var e=this.getRows();this.numRows=e.length,this.cells=[];for(var n=0;n<e.length;n++){var r=t(e[n]),i=r.children();for(var s=0;s<i.length;s++)var o=i[s],u=this.newCell(o)}},f.prototype.countVirtualCols=function(){var e=this.obj.children().children("tr:first-child").children();return e.length-e.filter("."+this.get("classLeftUpperCorner")).length},f.prototype.get=function(e){return this.tablePlugin.get(e)},f.prototype.set=function(e,t){this.tablePlugin.set(e,t)},f.prototype.activate=function(){if(this.isActive)return;var n=this,r,i;this.obj.addClass(this.get("className")),this.obj.contentEditable(!1),this.obj.attr("id")==""&&this.obj.attr("id",a.Utils.guid()),this.selection.selectionType=u,this.obj.bind("keydown",function(e){!e.ctrlKey&&!e.shiftKey&&n.selection.selectedCells.length>0&&n.selection.selectedCells[0].length>0&&n.selection.selectedCells[0][0].firstChild.focus()}),this.obj.bind("mousedown",function(e){return n.hasFocus||n.focus(),e.stopPropagation(),e.preventDefault(),!1}),i=t('<div class="'+this.get("classTableWrapper")+'"></div>'),i.contentEditable(!1),this.obj.wrap(i),r=this.obj.parents("."+this.get("classTableWrapper")),r.get(0).onresizestart=function(e){return!1},r.get(0).oncontrolselect=function(e){return!1},r.get(0).ondragstart=function(e){return!1},r.get(0).onmovestart=function(e){return!1},r.get(0).onselectstart=function(e){return!1},this.tableWrapper=this.obj.parents("."+this.get("classTableWrapper")).get(0),t(this.cells).each(function(){this.activate()}),this.attachSelectionColumn(),this.attachSelectionRow(),this.makeCaptionEditable(),this.checkWai(),this.isActive=!0,e.trigger("aloha-table-activated")},f.prototype.makeCaptionEditable=function(){var e=this.obj.find("caption").eq(0);e&&this.tablePlugin.makeCaptionEditable(e)},f.prototype.checkWai=function(){var e=this.wai;e.removeClass(this.get("waiGreen")),e.removeClass(this.get("waiRed")),this.obj[0].summary.trim()!=""?e.addClass(this.get("waiGreen")):e.addClass(this.get("waiRed"))},f.prototype.attachSelectionColumn=function(){var e=t("<td>"),n,r,i,s=this,o,u;e.html(" "),s=this,o=this.obj.context.rows;for(u=0;u<o.length;u++)i=t(o[u]),r=e.clone(),r.addClass(this.get("classSelectionColumn")),r.css("width",this.get("selectionArea")+"px"),i.prepend(r),n=u+1,this.attachRowSelectionEventsToCell(r)},f.prototype.attachRowSelectionEventsToCell=function(e){var t=this;e.unbind("mousedown"),e.unbind("mouseover"),e.get(0).onselectstart=function(){return!1},e.bind("mousedown",function(e){return t.rowSelectionMouseDown(e)}),e.bind("mouseover",function(e){if(t.mousedown)return t.rowSelectionMouseOver(e)})},f.prototype.rowSelectionMouseDown=function(e){this.focus(),this.selection.selectedCells.length==0&&(this.rowsToSelect=[]),this.clickedRowId=e.currentTarget.parentNode.rowIndex;if(e.metaKey){var n=t.inArray(this.clickedRowId,this.rowsToSelect);n>=0?this.rowsToSelect.splice(n,1):this.rowsToSelect.push(this.clickedRowId)}else if(e.shiftKey){this.rowsToSelect.sort(function(e,t){return e-t});var r=this.rowsToSelect[0],i=this.clickedRowId;r>i&&(r=i,i=this.rowsToSelect[0]),this.rowsToSelect=[];for(var s=r;s<=i;s++)this.rowsToSelect.push(s)}else this.rowsToSelect=[this.clickedRowId];return this.selectRows(),e.preventDefault(),e.stopPropagation(),!1},f.prototype.rowSelectionMouseOver=function(e){var n=e.currentTarget.parentNode.rowIndex,r,i,s,o;if(this.mousedown&&this.clickedRowId>=0){r=t.inArray(n,this.rowsToSelect),i=n<this.clickedRowId?n:this.clickedRowId,s=n<this.clickedRowId?this.clickedRowId:n,this.rowsToSelect=new Array;for(o=i;o<=s;o++)this.rowsToSelect.push(o);return this.selectRows(),e.preventDefault(),e.stopPropagation(),!1}},f.prototype.attachSelectionRow=function(){var e=this,r=t("<td>");r.html(" ");var i=0;for(var s=0;s<this.obj.context.rows.length;s++){var u=0;for(var a=0;a<this.obj.context.rows[s].cells.length;a++){var f=o.colspan(this.obj.context.rows[s].cells[a]);u+=f}i<u&&(i=u)}var l=t("<tr>");l.addClass(this.get("classSelectionRow")),l.css("height",this.get("selectionArea")+"px");for(var s=0;s<i;s++){var c=r.clone();if(s>0)this.attachColumnSelectEventsToCell(c);else{var c=t("<td>").clone();c.addClass(this.get("classLeftUpperCorner"));var h=function(t){e.focus(),e.selection.selectAll(),e.tablePlugin.activeTable.selection.selectionType="cell",e.tablePlugin.updateFloatingMenuScope(),n.activateTabOfButton("rowheader"),e._removeCursorSelection();try{e.tablePlugin.summary.focus(),t.stopPropagation(),t.preventDefault()}catch(t){}return!1};this.wai=t("<div/>").width(25).height(12).click(h),c.append(this.wai)}l.append(c)}t(document).bind("mouseup",function(t){e.columnSelectionMouseUp(t)}),this.obj.find("tr:first").before(l)},f.prototype.attachColumnSelectEventsToCell=function(e){var t=this;e.unbind("mousedown"),e.unbind("mouseover"),e.get(0).onselectstart=function(){return!1},e.bind("mousedown",function(e){t.columnSelectionMouseDown(e)}),e.bind("mouseover",function(e){t.columnSelectionMouseOver(e)})},f.prototype.columnSelectionMouseDown=function(e){this.focus(),this.selection.selectedCells.length==0&&(this.columnsToSelect=[]),this.clickedColumnId=t(e.currentTarget.parentNode).children().index(e.currentTarget);if(e.metaKey){var n=t.inArray(this.clickedColumnId,this.columnsToSelect);n>=0?this.columnsToSelect.splice(n,1):this.columnsToSelect.push(this.clickedColumnId)}else if(e.shiftKey){this.columnsToSelect.sort(function(e,t){return e-t});var r=this.columnsToSelect[0],i=this.clickedColumnId;r>i&&(r=i,i=this.columnsToSelect[0]),this.columnsToSelect=[];for(var s=r;s<=i;s++)this.columnsToSelect.push(s)}else this.columnsToSelect=[this.clickedColumnId];return this.selectColumns(),e.preventDefault(),e.stopPropagation(),!1},f.prototype.columnSelectionMouseOver=function(e){var t=e.currentTarget.cellIndex,n=[],r,i;if(this.mouseDownColIdx){r=t<this.mouseDownColIdx?t:this.mouseDownColIdx,i=t<this.mouseDownColIdx?this.mouseDownColIdx:t;for(var s=r;s<=i;s++)n.push(s);this.selectColumns(n)}},f.prototype.columnSelectionMouseUp=function(e){this.mouseDownColIdx=!1},f.prototype.deleteRows=function(){var n=[],i={},s=this;if(0===this.selection.selectedCells.length)return;for(var u=0;u<this.selection.selectedCells.length;u++)i[this.selection.selectedCells[u].parentNode.rowIndex]=!0;for(rowId in i)n.push(rowId);var a=!1;n.length==this.numRows&&(a=!0);if(a){var f=this;e.showMessage(new e.Message({title:r.t("Table"),text:r.t("deletetable.confirm"),type:e.Message.Type.CONFIRM,callback:function(e){e=="yes"&&f.deleteTable()}}))}else{n.sort(function(e,t){return e-t});var l=n[0];l>this.numRows-n.length&&l--;var c=this.getRows();t.each(n,function(e,t){var n=c[t];for(var r=0;r<n.cells.length;r++)o.splitCell(n.cells[r],function(){return s.newActiveCell().obj})});var h=o.makeGrid(c);t.each(n,function(e,n){var r=h[n];for(var i=0;i<r.length;){var s=r[i],u=o.rowspan(s.cell);1<u&&t(s.cell).attr("rowspan",u-1),i+=s.colspan}t(c[n]).remove()}),this.numRows-=n.length,setTimeout(function(){var e=t(c[1].cells[l+1]);e.focus()},5),this.selection.unselectCells()}},f.prototype.deleteColumns=function(){var n=[],i=[],s=this.getRows(),u=this,a=[],f,l,c,h=o.makeGrid(s),p=1;if(this.selection.selectedColumnIdxs.length==h[0].length-p)e.showMessage(new e.Message({title:r.t("Table"),text:r.t("deletetable.confirm"),type:e.Message.Type.CONFIRM,callback:function(e){e=="yes"&&u.deleteTable()}}));else{n.sort(function(e,t){return e-t});var d=this.selection.selectedColumnIdxs.sort(function(e,t){return t-e});for(var v=0;v<d.length;v++){var m=d[v];for(var g=0;g<s.length;g++){var c=h[g][m];if(!c)continue;if(0===c.spannedX){if(1<c.colspan){var y=this.newActiveCell().obj;t(c.cell).after(y),y.attr("rowspan",c.rowspan),y.attr("colspan",c.colspan-1)}t(c.cell).remove()}else t(c.cell).attr("colspan",c.colspan-1);g+=c.rowspan-1}h=o.makeGrid(s)}this.numCols-=n.length,setTimeout(function(){var e=t(s[1].cells[f+1]);e.focus()},5),this.selection.unselectCells()}},f.prototype.deleteTable=function(){var t=-1;for(var n=0;n<this.tablePlugin.TableRegistry.length;n++)if(this.tablePlugin.TableRegistry[n].obj.attr("id")==this.obj.attr("id")){t=n;break}if(t>=0){this.deactivate(),this.selection.selectionType=u,this.tablePlugin.TableRegistry.splice(n,1);var r=e.Selection.rangeObject;r.startContainer=r.endContainer=this.obj.get(0).parentNode,r.startOffset=r.endOffset=a.Utils.Dom.getIndexInParent(this.obj.get(0).parentNode),r.clearCaches(),this.obj.remove(),this.parentEditable.obj.focus(),r.correctRange(),r.select()}},f.prototype.addRowBeforeSelection=function(e){var t=c("before",this.selection);-1!==t&&this.addRow(t)},f.prototype.addRowAfterSelection=function(){var e=c("after",this.selection);-1!==e&&this.addRow(e+1)},f.prototype.addRow=function(e){var n=this,r=1,i=this.countVirtualCols(),s=this.obj.children().children("tr");for(var u=0;u<r;u++){var a=t("<tr>"),f=t("<td>");f.addClass(this.get("classSelectionColumn")),this.attachRowSelectionEventsToCell(f),a.append(f);var l=o.makeGrid(s),c=1;if(e>=l.length)for(var h=c;h<l[0].length;h++)a.append(this.newActiveCell().obj);else for(var h=c;h<l[e].length;){var p=l[e][h];if(o.containsDomCell(p)){var d=p.colspan;while(d--)a.append(this.newActiveCell().obj)}else t(p.cell).attr("rowspan",p.rowspan+1);h+=p.colspan}e>=s.length?s.eq(s.length-1).after(a):s.eq(e).before(a)}this.numRows+=r},f.prototype.addColumnsRight=function(){this.addColumns("right")},f.prototype.addColumnsLeft=function(){this.addColumns("left")},f.prototype.addColumns=function(n){var i=this,s=t("<td>"),u=this.getRows(),a,f,l=[],c=this.selection.selectedColumnIdxs;if(0===c.length)return;c.sort(function(e,t){return e-t});if(!o.isConsecutive(c)){e.showMessage(new e.Message({title:r.t("Table"),text:r.t("table.addColumns.nonConsecutive"),type:e.Message.Type.ALERT}));return}if("left"===n){f=c[0];for(var h=0;h<this.selection.selectedColumnIdxs.length;h++)this.selection.selectedColumnIdxs[h]+=1}else f=c[c.length-1];var p=o.makeGrid(u);for(var h=0;h<u.length;h++){a=s.clone(),a.html(" "),h==0?this.attachColumnSelectEventsToCell(a):(cellObj=this.newActiveCell(a.get(0)),a=cellObj.obj);var d=o.leftDomCell(p,h,f);null==d?t(u[h]).prepend(a):"left"===n&&o.containsDomCell(p[h][f])?t(d).before(a):t(d).after(a),this.numCols++}},f.prototype.focus=function(){this.hasFocus||(this.parentEditable.isActive||this.parentEditable.obj.focus(),this.tablePlugin.setFocusedTable(this))},f.prototype.focusOut=function(){this.hasFocus&&(this.tablePlugin.setFocusedTable(u),this.selection.selectionType=u)},f.prototype._removeCursorSelection=function(){var n=e.getSelection();if(!n||!n._nativeSelection||n._nativeSelection._ranges.length==0)return;var r=n.getRangeAt(0);if(null==r.startContainer)return;if(0!==t(r.startContainer).closest("table").length)return;if(0===this.selection.selectedCells.length)return;var s=i.getContainer(this.selection.selectedCells[0]);t(s).focus()},f.prototype.selectColumns=function(e){var r;e?r=e:r=this.columnsToSelect;for(var i=0;i<this.tablePlugin.columnMSItems.length;i++)this.tablePlugin.columnMSButton.showItem(this.tablePlugin.columnMSItems[i].name);n.setScope(this.tablePlugin.name+".column"),this.tablePlugin.columnHeader.setPressed(this.selection.isHeader());var s=this.getRows();this.tablePlugin.columnMSButton.setActiveItem();for(var o=0;o<this.tablePlugin.columnConfig.length;o++)t(s[0].cells[0]).hasClass(this.tablePlugin.columnConfig[o].cssClass)&&(this.tablePlugin.columnMSButton.setActiveItem(this.tablePlugin.columnConfig[o].name),o=this.tablePlugin.columnConfig.length);this.obj.find("div.aloha-ui-table-cell-editable").blur(),this.selection.selectColumns(r),this.selection.notifyCellsSelected(),this._removeCursorSelection()},f.prototype.selectRows=function(){for(var e=0;e<this.tablePlugin.rowMSItems.length;e++)this.tablePlugin.rowMSButton.showItem(this.tablePlugin.rowMSItems[e].name);for(var e=0;e<this.rowsToSelect.length;e++){var r=this.rowsToSelect[e],i=t(this.getRows()[r].cells).toArray();if(e==0)for(var s=0;s<i.length;s++){this.tablePlugin.rowMSButton.setActiveItem();for(var o=0;o<this.tablePlugin.rowConfig.length;o++)t(i[s]).hasClass(this.tablePlugin.rowConfig[o].cssClass)&&(this.tablePlugin.rowMSButton.setActiveItem(this.tablePlugin.rowConfig[o].name),o=this.tablePlugin.rowConfig.length)}}n.setScope(this.tablePlugin.name+".row"),this.selection.selectRows(this.rowsToSelect),this.tablePlugin.columnHeader.setPressed(this.selection.isHeader()),this.obj.find("div.aloha-ui-table-cell-editable").blur(),this.selection.notifyCellsSelected(),this._removeCursorSelection()},f.prototype.deactivate=function(){this.obj.removeClass(this.get("className")),t.trim(this.obj.attr("class"))==""&&this.obj.removeAttr("class"),this.obj.removeAttr("contenteditable"),this.obj.parents("."+this.get("classTableWrapper")).length&&this.obj.unwrap(),this.obj.find("tr."+this.get("classSelectionRow")+":first").remove();var e=this;t.each(this.obj.context.rows,function(){t(this).children("td."+e.get("classSelectionColumn")).remove()}),this.obj.find("td, th").removeClass(this.get("classCellSelected")),this.obj.unbind();for(var n=0;n<this.cells.length;n++){var r=this.cells[n];r.deactivate()}this.obj.find("caption div").each(function(){t(this).contents().unwrap()}),this.isActive=!1},f.prototype.toString=function(){return"Table"},f.prototype.newCell=function(e){return new i(e,this)},f.prototype.newActiveCell=function(e){var t=new i(e,this);return t.activate(),t},f.prototype.getRows=function(){var e=this.obj.get(0).rows;return t.makeArray(e)},f});