/**
 * Place selection outside of table.
 * Select a column and delete it.
 * Now try and click another column.
 * You get and index out of bounds error caused
 * the fact that the selection is gone
 */
/**
 * Aloha Table Plugin
 * ------------------
 * This plugin provides advanced support for manipulating tables in Aloha
 * Editables.
 * Nested tables are not support. If nested tables are pasted into the
 * editable, they will simply be left alone.
 * Each (non-nested) table in the editable will have a corresponding Aloha
 * Table instance created for it, which will maintain internal state, and
 * information related to its DOM element.
 *
 * @todo: - selectRow/selectColumn should take into account the helper row/column.
 *			ie: selectRow(0) and selectColumn(0), should be zero indexed
 */
define(["aloha","aloha/jquery","aloha/floatingmenu","i18n!table/nls/i18n","table/table-cell","table/table-selection","table/table-plugin-utils"],function(a,b,c,d,e,f,g){function k(a){var c=a.obj,d,e,f=a.getRows(),h=f.length,i,j,k,l=0,m=[],n,o;for(d=0;d<h;d++)e=b(f[d]),i=e.children("td, th"),j=i.length,k=g.cellIndexToGridColumn(f,d,j-1)+1,o=parseInt(i.last().attr("colspan"),10),o!=0&&(isNaN(o)||(o==1&&i.last().removeAttr("colspan"),k+=o-1)),m.push(k),k>l&&(l=k);for(d=0;d<h;d++)n=l-m[d],n>0&&b(f[d]).append((new Array(n+1)).join("<td></td>"))}function l(a,b){var c=-1,d=null;if("before"===a)d=b.selectedCells[0];else if("after"===a){var e=b.selectedCells.length-1;d=b.selectedCells[e]}return d&&d.nodeType==1&&(c=d.parentNode.rowIndex),c}var h=void 0,i=window.GENTICS,j=function(a,c){this.obj=b(a),k(this),this.obj.attr("id")||this.obj.attr("id",i.Utils.guid()),this.tablePlugin=c,this.selection=new f(this),this.refresh()};return b.extend(j.prototype,{obj:h,tableWrapper:h,cells:h,numRows:h,numCols:h,isActive:!1,hasFocus:!1,parentEditable:h,mousedown:!1,clickedColumnId:-1,clickedRowId:-1,columnsToSelect:[],rowsToSelect:[],fmPluginId:h}),j.prototype.refresh=function(){this.numCols=this.countVirtualCols();var a=this.getRows();this.numRows=a.length,this.cells=[];for(var c=0;c<a.length;c++){var d=b(a[c]),e=d.children();for(var f=0;f<e.length;f++)var g=e[f],h=this.newCell(g)}},j.prototype.countVirtualCols=function(){var a=this.obj.children().children("tr:first-child").children();return a.length-a.filter("."+this.get("classLeftUpperCorner")).length},j.prototype.get=function(a){return this.tablePlugin.get(a)},j.prototype.set=function(a,b){this.tablePlugin.set(a,b)},j.prototype.activate=function(){if(this.isActive)return;var c=this,d,e;this.obj.addClass(this.get("className")),this.obj.contentEditable(!1),this.obj.attr("id")==""&&this.obj.attr("id",i.Utils.guid()),this.selection.selectionType=h,this.obj.bind("keydown",function(a){!a.ctrlKey&&!a.shiftKey&&c.selection.selectedCells.length>0&&c.selection.selectedCells[0].length>0&&c.selection.selectedCells[0][0].firstChild.focus()}),this.obj.bind("mousedown",function(a){return c.hasFocus||c.focus(),a.stopPropagation(),a.preventDefault(),!1}),e=b('<div class="'+this.get("classTableWrapper")+'"></div>'),e.contentEditable(!1),this.obj.wrap(e),d=this.obj.parents("."+this.get("classTableWrapper")),d.get(0).onresizestart=function(a){return!1},d.get(0).oncontrolselect=function(a){return!1},d.get(0).ondragstart=function(a){return!1},d.get(0).onmovestart=function(a){return!1},d.get(0).onselectstart=function(a){return!1},this.tableWrapper=this.obj.parents("."+this.get("classTableWrapper")).get(0),b(this.cells).each(function(){this.activate()}),this.attachSelectionColumn(),this.attachSelectionRow(),this.makeCaptionEditable(),this.checkWai(),this.isActive=!0,a.trigger("aloha-table-activated")},j.prototype.makeCaptionEditable=function(){var a=this.obj.find("caption").eq(0);a&&this.tablePlugin.makeCaptionEditable(a)},j.prototype.checkWai=function(){var a=this.wai;a.removeClass(this.get("waiGreen")),a.removeClass(this.get("waiRed")),this.obj[0].summary.trim()!=""?a.addClass(this.get("waiGreen")):a.addClass(this.get("waiRed"))},j.prototype.attachSelectionColumn=function(){var a=b("<td>"),c,d,e,f=this,g,h;a.html(" "),f=this,g=this.obj.context.rows;for(h=0;h<g.length;h++)e=b(g[h]),d=a.clone(),d.addClass(this.get("classSelectionColumn")),d.css("width",this.get("selectionArea")+"px"),e.prepend(d),c=h+1,this.attachRowSelectionEventsToCell(d)},j.prototype.attachRowSelectionEventsToCell=function(a){var b=this;a.unbind("mousedown"),a.unbind("mouseover"),a.get(0).onselectstart=function(){return!1},a.bind("mousedown",function(a){return b.rowSelectionMouseDown(a)}),a.bind("mouseover",function(a){if(b.mousedown)return b.rowSelectionMouseOver(a)})},j.prototype.rowSelectionMouseDown=function(a){this.focus(),this.selection.selectedCells.length==0&&(this.rowsToSelect=[]),this.clickedRowId=a.currentTarget.parentNode.rowIndex;if(a.metaKey){var c=b.inArray(this.clickedRowId,this.rowsToSelect);c>=0?this.rowsToSelect.splice(c,1):this.rowsToSelect.push(this.clickedRowId)}else if(a.shiftKey){this.rowsToSelect.sort(function(a,b){return a-b});var d=this.rowsToSelect[0],e=this.clickedRowId;d>e&&(d=e,e=this.rowsToSelect[0]),this.rowsToSelect=[];for(var f=d;f<=e;f++)this.rowsToSelect.push(f)}else this.rowsToSelect=[this.clickedRowId];return this.selectRows(),a.preventDefault(),a.stopPropagation(),!1},j.prototype.rowSelectionMouseOver=function(a){var c=a.currentTarget.parentNode.rowIndex,d,e,f,g;if(this.mousedown&&this.clickedRowId>=0){d=b.inArray(c,this.rowsToSelect),e=c<this.clickedRowId?c:this.clickedRowId,f=c<this.clickedRowId?this.clickedRowId:c,this.rowsToSelect=new Array;for(g=e;g<=f;g++)this.rowsToSelect.push(g);return this.selectRows(),a.preventDefault(),a.stopPropagation(),!1}},j.prototype.attachSelectionRow=function(){var a=this,d=b("<td>");d.html(" ");var e=0;for(var f=0;f<this.obj.context.rows.length;f++){var h=0;for(var i=0;i<this.obj.context.rows[f].cells.length;i++){var j=g.colspan(this.obj.context.rows[f].cells[i]);h+=j}e<h&&(e=h)}var k=b("<tr>");k.addClass(this.get("classSelectionRow")),k.css("height",this.get("selectionArea")+"px");for(var f=0;f<e;f++){var l=d.clone();if(f>0)this.attachColumnSelectEventsToCell(l);else{var l=b("<td>").clone();l.addClass(this.get("classLeftUpperCorner"));var m=function(b){a.focus(),a.selection.selectAll(),a.tablePlugin.activeTable.selection.selectionType="cell",a.tablePlugin.updateFloatingMenuScope(),c.activateTabOfButton("rowheader"),a._removeCursorSelection();try{a.tablePlugin.summary.focus(),b.stopPropagation(),b.preventDefault()}catch(b){}return!1};this.wai=b("<div/>").width(25).height(12).click(m),l.append(this.wai)}k.append(l)}b(document).bind("mouseup",function(b){a.columnSelectionMouseUp(b)}),this.obj.find("tr:first").before(k)},j.prototype.attachColumnSelectEventsToCell=function(a){var b=this;a.unbind("mousedown"),a.unbind("mouseover"),a.get(0).onselectstart=function(){return!1},a.bind("mousedown",function(a){b.columnSelectionMouseDown(a)}),a.bind("mouseover",function(a){b.columnSelectionMouseOver(a)})},j.prototype.columnSelectionMouseDown=function(a){this.focus(),this.selection.selectedCells.length==0&&(this.columnsToSelect=[]),this.clickedColumnId=b(a.currentTarget.parentNode).children().index(a.currentTarget);if(a.metaKey){var c=b.inArray(this.clickedColumnId,this.columnsToSelect);c>=0?this.columnsToSelect.splice(c,1):this.columnsToSelect.push(this.clickedColumnId)}else if(a.shiftKey){this.columnsToSelect.sort(function(a,b){return a-b});var d=this.columnsToSelect[0],e=this.clickedColumnId;d>e&&(d=e,e=this.columnsToSelect[0]),this.columnsToSelect=[];for(var f=d;f<=e;f++)this.columnsToSelect.push(f)}else this.columnsToSelect=[this.clickedColumnId];return this.selectColumns(),a.preventDefault(),a.stopPropagation(),!1},j.prototype.columnSelectionMouseOver=function(a){var b=a.currentTarget.cellIndex,c=[],d,e;if(this.mouseDownColIdx){d=b<this.mouseDownColIdx?b:this.mouseDownColIdx,e=b<this.mouseDownColIdx?this.mouseDownColIdx:b;for(var f=d;f<=e;f++)c.push(f);this.selectColumns(c)}},j.prototype.columnSelectionMouseUp=function(a){this.mouseDownColIdx=!1},j.prototype.deleteRows=function(){var c=[],e={},f=this;if(0===this.selection.selectedCells.length)return;for(var h=0;h<this.selection.selectedCells.length;h++)e[this.selection.selectedCells[h].parentNode.rowIndex]=!0;for(rowId in e)c.push(rowId);var i=!1;c.length==this.numRows&&(i=!0);if(i){var j=this;a.showMessage(new a.Message({title:d.t("Table"),text:d.t("deletetable.confirm"),type:a.Message.Type.CONFIRM,callback:function(a){a=="yes"&&j.deleteTable()}}))}else{c.sort(function(a,b){return a-b});var k=c[0];k>this.numRows-c.length&&k--;var l=this.getRows();b.each(c,function(a,b){var c=l[b];for(var d=0;d<c.cells.length;d++)g.splitCell(c.cells[d],function(){return f.newActiveCell().obj})});var m=g.makeGrid(l);b.each(c,function(a,c){var d=m[c];for(var e=0;e<d.length;){var f=d[e],h=g.rowspan(f.cell);1<h&&b(f.cell).attr("rowspan",h-1),e+=f.colspan}b(l[c]).remove()}),this.numRows-=c.length,setTimeout(function(){var a=b(l[1].cells[k+1]);a.focus()},5),this.selection.unselectCells()}},j.prototype.deleteColumns=function(){var c=[],e=[],f=this.getRows(),h=this,i=[],j,k,l,m=g.makeGrid(f),n=1;if(this.selection.selectedColumnIdxs.length==m[0].length-n)a.showMessage(new a.Message({title:d.t("Table"),text:d.t("deletetable.confirm"),type:a.Message.Type.CONFIRM,callback:function(a){a=="yes"&&h.deleteTable()}}));else{c.sort(function(a,b){return a-b});var o=this.selection.selectedColumnIdxs.sort(function(a,b){return b-a});for(var p=0;p<o.length;p++){var q=o[p];for(var r=0;r<f.length;r++){var l=m[r][q];if(!l)continue;if(0===l.spannedX){if(1<l.colspan){var s=this.newActiveCell().obj;b(l.cell).after(s),s.attr("rowspan",l.rowspan),s.attr("colspan",l.colspan-1)}b(l.cell).remove()}else b(l.cell).attr("colspan",l.colspan-1);r+=l.rowspan-1}m=g.makeGrid(f)}this.numCols-=c.length,setTimeout(function(){var a=b(f[1].cells[j+1]);a.focus()},5),this.selection.unselectCells()}},j.prototype.deleteTable=function(){var b=-1;for(var c=0;c<this.tablePlugin.TableRegistry.length;c++)if(this.tablePlugin.TableRegistry[c].obj.attr("id")==this.obj.attr("id")){b=c;break}if(b>=0){this.deactivate(),this.selection.selectionType=h,this.tablePlugin.TableRegistry.splice(c,1);var d=a.Selection.rangeObject;d.startContainer=d.endContainer=this.obj.get(0).parentNode,d.startOffset=d.endOffset=i.Utils.Dom.getIndexInParent(this.obj.get(0).parentNode),d.clearCaches(),this.obj.remove(),this.parentEditable.obj.focus(),d.correctRange(),d.select()}},j.prototype.addRowBeforeSelection=function(a){var b=l("before",this.selection);-1!==b&&this.addRow(b)},j.prototype.addRowAfterSelection=function(){var a=l("after",this.selection);-1!==a&&this.addRow(a+1)},j.prototype.addRow=function(a){var c=this,d=1,e=this.countVirtualCols(),f=this.obj.children().children("tr");for(var h=0;h<d;h++){var i=b("<tr>"),j=b("<td>");j.addClass(this.get("classSelectionColumn")),this.attachRowSelectionEventsToCell(j),i.append(j);var k=g.makeGrid(f),l=1;if(a>=k.length)for(var m=l;m<k[0].length;m++)i.append(this.newActiveCell().obj);else for(var m=l;m<k[a].length;){var n=k[a][m];if(g.containsDomCell(n)){var o=n.colspan;while(o--)i.append(this.newActiveCell().obj)}else b(n.cell).attr("rowspan",n.rowspan+1);m+=n.colspan}a>=f.length?f.eq(f.length-1).after(i):f.eq(a).before(i)}this.numRows+=d},j.prototype.addColumnsRight=function(){this.addColumns("right")},j.prototype.addColumnsLeft=function(){this.addColumns("left")},j.prototype.addColumns=function(c){var e=this,f=b("<td>"),h=this.getRows(),i,j,k=[],l=this.selection.selectedColumnIdxs;if(0===l.length)return;l.sort(function(a,b){return a-b});if(!g.isConsecutive(l)){a.showMessage(new a.Message({title:d.t("Table"),text:d.t("table.addColumns.nonConsecutive"),type:a.Message.Type.ALERT}));return}if("left"===c){j=l[0];for(var m=0;m<this.selection.selectedColumnIdxs.length;m++)this.selection.selectedColumnIdxs[m]+=1}else j=l[l.length-1];var n=g.makeGrid(h);for(var m=0;m<h.length;m++){i=f.clone(),i.html(" "),m==0?this.attachColumnSelectEventsToCell(i):(cellObj=this.newActiveCell(i.get(0)),i=cellObj.obj);var o=g.leftDomCell(n,m,j);null==o?b(h[m]).prepend(i):"left"===c&&g.containsDomCell(n[m][j])?b(o).before(i):b(o).after(i),this.numCols++}},j.prototype.focus=function(){this.hasFocus||(this.parentEditable.isActive||this.parentEditable.obj.focus(),this.tablePlugin.setFocusedTable(this))},j.prototype.focusOut=function(){this.hasFocus&&(this.tablePlugin.setFocusedTable(h),this.selection.selectionType=h)},j.prototype._removeCursorSelection=function(){var c=a.getSelection();if(!c||!c._nativeSelection||c._nativeSelection._ranges.length==0)return;var d=c.getRangeAt(0);if(null==d.startContainer)return;if(0!==b(d.startContainer).closest("table").length)return;if(0===this.selection.selectedCells.length)return;var f=e.getContainer(this.selection.selectedCells[0]);b(f).focus()},j.prototype.selectColumns=function(a){var d;a?d=a:d=this.columnsToSelect;for(var e=0;e<this.tablePlugin.columnMSItems.length;e++)this.tablePlugin.columnMSButton.showItem(this.tablePlugin.columnMSItems[e].name);c.setScope(this.tablePlugin.name+".column"),this.tablePlugin.columnHeader.setPressed(this.selection.isHeader());var f=this.getRows();this.tablePlugin.columnMSButton.setActiveItem();for(var g=0;g<this.tablePlugin.columnConfig.length;g++)b(f[0].cells[0]).hasClass(this.tablePlugin.columnConfig[g].cssClass)&&(this.tablePlugin.columnMSButton.setActiveItem(this.tablePlugin.columnConfig[g].name),g=this.tablePlugin.columnConfig.length);this.obj.find("div.aloha-ui-table-cell-editable").blur(),this.selection.selectColumns(d),this.selection.notifyCellsSelected(),this._removeCursorSelection()},j.prototype.selectRows=function(){for(var a=0;a<this.tablePlugin.rowMSItems.length;a++)this.tablePlugin.rowMSButton.showItem(this.tablePlugin.rowMSItems[a].name);for(var a=0;a<this.rowsToSelect.length;a++){var d=this.rowsToSelect[a],e=b(this.getRows()[d].cells).toArray();if(a==0)for(var f=0;f<e.length;f++){this.tablePlugin.rowMSButton.setActiveItem();for(var g=0;g<this.tablePlugin.rowConfig.length;g++)b(e[f]).hasClass(this.tablePlugin.rowConfig[g].cssClass)&&(this.tablePlugin.rowMSButton.setActiveItem(this.tablePlugin.rowConfig[g].name),g=this.tablePlugin.rowConfig.length)}}c.setScope(this.tablePlugin.name+".row"),this.selection.selectRows(this.rowsToSelect),this.tablePlugin.columnHeader.setPressed(this.selection.isHeader()),this.obj.find("div.aloha-ui-table-cell-editable").blur(),this.selection.notifyCellsSelected(),this._removeCursorSelection()},j.prototype.deactivate=function(){this.obj.removeClass(this.get("className")),b.trim(this.obj.attr("class"))==""&&this.obj.removeAttr("class"),this.obj.removeAttr("contenteditable"),this.obj.parents("."+this.get("classTableWrapper")).length&&this.obj.unwrap(),this.obj.find("tr."+this.get("classSelectionRow")+":first").remove();var a=this;b.each(this.obj.context.rows,function(){b(this).children("td."+a.get("classSelectionColumn")).remove()}),this.obj.find("td, th").removeClass(this.get("classCellSelected")),this.obj.unbind();for(var c=0;c<this.cells.length;c++){var d=this.cells[c];d.deactivate()}this.obj.find("caption div").each(function(){b(this).contents().unwrap()}),this.isActive=!1},j.prototype.toString=function(){return"Table"},j.prototype.newCell=function(a){return new e(a,this)},j.prototype.newActiveCell=function(a){var b=new e(a,this);return b.activate(),b},j.prototype.getRows=function(){var a=this.obj.get(0).rows;return b.makeArray(a)},j});