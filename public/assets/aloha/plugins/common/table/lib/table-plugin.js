/*!
* Aloha Editor
* Author & Copyright (c) 2010 Gentics Software GmbH
* aloha-sales@gentics.com - way to over-lawyer it up Andrew :/
* Licensed unter the terms of http://www.aloha-editor.com/license.html
*/
define(["aloha","aloha/jquery","aloha/plugin","aloha/pluginmanager","aloha/floatingmenu","i18n!table/nls/i18n","i18n!aloha/nls/i18n","table/table-create-layer","table/table","table/table-plugin-utils","css!table/css/table.css"],function(a,b,c,d,e,f,g,h,i,j){function n(){var a=[],c=m;return b.each(arguments,function(){a.push("."+(this==""?c:c+"-"+this))}),a.join(" ").trim()}function o(){var a=[],c=m;return b.each(arguments,function(){a.push(this==""?c:c+"-"+this)}),a.join(" ").trim()}function p(a,c){var d=a.endContainer,e=a.startContainer,f=d.nodeType==3?d.length:d.childNodes.length;e.nodeType==3&&e.parentNode.tagName=="P"&&e.parentNode.childNodes.length==1&&/^(\s|%A0)$/.test(escape(e.data))&&(e.data="",a.startOffset=0,d==e&&(a.endOffset=0)),k.Utils.Dom.allowsNesting(e.nodeType==3?e.parentNode:e,c)||(a.startOffset==0&&b(e.nodeType==3?e.parentNode:e).addClass("aloha-table-cleanme"),a.endOffset==f&&b(d.nodeType==3?d.parentNode:d).addClass("aloha-table-cleanme"))}function q(){var a=b(".aloha-table-cleanme").removeClass("aloha-table-cleanme");for(var c=0;c<a.length;c++)b.trim(b(a[c]).html())==""&&!k.Utils.Dom.isEditingHost(a[c])&&b(a[c]).remove()}var k=window.GENTICS,l=new c("table");l.createLayer=undefined,l.languages=["en","de","fr","eo","fi","ru","it","pl"],l.config=["table"],l.TableRegistry=new Array,l.activeTable=undefined,l.parameters={className:"aloha-table",classSelectionRow:"aloha-table-selectcolumn",classSelectionColumn:"aloha-table-selectrow",classLeftUpperCorner:"aloha-table-leftuppercorner",classTableWrapper:"aloha-table-wrapper",classCellSelected:"aloha-cell-selected",waiRed:"aloha-wai-red",waiGreen:"aloha-wai-green",selectionArea:10},l.checkConfig=function(a){if(typeof a=="object"&&a.length){var b=[];for(var c=0;c<a.length;c++)a[c]&&b.push({text:a[c].text?a[c].text:a[c].name,tooltip:a[c].tooltip?a[c].tooltip:a[c].text,iconClass:a[c].iconClass?a[c].iconClass:"aloha-button-"+a[c].name,cssClass:a[c].cssClass?a[c].cssClass:a[c].name});a=b}else a=[];return a},l.init=function(){this.tableConfig=this.checkConfig(this.tableConfig||this.settings.tableConfig),this.columnConfig=this.checkConfig(this.columnConfig||this.settings.columnConfig),this.rowConfig=this.checkConfig(this.rowConfig||this.settings.rowConfig),this.createLayer=new h(this);var c=this;a.bind("aloha-editable-created",function(a,b){b.obj.bind("mousedown",function(a){l.setFocusedTable(undefined)}),b.obj.find("table").each(function(){if(c.isEditableTable(this)&&!l.isWithinTable(this)){var a=new i(this,l);a.parentEditable=b,l.TableRegistry.push(a)}l.checkForNestedTables(b.obj)})}),this.initTableButtons(),a.bind("aloha-table-selection-changed",function(){null!=l.activeTable&&0!==l.activeTable.selection.selectedCells.length&&l.updateFloatingMenuScope(),typeof l.activeTable!="undefined"&&l.activeTable.selection&&(l.activeTable.selection.cellsAreSplitable()?(c.btnSplitcells.enable(),c.btnRowsplitcells.enable(),c.btnTablesplitcells.enable()):(c.btnSplitcells.disable(),c.btnRowsplitcells.disable(),c.btnTablesplitcells.disable()),l.activeTable.selection.cellsAreMergeable()?(c.btnMergecells.enable(),c.btnRowmergecells.enable(),c.btnTablemergecells.enable()):(c.btnMergecells.disable(),c.btnRowmergecells.disable(),c.btnTablemergecells.disable()))}),a.bind("aloha-selection-changed",function(d,f){if(null==f.startContainer)return;if(a.activeEditable){var g=c.getEditableConfig(a.activeEditable.obj);b.inArray("table",g)!=-1&&a.Selection.mayInsertTag("table")?c.createTableButton.show():c.createTableButton.hide();var h=f.findMarkup(function(){return this.nodeName.toLowerCase()=="table"},a.activeEditable.obj);c.activeTable&&(h?l.updateFloatingMenuScope():(c.activeTable.selection.cellSelectionMode=!1,c.activeTable.selection.baseCellPosition=null,c.activeTable.selection.lastSelectionRange=null,c.activeTable.focusOut())),e.doLayout()}}),a.bind("aloha-editable-activated",function(a,d){c.btnSplitcells.disable(),c.btnRowsplitcells.disable(),c.btnTablesplitcells.disable(),c.btnMergecells.disable(),c.btnRowmergecells.disable(),c.btnTablemergecells.disable(),d.editable.obj.find("table").each(function(){var a=l.TableRegistry;for(var e=0;e<a.length;e++)if(a[e].obj.attr("id")==b(this).attr("id"))return a[e].activate(),!0;if(c.isEditableTable(this)&&!l.isWithinTable(this)){var f=new i(this,l);f.parentEditable=d.editable,f.activate(),l.TableRegistry.push(f)}l.checkForNestedTables(d.editable.obj)})}),a.bind("aloha-editable-deactivated",function(a,b){l.activeTable&&l.activeTable.selection.unselectCells(),l.setFocusedTable(undefined);var c=l.TableRegistry;for(var d=0;d<c.length;d++)c[d].deactivate()}),a.bind("aloha-smart-content-changed",function(b){a.activeEditable&&a.activeEditable.obj.find("table").each(function(){if(l.indexOfTableInRegistry(this)==-1&&!l.isWithinTable(this)){this.id=k.Utils.guid();var b=new i(this,l);b.parentEditable=a.activeEditable,l.TableRegistry.push(b),b.activate()}l.checkForNestedTables(a.activeEditable.obj)})}),this.settings.summaryinsidebar&&a.ready(function(){c.initSidebar(a.Sidebar.right.show())})};var m="aloha-table";return l.initSidebar=function(a){var c=this;c.sidebar=a,a.addPanel({id:o("sidebar-panel"),title:f.t("table.sidebar.title"),content:"",expanded:!0,activeOn:"table",onInit:function(){var a=this,d=this.setContent('<label class="'+o("label")+'" for="'+o("textarea")+'" >'+f.t("table.label.target")+"</label>"+'<textarea id="'+o("textarea")+'" class="'+o("textarea")+'" />').content;b(n("textarea")).live("keyup",function(){b(a.effective).attr("summary",b(n("textarea")).val());var d=b('div[class*="wai"]',"table#"+b(a.effective).attr("id"));d.removeClass(c.get("waiGreen")),d.removeClass(c.get("waiRed")),b(n("textarea")).val().trim()!=""?d.addClass(c.get("waiGreen")):d.addClass(c.get("waiRed"))})},onActivate:function(a){var c=this;c.effective=a,b(n("textarea")).val(b(c.effective).attr("summary"))}}),a.show()},l.isEditableTable=function(a){return k.Utils.Dom.isEditable(a)},l.indexOfTableInRegistry=function(a){var b=this.TableRegistry;for(var c=0;c<b.length;c++)if(b[c].obj[0].id==a.id)return c;return-1},l.getTableFromRegistry=function(a){var b=this.indexOfTableInRegistry(a);return b>-1?this.TableRegistry[b]:null},l.isSelectionInTable=function(){var c=a.Selection.getRangeObject(),d=b(c.commonAncestorContainer);return d.length==0?!1:d.parents(".aloha-editable table").length?!0:!1},l.preventNestedTables=function(){return this.isSelectionInTable()?(a.showMessage(new a.Message({title:f.t("Table"),text:f.t("table.createTable.nestedTablesNoSupported"),type:a.Message.Type.ALERT})),!0):!1},l.isWithinTable=function(a){return b(a).parents(".aloha-editable table").length>0},l.checkForNestedTables=function(a){!a.find("table table").length},l.initRowsBtns=function(){var c=this;e.addButton(this.name+".row",new a.ui.Button({name:"addrowbefore",iconClass:"aloha-button aloha-button-addRowBefore",size:"small",tooltip:f.t("button.addrowbefore.tooltip"),onclick:function(){c.activeTable&&c.activeTable.addRowBeforeSelection()}}),f.t("floatingmenu.tab.table"),1),e.addButton(this.name+".row",new a.ui.Button({name:"addrowafter",iconClass:"aloha-button aloha-button-addRowAfter",size:"small",tooltip:f.t("button.addrowafter.tooltip"),onclick:function(){c.activeTable&&c.activeTable.addRowAfterSelection()}}),f.t("floatingmenu.tab.table"),1),e.addButton(this.name+".row",new a.ui.Button({name:"deleterow",iconClass:"aloha-button aloha-button-deleteRows",size:"small",tooltip:f.t("button.delrows.tooltip"),onclick:function(){if(c.activeTable){var b=c.activeTable;a.showMessage(new a.Message({title:f.t("Table"),text:f.t("deleterows.confirm"),type:a.Message.Type.CONFIRM,callback:function(a){a=="yes"&&b.deleteRows()}}))}}}),f.t("floatingmenu.tab.table"),1),this.rowHeader=new a.ui.Button({name:"rowheader",iconClass:"aloha-button aloha-button-row-header",size:"small",tooltip:f.t("button.rowheader.tooltip"),toggle:!0,onclick:function(){if(c.activeTable){var d=c.activeTable.selection.selectedCells;c.rowsToSelect=[];var e=d[0]&&d[0].nodeName.toLowerCase()=="td"&&d.length==1||d[0]&&d[0].nodeName.toLowerCase()=="td"&&d[1].nodeName.toLowerCase()=="td";for(var f=0;f<d.length;f++)f==0&&c.rowsToSelect.push(d[f].rowIndex),e?d[f]=a.Markup.transformDomObject(d[f],"th").attr("scope","col")[0]:d[f]=a.Markup.transformDomObject(d[f],"td").removeAttr("scope")[0],b(d[f]).bind("mousedown",function(a){var d=b(this).children("div").eq(0);setTimeout(function(){d.trigger("focus")},1),c.activeTable&&c.activeTable.selection.unselectCells()});c.activeTable&&(c.activeTable.refresh(),c.activeTable.selectRows())}}}),e.addButton(this.name+".row",this.rowHeader,f.t("floatingmenu.tab.table"),1),this.btnRowmergecells=new a.ui.Button({name:"rowmergecells",iconClass:"aloha-button aloha-button-merge-cells",size:"small",tooltip:f.t("button.mergecells.tooltip"),toggle:!1,onclick:function(){c.activeTable&&c.activeTable.selection.mergeCells()}}),e.addButton(this.name+".row",this.btnRowmergecells,f.t("floatingmenu.tab.table"),1),this.btnRowsplitcells=new a.ui.Button({name:"rowsplitcells",iconClass:"aloha-button aloha-button-split-cells",size:"small",tooltip:f.t("button.splitcells.tooltip"),toggle:!1,onclick:function(){c.activeTable&&c.activeTable.selection.splitCells()}}),e.addButton(this.name+".row",this.btnRowsplitcells,f.t("floatingmenu.tab.table"),1),this.rowMSItems=[],b.each(this.rowConfig,function(a,d){c.rowMSItems.push({name:d.name,text:f.t(d.text),tooltip:f.t(d.tooltip),iconClass:"aloha-button aloha-row-layout "+d.iconClass,click:function(){if(c.activeTable){var a=c.activeTable.selection.selectedCells;for(var e=0;e<a.length;e++)if(b(a[e]).attr("class").indexOf(d.cssClass)>-1)b(a[e]).removeClass(d.cssClass);else{b(a[e]).addClass(d.cssClass);for(var f=0;f<c.rowConfig.length;f++)c.rowConfig[f].cssClass!=d.cssClass&&b(a[e]).removeClass(c.rowConfig[f].cssClass)}c.activeTable.selectRows()}}})}),this.rowMSItems.length>0&&this.rowMSItems.push({name:"removeFormat",text:f.t("button.removeFormat.text"),tooltip:f.t("button.removeFormat.tooltip"),iconClass:"aloha-button aloha-button-removeFormat",wide:!0,click:function(){if(c.activeTable){var a=c.activeTable.selection.selectedCells;for(var d=0;d<a.length;d++)for(var e=0;e<c.rowConfig.length;e++)b(a[d]).removeClass(c.rowConfig[e].cssClass);c.activeTable.selectRows()}}}),this.rowMSButton=new a.ui.MultiSplitButton({items:this.rowMSItems,name:"tableRowActions"}),this.rowMSItems.length>0&&e.addButton(this.name+".row",this.rowMSButton,f.t("floatingmenu.tab.table"),3)},l.initColumnBtns=function(){var c=this;e.addButton(this.name+".column",new a.ui.Button({name:"addcolumnleft",iconClass:"aloha-button aloha-button-addColumnLeft",size:"small",tooltip:f.t("button.addcolleft.tooltip"),onclick:function(){c.activeTable&&c.activeTable.addColumnsLeft()}}),f.t("floatingmenu.tab.table"),1),e.addButton(this.name+".column",new a.ui.Button({name:"addcolumnright",iconClass:"aloha-button aloha-button-addColumnRight",size:"small",tooltip:f.t("button.addcolright.tooltip"),onclick:function(){c.activeTable&&c.activeTable.addColumnsRight()}}),f.t("floatingmenu.tab.table"),1),e.addButton(this.name+".column",new a.ui.Button({name:"deletecolumns",iconClass:"aloha-button aloha-button-deleteColumns",size:"small",tooltip:f.t("button.delcols.tooltip"),onclick:function(){if(c.activeTable){var b=c.activeTable;a.showMessage(new a.Message({title:f.t("Table"),text:f.t("deletecolumns.confirm"),type:a.Message.Type.CONFIRM,callback:function(a){a=="yes"&&b.deleteColumns()}}))}}}),f.t("floatingmenu.tab.table"),1),this.columnHeader=new a.ui.Button({name:"columnheader",iconClass:"aloha-button aloha-button-col-header",size:"small",tooltip:f.t("button.columnheader.tooltip"),toggle:!0,onclick:function(){if(c.activeTable){var d=c.activeTable.selection.selectedColumnIdxs,e,f=c.activeTable.selection.isHeader();for(var g=0;g<c.activeTable.selection.selectedCells.length;g++)e=c.activeTable.selection.selectedCells[g],f?e=a.Markup.transformDomObject(e,"td").removeAttr("scope").get(0):e=a.Markup.transformDomObject(e,"th").attr("scope","row").get(0),b(c.activeTable.selection.selectedCells[g]).bind("mousedown",function(a){var c=b(this).children("div").eq(0);setTimeout(function(){c.trigger("focus")},1)});c.activeTable.refresh(),c.activeTable.selection.unselectCells(),c.activeTable.selection.selectColumns(d)}}}),e.addButton(this.name+".column",this.columnHeader,f.t("floatingmenu.tab.table"),1),this.btnTablemergecells=new a.ui.Button({name:"tablemergecells",iconClass:"aloha-button aloha-button-merge-cells",size:"small",tooltip:f.t("button.mergecells.tooltip"),toggle:!1,onclick:function(){c.activeTable&&c.activeTable.selection.mergeCells()}}),e.addButton(this.name+".column",this.btnTablemergecells,f.t("floatingmenu.tab.table"),1),this.btnTablesplitcells=new a.ui.Button({name:"tablesplitcells",iconClass:"aloha-button aloha-button-split-cells",size:"small",tooltip:f.t("button.splitcells.tooltip"),toggle:!1,onclick:function(){c.activeTable&&c.activeTable.selection.splitCells()}}),e.addButton(this.name+".column",this.btnTablesplitcells,f.t("floatingmenu.tab.table"),1),this.columnMSItems=[],b.each(this.columnConfig,function(a,d){var e={name:d.name,text:f.t(d.text),tooltip:f.t(d.tooltip),iconClass:"aloha-button aloha-column-layout "+d.iconClass,click:function(a,e,f){if(c.activeTable){var g=c.activeTable.selection.selectedCells;for(var h=0;h<g.length;h++)if(b(g[h]).attr("class").indexOf(d.cssClass)>-1)b(g[h]).removeClass(d.cssClass);else{b(g[h]).addClass(d.cssClass);for(var i=0;i<c.columnConfig.length;i++)c.columnConfig[i].cssClass!=d.cssClass&&b(g[h]).removeClass(c.columnConfig[i].cssClass)}c.activeTable.selectColumns()}}};c.columnMSItems.push(e)}),this.columnMSItems.length>0&&this.columnMSItems.push({name:"removeFormat",text:f.t("button.removeFormat.text"),tooltip:f.t("button.removeFormat.tooltip"),iconClass:"aloha-button aloha-button-removeFormat",wide:!0,click:function(){if(c.activeTable){var a=c.activeTable.selection.selectedCells;for(var d=0;d<a.length;d++)for(var e=0;e<c.columnConfig.length;e++)b(a[d]).removeClass(c.columnConfig[e].cssClass);c.activeTable.selectColumns()}}}),this.columnMSButton=new a.ui.MultiSplitButton({items:this.columnMSItems,name:"tableColumnActions"}),this.columnMSItems.length>0&&e.addButton(this.name+".column",this.columnMSButton,f.t("floatingmenu.tab.table"),3)},l.initTableButtons=function(){var c=this;e.createScope(this.name+".row","Aloha.global"),e.createScope(this.name+".column","Aloha.global"),e.createScope(this.name+".cell","Aloha.continuoustext"),this.createTableButton=new a.ui.Button({name:"table",iconClass:"aloha-button aloha-button-table",size:"small",tooltip:f.t("button.createtable.tooltip"),onclick:function(a,b){l.createDialog(a.btnEl.dom)}}),e.addButton("Aloha.continuoustext",this.createTableButton,g.t("floatingmenu.tab.insert"),1),this.initColumnBtns(),this.initRowsBtns(),this.tableMSItems=[];var d=this.tableConfig;b.each(d,function(a,b){c.tableMSItems.push({name:b.name,text:f.t(b.text),tooltip:f.t(b.tooltip),iconClass:"aloha-button aloha-table-layout "+b.iconClass,click:function(){if(c.activeTable){for(var a=0;a<d.length;a++)c.activeTable.obj.removeClass(d[a].cssClass);c.activeTable.obj.addClass(b.cssClass)}}})}),this.tableMSItems.length>0&&this.tableMSItems.push({name:"removeFormat",text:f.t("button.removeFormat.text"),tooltip:f.t("button.removeFormat.tooltip"),iconClass:"aloha-button aloha-button-removeFormat",wide:!0,click:function(){if(c.activeTable)for(var a=0;a<d.length;a++)c.activeTable.obj.removeClass(c.tableConfig[a].cssClass)}}),this.tableMSButton=new a.ui.MultiSplitButton({items:this.tableMSItems,name:"tableActions"}),this.tableMSItems.length>0&&e.addButton(this.name+".cell",this.tableMSButton,f.t("floatingmenu.tab.tablelayout"),3),this.btnMergecells=new a.ui.Button({name:"mergecells",iconClass:"aloha-button aloha-button-merge-cells",size:"small",tooltip:f.t("button.mergecells.tooltip"),toggle:!1,onclick:function(){c.activeTable&&c.activeTable.selection.mergeCells()}}),e.addButton(this.name+".cell",this.btnMergecells,f.t("floatingmenu.tab.table"),1),this.btnSplitcells=new a.ui.Button({name:"splitcells",iconClass:"aloha-button aloha-button-split-cells",size:"small",tooltip:f.t("button.splitcells.tooltip"),toggle:!1,onclick:function(){c.activeTable&&c.activeTable.selection.splitCells()}}),e.addButton(this.name+".cell",this.btnSplitcells,f.t("floatingmenu.tab.table"),1),this.captionButton=new a.ui.Button({name:"tablecaption",iconClass:"aloha-button aloha-button-table-caption",size:"small",tooltip:f.t("button.caption.tooltip"),toggle:!0,onclick:function(){if(c.activeTable)if(c.activeTable.obj.children("caption").is("caption"))c.activeTable.obj.children("caption").remove();else{var d=f.t("empty.caption"),e=b("<caption></caption>");c.activeTable.obj.append(e),c.makeCaptionEditable(e,d);var g=e.find("div").eq(0),h=g.contents().eq(0);if(h.length>0){var i=new k.Utils.RangeObject;i.startContainer=i.endContainer=h.get(0),i.startOffset=0,i.endOffset=h.text().length,c.activeTable.obj.find("div.aloha-table-cell-editable").blur(),g.focus(),i.select(),a.Selection.updateSelection()}}}}),e.addButton(this.name+".cell",this.captionButton,f.t("floatingmenu.tab.table"),1),this.summary=new a.ui.AttributeField({width:275,name:"tableSummary"}),this.summary.addListener("keyup",function(a,b){c.activeTable.checkWai()}),this.settings.summaryinsidebar||e.addButton(this.name+".cell",this.summary,f.t("floatingmenu.tab.table"),1)},l.makeCaptionEditable=function(a,c){var d=this,e=a.children("div").eq(0);e.length==0&&(e=b("<div></div>"),b(e).addClass("aloha-ui"),b(e).addClass("aloha-editable-caption"),a.contents().length>0?a.contents().wrap(e):(c&&e.text(c),a.append(e))),e.contentEditable(!0),e.unbind("mousedown"),e.bind("mousedown",function(a){return e.focus(),a.preventDefault(),a.stopPropagation(),!1})},l.createDialog=function(a){this.createLayer.set("target",a),this.createLayer.show()},l.createTable=function(c,d){if(this.preventNestedTables())return;if(a.activeEditable&&typeof a.activeEditable.obj!="undefined"){var e=document.createElement("table"),f=e.id=k.Utils.guid(),g=document.createElement("tbody");for(var h=0;h<d;h++){var j=document.createElement("tr");for(var m=0;m<c;m++){var n=document.createTextNode(" "),o=document.createElement("td");o.appendChild(n),j.appendChild(o)}g.appendChild(j)}e.appendChild(g),p(a.Selection.getRangeObject(),e),k.Utils.Dom.insertIntoDOM(b(e),a.Selection.getRangeObject(),a.activeEditable.obj),q();var r=document.getElementById(f);if(!l.isWithinTable(r)){var s=new i(r,l);s.parentEditable=a.activeEditable,s.activate(),b.browser.msie?window.setTimeout(function(){s.cells[0].wrapper.get(0).focus()},20):s.cells[0].wrapper.get(0).focus(),l.TableRegistry.push(s)}l.checkForNestedTables(a.activeEditable.obj)}else this.error("There is no active Editable where the table can be				inserted!")},l.setFocusedTable=function(a){var b=this;null==a&&null!=this.activeTable&&this.activeTable.selection.unselectCells();for(var c=0;c<l.TableRegistry.length;c++)l.TableRegistry[c].hasFocus=!1;if(typeof a!="undefined"){this.summary.setTargetObject(a.obj,"summary");if(a.obj.children("caption").is("caption")){b.captionButton.setPressed(!0);var d=a.obj.children("caption");b.makeCaptionEditable(d)}a.hasFocus=!0}l.activeTable=a;if(this.tableMSButton.extButton){for(var c=0;c<this.tableMSItems.length;c++)this.tableMSButton.showItem(this.tableMSItems[c].name);this.tableMSButton.setActiveItem()}if(this.activeTable)for(var c=0;c<this.tableConfig.length;c++)this.activeTable.obj.hasClass(this.tableConfig[c].cssClass)&&this.tableMSButton.setActiveItem(this.tableConfig[c].name)},l.error=function(b){a.Log.error(this,b)},l.debug=function(b){a.Log.debug(this,b)},l.info=function(b){a.Log.info(this,b)},l.log=function(b){a.log("log",this,b)},l.get=function(a){return this.config[a]?this.config[a]:this.parameters[a]?this.parameters[a]:undefined},l.set=function(a,b){this.config[a]?this.config[a]=b:this.parameters[a]=b},l.makeClean=function(a){var b=this;a.find("table").each(function(){b.getTableFromRegistry(this)&&(new i(this,b)).deactivate()})},l.toString=function(){return this.prefix},l.updateFloatingMenuScope=function(){null!=l.activeTable&&null!=l.activeTable.selection.selectionType&&e.setScope(l.name+"."+l.activeTable.selection.selectionType)},d.register(l),l});