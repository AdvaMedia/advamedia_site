/*!
* Aloha Editor
* Author & Copyright (c) 2010 Gentics Software GmbH
* aloha-sales@gentics.com
* Licensed unter the terms of http://www.aloha-editor.com/license.html
*/
define(["aloha","aloha/jquery","aloha/floatingmenu","aloha/observable","aloha/registry"],function(e,t,n,r,i){var s=window.GENTICS,o=new(Class.extend(r,{defaults:{"aloha-block-type":"DefaultBlock"},blockTypes:null,blocks:null,_highlightedBlocks:null,_activeBlock:null,_constructor:function(){n.createScope("Aloha.Block"),this.blockTypes=new i,this.blocks=new i,this._highlightedBlocks={}},registerEventHandlers:function(){var n=this;this._registerEventHandlersForDeactivatingAlohaBlock(),this._registerEventHandlersForDeterminingCurrentlyActiveBlock(),this._registerEventHandlersForBlockDeletion(),this._registerEventHandlersForCutCopyPaste(),e.bind("aloha-selection-changed",function(e,r,i){if(r&&t(r.getCommonAncestorContainer()).parents(".aloha-block").length>0)return;n._deactivateHighlightedBlocks()})},_registerEventHandlersForDeactivatingAlohaBlock:function(){var e=this;t(document).bind("click",function(n){if(e._highlightedBlocks=={})return;if(t(n.target).closest(".aloha-sidebar-bar, .aloha-block-do-not-deactivate, .aloha-floatingmenu, .aloha-block").length>0)return;e._deactivateHighlightedBlocks()})},_registerEventHandlersForDeterminingCurrentlyActiveBlock:function(){var e=this;this.bind("block-selection-change",function(t){t.length>0?e._activeBlock=t[0]:e._activeBlock=null})},_registerEventHandlersForBlockDeletion:function(){var n=this;e.bind("aloha-command-will-execute",function(r,i){var s=i.commandId,o=e.getSelection().getRangeCount()===0||e.getSelection().getRangeCount()===1&&e.getSelection().getRangeAt(0).endContainer===e.getSelection().getRangeAt(0).startContainer&&e.getSelection().getRangeAt(0).endContainer===t("body")[0]||e.getSelection().getRangeCount()===1&&e.getSelection().getRangeAt(0).endContainer===e.getSelection().getRangeAt(0).startContainer&&e.getSelection().getRangeAt(0).startOffset+1===e.getSelection().getRangeAt(0).endOffset;if(n._activeBlock&&(s==="delete"||s==="forwarddelete")&&o)i.preventDefault=!0,n._activeBlock.destroy();else if(!n._activeBlock&&(s==="delete"||s==="forwarddelete")&&e.getSelection().getRangeCount()===1&&e.getSelection().getRangeAt(0).collapsed===!1){var u;u=function(e){var n;for(var r=0,i=e.length;r<i;r++){n=e[r];if(n.domobj.nodeType===1){var s=t(n.domobj);n.selection==="full"&&s.is(".aloha-block")?s.remove():u(n.children)}}},u(e.Selection.getSelectionTree())}}),t(window.document).keydown(function(e){if(typeof e.srcElement!="undefined"&&typeof e.srcElement.form!="undefined")return!0;if(n._activeBlock&&(e.which===46||e.which===8)&&n._activeBlock._isInsideNestedEditable===!1){if((Ext.isIE8||Ext.isIE7)&&n._activeBlock.$element.parents(".aloha-editable,.aloha-block").first().hasClass("aloha-editable"))return n._activeBlock.destroy(),e.preventDefault(),!1;if(n._activeBlock.shouldDestroy())return n._activeBlock.destroy(),e.preventDefault(),!1}})},_registerEventHandlersForCutCopyPaste:function(){var e=this,n=!1,r=!1,i=null;t(window.document).keydown(function(t){e._activeBlock&&(t.ctrlKey||t.metaKey)&&t.which===67&&(n=!0,e._activeBlock.$element.attr("data-aloha-block-copy-only-block","true"),s.Utils.Dom.selectDomNode(e._activeBlock.$element[0])),e._activeBlock&&(t.ctrlKey||t.metaKey)&&t.which===88&&(r=!0,e._activeBlock.$element.attr("data-aloha-block-copy-only-block","true"),s.Utils.Dom.selectDomNode(e._activeBlock.$element[0]))}),t(window.document).keyup(function(t){!r&&n&&(t.which===67||t.which===18||t.which===91)&&(n=!1,e._activeBlock.$element.removeAttr("data-aloha-block-copy-only-block"),i&&(i=null)),r&&(t.which===67||t.which===18||t.which===88)&&(r=!1)})},initializeBlockLevelDragDrop:function(){var n=this;t.each(e.editables,function(e,t){n.createBlockLevelSortableForEditableOrBlockCollection(t.obj)}),e.bind("aloha-editable-created",function(e,t){n.createBlockLevelSortableForEditableOrBlockCollection(t.obj)})},createBlockLevelSortableForEditableOrBlockCollection:function(e){e.hasClass("aloha-block-blocklevel-sortable")||(e.addClass("aloha-block-blocklevel-sortable").sortable({revert:100,handle:".aloha-block-draghandle-blocklevel",connectWith:".aloha-block-blocklevel-sortable"}),e.get(0).ondragstart=function(e,t){if(!t||!t.helper||!t.helper.is(".aloha-block"))return!1})},registerBlockType:function(e,t){n.createScope("Aloha.Block."+e,"Aloha.Block"),this.blockTypes.register(e,t)},_blockify:function(n,r){var i,s,o;o=t(n);var u=o[0].tagName.toLowerCase();if(u!=="span"&&u!=="div"){e.Log.error("block/blockmanager","Blocks can only be created from <div> or <span> element. You passed "+u+".");return}i=this.getConfig(o,r);if(!this.blockTypes.has(i["aloha-block-type"])){e.Log.error("block/blockmanager","Block Type "+i["aloha-block-type"]+" not found!");return}s=new(this.blockTypes.get(i["aloha-block-type"]))(o),s.$element.addClass("aloha-block-"+i["aloha-block-type"]),t.each(i,function(e,t){s._setAttribute(e,t)}),this.blocks.register(s.getId(),s)},getConfig:function(e,n){return t.extend({},this.defaults,n,e.data())},getBlock:function(e){var n,r;return typeof e=="object"?(r=t(e),r.hasClass("aloha-block-inner")&&(r=r.parent()),n=r.attr("id")):n=e,this.blocks.get(n)},_unregisterBlock:function(e){var t;typeof e=="object"?t=e.getId():t=e,this.blocks.unregister(e)},_deactivateHighlightedBlocks:function(){t.each(t.extend({},this._highlightedBlocks),function(e){var t=o.getBlock(e);t&&t.deactivate()})},_getHighlightedBlocks:function(){var e={};return t.each(this.blocks.getEntries(),function(t,n){n.isActive()&&(e[t]=n)}),e},_setHighlighted:function(e){this._highlightedBlocks[e.id]=!0},_setUnhighlighted:function(e){delete this._highlightedBlocks[e.id]}}));return e.Block=e.Block||{},e.Block.BlockManager=o,o});