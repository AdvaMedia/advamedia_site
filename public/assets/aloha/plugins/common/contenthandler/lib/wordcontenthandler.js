/*!
* Aloha Editor
* Author & Copyright (c) 2010 Gentics Software GmbH
* aloha-sales@gentics.com
* Licensed unter the terms of http://www.aloha-editor.com/license.html
*/
define(["aloha","aloha/jquery","aloha/contenthandlermanager"],function(a,b,c){var d=c.createHandler({handleContent:function(a){return typeof a=="string"?a=b("<div>"+a+"</div>"):a instanceof b&&(a=b("<div>").append(a)),this.detectWordContent(a)&&this.transformWordContent(a),a.html()},detectWordContent:function(a){var c=!1;return a.find("*").each(function(){var a=b(this).attr("style"),d;if(a&&a.toLowerCase().indexOf("mso")>=0)return c=!0,!1;d=b(this).attr("class");if(d&&d.toLowerCase().indexOf("mso")>=0)return c=!0,!1}),c},isOrderedList:function(a){return a.css("fontFamily")=="Wingdings"||a.css("fontFamily")=="Symbol"?!1:a.text().match(/^([0-9]{1,3}\.)|([0-9]{1,3}\)|([a-zA-Z]{1,5}\.)|([a-zA-Z]{1,5}\)))$/)?!0:!1},transformListsFromWord:function(a){var c=this,d,e,f,g,h,i;i="aloha-list-element",h="aloha-list-bullet",e="p.MsoListParagraphCxSpFirst,p.MsoListParagraph,p span",g=a.find(e),g.each(function(){var a=b(this),c=a.css("font-family")||"",d=a.css("mso-list")||"",e=a.attr("style")||"";a.hasClass("MsoListParagraphCxSpFirst")||a.hasClass("MsoListParagraph")?a.addClass(i):c.indexOf("Symbol")>=0?a.closest("p").addClass(i):c.indexOf("Wingdings")>=0?a.closest("p").addClass(i):d!==""?a.closest("p").addClass(i):e.indexOf("mso-list")>=0&&a.closest("p").addClass(i)}),e="p span span span",f=a.find(e),f.each(function(){var a=b(this),c=a.text().trim().replace(/&nbsp;/g,""),d;c.length===0&&(d=a.parent().parent().text().trim().replace(/&nbsp;/g,""),d.match(/^([0-9]{1,3}\.)|([0-9]{1,3}\))|([a-zA-Z]{1,5}\.)|([a-zA-Z]{1,5}\))|(.)$/)&&(a.closest("p").addClass(i),a.parent().parent().addClass(h)))}),e="p."+i,d=":not("+e+")",g=a.find(e),g.length>0&&g.each(function(){var a=b(this),e,f,g,j,k,l,m,n;a.removeClass(i),a.find("font").each(function(){b(this).contents().unwrap()}),n=[],m=parseFloat(a.css("marginLeft")),l=[],k=a.nextUntil(d),j=b(a.find("span."+h)),j.length===0&&(j=a.find("span").eq(0)),g=c.isOrderedList(j),j.remove(),f=b(g?"<ol></ol>":"<ul></ul>"),l.push(f),e=b("<li></li>"),f.append(e),a.contents().appendTo(e),a.replaceWith(f),k.each(function(){var a=b(this),d,i;a.find("font").each(function(){b(this).contents().unwrap()}),d=parseFloat(a.css("marginLeft")),j=b(a.find("span."+h)),j.length===0&&(j=a.find("span").eq(0)),g=c.isOrderedList(j),j.remove();if(d>m)i=b(g?"<ol></ol>":"<ul></ul>"),f.children(":last").append(i),f=i,l.push(f),n.push(d),m=d;else if(d<m&&n.length>0){while(n.length>0&&n[n.length-1]>d)n.pop(),l.pop();f=l[l.length-1],m=d}e=b("<li></li>"),f.append(e),a.contents().appendTo(e),a.remove()})})},transformTitles:function(c){c.find("p.MsoTitle").each(function(){a.Markup.transformDomObject(b(this),"h1")}),c.find("p.MsoSubtitle").each(function(){a.Markup.transformDomObject(b(this),"h2")})},cleanHtml:function(a){a.find("*").filter(function(){return b.trim(b(this).text())==""}).contents().unwrap(),a.find("span").contents().unwrap(),a.find("a").each(function(){b(this).attr("href")&&b(this).attr("href").trim().match(/^#(.*)$/)&&b(this).contents().unwrap()}),a.find("div").contents().unwrap(),a.find("*").filter(function(){return b.trim(b(this).text())==""}).remove()},removeParagraphNumbering:function(a){var c="h1,h2,h3,h4,h5,h6",d=a.find(c);d.length>0&&d.each(function(){var a=b(this),c=a.find("span"),d=a.find("a");c.each(function(){b(this).text().trim().match(/^([\.\(]?[\d\D][\.\(]?){1,4}$/)&&b(this).remove()}),d.each(function(){typeof b(this).attr("href")=="undefined"&&b(this).contents().unwrap()})})},transformToc:function(a){var c="[class*=MsoToc]",d=a.find(c);d.each(function(){var a=b(this),c=a.find("span"),d=a.find("a");c.each(function(){b(this).attr("style")&&b(this).attr("style").search("mso-hide")>-1&&b(this).remove(),b(this).contents().unwrap()}),d.each(function(){b(this).contents().unwrap()})})},transformWordContent:function(a){this.transformToc(a),this.removeParagraphNumbering(a),this.transformListsFromWord(a),this.transformTitles(a),this.cleanHtml(a)}});return d});