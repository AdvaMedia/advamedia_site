/*!
* Aloha Editor
* Author & Copyright (c) 2010 Gentics Software GmbH
* aloha-sales@gentics.com
* Licensed unter the terms of http://www.aloha-editor.com/license.html
*/
define(["aloha","aloha/jquery","aloha/contenthandlermanager"],function(e,t,n){var r=n.createHandler({handleContent:function(e){return typeof e=="string"?e=t("<div>"+e+"</div>"):e instanceof t&&(e=t("<div>").append(e)),this.detectWordContent(e)&&this.transformWordContent(e),e.html()},detectWordContent:function(e){var n=!1;return e.find("*").each(function(){var e=t(this).attr("style"),r;if(e&&e.toLowerCase().indexOf("mso")>=0)return n=!0,!1;r=t(this).attr("class");if(r&&r.toLowerCase().indexOf("mso")>=0)return n=!0,!1}),n},isOrderedList:function(e){return e.css("fontFamily")=="Wingdings"||e.css("fontFamily")=="Symbol"?!1:e.text().match(/^([0-9]{1,3}\.)|([0-9]{1,3}\)|([a-zA-Z]{1,5}\.)|([a-zA-Z]{1,5}\)))$/)?!0:!1},transformListsFromWord:function(e){var n=this,r,i,s,o,u,a;a="aloha-list-element",u="aloha-list-bullet",i="p.MsoListParagraphCxSpFirst,p.MsoListParagraph,p span",o=e.find(i),o.each(function(){var e=t(this),n=e.css("font-family")||"",r=e.css("mso-list")||"",i=e.attr("style")||"";e.hasClass("MsoListParagraphCxSpFirst")||e.hasClass("MsoListParagraph")?e.addClass(a):n.indexOf("Symbol")>=0?e.closest("p").addClass(a):n.indexOf("Wingdings")>=0?e.closest("p").addClass(a):r!==""?e.closest("p").addClass(a):i.indexOf("mso-list")>=0&&e.closest("p").addClass(a)}),i="p span span span",s=e.find(i),s.each(function(){var e=t(this),n=e.text().trim().replace(/&nbsp;/g,""),r;n.length===0&&(r=e.parent().parent().text().trim().replace(/&nbsp;/g,""),r.match(/^([0-9]{1,3}\.)|([0-9]{1,3}\))|([a-zA-Z]{1,5}\.)|([a-zA-Z]{1,5}\))|(.)$/)&&(e.closest("p").addClass(a),e.parent().parent().addClass(u)))}),i="p."+a,r=":not("+i+")",o=e.find(i),o.length>0&&o.each(function(){var e=t(this),i,s,o,f,l,c,h,p;e.removeClass(a),e.find("font").each(function(){t(this).contents().unwrap()}),p=[],h=parseFloat(e.css("marginLeft")),c=[],l=e.nextUntil(r),f=t(e.find("span."+u)),f.length===0&&(f=e.find("span").eq(0)),o=n.isOrderedList(f),f.remove(),s=t(o?"<ol></ol>":"<ul></ul>"),c.push(s),i=t("<li></li>"),s.append(i),e.contents().appendTo(i),e.replaceWith(s),l.each(function(){var e=t(this),r,a;e.find("font").each(function(){t(this).contents().unwrap()}),r=parseFloat(e.css("marginLeft")),f=t(e.find("span."+u)),f.length===0&&(f=e.find("span").eq(0)),o=n.isOrderedList(f),f.remove();if(r>h)a=t(o?"<ol></ol>":"<ul></ul>"),s.children(":last").append(a),s=a,c.push(s),p.push(r),h=r;else if(r<h&&p.length>0){while(p.length>0&&p[p.length-1]>r)p.pop(),c.pop();s=c[c.length-1],h=r}i=t("<li></li>"),s.append(i),e.contents().appendTo(i),e.remove()})})},transformTitles:function(n){n.find("p.MsoTitle").each(function(){e.Markup.transformDomObject(t(this),"h1")}),n.find("p.MsoSubtitle").each(function(){e.Markup.transformDomObject(t(this),"h2")})},cleanHtml:function(e){e.find("*").filter(function(){return t.trim(t(this).text())==""}).contents().unwrap(),e.find("span").contents().unwrap(),e.find("a").each(function(){t(this).attr("href")&&t(this).attr("href").trim().match(/^#(.*)$/)&&t(this).contents().unwrap()}),e.find("div").contents().unwrap(),e.find("*").filter(function(){return t.trim(t(this).text())==""}).remove()},removeParagraphNumbering:function(e){var n="h1,h2,h3,h4,h5,h6",r=e.find(n);r.length>0&&r.each(function(){var e=t(this),n=e.find("span"),r=e.find("a");n.each(function(){t(this).text().trim().match(/^([\.\(]?[\d\D][\.\(]?){1,4}$/)&&t(this).remove()}),r.each(function(){typeof t(this).attr("href")=="undefined"&&t(this).contents().unwrap()})})},transformToc:function(e){var n="[class*=MsoToc]",r=e.find(n);r.each(function(){var e=t(this),n=e.find("span"),r=e.find("a");n.each(function(){t(this).attr("style")&&t(this).attr("style").search("mso-hide")>-1&&t(this).remove(),t(this).contents().unwrap()}),r.each(function(){t(this).contents().unwrap()})})},transformWordContent:function(e){this.transformToc(e),this.removeParagraphNumbering(e),this.transformListsFromWord(e),this.transformTitles(e),this.cleanHtml(e)}});return r});