/*!
* Aloha Editor
* Author & Copyright (c) 2010 Gentics Software GmbH
* aloha-sales@gentics.com
* Licensed unter the terms of http://www.aloha-editor.com/license.html
*/
define(["aloha","aloha/jquery","aloha/contenthandlermanager"],function(e,t,n){var r=window.GENTICS,i=n.createHandler({handleContent:function(e){typeof e=="string"?e=t("<div>"+e+"</div>"):e instanceof t&&(e=t("<div>").append(e));if(e.find(".aloha-block").length>0)return;return this.cleanLists(e),this.transformTables(e),this.removeComments(e),this.unwrapTags(e),this.removeStyles(e),this.removeNamespacedElements(e),this.transformFormattings(e),e.html()},cleanLists:function(e){e.find("ul,ol").each(function(){var e=t(this);e.contents(":not(li,ul,ol)").each(function(){t(this).remove()}),e.children("li").each(function(){var e=t(this);e.contents().each(function(){this.nodeType===3&&(this.data=t.trim(this.data))})})})},transformTables:function(e){e.find("table").each(function(){t(this).removeAttr("border").removeAttr("cellspacing").removeAttr("cellpadding")}),e.find("td").each(function(){t(this).removeAttr("width").removeAttr("height").removeAttr("valign"),this.innerHTML.replace(/[\s\xA0]+/g,"")==="<p><br></p>"&&(this.innerHTML="&nbsp;"),t(this).find("p").length==1&&t(this).find("p").contents().unwrap()}),e.find("tr").each(function(){t(this).removeAttr("width").removeAttr("height").removeAttr("valign")}),e.find("colgroup").remove()},transformFormattings:function(n){n.find("strong,em,s,u").each(function(){this.nodeName.toLowerCase()=="strong"?e.Markup.transformDomObject(t(this),"b"):this.nodeName.toLowerCase()=="em"?e.Markup.transformDomObject(t(this),"i"):this.nodeName.toLowerCase()=="s"?e.Markup.transformDomObject(t(this),"del"):this.nodeName.toLowerCase()=="u"&&t(this).contents().unwrap()})},transformLinks:function(e){e.find("a").each(function(){typeof t(this).attr("href")=="undefined"&&t(this).contents().unwrap()})},removeComments:function(e){var n=this;e.contents().each(function(){this.nodeType==8?t(this).remove():n.removeComments(t(this))})},unwrapTags:function(n){var r=this;n.children("span,font,div").filter(function(){return this.contentEditable!="false"}).each(function(){this.nodeName=="DIV"?this.innerHTML=="<br>"?t(this).contents().unwrap():t(e.Markup.transformDomObject(t(this),"p").append("<br>")).contents().unwrap():t(this).contents().unwrap(),r.unwrapTags(t(this))})},removeStyles:function(e){var n=this;e.children("style").filter(function(){return this.contentEditable!="false"}).remove(),e.children().filter(function(){return this.contentEditable!="false"}).each(function(){t(this).removeAttr("style").removeClass(),n.removeStyles(t(this))})},removeNamespacedElements:function(e){e.find("*").each(function(){var e=this.prefix?this.prefix:this.scopeName?this.scopeName:undefined;if(e&&e!="HTML"||this.nodeName.indexOf(":")>=0){var n=t(this),r=n.contents();r.length?r.unwrap():n.remove()}})}});return i});