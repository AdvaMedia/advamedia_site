/**
 * Aloha.Browser
 *
 * The browser is an interface to interact with a Repository Managers.
 *
 * Reference:
 *		www.aloha-editor.org/wiki/Repository
 * 3rd party tools:
 *		www.jstree.com/documentation/core
 *		www.trirand.com/blog (jqGrid)
 *		layout.jquery-dev.net
 *
 * NOTE: regarding 'jquery-plugin' RequireJS loader:
 * due to Cross-Origin Resource Sharing (CORS) / Access-Control-Allow-Origin 
 * problems with the CDN the jQuery plugins got a litte rewrite.
 *
 * ATTENTION: when updating the plugins you need to insert at the top of the file:
 * 
 * define(['aloha/jquery'], function(jQuery) { 
 * 	var $ = jQuery;
 * 
 * and at the end of the file:
 * 
 * });
 *
 * see: README https://github.com/jrburke/require-jquery/ or
 * http://requirejs.org/docs/jquery.html
 *
 * others: depend.js from https://github.com/millermedeiros/requirejs-plugins
 *
 * todo: think about if using order plugin or priority config can help us here
 */
define(["aloha/jquery","util/class","i18n!browser/nls/i18n","aloha/console","browser/locale","css!browser/css/browsercombined.css","browser/vendor/jquery.ui","browser/vendor/ui-layout","browser/vendor/jquery.jqGrid","browser/vendor/jquery.jstree"],function(a,b,c,d){function g(a,b){return a.replace(/\{([a-z0-9\-\_]+)\}/ig,function(a,c,d,e){var f=b[c]||a;return typeof f=="function"?f():f})}function h(a){return typeof a=="string"?g(a,f):a}function i(b){b.each(function(){a(this).attr("unselectable","on").css({"-moz-user-select":"none","-webkit-user-select":"none","user-select":"none"}).each(function(){this.onselectstart=function(){return!1}})})}var e=+(new Date),f={tree:"aloha-browser-tree","tree-header":"aloha-browser-tree-header","grab-handle":"aloha-browser-grab-handle",shadow:"aloha-browser-shadow","rounded-top":"aloha-browser-rounded-top",list:"aloha-browser-list","list-altrow":"aloha-browser-list-altrow","list-resizable":"aloha-browser-list-resizable","list-pager":"aloha-browser-list-pager","list-btns":"aloha-browser-list-btns","search-btn":"aloha-browser-search-btn","search-field":"aloha-browser-search-field","search-icon":"aloha-browser-search-icon","close-btn":"aloha-browser-close-btn",btn:"aloha-browser-btn",btns:"aloha-browser-btns",grid:"aloha-browser-grid",clear:"aloha-browser-clear",inner:"aloha-browser-inner","modal-overlay":"aloha-browser-modal-overlay","modal-window":"aloha-browser-modal-window"},j=b.extend({_constructor:function(){this.init.apply(this,arguments)},init:function(b){var d=a.extend({verbose:!1,repositoryManager:null,repositoryFilter:[],objectTypeFilter:[],renditionFilter:["cmis:none"],filter:["url"],element:undefined,rootFolderId:"aloha",rootPath:"",treeWidth:300,listWidth:"auto",pageSize:10,columns:{icon:{title:"",width:30,sortable:!1,resizable:!1},name:{title:c.t("Name"),width:250,sorttype:"text"},url:{title:c.t("URL"),width:250,sorttype:"text"},preview:{title:c.t("Preview"),width:200,sorttype:"text"}},isFloating:!1},b||{});if(!d.element||!d.element.length)d.isFloating=!0,d.element=this.createOverlay();this._callbacks={},this._objs={},this._searchQuery=null,this._orderBy=null,this._pagingOffset=0,this._pagingCount=undefined,this._pagingBtns={first:null,end:null,next:null,prev:null},typeof d.implement=="object"&&(a.each(d.implement,function(a,b){f[a]=b}),delete d.implement),typeof d.callbacks=="object"&&(a.each(d.callbacks,function(){f.callback(this[0],this[1])}),delete d.callbacks),a.extend(this,d);var f=this,g=this.treeWidth,h=g/5;this.preloadImages(),this.element.attr("data-aloha-browser",++e).html(""),this.totalWidth&&this.element.width(this.totalWidth),this.grid=this.createGrid(this.element).resize(),this.tree=this.createTree(this.grid.find(".ui-layout-west")),this.list=this.createList(this.grid.find(".ui-layout-center")),this.grid.layout({west__size:g-1,west__minSize:g-h,west__maxSize:g+h,center__size:"auto",paneClass:"ui-layout-pane",resizerClass:"ui-layout-resizer",togglerClass:"ui-layout-toggler",onresize:function(a,b){a=="center"&&f.list.setGridWidth(b.width())}}).sizePane("west",g),i(this.grid),this.close()},destroy:function(){},instanceOf:"Aloha.Browser",grid:null,tree:null,list:null,preloadImages:function(){var b=this;a.each(["arrow-000-medium.png","arrow-180.png","arrow-315-medium.png","arrow-stop-180.png","arrow-stop.png","arrow.png","control-stop-square-small.png","folder-horizontal-open.png","folder-open.png","magnifier-left.png","page.png","picture.png","sort-alphabet-descending.png","sort-alphabet.png"],function(){(new Image).src=b.rootPath+"img/"+this})},trigger:function(a,b){var c=this._callbacks,d=c[a];if(typeof d=="object")for(var e=0,f=d.length;e<f;++e)typeof d[e]=="function"&&d[e].call(this,b)},callback:function(a,b){return typeof this[a]!="function"?(d.warn('Unable to add a callback to "'+a+'" because it is not a method in Aloha.Browser.'),this):typeof b!="function"?(d.warn('Unable to add a callback to "'+a+'" because '+'the callback object that was given is of type "'+typeof b+'". '+'The callback object needs to be of type "function".'),this):(this._callbacks[a]==undefined?this.enableCallbacks(a)&&(this._callbacks[a]=[b]):this._callbacks[a].push(b),this)},enableCallbacks:function(a){var b=this,c=this[a];return typeof c=="function"?(this[a]=function(){var d=c.apply(b,arguments);return b.trigger.call(b,a,d),d},!0):(d.warn('Cannot enable callbacks for function "'+a+'" because no such method was found in Aloha.Browser.'),!1)},getRepoChildren:function(a,b){var c=this;this.repositoryManager&&this.repositoryManager.getChildren(a,function(a){c.processRepoResponse(a,b)})},queryRepository:function(a,b){var c=this;this.repositoryManager&&this.repositoryManager.query(a,function(a){c.processRepoResponse(a.results>0?a.items:[],{numItems:a.numItems,hasMoreItems:a.hasMoreItems},b)})},processRepoResponse:function(b,c,d){var e=this,f=[];typeof c=="function"&&(d=c,c=undefined),a.each(b,function(){f.push(e.harvestRepoObject(this))}),typeof d=="function"&&d.call(this,f,c)},harvestRepoObject:function(b){++e;var c=this._objs[e]=a.extend(b,{uid:e,loaded:!1});return this.processRepoObject(c)},processRepoObject:function(a){var b="",c;switch(a.baseType){case"folder":b="folder";break;case"document":b="document"}return a.type&&(c={rel:a.type}),{data:{title:a.name,attr:{"data-rep-oobj":a.uid},icon:b},attr:c,state:a.hasMoreItems||a.baseType==="folder"?"closed":null,resource:a}},fetchRepoRoot:function(a){this.repositoryManager&&this.getRepoChildren({inFolderId:this.rootFolderId,repositoryFilter:this.repositoryFilter},function(b){typeof a=="function"&&a(b)})},renderRowCols:function(b){var c={};return a.each(this.columns,function(a,d){switch(a){case"icon":c.icon='<div class="aloha-browser-icon aloha-browser-icon-'+b.type+'"></div>';break;default:c[a]=b[a]||"--"}}),c},onSelect:function(a){},fetchChildren:function(a,b){var c=this;(a.hasMoreItems==1||a.baseType==="folder")&&a.loaded==0&&this.getRepoChildren({inFolderId:a.id,repositoryId:a.repositoryId},function(d){c._objs[a.uid].loaded=!0,typeof b=="function"&&b(d)})},getObjectFromCache:function(a){var b;if(typeof a=="object"){var c=a.find("a:first").attr("data-rep-oobj");b=this._objs[c]}return b},rowClicked:function(b){var c=a(b.target).parent("tr"),d=null;if(c.length>0){var e=c.attr("id");d=this._objs[e],this.onSelect(d)}return d},createTree:function(b){var c=this,d=a(h('<div class="{tree}">')),e=a(h('<div class="{tree-header} {grab-handle}">					Repository Browser				</div>'));return b.append(e,d),d.height(this.grid.height()-e.outerHeight(!0)).bind("loaded.jstree",function(b,c){a(">ul>li",this).first().css("padding-top",5),d.jstree("open_node","li[rel='repository']")}).bind("select_node.jstree",function(a,b){if(b.args[0].context)return;var d=b.rslt.obj,e=c.getObjectFromCache(d);typeof e=="object"&&(c._pagingOffset=0,c._searchQuery=null,c._currentFolder=e,c.fetchItems(e,c.processItems))}).jstree({types:c.types,rootFolderId:this.rootFolderId,plugins:["themes","json_data","ui","types"],core:{animation:250},themes:{theme:"browser",url:c.rootPath+"css/jstree.css",dots:!0,icons:!0},json_data:{data:function(a,b){if(window.GCN&&!window.GCN.sid)return;c.repositoryManager?(c.jstree_callback=b,c.fetchSubnodes.call(c,a,b)):b()},correct_state:!0},ui:{select_limit:1}}),d},createGrid:function(b){var c=a(h('<div class="{grid} {shadow} {rounded-top}"> 					<div class="ui-layout-west"></div>		 					<div class="ui-layout-center"></div>	 				</div>'));return b.append(c),c},createList:function(b){var c=this,d="aloha-browser-list-"+ ++e,f=a(h('<table id="'+d+'"				class="{list}"></table>')),g=[""],i=[{name:"id",sorttype:"int",firstsortorder:"asc",hidden:!0}];a.each(this.columns,function(a,b){g.push(b.title&&b.title?b.title:"&nbsp;"),i.push({name:a,width:b.width,sortable:b.sortable,sorttype:b.sorttype,resizable:b.resizable,fixed:b.fixed})});var j="aloha-browser-list-page-"+ ++e;b.append(f,a('<div id="'+j+'">')),f.jqGrid({datatype:"local",width:b.width(),shrinkToFit:!0,colNames:g,colModel:i,caption:"&nbsp;",altRows:!0,altclass:"aloha-browser-list-altrow",resizeclass:"aloha-browser-list-resizable",pager:"#"+j,viewrecords:!0,onPaging:function(a){},loadError:function(a,b,c){},ondblClickRow:function(a,b,c,d){},gridComplete:function(){},loadComplete:function(a){}}),b.find(".ui-jqgrid-bdiv").height(this.grid.height()-(b.find(".ui-jqgrid-titlebar").height()+b.find(".ui-jqgrid-hdiv").height()+b.find(".ui-jqgrid-pager").height())),f.click(function(){c.rowClicked.apply(c,arguments)}),b.find(".ui-pg-button").unbind().find(">span.ui-icon").each(function(){var b=this.className.match(/ui\-icon\-seek\-([a-z]+)/)[1];c._pagingBtns[b]=a(this).parent().addClass("ui-state-disabled").click(function(){a(this).hasClass("ui-state-disabled")||c.doPaging(b)})}),b.find(".ui-pg-input").parent().hide(),b.find(".ui-separator").parent().css("opacity",0).first().hide(),this.createTitlebar(b);var k=f[0].p;return b.find(".ui-jqgrid-view tr:first th div").each(function(b){k.colModel[b].sortable!==!1&&a(this).unbind().click(function(a){a.stopPropagation(),c.sortList(k.colModel[b],this)})}),f},createTitlebar:function(b){var d=this,e,f=b.find(".ui-jqgrid-titlebar"),g=a(h('<div class="{btns}">							 					<input type="text" class="{search-field}" /> 					<span class="{btn} {search-btn}">			 						<span class="{search-icon}"></span>		 					</span>										 					<span class="{btn} {close-btn}">Close</span> 					<div class="{clear}"></div>					 				</div>'));f.addClass("aloha-browser-grab-handle").append(g),f.find(".aloha-browser-search-btn").html(c.t("Search")).click(function(){d.triggerSearch()}),e=f.find(".aloha-browser-search-field").keypress(function(a){a.keyCode==13&&d.triggerSearch()});var i=c.t("Input search text...");e.val(i).addClass("aloha-browser-search-field-empty").focus(function(){a(this).val()==i&&a(this).val("").removeClass("aloha-browser-search-field-empty")}).blur(function(){a(this).val()==""&&a(this).val(i).addClass("aloha-browser-search-field-empty")}),f.find(".aloha-browser-close-btn").html(c.t("Close")).click(function(){d.close()}),f.find(".aloha-browser-btn").mousedown(function(){a(this).addClass("aloha-browser-pressed")}).mouseup(function(){a(this).removeClass("aloha-browser-pressed")})},triggerSearch:function(){var b=this.grid.find("input.aloha-browser-search-field"),c=b.val();a(b).css("font-style")=="italic"&&(c=""),this._pagingOffset=0,this._searchQuery=b.val(),this.fetchItems(this._currentFolder,this.processItems)},sortList:function(b,c){a("span.ui-grid-ico-sort").addClass("ui-state-disabled"),b.sortorder=b.sortorder=="asc"?"desc":"asc",a(c).find("span.s-ico").show().find(".ui-icon-"+b.sortorder).removeClass("ui-state-disabled"),this.setSortOrder(b.name,b.sortorder).fetchItems(this._currentFolder,this.processItems)},setSortOrder:function(a,b){var c={};c[a]=b||"asc";var d=this._orderBy||[],e,f,g=!1;for(var h=0,i=d.length;h<i;++h){f=d[h];for(e in f)if(e===a){d.splice(h,1),d.unshift(c),g=!0;break}if(g)break}return g||d.unshift(c),this._orderBy=d,this},getFieldOfHeader:function(a){return a.find("div.ui-jqgrid-sortable").attr("id").replace("jqgh_","")},doPaging:function(a){switch(a){case"first":this._pagingOffset=0;break;case"end":this._pagingCount%this.pageSize===0?this._pagingOffset=this._pagingCount-this.pageSize:this._pagingOffset=this._pagingCount-this._pagingCount%this.pageSize;break;case"next":this._pagingOffset+=this.pageSize;break;case"prev":this._pagingOffset-=this.pageSize}this.fetchItems(this._currentFolder,this.processItems)},fetchItems:function(a,b){if(!a)return;this.list.setCaption(typeof this._searchQuery=="string"?c.t("Searching for")+' "'+this._searchQuery+'" '+c.t("in")+" "+a.name:c.t("Browsing")+": "+a.name),this.list.hide(),this.grid.find(".loading").show();var d=this;this.queryRepository({repositoryId:a.repositoryId,inFolderId:a.id,queryString:this._searchQuery,orderBy:this._orderBy,skipCount:this._pagingOffset,maxItems:this.pageSize,objectTypeFilter:this.objectTypeFilter,renditionFilter:this.renditionFilter,filter:this.filter,recursive:!1},function(a,c){typeof b=="function"&&b.call(d,a,c)})},fetchSubnodes:function(a,b){if(a===-1)this.fetchRepoRoot(b);else{var c=this.getObjectFromCache(a);typeof c=="object"&&this.fetchChildren(c,b)}},listItems:function(b){var c=this,d=this.list.clearGridData();a.each(b,function(){var b=this.resource;d.addRowData(b.uid,a.extend({id:b.id},c.renderRowCols(b)))})},processItems:function(b,d){var e=this._pagingBtns,f="ui-state-disabled";d&&a.isNumeric(d.numItems)?this._pagingCount=d.numItems:this._pagingCount=undefined,this.grid.find(".loading").hide(),this.list.show(),this.listItems(b),this._pagingOffset<=0?e.first.add(e.prev).addClass(f):e.first.add(e.prev).removeClass(f),isNaN(this._pagingCount)?(e.end.addClass(f),b.length<this.pageSize?e.next.addClass(f):e.next.removeClass(f)):this._pagingOffset+this.pageSize>=this._pagingCount?e.end.add(e.next).addClass(f):e.end.add(e.next).removeClass(f);var g,h;b.length==0&&this._pagingOffset==0?(g=0,h=0):(g=this._pagingOffset+1,h=g+b.length-1),this.grid.find(".ui-paging-info").html(c.t("Viewing")+" "+g+" - "+h+" "+c.t("of")+" "+(a.isNumeric(this._pagingCount)?this._pagingCount:c.t("numerous")))},createOverlay:function(){var b=this;a(".aloha-browser-modal-overlay").length==0&&a("body").append(h('<div class="{modal-overlay}" style="top: -99999px; z-index: 99999;"></div>')),a(".aloha-browser-modal-overlay").click(function(){b.close()});var c=a(h('<div class="{modal-window}"  style="top: -99999px; z-index: 99999;"></div>'));return a("body").append(c),c},setObjectTypeFilter:function(a){this.objectTypeFilter=typeof a=="string"?[a]:a},getObjectTypeFilter:function(){return this.objectTypeFilter},show:function(){this.opened=!0;var b=this.element;if(this.isFloating){b.find(".aloha-browser-close-btn").show(),a(".aloha-browser-modal-overlay").css({top:0,left:0}).add(b).stop().show();var c=a(window);b.css({left:(c.width()-b.width())/2,top:(c.height()-b.height())/3}).draggable({handle:b.find(".aloha-browser-grab-handle")}).resizable(),this.grid.css({marginTop:30,opacity:0}).animate({marginTop:0,opacity:1},1500,"easeOutExpo",function(){a.browser.msie&&a(this).add(b).css("filter","progid:DXImageTransform.Microsoft.gradient(enabled = false)")})}else b.stop().show().css({opacity:1,filter:"progid:DXImageTransform.Microsoft.gradient(enabled = false)"}),b.find(".aloha-browser-close-btn").hide()},close:function(){this.opened=!0,this.element.fadeOut(250,function(){a(this).css("top",0).hide(),a(".aloha-browser-modal-overlay").hide()})},refresh:function(){this._currentFolder&&this.fetchItems(this._currentFolder,this.processItems)}});return j});