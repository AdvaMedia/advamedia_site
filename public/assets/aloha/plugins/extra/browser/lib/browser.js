/**
 * Aloha.Browser
 *
 * The browser is an interface to interact with a Repository Managers.
 *
 * Reference:
 *		www.aloha-editor.org/wiki/Repository
 * 3rd party tools:
 *		www.jstree.com/documentation/core
 *		www.trirand.com/blog (jqGrid)
 *		layout.jquery-dev.net
 *
 * NOTE: regarding 'jquery-plugin' RequireJS loader:
 * due to Cross-Origin Resource Sharing (CORS) / Access-Control-Allow-Origin 
 * problems with the CDN the jQuery plugins got a litte rewrite.
 *
 * ATTENTION: when updating the plugins you need to insert at the top of the file:
 * 
 * define(['aloha/jquery'], function(jQuery) { 
 * 	var $ = jQuery;
 * 
 * and at the end of the file:
 * 
 * });
 *
 * see: README https://github.com/jrburke/require-jquery/ or
 * http://requirejs.org/docs/jquery.html
 *
 * others: depend.js from https://github.com/millermedeiros/requirejs-plugins
 *
 * todo: think about if using order plugin or priority config can help us here
 */
define(["aloha/jquery","util/class","i18n!browser/nls/i18n","aloha/console","browser/locale","css!browser/css/browsercombined.css","browser/vendor/jquery.ui","browser/vendor/ui-layout","browser/vendor/jquery.jqGrid","browser/vendor/jquery.jstree"],function(e,t,n,r){function o(e,t){return e.replace(/\{([a-z0-9\-\_]+)\}/ig,function(e,n,r,i){var s=t[n]||e;return typeof s=="function"?s():s})}function u(e){return typeof e=="string"?o(e,s):e}function a(t){t.each(function(){e(this).attr("unselectable","on").css({"-moz-user-select":"none","-webkit-user-select":"none","user-select":"none"}).each(function(){this.onselectstart=function(){return!1}})})}var i=+(new Date),s={tree:"aloha-browser-tree","tree-header":"aloha-browser-tree-header","grab-handle":"aloha-browser-grab-handle",shadow:"aloha-browser-shadow","rounded-top":"aloha-browser-rounded-top",list:"aloha-browser-list","list-altrow":"aloha-browser-list-altrow","list-resizable":"aloha-browser-list-resizable","list-pager":"aloha-browser-list-pager","list-btns":"aloha-browser-list-btns","search-btn":"aloha-browser-search-btn","search-field":"aloha-browser-search-field","search-icon":"aloha-browser-search-icon","close-btn":"aloha-browser-close-btn",btn:"aloha-browser-btn",btns:"aloha-browser-btns",grid:"aloha-browser-grid",clear:"aloha-browser-clear",inner:"aloha-browser-inner","modal-overlay":"aloha-browser-modal-overlay","modal-window":"aloha-browser-modal-window"},f=t.extend({_constructor:function(){this.init.apply(this,arguments)},init:function(t){var r=e.extend({verbose:!1,repositoryManager:null,repositoryFilter:[],objectTypeFilter:[],renditionFilter:["cmis:none"],filter:["url"],element:undefined,rootFolderId:"aloha",rootPath:"",treeWidth:300,listWidth:"auto",pageSize:10,columns:{icon:{title:"",width:30,sortable:!1,resizable:!1},name:{title:n.t("Name"),width:250,sorttype:"text"},url:{title:n.t("URL"),width:250,sorttype:"text"},preview:{title:n.t("Preview"),width:200,sorttype:"text"}},isFloating:!1},t||{});if(!r.element||!r.element.length)r.isFloating=!0,r.element=this.createOverlay();this._callbacks={},this._objs={},this._searchQuery=null,this._orderBy=null,this._pagingOffset=0,this._pagingCount=undefined,this._pagingBtns={first:null,end:null,next:null,prev:null},typeof r.implement=="object"&&(e.each(r.implement,function(e,t){s[e]=t}),delete r.implement),typeof r.callbacks=="object"&&(e.each(r.callbacks,function(){s.callback(this[0],this[1])}),delete r.callbacks),e.extend(this,r);var s=this,o=this.treeWidth,u=o/5;this.preloadImages(),this.element.attr("data-aloha-browser",++i).html(""),this.totalWidth&&this.element.width(this.totalWidth),this.grid=this.createGrid(this.element).resize(),this.tree=this.createTree(this.grid.find(".ui-layout-west")),this.list=this.createList(this.grid.find(".ui-layout-center")),this.grid.layout({west__size:o-1,west__minSize:o-u,west__maxSize:o+u,center__size:"auto",paneClass:"ui-layout-pane",resizerClass:"ui-layout-resizer",togglerClass:"ui-layout-toggler",onresize:function(e,t){e=="center"&&s.list.setGridWidth(t.width())}}).sizePane("west",o),a(this.grid),this.close()},destroy:function(){},instanceOf:"Aloha.Browser",grid:null,tree:null,list:null,preloadImages:function(){var t=this;e.each(["arrow-000-medium.png","arrow-180.png","arrow-315-medium.png","arrow-stop-180.png","arrow-stop.png","arrow.png","control-stop-square-small.png","folder-horizontal-open.png","folder-open.png","magnifier-left.png","page.png","picture.png","sort-alphabet-descending.png","sort-alphabet.png"],function(){(new Image).src=t.rootPath+"img/"+this})},trigger:function(e,t){var n=this._callbacks,r=n[e];if(typeof r=="object")for(var i=0,s=r.length;i<s;++i)typeof r[i]=="function"&&r[i].call(this,t)},callback:function(e,t){return typeof this[e]!="function"?(r.warn('Unable to add a callback to "'+e+'" because it is not a method in Aloha.Browser.'),this):typeof t!="function"?(r.warn('Unable to add a callback to "'+e+'" because '+'the callback object that was given is of type "'+typeof t+'". '+'The callback object needs to be of type "function".'),this):(this._callbacks[e]==undefined?this.enableCallbacks(e)&&(this._callbacks[e]=[t]):this._callbacks[e].push(t),this)},enableCallbacks:function(e){var t=this,n=this[e];return typeof n=="function"?(this[e]=function(){var r=n.apply(t,arguments);return t.trigger.call(t,e,r),r},!0):(r.warn('Cannot enable callbacks for function "'+e+'" because no such method was found in Aloha.Browser.'),!1)},getRepoChildren:function(e,t){var n=this;this.repositoryManager&&this.repositoryManager.getChildren(e,function(e){n.processRepoResponse(e,t)})},queryRepository:function(e,t){var n=this;this.repositoryManager&&this.repositoryManager.query(e,function(e){n.processRepoResponse(e.results>0?e.items:[],{numItems:e.numItems,hasMoreItems:e.hasMoreItems},t)})},processRepoResponse:function(t,n,r){var i=this,s=[];typeof n=="function"&&(r=n,n=undefined),e.each(t,function(){s.push(i.harvestRepoObject(this))}),typeof r=="function"&&r.call(this,s,n)},harvestRepoObject:function(t){++i;var n=this._objs[i]=e.extend(t,{uid:i,loaded:!1});return this.processRepoObject(n)},processRepoObject:function(e){var t="",n;switch(e.baseType){case"folder":t="folder";break;case"document":t="document"}return e.type&&(n={rel:e.type}),{data:{title:e.name,attr:{"data-rep-oobj":e.uid},icon:t},attr:n,state:e.hasMoreItems||e.baseType==="folder"?"closed":null,resource:e}},fetchRepoRoot:function(e){this.repositoryManager&&this.getRepoChildren({inFolderId:this.rootFolderId,repositoryFilter:this.repositoryFilter},function(t){typeof e=="function"&&e(t)})},renderRowCols:function(t){var n={};return e.each(this.columns,function(e,r){switch(e){case"icon":n.icon='<div class="aloha-browser-icon aloha-browser-icon-'+t.type+'"></div>';break;default:n[e]=t[e]||"--"}}),n},onSelect:function(e){},fetchChildren:function(e,t){var n=this;(e.hasMoreItems==1||e.baseType==="folder")&&e.loaded==0&&this.getRepoChildren({inFolderId:e.id,repositoryId:e.repositoryId},function(r){n._objs[e.uid].loaded=!0,typeof t=="function"&&t(r)})},getObjectFromCache:function(e){var t;if(typeof e=="object"){var n=e.find("a:first").attr("data-rep-oobj");t=this._objs[n]}return t},rowClicked:function(t){var n=e(t.target).parent("tr"),r=null;if(n.length>0){var i=n.attr("id");r=this._objs[i],this.onSelect(r)}return r},createTree:function(t){var n=this,r=e(u('<div class="{tree}">')),i=e(u('<div class="{tree-header} {grab-handle}">					Repository Browser				</div>'));return t.append(i,r),r.height(this.grid.height()-i.outerHeight(!0)).bind("loaded.jstree",function(t,n){e(">ul>li",this).first().css("padding-top",5),r.jstree("open_node","li[rel='repository']")}).bind("select_node.jstree",function(e,t){if(t.args[0].context)return;var r=t.rslt.obj,i=n.getObjectFromCache(r);typeof i=="object"&&(n._pagingOffset=0,n._searchQuery=null,n._currentFolder=i,n.fetchItems(i,n.processItems))}).jstree({types:n.types,rootFolderId:this.rootFolderId,plugins:["themes","json_data","ui","types"],core:{animation:250},themes:{theme:"browser",url:n.rootPath+"css/jstree.css",dots:!0,icons:!0},json_data:{data:function(e,t){if(window.GCN&&!window.GCN.sid)return;n.repositoryManager?(n.jstree_callback=t,n.fetchSubnodes.call(n,e,t)):t()},correct_state:!0},ui:{select_limit:1}}),r},createGrid:function(t){var n=e(u('<div class="{grid} {shadow} {rounded-top}"> 					<div class="ui-layout-west"></div>		 					<div class="ui-layout-center"></div>	 				</div>'));return t.append(n),n},createList:function(t){var n=this,r="aloha-browser-list-"+ ++i,s=e(u('<table id="'+r+'"				class="{list}"></table>')),o=[""],a=[{name:"id",sorttype:"int",firstsortorder:"asc",hidden:!0}];e.each(this.columns,function(e,t){o.push(t.title&&t.title?t.title:"&nbsp;"),a.push({name:e,width:t.width,sortable:t.sortable,sorttype:t.sorttype,resizable:t.resizable,fixed:t.fixed})});var f="aloha-browser-list-page-"+ ++i;t.append(s,e('<div id="'+f+'">')),s.jqGrid({datatype:"local",width:t.width(),shrinkToFit:!0,colNames:o,colModel:a,caption:"&nbsp;",altRows:!0,altclass:"aloha-browser-list-altrow",resizeclass:"aloha-browser-list-resizable",pager:"#"+f,viewrecords:!0,onPaging:function(e){},loadError:function(e,t,n){},ondblClickRow:function(e,t,n,r){},gridComplete:function(){},loadComplete:function(e){}}),t.find(".ui-jqgrid-bdiv").height(this.grid.height()-(t.find(".ui-jqgrid-titlebar").height()+t.find(".ui-jqgrid-hdiv").height()+t.find(".ui-jqgrid-pager").height())),s.click(function(){n.rowClicked.apply(n,arguments)}),t.find(".ui-pg-button").unbind().find(">span.ui-icon").each(function(){var t=this.className.match(/ui\-icon\-seek\-([a-z]+)/)[1];n._pagingBtns[t]=e(this).parent().addClass("ui-state-disabled").click(function(){e(this).hasClass("ui-state-disabled")||n.doPaging(t)})}),t.find(".ui-pg-input").parent().hide(),t.find(".ui-separator").parent().css("opacity",0).first().hide(),this.createTitlebar(t);var l=s[0].p;return t.find(".ui-jqgrid-view tr:first th div").each(function(t){l.colModel[t].sortable!==!1&&e(this).unbind().click(function(e){e.stopPropagation(),n.sortList(l.colModel[t],this)})}),s},createTitlebar:function(t){var r=this,i,s=t.find(".ui-jqgrid-titlebar"),o=e(u('<div class="{btns}">							 					<input type="text" class="{search-field}" /> 					<span class="{btn} {search-btn}">			 						<span class="{search-icon}"></span>		 					</span>										 					<span class="{btn} {close-btn}">Close</span> 					<div class="{clear}"></div>					 				</div>'));s.addClass("aloha-browser-grab-handle").append(o),s.find(".aloha-browser-search-btn").html(n.t("Search")).click(function(){r.triggerSearch()}),i=s.find(".aloha-browser-search-field").keypress(function(e){e.keyCode==13&&r.triggerSearch()});var a=n.t("Input search text...");i.val(a).addClass("aloha-browser-search-field-empty").focus(function(){e(this).val()==a&&e(this).val("").removeClass("aloha-browser-search-field-empty")}).blur(function(){e(this).val()==""&&e(this).val(a).addClass("aloha-browser-search-field-empty")}),s.find(".aloha-browser-close-btn").html(n.t("Close")).click(function(){r.close()}),s.find(".aloha-browser-btn").mousedown(function(){e(this).addClass("aloha-browser-pressed")}).mouseup(function(){e(this).removeClass("aloha-browser-pressed")})},triggerSearch:function(){var t=this.grid.find("input.aloha-browser-search-field"),n=t.val();e(t).css("font-style")=="italic"&&(n=""),this._pagingOffset=0,this._searchQuery=t.val(),this.fetchItems(this._currentFolder,this.processItems)},sortList:function(t,n){e("span.ui-grid-ico-sort").addClass("ui-state-disabled"),t.sortorder=t.sortorder=="asc"?"desc":"asc",e(n).find("span.s-ico").show().find(".ui-icon-"+t.sortorder).removeClass("ui-state-disabled"),this.setSortOrder(t.name,t.sortorder).fetchItems(this._currentFolder,this.processItems)},setSortOrder:function(e,t){var n={};n[e]=t||"asc";var r=this._orderBy||[],i,s,o=!1;for(var u=0,a=r.length;u<a;++u){s=r[u];for(i in s)if(i===e){r.splice(u,1),r.unshift(n),o=!0;break}if(o)break}return o||r.unshift(n),this._orderBy=r,this},getFieldOfHeader:function(e){return e.find("div.ui-jqgrid-sortable").attr("id").replace("jqgh_","")},doPaging:function(e){switch(e){case"first":this._pagingOffset=0;break;case"end":this._pagingCount%this.pageSize===0?this._pagingOffset=this._pagingCount-this.pageSize:this._pagingOffset=this._pagingCount-this._pagingCount%this.pageSize;break;case"next":this._pagingOffset+=this.pageSize;break;case"prev":this._pagingOffset-=this.pageSize}this.fetchItems(this._currentFolder,this.processItems)},fetchItems:function(e,t){if(!e)return;this.list.setCaption(typeof this._searchQuery=="string"?n.t("Searching for")+' "'+this._searchQuery+'" '+n.t("in")+" "+e.name:n.t("Browsing")+": "+e.name),this.list.hide(),this.grid.find(".loading").show();var r=this;this.queryRepository({repositoryId:e.repositoryId,inFolderId:e.id,queryString:this._searchQuery,orderBy:this._orderBy,skipCount:this._pagingOffset,maxItems:this.pageSize,objectTypeFilter:this.objectTypeFilter,renditionFilter:this.renditionFilter,filter:this.filter,recursive:!1},function(e,n){typeof t=="function"&&t.call(r,e,n)})},fetchSubnodes:function(e,t){if(e===-1)this.fetchRepoRoot(t);else{var n=this.getObjectFromCache(e);typeof n=="object"&&this.fetchChildren(n,t)}},listItems:function(t){var n=this,r=this.list.clearGridData();e.each(t,function(){var t=this.resource;r.addRowData(t.uid,e.extend({id:t.id},n.renderRowCols(t)))})},processItems:function(t,r){var i=this._pagingBtns,s="ui-state-disabled";r&&e.isNumeric(r.numItems)?this._pagingCount=r.numItems:this._pagingCount=undefined,this.grid.find(".loading").hide(),this.list.show(),this.listItems(t),this._pagingOffset<=0?i.first.add(i.prev).addClass(s):i.first.add(i.prev).removeClass(s),isNaN(this._pagingCount)?(i.end.addClass(s),t.length<this.pageSize?i.next.addClass(s):i.next.removeClass(s)):this._pagingOffset+this.pageSize>=this._pagingCount?i.end.add(i.next).addClass(s):i.end.add(i.next).removeClass(s);var o,u;t.length==0&&this._pagingOffset==0?(o=0,u=0):(o=this._pagingOffset+1,u=o+t.length-1),this.grid.find(".ui-paging-info").html(n.t("Viewing")+" "+o+" - "+u+" "+n.t("of")+" "+(e.isNumeric(this._pagingCount)?this._pagingCount:n.t("numerous")))},createOverlay:function(){var t=this;e(".aloha-browser-modal-overlay").length==0&&e("body").append(u('<div class="{modal-overlay}" style="top: -99999px; z-index: 99999;"></div>')),e(".aloha-browser-modal-overlay").click(function(){t.close()});var n=e(u('<div class="{modal-window}"  style="top: -99999px; z-index: 99999;"></div>'));return e("body").append(n),n},setObjectTypeFilter:function(e){this.objectTypeFilter=typeof e=="string"?[e]:e},getObjectTypeFilter:function(){return this.objectTypeFilter},show:function(){this.opened=!0;var t=this.element;if(this.isFloating){t.find(".aloha-browser-close-btn").show(),e(".aloha-browser-modal-overlay").css({top:0,left:0}).add(t).stop().show();var n=e(window);t.css({left:(n.width()-t.width())/2,top:(n.height()-t.height())/3}).draggable({handle:t.find(".aloha-browser-grab-handle")}).resizable(),this.grid.css({marginTop:30,opacity:0}).animate({marginTop:0,opacity:1},1500,"easeOutExpo",function(){e.browser.msie&&e(this).add(t).css("filter","progid:DXImageTransform.Microsoft.gradient(enabled = false)")})}else t.stop().show().css({opacity:1,filter:"progid:DXImageTransform.Microsoft.gradient(enabled = false)"}),t.find(".aloha-browser-close-btn").hide()},close:function(){this.opened=!0,this.element.fadeOut(250,function(){e(this).css("top",0).hide(),e(".aloha-browser-modal-overlay").hide()})},refresh:function(){this._currentFolder&&this.fetchItems(this._currentFolder,this.processItems)}});return f});