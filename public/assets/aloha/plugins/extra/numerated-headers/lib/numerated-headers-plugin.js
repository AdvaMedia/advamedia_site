/*!
* Aloha Editor
* Author & Copyright (c) 2010 Gentics Software GmbH
* aloha-sales@gentics.com
* Licensed unter the terms of http://www.aloha-editor.com/license.html
*/
define(["aloha/jquery","aloha/plugin","aloha/floatingmenu","i18n!numerated-headers/nls/i18n","i18n!aloha/nls/i18n","css!numerated-headers/css/numerated-headers.css"],function(e,t,n,r,i){var s=e,o=window.GENTICS,u=window.Aloha;return t.create("numerated-headers",{numeratedactive:!0,headingselector:"h1, h2, h3, h4, h5, h6",init:function(){var e=this;typeof this.settings.numeratedactive!="undefined"&&(this.numeratedactive=this.settings.numeratedactive),typeof this.settings.headingselector!="undefined"&&(this.headingselector=this.settings.headingselector),typeof this.settings.baseobjectSelector!="undefined"&&(this.baseobjectSelector=this.settings.baseobjectSelector),this.numeratedHeadersButton=new u.ui.Button({iconClass:"aloha-button aloha-button-numerated-headers",size:"small",onclick:function(){e.numeratedHeadersButton.isPressed()?e.removeNumerations():e.createNumeratedHeaders()},tooltip:r.t("button.numeratedHeaders.tooltip"),toggle:!0,pressed:this.numeratedactive}),n.addButton("Aloha.continuoustext",this.numeratedHeadersButton,i.t("floatingmenu.tab.format"),1),u.bind("aloha-selection-changed",function(t){e.numeratedHeadersButton.isPressed()&&e.createNumeratedHeaders()})},removeNumerations:function(){var t=this.getBaseElement();if(!t)return;var n=t.find(this.headingselector);n.each(function(){e(this).find("span[role=annotation]").each(function(){e(this).remove()})})},getBaseElement:function(){return typeof this.baseobjectSelector!="undefined"?e(this.baseobjectSelector).length>0?e(this.baseobjectSelector):!1:typeof u.activeEditable=="undefined"||u.activeEditable==null?!1:u.activeEditable.obj},hasNote:function(t){return!t||!e(t).length>0?!1:(t=e(t),t.find("span[role=annotation]").length>0?!0:!1)},hasContent:function(t){if(!t||!e(t).length>0)return!1;t=e(t);var n=t.clone().find("span[role=annotation]").remove().end();return n.text().trim().length>0?!0:!1},createNumeratedHeaders:function(){var t=this.getBaseElement();if(!t)return;var n=this,r=t.find(this.headingselector);if(typeof r=="undefined"||r.length==0)return;var i=parseInt(r[0].nodeName.substr(1)),s=null,o=[],u=0;for(var a=0;a<6-i+1;a++)o[a]=0;r.each(function(){if(n.hasContent(this)){var t=parseInt(this.nodeName.substr(1));if(s==null)o[u]++;else if(t>s)o[++u]++;else if(t==s)o[u]++;else if(t<s){var r=t-i;for(var a=u;a>r;a--)o[a]=0;u=r,o[u]++}s=t;var f=o[0];for(var l=1;l<o.length;l++)o[l]!=0&&(f+="."+o[l]);n.hasNote(this)?e(this).find("span[role=annotation]").html(f):e(this).prepend("<span role='annotation'>"+f+"</span> ")}else n.hasNote(this)&&e(this).find("span[role=annotation]").remove()})}})});