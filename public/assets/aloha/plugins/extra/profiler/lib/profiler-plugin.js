/*!
 * Aloha Editor
 * Author & Copyright (c) 2011 Gentics Software GmbH
 * aloha-sales@gentics.com
 * Licensed unter the terms of http://www.aloha-editor.com/license.html
 *
 * Aloha Profiler
 * --------------
 * Provides a useful interface to profile some of Aloha components and their
 * methods.
 *
 * Potentially process intensive methods:
 *		Aloha.Profiler.profileAlohaComponent('Markup.preProcessKeyStrokes')
 *		Aloha.Profiler.profileAlohaComponent('Selection._updateSelection')
 */
window.define(["aloha/core","aloha/plugin","aloha/editable","aloha/selection","aloha/markup","aloha/contenthandlermanager","aloha/floatingmenu","aloha/console","css!profiler/css/profiler"],function(Aloha,Plugin,Editable,Selection,Markup,ContentHandlerManager,FloatingMenu,console){function resolvePath(e,t){if(typeof e!="string")return e;if(!t||typeof t!="object")t=window;var n=e.split("."),r=0,i=n.length;for(;r<i;++r){t=t[n[r]];if(typeof t=="undefined")return console.error("Aloha.Profiler",'Property "'+n[r]+'" does not exist'+(r?" in object "+n.slice(0,r).join("."):"")),null}return t}function parseObjectPath(e,t){if(typeof e!="string")return null;var n=e.split("."),r=n.slice(0,Math.max(1,n.length-1)).join("."),i;t=resolvePath(r,t);if(!t)return null;if(n.length>1){var s=n[n.length-1];typeof t[s]=="undefined"?console.error("Aloha.Profiler",'Property "'+s+'" does not exist in object '+r):i=s}return{obj:t[i],path:e,parentObj:t,propName:i}}function initSidebarPanel(sidebar){sidebar.addPanel({id:"aloha-devtool-profiler-panel",title:"Aloha Profiler",expanded:!0,activeOn:!0,content:'<div id="aloha-devtool-profiler-container"><input id="aloha-devtool-profiler-input" value="Aloha.Profiler.profileAlohaComponent(\'Markup.preProcessKeyStrokes\')" /><ul id="aloha-devtool-profiler-console"></ul></div>',onInit:function(){this.content.find("input#aloha-devtool-profiler-input").keydown(function(event){if(event.keyCode===13){var input=jQuery(this),value=input.val();value&&(eval(value),PanelConsole.log(value),input.val(""))}})}}),sidebar.show().open()}var jQuery=Aloha.jQuery,profiledFunctions=[],argsStr=/function[^\(]*\(([^\)]+)/g.exec(arguments.callee.toString()),argNames=argsStr?argsStr[1].replace(/^\s+|\s+$/g,"").split(/\,\s*/):[],args=Array.prototype.slice.call(arguments),panel,PanelConsole={log:function(){jQuery("#aloha-devtool-profiler-console").prepend("<li>"+Array.prototype.slice.call(arguments).join(" ")+"</li>")}};return Aloha.Profiler=Plugin.create("profiler",{loadedDependencies:Array.prototype.slice.call(arguments),alohaComponents:{},panel:null,init:function(){var e=argNames.length;while(--e>=0)this.alohaComponents[argNames[e]]=args[e];var t=this;Aloha.ready(function(){Aloha.Sidebar&&Aloha.Sidebar.right&&(t.panel=initSidebarPanel(Aloha.Sidebar.right))})},log:function(){PanelConsole.log.apply(PanelConsole,arguments)},profileAlohaComponent:function(e,t){var n=parseObjectPath(e,this.alohaComponents);return this.profile(n.parentObj,t||n.propName)},profile:function(e,t,n){var r,i,s=-1,o;typeof e=="string"&&(i=parseObjectPath(e),e=i.parentObj,r=i.path+(t?"."+t:""),i.propName&&(typeof i.obj=="function"?t=i.propName:i.obj==="object"&&(e=i.obj)));if(!e||!t||typeof e[t]!="function")return;for(o=0;o<profiledFunctions.length;++o)if(profiledFunctions[o]===e){s=o;if(profiledFunctions[o][t])return}var u=e[t],a=this;window.console&&window.console.log&&(s===-1&&(s=profiledFunctions.push(e)-1),profiledFunctions[s][t]=u,e[t]=function(){typeof n=="function"&&n(u,arguments);var i=+(new Date),s=u.apply(e,arguments);return a.log((r||t)+": "+(new Date-i)+"ms"),s})},toString:function(){return"Aloha.Profiler"}}),Aloha.Profiler});