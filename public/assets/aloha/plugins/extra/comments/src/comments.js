/*!
* Aloha Editor
* Author & Copyright (c) 2010 Gentics Software GmbH
* aloha-sales@gentics.com
* Licensed unter the terms of http://www.aloha-editor.com/license.html
*/
// TODO: SHIFT + ENTER => submit comment  |
(function(e,t){var n=e.alohaQuery||e.jQuery,r=n,i=e.GENTICS,s=e.Aloha;r.extend(r.easing,{easeOutExpo:function(e,t,n,r,i){return t==i?n+r:r*(-Math.pow(2,-10*t/i)+1)+n},easeOutElastic:function(e,t,n,r,i){var s=1.70158,o=0,u=r;if(t==0)return n;if((t/=i)==1)return n+r;o||(o=i*.3);if(u<Math.abs(r)){u=r;var s=o/4}else var s=o/(2*Math.PI)*Math.asin(r/u);return u*Math.pow(2,-10*t)*Math.sin((t*i-s)*2*Math.PI/o)+r+n}});var o=i.Utils.Dom,u="aloha-comments",a=+(new Date),f=r('<div class="'+u+'-addbox">'+'<div class="'+u+'-content">'+"<h2>Comment:</h2>"+'<input class="'+u+'-user" value="" />'+'<div class="'+u+'-user-err-msg"></div>'+"<textarea></textarea>"+'<div class="'+u+'-text-err-msg"></div>'+'<ul class="'+u+'-colors"></ul>'+'<button class="'+u+"-cancel "+u+'-btn">Cancel</button>'+'<button class="'+u+"-submit "+u+'-btn">Comment</button>'+'<div class="'+u+'-clear"></div>'+"</div>"+'<div class="'+u+'-arrow">'+'<div class="'+u+'-arrow-inner"></div>'+"</div>"+"</div>"),l=r('<div class="'+u+'-viewbox">'+'<div class="'+u+'-content">'+"<h2>Comment:</h2>"+"<textarea></textarea>"+'<ul class="'+u+'-colors"></ul>'+'<button class="'+u+'-submit">Submit</button>'+'<div class="'+u+'-clear"></div>'+"</div>"+'<div class="'+u+'-arrow">'+'<div class="'+u+'-arrow-inner"></div>'+"</div>"+"</div>"),c,h={};s.Comments=new(s.Plugin.extend({user:null,comments:{},colors:{"Golden Yellow":"#fc0","Blood Red":"#c33","Sky Blue":"#9cf","Grass Green":"#9c0"},isModalOpen:!1,isRevealing:!1,bar:null,isBarOpen:!1,_constructor:function(){this._super("comments")},init:function(){var e=this,t=f.find("."+u+"-colors");r("body").append(f).mousedown(function(){e.bodyClicked.apply(e,arguments)}).mouseup(function(){}),r.each(this.colors,function(n,i){t.append(r('<li title="'+n+'" style="background-color:'+i+'"></li>').click(function(){e.setColor(n)}))}),f.find("."+u+"-submit").click(function(){e.submit()}),f.find("."+u+"-cancel").click(function(){e.cancelAdd()}),this.preloadImages(),this.initBtns(),this.createBar()},initBtns:function(){var e=this,t=new s.ui.Button({iconClass:"aloha-button aloha-comments-toolbar-btn aloha-comments-btn-add",onclick:function(){e.isModalOpen||e.addComment.apply(e,arguments)},tooltip:"Add comments to the selected range"}),n=new s.ui.Button({iconClass:"aloha-button aloha-comments-toolbar-btn aloha-comments-btn-reveal",onclick:function(){!e.isModalOpen&&!e.isBarOpen&&e.revealComments.apply(e,arguments)},tooltip:"Show all comments on document"});s.FloatingMenu.addButton("Aloha.continuoustext",t,"Comments",1),s.FloatingMenu.addButton("Aloha.continuoustext",n,"Comments",1)},cancelAdd:function(){this.closeModal(),this.removeHighlight()},createBar:function(){var t=this,n=this.bar=r('<div class="'+u+'-bar">'+'<div class="'+u+'-bar-shadow"></div>'+'<div class="'+u+'-bar-toggle">'+'<div class="'+u+'-bar-toggle-img"></div>'+"</div>"+'<div class="'+u+'-bar-inner">'+"<h2>"+"Comments:"+"</h2>"+"<ul></ul>"+'<div class="'+u+'-bar-bottom">'+"</div>"+"</div>"+"</div>").click(function(){t.barClicked.apply(t,arguments)});r("body").append(n),r(e).resize(function(){t.setBarScrolling()}),this.bar.find("."+u+"-bar-toggle").click(function(){t.isBarOpen?(r(this).removeClass(u+"-bar-toggle-opened"),t.closeBar()):(r(this).addClass(u+"-bar-toggle-opened"),t.showBar())}),this.setBarScrolling()},barClicked:function(e){var t=r(e.target),n=t;!t[0].tagName!="LI"&&(n=n.parents("li")),n.length>0&&this.insertReplyTools(n.first())},getGravatar:function(e,t){var n=function(e){function t(e,t){return e<<t|e>>>32-t}function n(e,t){var n,r,i,s,o;return i=e&2147483648,s=t&2147483648,n=e&1073741824,r=t&1073741824,o=(e&1073741823)+(t&1073741823),n&r?o^2147483648^i^s:n|r?o&1073741824?o^3221225472^i^s:o^1073741824^i^s:o^i^s}function r(e,t,n){return e&t|~e&n}function i(e,t,n){return e&n|t&~n}function s(e,t,n){return e^t^n}function o(e,t,n){return t^(e|~n)}function u(e,i,s,o,u,a,f){return e=n(e,n(n(r(i,s,o),u),f)),n(t(e,a),i)}function a(e,r,s,o,u,a,f){return e=n(e,n(n(i(r,s,o),u),f)),n(t(e,a),r)}function f(e,r,i,o,u,a,f){return e=n(e,n(n(s(r,i,o),u),f)),n(t(e,a),r)}function l(e,r,i,s,u,a,f){return e=n(e,n(n(o(r,i,s),u),f)),n(t(e,a),r)}function c(e){var t,n=e.length,r=n+8,i=(r-r%64)/64,s=(i+1)*16,o=Array(s-1),u=0,a=0;while(a<n)t=(a-a%4)/4,u=a%4*8,o[t]=o[t]|e.charCodeAt(a)<<u,a++;return t=(a-a%4)/4,u=a%4*8,o[t]=o[t]|128<<u,o[s-2]=n<<3,o[s-1]=n>>>29,o}function h(e){var t="",n="",r,i;for(i=0;i<=3;i++)r=e>>>i*8&255,n="0"+r.toString(16),t+=n.substr(n.length-2,2);return t}function p(e){e=e.replace(/\r\n/g,"\n");var t="";for(var n=0;n<e.length;n++){var r=e.charCodeAt(n);r<128?t+=String.fromCharCode(r):r>127&&r<2048?(t+=String.fromCharCode(r>>6|192),t+=String.fromCharCode(r&63|128)):(t+=String.fromCharCode(r>>12|224),t+=String.fromCharCode(r>>6&63|128),t+=String.fromCharCode(r&63|128))}return t}var d=Array(),v,m,g,y,b,w,E,S,x,T=7,N=12,C=17,k=22,L=5,A=9,O=14,M=20,_=4,D=11,P=16,H=23,B=6,j=10,F=15,I=21;e=p(e),d=c(e),w=1732584193,E=4023233417,S=2562383102,x=271733878;for(v=0;v<d.length;v+=16)m=w,g=E,y=S,b=x,w=u(w,E,S,x,d[v+0],T,3614090360),x=u(x,w,E,S,d[v+1],N,3905402710),S=u(S,x,w,E,d[v+2],C,606105819),E=u(E,S,x,w,d[v+3],k,3250441966),w=u(w,E,S,x,d[v+4],T,4118548399),x=u(x,w,E,S,d[v+5],N,1200080426),S=u(S,x,w,E,d[v+6],C,2821735955),E=u(E,S,x,w,d[v+7],k,4249261313),w=u(w,E,S,x,d[v+8],T,1770035416),x=u(x,w,E,S,d[v+9],N,2336552879),S=u(S,x,w,E,d[v+10],C,4294925233),E=u(E,S,x,w,d[v+11],k,2304563134),w=u(w,E,S,x,d[v+12],T,1804603682),x=u(x,w,E,S,d[v+13],N,4254626195),S=u(S,x,w,E,d[v+14],C,2792965006),E=u(E,S,x,w,d[v+15],k,1236535329),w=a(w,E,S,x,d[v+1],L,4129170786),x=a(x,w,E,S,d[v+6],A,3225465664),S=a(S,x,w,E,d[v+11],O,643717713),E=a(E,S,x,w,d[v+0],M,3921069994),w=a(w,E,S,x,d[v+5],L,3593408605),x=a(x,w,E,S,d[v+10],A,38016083),S=a(S,x,w,E,d[v+15],O,3634488961),E=a(E,S,x,w,d[v+4],M,3889429448),w=a(w,E,S,x,d[v+9],L,568446438),x=a(x,w,E,S,d[v+14],A,3275163606),S=a(S,x,w,E,d[v+3],O,4107603335),E=a(E,S,x,w,d[v+8],M,1163531501),w=a(w,E,S,x,d[v+13],L,2850285829),x=a(x,w,E,S,d[v+2],A,4243563512),S=a(S,x,w,E,d[v+7],O,1735328473),E=a(E,S,x,w,d[v+12],M,2368359562),w=f(w,E,S,x,d[v+5],_,4294588738),x=f(x,w,E,S,d[v+8],D,2272392833),S=f(S,x,w,E,d[v+11],P,1839030562),E=f(E,S,x,w,d[v+14],H,4259657740),w=f(w,E,S,x,d[v+1],_,2763975236),x=f(x,w,E,S,d[v+4],D,1272893353),S=f(S,x,w,E,d[v+7],P,4139469664),E=f(E,S,x,w,d[v+10],H,3200236656),w=f(w,E,S,x,d[v+13],_,681279174),x=f(x,w,E,S,d[v+0],D,3936430074),S=f(S,x,w,E,d[v+3],P,3572445317),E=f(E,S,x,w,d[v+6],H,76029189),w=f(w,E,S,x,d[v+9],_,3654602809),x=f(x,w,E,S,d[v+12],D,3873151461),S=f(S,x,w,E,d[v+15],P,530742520),E=f(E,S,x,w,d[v+2],H,3299628645),w=l(w,E,S,x,d[v+0],B,4096336452),x=l(x,w,E,S,d[v+7],j,1126891415),S=l(S,x,w,E,d[v+14],F,2878612391),E=l(E,S,x,w,d[v+5],I,4237533241),w=l(w,E,S,x,d[v+12],B,1700485571),x=l(x,w,E,S,d[v+3],j,2399980690),S=l(S,x,w,E,d[v+10],F,4293915773),E=l(E,S,x,w,d[v+1],I,2240044497),w=l(w,E,S,x,d[v+8],B,1873313359),x=l(x,w,E,S,d[v+15],j,4264355552),S=l(S,x,w,E,d[v+6],F,2734768916),E=l(E,S,x,w,d[v+13],I,1309151649),w=l(w,E,S,x,d[v+4],B,4149444226),x=l(x,w,E,S,d[v+11],j,3174756917),S=l(S,x,w,E,d[v+2],F,718787259),E=l(E,S,x,w,d[v+9],I,3951481745),w=n(w,m),E=n(E,g),S=n(S,y),x=n(x,b);var q=h(w)+h(E)+h(S)+h(x);return q.toLowerCase()},t=t||80;return"http://www.gravatar.com/avatar/"+n(e)+".jpg?s="+t},addComment:function(){var e=this,t=s.Selection.getRangeObject(),n=u+"-"+ ++a,i=[u+"-wrapper",n],f=r('<div class="'+i.join(" ")+'">');o.addMarkup(t,f);if(r("."+n).length==0)return;o.doCleanup({merge:!0,removeempty:!0},t);var l=c=this.comments[n]={id:n,timestamp:null,email:null,comment:null,mom:null,kids:[],color:this.colors["Golden Yellow"],elements:r("."+n),commonAncestor:r(t.getCommonAncestorContainer())};h[n]=this.comments[n],this.highlight(l),this.openModal(l),r(".aloha-floatingmenu").hide(),l.elements.click(function(){e.commentClicked(l)}).hover(function(){e.hover(l,!0)},function(){e.hover(l,!1)})},revealComments:function(){this.isRevealing?r("."+u+"-active").removeClass(u+"-active").css("background-color",""):r.each(this.comments,function(e,t){t.elements.addClass(u+"-active").css("background-color",t.color)}),this.isRevealing=!this.isRevealing},openModal:function(e){var t=this,n=e.elements.first(),i=n.offset();f.show().css("height","auto").find("input").val(this.user);var s,o=f.find("."+u+"-content"),a=f.find("input."+u+"-user").removeClass(u+"-error"),l=f.find("textarea").removeClass(u+"-error").val(""),c=o.height(),h=30,p=i.top-(f.outerHeight(!0)+h);p<=0?(s=i.top-h,n=e.elements.last(),i=n.last().offset(),p=i.top+n.height()+h,f.addClass(u+"-point-from-bottom")):(f.removeClass(u+"-point-from-bottom"),s=p-h),f.css({left:i.left+n.width()/2-f.outerWidth(!0)/2,top:p,marginTop:c,opacity:0}).animate({marginTop:0,opacity:1},800,"easeOutElastic"),r("body").animate({scrollTop:s},1e3,"easeOutExpo"),this.user==""||!this.user?a.select():(a.val(this.user),l.focus()),o.css("height",0).animate({height:c},800,"easeOutElastic"),this.isModalOpen=!0},closeModal:function(){r(".aloha-floatingmenu").show(),f.fadeOut(250),this.isModalOpen=!1},highlight:function(e){e.elements.css("background-color",e.color).addClass(u+"-active").parents().addClass(u+"-ancestor").siblings(":not(."+u+"-addbox,"+"."+u+"-ancestor,"+"."+u+"-bar,"+".aloha-floatingmenu"+")").addClass(u+"-grayed"),this.highlightElement(e.commonAncestor),r("."+u+"-grayed").animate({opacity:.25},250),r("."+u+"-cleanme").each(function(){o.isEmpty(this)&&r(this).remove()})},highlightElement:function(e){var t=this;return e.contents().each(function(){var e=this.nodeType==3?r(this).wrap('<span class="'+u+'-cleanme">').parent():r(this);e.hasClass(u+"-ancestor")?t.highlightElement(e):e.hasClass(u+"-active")||e.addClass(u+"-grayed")}),e},removeHighlight:function(){r("."+u+"-grayed").removeClass(u+"-grayed").css("opacity",""),r("."+u+"-active").removeClass(u+"-active").css("background-color",""),r("."+u+"-ancestor").removeClass(u+"-ancestor"),typeof c=="object"&&(c.elements.css("background-color",""),c=t)},hover:function(e,t){var n=e.elements;n.hasClass(u+"-active")||(t?n.addClass(u+"-hover").css("background-color",e.color):n.removeClass(u+"-hover").css("background-color",""))},commentClicked:function(e){this.showBar(e)},showBar:function(e){var t=this,n=this.bar.find("ul:first").html("");this.bar.animate({width:300},250,"easeOutExpo"),r("body").animate({marginLeft:300},250,"easeOutExpo"),e?(this.highlight(e),this.printThread(n,e)):r.each(this.comments,function(){t.printThread(n,this)}),this.isBarOpen=!0,this.setBarScrolling()},setBarScrolling:function(){var t=this.bar.find("."+u+"-bar-bottom").position();this.bar.find("."+u+"-bar-inner").css({height:r(e).height(),"overflow-y":t.top>this.bar.height()?"scroll":"auto"}),this.bar.find("."+u+"-bar-shadow").css("height",this.bar.height())},closeBar:function(){this.bar.animate({width:0},250,"easeOutExpo"),r("body").animate({marginLeft:0},250,"easeOutExpo"),this.removeHighlight(),this.isBarOpen=!1},printThread:function(e,t){var n=this,i=r('<li data-aloha-comment="'+t.id+'">'+'<div class="'+u+'-bar-comment">'+'<img src="'+n.getGravatar(t.email,40)+'" alt="" />'+'<div style="float:left;">'+"<span>"+t.email+" says:</span>"+"<div>"+t.comment+"</div>"+"</div>"+'<div class="'+u+'-clear"></div>'+"</div>"+"</li>");e.append(i),r.each(t.kids,function(){var e=r("<ul>");i.append(e),n.printThread(e,this)})},insertReplyTools:function(e){var t=this,n=e.addClass(u+"-bar-comment-active").find(".aloha-comments-bar-comment>."+u+"-bar-reply");if(n.length==0){n=r('<div class="'+u+'-bar-reply">'+'<input value="'+this.user+'" />'+"<textarea>Replying...</textarea>"+"<button>Reply</button>"+"</div>"),e.find(">div").append(n),e.find("button").click(function(){t.submitReply.call(t,n)});var i=n.css("height","auto").height();n.css("height",0).animate({height:i},250,"easeOutExpo"),n.find("input, textarea").css("width",n.width()-12),n.find("input").select(),this.bar.scrollTop(n.offset().top)}},submitReply:function(e){var t=this,n=e.parents("li").first(),i=n.attr("data-aloha-comment"),s=h[i];if(typeof s=="object"){var o=u+"-"+ ++a,f=e.find("input").val().trim(),l=e.find("textarea").val().trim().replace(/[\r\n]/g,"<br />"),c=s.kids.push({id:o,timestamp:(new Date).getTime(),email:f,comment:l,kids:[],mom:s.id,color:s.color,elements:s.elements,commonAncestor:s.elements});h[o]=s.kids[c-1],e.animate({height:0},250,"easeOutExpo",function(){r(this).remove();var e=r("<ul>");n.append(e),t.printThread(e,h[o])}),this.user=f}},setColor:function(e){c.color=this.colors[e],c.elements.css("background-color",c.color),f.find("textarea").focus()},submit:function(){var e=f.find("textarea"),t=f.find("."+u+"-user"),n=t.val().trim(),i=e.val().trim(),s=!1,o=u+"-error";n==""?(t.focus().addClass(o),s=!0):t.removeClass(o),i==""?(e.focus().addClass(o),s=!0):e.removeClass(o),i=i.replace(/[\r\n]/g,"<br />"),s||(r.extend(c,{email:n,comment:i,timestamp:(new Date).getTime()}),this.insertComment(c),this.closeModal(),this.showBar(c),e.val(""),t.val("")),this.user=n},insertComment:function(e){h[e.id]=this.comments[e.id]=e},bodyClicked:function(e){var t=r(e.target);this.isModalOpen&&!t.hasClass(u+"-addbox")&&t.parents("."+u+"-addbox").length==0&&(this.closeModal(),this.removeHighlight()),this.isModalOpen||t.hasClass(u+"-bar")||t.parents("."+u+"-bar").length==0&&this.removeHighlight()},preloadImages:function(){r.each(["hr.png","textbox.png"],function(){(new Image).src="../../plugin/comments/img/"+this})}}))})(window);