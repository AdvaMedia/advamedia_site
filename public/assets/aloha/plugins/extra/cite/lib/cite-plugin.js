/*!
* Aloha Editor
* Author & Copyright (c) 2010 Gentics Software GmbH
* aloha-sales@gentics.com
* Licensed unter the terms of http://www.aloha-editor.com/license.html
*/
define(["aloha","aloha/jquery","aloha/plugin","aloha/floatingmenu","format/format-plugin","util/dom","i18n!cite/nls/i18n","i18n!aloha/nls/i18n"],function(t,n,r,i,s,o,u,a){function v(e,t){return e.replace(/\{([a-z0-9\-\_]+)\}/ig,function(e,n,r,i){var s=t[n]||e;return typeof s=="function"?s():s})}function m(e){return typeof e=="string"?v(e,d):e}function g(){var e=[],t=c;return l.each(arguments,function(){e.push("."+(this==""?t:t+"-"+this))}),l.trim(e.join(" "))}function y(){var e=[],t=c;return l.each(arguments,function(){e.push(this==""?t:t+"-"+this)}),l.trim(e.join(" "))}function b(e){var e=e.replace("#","").split("");e.length==3&&(e[5]=e[4]=e[2],e[3]=e[2]=e[1],e[1]=e[0]);var t=[];for(var n=0;n<3;++n)t[n]=parseInt("0x"+e[n*2]+e[n*2+1],16);return t}t.require(["css!cite/css/cite.css"]);var f=window.GENTICS,l=n,c="aloha-cite",h=+(new Date),p=!1,d={quote:y("quote"),blockquote:y("blockquote"),"panel-label":y("panel-label"),"panel-field":y("panel-field"),"panel-btns":y("panel-btns"),"link-field":y("link-field"),"note-field":y("note-field"),references:y("references")};return r.create("cite",{citations:[],referenceContainer:null,settings:null,init:function(){var e=this;if(t.settings&&t.settings.plugins&&t.settings.plugins.cite){var n=l(t.settings.plugins.cite.referenceContainer);n.length>0&&(this.referenceContainer=n),typeof t.settings.plugins.cite!="undefinded"&&(e.settings=t.settings.plugins.cite),typeof e.settings.sidebar=="undefinded"&&(e.settings.sidebar={}),typeof e.settings.sidebar.open=="undefinded"&&(e.settings.sidebar.open=!0)}this.buttons=[],this.buttons[0]=new t.ui.Button({name:"quote",text:"Quote",tooltip:u.t("cite.button.add.quote"),iconClass:y("button","inline-button"),size:"small",toggle:!0,onclick:function(){e.addInlineQuote()}}),i.addButton("Aloha.continuoustext",this.buttons[0],a.t("floatingmenu.tab.format"),1),s.multiSplitButton.items.push({name:"blockquote",text:"Blockquote",tooltip:u.t("cite.button.add.blockquote"),iconClass:y("button","block-button"),click:function(){e.addBlockQuote()}}),this.sidebar=null;var r=this;t.ready(function(n){r.sidebar=t.Sidebar.right.show(),r.sidebar.addPanel({id:y("sidebar-panel"),title:"Citation",content:"",expanded:!0,activeOn:".aloha-cite-wrapper",onInit:function(){var e=this,t=this.setContent(m('<div class="{panel-label}">Link:</div>								<div class="{panel-field} {link-field}" style="margin: 5px;"><input type="text" /></div>'+(r.referenceContainer?'<div class="{panel-label}">Note:</div>									   <div class="{panel-field} {note-field}" style="margin: 5px;"><textarea></textarea></div>':""))).content;t.find("input, textarea").bind("keypress change",function(){var t=e.content;r.addCiteDetails(t.attr("data-cite-id"),t.find(g("link-field input")).val(),t.find(g("note-field textarea")).val())})},onActivate:function(t){var n=t.attr("data-cite-id"),r=e.getIndexOfCitation(n),i=this.content;r==-1&&(r=e.citations.push({uid:n,link:null,notes:null})-1),i.attr("data-cite-id",n),i.find(g("link-field input")).val(t.attr("cite")),i.find(g("note-field textarea")).val(e.citations[r].note)}})}),t.bind("aloha-selection-changed",function(t,n){s.multiSplitButton.showItem("blockquote");var r=l("button"+g("button"));l.each(e.buttons,function(t,i){var s=!1,o,u=n.markupEffectiveAtStart,a=u.length;while(a--){o=u[a].tagName.toLowerCase();if("q"==o||"blockquote"==o){s=!0;break}}r.filter(g("block-button")).removeClass(y("pressed")),e.buttons[0].setPressed(!1);if(s)return o=="q"?e.buttons[0].setPressed(!0):r.filter(g("block-button")).addClass(y("pressed")),!1})})},getIndexOfCitation:function(e){var t=this.citations,n=t.length,r=0,i,s;while(r<n){i=r+n>>1;if((s=t[i].uid)==e)return i;s>e?n=i:s<e&&(r=i+1)}return-1},addBlockQuote:function(){var e=this,r=[y("wrapper"),y(++h)].join(" "),i=l(v('<blockquote class="{classes}" data-cite-id="{uid}"></blockquote>',{uid:h,classes:r}));t.activeEditable&&n(t.activeEditable.obj[0]).click(),t.Selection.changeMarkupOnSelection(i),this.referenceContainer&&this.addCiteToReferences(h),this.sidebar&&e.settings.sidebar.open===!0&&this.sidebar.open()},addInlineQuote:function(){var e=[y("wrapper"),y(++h)].join(" "),r=l(v('<q class="{classes}" data-cite-id="{uid}"></q>',{uid:h,classes:e})),i=t.Selection.rangeObject,s,u=this;return t.activeEditable&&n(t.activeEditable.obj[0]).click(),s=i.findMarkup(function(){return this.nodeName&&r.get(0)&&typeof this.nodeName=="string"&&typeof r.get(0).nodeName=="string"?this.nodeName.toLowerCase()==r.get(0).nodeName.toLowerCase():!1},t.activeEditable.obj),s?i.isCollapsed()?o.removeFromDOM(s,i,!0):o.removeMarkup(i,r,t.activeEditable.obj):(i.isCollapsed()&&o.extendToWord(i),o.addMarkup(i,r)),i.select(),this.referenceContainer&&this.addCiteToReferences(h),this.sidebar&&u.settings.sidebar.open===!0&&this.sidebar.open(),!1},addCiteToReferences:function(e){var t=this.getIndexOfCitation(e);if(t==-1)return;var n=l(".aloha-editable-active "+g(e)),r="cite-note-"+e,i="cite-ref-"+e;n.append(v('<sup id="{ref}" contenteditable="false"><a href="#{note}">[{count}]</a></sup>',{ref:i,note:r,count:t+1})),this.referenceContainer.find("ol.references").length==0&&this.referenceContainer.append("<h2>References</h2>").append('<ol class="references"></ol>'),this.referenceContainer.find("ol.references").append(v('<li id="{note}"><a href="#{ref}">^</a> &nbsp; <span></span></li>',{ref:i,note:r}))},addCiteDetails:function(e,t,n){this.citations[this.getIndexOfCitation(e)]={uid:e,link:t,note:n};if(t){var r=l(g(e)).attr("cite",t),i=Math.round,s=b("#fdff9a"),o=b("#fdff9a");s.push(1),o.push(0);var u=[o[0]-s[0],o[1]-s[1],o[2]-s[2],o[3]-s[3]];r.css({__tick:0,"background-color":"rgba("+s.join(",")+")","box-shadow":"0 0 20px rgba("+s.join(",")+")"}),p||(p=!0,r.animate({__tick:1},{duration:500,easing:"linear",step:function(e,t){var n=[i(s[0]+u[0]*e),i(s[1]+u[1]*e),i(s[2]+u[2]*e),s[3]+u[3]*e];l(this).css({"background-color":"rgba("+n.join(",")+")","box-shadow":"0 0 "+20*(1-e)+"px rgba("+s.join(",")+")"})},complete:function(){p=!1}}))}this.referenceContainer&&l("li#cite-note-"+e+" span").html(v(t?'<a class="external" target="_blank" href="{url}">{url}</a>':"",{url:t})+(n?". "+n:""))},toString:function(){return"aloha-citiation-plugin"}})});