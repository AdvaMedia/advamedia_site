/*!
* Aloha Editor
* Author & Copyright (c) 2010 Gentics Software GmbH
* aloha-sales@gentics.com
* Licensed unter the terms of http://www.aloha-editor.com/license.html
*/
define(["aloha","aloha/plugin","aloha/jquery","aloha/floatingmenu","i18n!toc/nls/i18n","i18n!aloha/nls/i18n","aloha/console"],function(a,b,c,d,e,f,g){function l(a){return a[a.length-1]}function m(a){return a[0]}function n(a){return a.slice(1)}function o(a,b){return p(a,function(a){return a===b})}function p(a,b){for(var c=0;c<a.length;c++)if(b(a[c]))return a[c];return null}function q(a,b){var c=[];for(var d=0;d<a.length;d++)c.push(b(a[d]));return c}function r(a,b){q(a,b)}function s(){return c(q(a.editables,function(a){return document.getElementById(a.getId())}))}function t(a,b){return b?a.find('a[href $= "#'+b+'"]'):c()}function u(a){var b=a.attr("href");return b?b.match(/#(.*?)$/)[1]:null}function v(a){var b;typeof a=="object"?b=c(a).text().replace(/[^a-zA-Z-]+/g,"-").replace(/^[^a-zA-Z]+/,""):a&&(b=a);for(var d=0;;d++){var e=b;d&&(e+="-"+d);var f=document.getElementById(e);if(!f||typeof a=="object"&&f===a)return e}}var h=window.GENTICS,i="toc",j=null,k=[];return b.create(i,{languages:["en","de"],minEntries:0,updateInterval:5e3,config:["toc"],init:function(){var b=this;typeof this.settings.minEntries=="undefined"&&(this.settings.minEntries=this.minEntries),typeof this.settings.updateInterval=="undefined"&&(this.settings.updateInterval=this.updateInterval),a.bind("aloha-editable-activated",function(d,e){if(a.activeEditable){b.cfg=b.getEditableConfig(a.activeEditable.obj);if(c.inArray("toc",b.cfg)==-1){b.insertTocButton.hide();return}b.insertTocButton.show()}}),this.initButtons(),c(document).ready(function(){b.spawn()})},initButtons:function(){var b="Aloha.continuoustext",c=this;this.insertTocButton=new a.ui.Button({iconClass:"aloha-button aloha-button-ol",size:"small",onclick:function(){c.insertAtSelection(j)},tooltip:e.t("button.addtoc.tooltip"),toggle:!1}),d.addButton(b,this.insertTocButton,f.t("floatingmenu.tab.insert"),1)},register:function(a){j=a},insertAtSelection:function(b){b=b||s();var d=v("toc"),e=c("<ol class='toc_root'></ol>").attr("id",d).attr("contentEditable","false"),f=a.Selection.getRangeObject(),g=a.activeEditable,i=c(document.getElementById(g.getId()));h.Utils.Dom.insertIntoDOM(e,f,i),this.create(d).register(b).update().tickTock()},spawn:function(a,b){a=a||c("body"),b=b||s(),a.find("ol.toc_root").each(function(){var a=c(this).attr("id");a||(a=v("toc"),c(this).attr("id",a)),that.create(a).register(b).tickTock()})},create:function(a){return k.push(this),{id:a,$containers:c(),settings:this.settings,root:function(){return c(document.getElementById(this.id))},register:function(a){var b=this;return b.$containers=b.$containers.add(a),b.$containers.filter(function(){return!c(this).data(i+"."+b.id+".listening")}).each(function(){var a=c(this);a.data(i+"."+b.id+".listening",!0),a.bind("blur",function(){b.cleanupIds(a.get(0)),b.update(a)})}),b},tickTock:function(a){var b=this;a=a||this.settings.updateInterval;if(!a)return;return window.setInterval(function(){b.register(s()),b.update()},a),b},cleanupIds:function(a){var b=[],d=this;return this.headings(this.$containers).each(function(){var d=c(this).attr("id");(d&&-1!=c.inArray(d,b)||a&&(c.contains(a,this)||a===this))&&c(this).attr("id",v(this)),b.push(d)}),this},update:function(a){var b=this;a=a||b.$containers;var c=this.outline(b.$containers),d=[b.root()],e=[];l(d).empty(),function g(a){var c=[];r(a,function(a){var e=m(a),f=b.linkSection(e,d,c);d.push(f),g(n(a)),d.pop(),c.push(f)})}(n(c));var f=b.root().attr("data-TOC-minEntries")||this.settings.minEntries;return b.root().find("li").length>=f?b.root().show():b.root().hide(),this},linkSection:function(a,b,d){var e=a.eq(0).attr("id");e||(e=v(a.get(0)),a.eq(0).attr("id",e));var f=this.root(),g=t(f,e);g.length||(g=c("<li><a/></li>")),g.find("a").attr("href","#"+e).text(a.eq(0).text());if(l(d))l(d).after(g);else if(l(b).get(0)==f.get(0))f.append(g);else{var h=c("<ol/>").append(g);l(b).append(h)}return g},outline:function(a){var b=[c()],d=[b];return this.headings(a).each(function(){var a=c(this),b=this.nodeName.toLowerCase(),e=["h6","h5","h4","h3","h2","h1"],f=c.inArray(b,e),g=e.slice(f).join(","),h=a.nextUntil(g).andSelf(),i=[h],j=p(d,function(b){var d=b[0];return!d.length||p(d,function(b){return a.get(0)===b||c.contains(b,a.get(0))})});j.push(i),d.splice(0,o(d,j),i)}),b},headings:function(a){return a.find(":header").add(a.filter(":header"))}}}})});