// Backbone.js 0.3.3
// (c) 2010 Jeremy Ashkenas, DocumentCloud Inc.
// Backbone may be freely distributed under the MIT license.
// For all details and documentation:
// http://documentcloud.github.com/backbone
(function(){var a;a=typeof exports!="undefined"?exports:this.Backbone={},a.VERSION="0.3.3";var b=this._;!b&&typeof require!="undefined"&&(b=require("underscore")._);var c=this.jQuery||this.Zepto;a.emulateHTTP=!1,a.emulateJSON=!1,a.Events={bind:function(a,b){return this._callbacks||(this._callbacks={}),(this._callbacks[a]||(this._callbacks[a]=[])).push(b),this},unbind:function(a,b){var c;if(a){if(c=this._callbacks)if(b){c=c[a];if(!c)return this;for(var d=0,e=c.length;d<e;d++)if(b===c[d]){c.splice(d,1);break}}else c[a]=[]}else this._callbacks={};return this},trigger:function(a){var b,c,d,e;if(!(c=this._callbacks))return this;if(b=c[a]){d=0;for(e=b.length;d<e;d++)b[d].apply(this,Array.prototype.slice.call(arguments,1))}if(b=c.all){d=0;for(e=b.length;d<e;d++)b[d].apply(this,arguments)}return this}},a.Model=function(a,c){a||(a={}),this.defaults&&(a=b.extend({},this.defaults,a)),this.attributes={},this._escapedAttributes={},this.cid=b.uniqueId("c"),this.set(a,{silent:!0}),this._previousAttributes=b.clone(this.attributes),c&&c.collection&&(this.collection=c.collection),this.initialize(a,c)},b.extend(a.Model.prototype,a.Events,{_previousAttributes:null,_changed:!1,initialize:function(){},toJSON:function(){return b.clone(this.attributes)},get:function(a){return this.attributes[a]},escape:function(a){var b;return(b=this._escapedAttributes[a])?b:(b=this.attributes[a],this._escapedAttributes[a]=(b==null?"":b).replace(/&(?!\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"))},set:function(a,c){c||(c={});if(!a)return this;a.attributes&&(a=a.attributes);var d=this.attributes,e=this._escapedAttributes;if(!c.silent&&this.validate&&!this._performValidation(a,c))return!1;"id"in a&&(this.id=a.id);for(var f in a){var g=a[f];b.isEqual(d[f],g)||(d[f]=g,delete e[f],c.silent||(this._changed=!0,this.trigger("change:"+f,this,g,c)))}return!c.silent&&this._changed&&this.change(c),this},unset:function(a,b){b||(b={});var c={};return c[a]=void 0,!b.silent&&this.validate&&!this._performValidation(c,b)?!1:(delete this.attributes[a],delete this._escapedAttributes[a],b.silent||(this._changed=!0,this.trigger("change:"+a,this,void 0,b),this.change(b)),this)},clear:function(a){a||(a={});var b=this.attributes,c={};for(attr in b)c[attr]=void 0;if(!a.silent&&this.validate&&!this._performValidation(c,a))return!1;this.attributes={},this._escapedAttributes={};if(!a.silent){this._changed=!0;for(attr in b)this.trigger("change:"+attr,this,void 0,a);this.change(a)}return this},fetch:function(b){b||(b={});var c=this,d=m(b.error,c,b);return(this.sync||a.sync)("read",this,function(a){if(!c.set(c.parse(a),b))return!1;b.success&&b.success(c,a)},d),this},save:function(b,c){c||(c={});if(b&&!this.set(b,c))return!1;var d=this,e=m(c.error,d,c),f=this.isNew()?"create":"update";return(this.sync||a.sync)(f,this,function(a){if(!d.set(d.parse(a),c))return!1;c.success&&c.success(d,a)},e),this},destroy:function(b){b||(b={});var c=this,d=m(b.error,c,b);return(this.sync||a.sync)("delete",this,function(a){c.collection&&c.collection.remove(c),b.success&&b.success(c,a)},d),this},url:function(){var a=l(this.collection);return this.isNew()?a:a+(a.charAt(a.length-1)=="/"?"":"/")+this.id},parse:function(a){return a},clone:function(){return new this.constructor(this)},isNew:function(){return!this.id},change:function(a){this.trigger("change",this,a),this._previousAttributes=b.clone(this.attributes),this._changed=!1},hasChanged:function(a){return a?this._previousAttributes[a]!=this.attributes[a]:this._changed},changedAttributes:function(a){a||(a=this.attributes);var c=this._previousAttributes,d=!1,e;for(e in a)b.isEqual(c[e],a[e])||(d=d||{},d[e]=a[e]);return d},previous:function(a){return!a||!this._previousAttributes?null:this._previousAttributes[a]},previousAttributes:function(){return b.clone(this._previousAttributes)},_performValidation:function(a,b){var c=this.validate(a);return c?(b.error?b.error(this,c):this.trigger("error",this,c,b),!1):!0}}),a.Collection=function(a,c){c||(c={}),c.comparator&&(this.comparator=c.comparator,delete c.comparator),this._boundOnModelEvent=b.bind(this._onModelEvent,this),this._reset(),a&&this.refresh(a,{silent:!0}),this.initialize(a,c)},b.extend(a.Collection.prototype,a.Events,{model:a.Model,initialize:function(){},toJSON:function(){return this.map(function(a){return a.toJSON()})},add:function(a,c){if(b.isArray(a))for(var d=0,e=a.length;d<e;d++)this._add(a[d],c);else this._add(a,c);return this},remove:function(a,c){if(b.isArray(a))for(var d=0,e=a.length;d<e;d++)this._remove(a[d],c);else this._remove(a,c);return this},get:function(a){return a==null?null:this._byId[a.id!=null?a.id:a]},getByCid:function(a){return a&&this._byCid[a.cid||a]},at:function(a){return this.models[a]},sort:function(a){a||(a={});if(!this.comparator)throw Error("Cannot sort a set without a comparator");return this.models=this.sortBy(this.comparator),a.silent||this.trigger("refresh",this,a),this},pluck:function(a){return b.map(this.models,function(b){return b.get(a)})},refresh:function(a,b){return a||(a=[]),b||(b={}),this._reset(),this.add(a,{silent:!0}),b.silent||this.trigger("refresh",this,b),this},fetch:function(b){b||(b={});var c=this,d=m(b.error,c,b);return(this.sync||a.sync)("read",this,function(a){c.refresh(c.parse(a)),b.success&&b.success(c,a)},d),this},create:function(b,c){var d=this;return c||(c={}),b instanceof a.Model?b.collection=d:b=new this.model(b,{collection:d}),b.save(null,{success:function(a,b){d.add(a),c.success&&c.success(a,b)},error:c.error})},parse:function(a){return a},chain:function(){return b(this.models).chain()},_reset:function(){this.length=0,this.models=[],this._byId={},this._byCid={}},_add:function(b,c){c||(c={}),b instanceof a.Model||(b=new this.model(b,{collection:this}));var d=this.getByCid(b);if(d)throw Error(["Can't add the same model to a set twice",d.id]);return this._byId[b.id]=b,this._byCid[b.cid]=b,b.collection=this,this.models.splice(this.comparator?this.sortedIndex(b,this.comparator):this.length,0,b),b.bind("all",this._boundOnModelEvent),this.length++,c.silent||b.trigger("add",b,this,c),b},_remove:function(a,b){return b||(b={}),a=this.getByCid(a)||this.get(a),a?(delete this._byId[a.id],delete this._byCid[a.cid],delete a.collection,this.models.splice(this.indexOf(a),1),this.length--,b.silent||a.trigger("remove",a,this,b),a.unbind("all",this._boundOnModelEvent),a):null},_onModelEvent:function(a,b){a==="change:id"&&(delete this._byId[b.previous("id")],this._byId[b.id]=b),this.trigger.apply(this,arguments)}}),b.each(["forEach","each","map","reduce","reduceRight","find","detect","filter","select","reject","every","all","some","any","include","invoke","max","min","sortBy","sortedIndex","toArray","size","first","rest","last","without","indexOf","lastIndexOf","isEmpty"],function(c){a.Collection.prototype[c]=function(){return b[c].apply(b,[this.models].concat(b.toArray(arguments)))}}),a.Controller=function(a){a||(a={}),a.routes&&(this.routes=a.routes),this._bindRoutes(),this.initialize(a)};var d=/:([\w\d]+)/g,e=/\*([\w\d]+)/g;b.extend(a.Controller.prototype,a.Events,{initialize:function(){},route:function(c,d,e){a.history||(a.history=new a.History),b.isRegExp(c)||(c=this._routeToRegExp(c)),a.history.route(c,b.bind(function(a){a=this._extractParameters(c,a),e.apply(this,a),this.trigger.apply(this,["route:"+d].concat(a))},this))},saveLocation:function(b){a.history.saveLocation(b)},_bindRoutes:function(){if(this.routes)for(var a in this.routes){var b=this.routes[a];this.route(a,b,this[b])}},_routeToRegExp:function(a){return a=a.replace(d,"([^/]*)").replace(e,"(.*?)"),RegExp("^"+a+"$")},_extractParameters:function(a,b){return a.exec(b).slice(1)}}),a.History=function(){this.handlers=[],this.fragment=this.getFragment(),b.bindAll(this,"checkUrl")};var f=/^#*/;b.extend(a.History.prototype,{interval:50,getFragment:function(a){return(a||window.location).hash.replace(f,"")},start:function(){var a=document.documentMode;if(a=c.browser.msie&&(!a||a<=7))this.iframe=c('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow;return"onhashchange"in window&&!a?c(window).bind("hashchange",this.checkUrl):setInterval(this.checkUrl,this.interval),this.loadUrl()},route:function(a,b){this.handlers.push({route:a,callback:b})},checkUrl:function(){var a=this.getFragment();a==this.fragment&&this.iframe&&(a=this.getFragment(this.iframe.location));if(a==this.fragment||a==decodeURIComponent(this.fragment))return!1;this.iframe&&(window.location.hash=this.iframe.location.hash=a),this.loadUrl()},loadUrl:function(){var a=this.fragment=this.getFragment();return b.any(this.handlers,function(b){if(b.route.test(a))return b.callback(a),!0})},saveLocation:function(a){a=(a||"").replace(f,""),this.fragment!=a&&(window.location.hash=this.fragment=a,this.iframe&&a!=this.getFragment(this.iframe.location)&&(this.iframe.document.open().close(),this.iframe.location.hash=a))}}),a.View=function(a){this._configure(a||{}),this._ensureElement(),this.delegateEvents(),this.initialize(a)};var g=/^(\w+)\s*(.*)$/;b.extend(a.View.prototype,a.Events,{tagName:"div",$:function(a){return c(a,this.el)},initialize:function(){},render:function(){return this},remove:function(){return c(this.el).remove(),this},make:function(a,b,d){return a=document.createElement(a),b&&c(a).attr(b),d&&c(a).html(d),a},delegateEvents:function(a){if(a||(a=this.events)){c(this.el).unbind();for(var d in a){var e=a[d],f=d.match(g),h=f[1];f=f[2],e=b.bind(this[e],this),f===""?c(this.el).bind(h,e):c(this.el).delegate(f,h,e)}}},_configure:function(a){this.options&&(a=b.extend({},this.options,a)),a.model&&(this.model=a.model),a.collection&&(this.collection=a.collection),a.el&&(this.el=a.el),a.id&&(this.id=a.id),a.className&&(this.className=a.className),a.tagName&&(this.tagName=a.tagName),this.options=a},_ensureElement:function(){if(!this.el){var a={};this.id&&(a.id=this.id),this.className&&(a["class"]=this.className),this.el=this.make(this.tagName,a)}}});var h=function(a,b){var c=k(this,a,b);return c.extend=h,c};a.Model.extend=a.Collection.extend=a.Controller.extend=a.View.extend=h;var i={create:"POST",update:"PUT","delete":"DELETE",read:"GET"};a.sync=function(b,d,e,f){var g=i[b];b=b==="create"||b==="update"?JSON.stringify(d.toJSON()):null,d={url:l(d),type:g,contentType:"application/json",data:b,dataType:"json",processData:!1,success:e,error:f},a.emulateJSON&&(d.contentType="application/x-www-form-urlencoded",d.processData=!0,d.data=b?{model:b}:{}),a.emulateHTTP&&(g==="PUT"||g==="DELETE")&&(a.emulateJSON&&(d.data._method=g),d.type="POST",d.beforeSend=function(a){a.setRequestHeader("X-HTTP-Method-Override",g)}),c.ajax(d)};var j=function(){},k=function(a,c,d){var e;return e=c&&c.hasOwnProperty("constructor")?c.constructor:function(){return a.apply(this,arguments)},j.prototype=a.prototype,e.prototype=new j,c&&b.extend(e.prototype,c),d&&b.extend(e,d),e.prototype.constructor=e,e.__super__=a.prototype,e},l=function(a){if(!a||!a.url)throw Error("A 'url' property or function must be specified");return b.isFunction(a.url)?a.url():a.url},m=function(a,b,c){return function(d){a?a(b,d):b.trigger("error",b,d,c)}}})();