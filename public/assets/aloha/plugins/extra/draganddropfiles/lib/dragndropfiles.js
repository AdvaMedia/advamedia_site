/**
 * Aloha Editor
 * Drag and Drop files plugin for Aloha Editor
 * copyright (c) 2010 Nicolas Karageuzian - http://nka.me/
 * Copyright (c) 2010 Gentics Software GmbH
 *
 * Handles drag and drop for files
 *
 */
//(function(window, undefined) {
//    var
//        $ = jQuery = window.alohaQuery || window.jQuery,
//        GENTICS = window.GENTICS,
//        Aloha = GENTICS.Aloha;
define(["aloha/jquery","aloha/plugin","draganddropfiles/dropfilesrepository"],function(e,t,n){var r=e,i=window.GENTICS,s=window.Aloha;return t.create("draganddropfiles",{languages:["en","fr"],config:{max_file_size:3e5,max_file_count:2,upload:{uploader_instance:new n("draganddropfilesrepository","Dropped Files"),config:{callback:function(e){return e},method:"POST",url:"",accept:"application/json",file_name_param:"filename",file_name_header:"X-File-Name",extra_headers:{},extra_post_data:{},send_multipart_form:!1,image:{max_width:800,max_height:800},www_encoded:!1}}},init:function(){var e=this;e.setBodyDropHandler(),e.settings===undefined?e.settings=e.config:e.settings=r.extend(!0,e.config,e.settings);try{e.uploader=e.initUploader(e.settings)}catch(t){s.Log.warn(e,t),s.Log.warn(e,"Error creating uploader, no upload will be processed")}s.bind("aloha-file-upload-prepared",function(t,n){e.droppedFilesCount>=e.processedFiles&&s.trigger("aloha-allfiles-upload-prepared")}),s.bind("aloha-allfiles-upload-prepared",function(t,n){var r=e.filesObjs.length;if(e.dropInEditable){s.trigger("aloha-drop-files-in-editable",{filesObjs:e.filesObjs,range:e.targetRange,editable:e.targetEditable});var i=e.getEditableConfig(e.targetEditable);while(--r>=0)e.uploader.startFileUpload(e.filesObjs[r].id,i.upload.config)}else{s.trigger("aloha-drop-files-in-page",e.filesObjs);while(--r>=0)e.uploader.startFileUpload(e.filesObjs[r].id,e.config.upload.config)}})},initUploader:function(e){var t;try{t=e.upload.uploader_instance}catch(r){s.Log.info(this,"Custom class loading error or not specified, using default"),t=new n("draganddropfilesrepository","Dropped Files")}return t},prepareFileUpload:function(e){var t=new FileReader,n,r=this;t.file=e,t.onloadend=function(){var e={name:this.file.name,type:this.file.type,fileSize:this.file.fileSize,fileName:this.file.fileName,data:t.result};r.filesObjs.push(r.uploader.addFileUpload(e)),r.processedFiles++,s.trigger("aloha-file-upload-prepared",n)},t.readAsDataURL(e)},dropEventHandler:function(e){var t=this,n,i,o,u=e.dataTransfer.files,a;this.targetEditable=undefined,this.droppedFilesCount=u.length,this.processedFiles=0,s.Log.info(t,this.droppedFilesCount+" files have been dropped on the page");if(!e.dataTransfer&&!e.dataTransfer.files)return e.sink=!1,!0;if(this.droppedFilesCount<1)return e.sink=!1,!0;e.preventDefault?e.preventDefault():e.cancelBubble=!0;if(this.droppedFilesCount>t.settings.max_file_count)return s.Log.warn(t,"too much files dropped"),e.stopPropagation?e.stopPropagation():e.returnValue=!1,!0;o=r(e.target),o.hasClass("aloha-editable")?(this.targetEditable=o,o=this.targetEditable.children(":last"),o.hasClass("aloha-editable")&&(this.targetEditable.append("<span> </span>"),o=this.targetEditable.children(":last"))):this.targetEditable=o.parents(".aloha-editable"),this.filesObjs=[],this.dropInEditable=!1,i=this.droppedFilesCount;if(this.targetEditable[0]===null)while(--i>=0)!document.createElement("canvas").getContext||!u[i].type.match(/image\//)||!n.upload.config.image?u[i].size<=t.settings.max_file_size?t.prepareFileUpload(u[i]):(this.processedFiles++,s.Log.warn(t,"max_file_size exeeded, upload of "+u[i].name+" aborted")):t.prepareFileUpload(u[i]);else{s.getEditableById(this.targetEditable.attr("id")).activate(),t.targetRange=t.initializeRangeForDropEvent(e,this.targetEditable),n=t.getEditableConfig(this.targetEditable),n&&(t.dropInEditable=!0);while(--i>=0){try{a=n.upload.config.image}catch(f){a=!1}!document.createElement("canvas").getContext||!u[i].type.match(/image\//)||!a?u[i].size<=n.max_file_size?t.prepareFileUpload(u[i]):(this.processedFiles++,s.Log.warn(t,"max_file_size exeeded, upload of "+u[i].name+" aborted")):t.prepareFileUpload(u[i])}}return e.stopPropagation?e.stopPropagation():e.returnValue=!1,!1},setBodyDropHandler:function(){var e=this;document.body.BodyDragSinker||(document.body.BodyDragSinker=!0,this.onstr="",this.mydoc=document,this.methodName="addEventListener",r.browser.msie&&(this.onstr="on",this.methodName="attachEvent",this.mydoc=document.body),this.mydoc[this.methodName](this.onstr+"drop",function(t){e.dropEventHandler(t)},!1),this.mydoc[this.methodName](this.onstr+"dragenter",function(e){return e.preventDefault?e.preventDefault():e.cancelBubble=!0,e.stopPropagation?e.stopPropagation():e.returnValue=!1,!1},!1),this.mydoc[this.methodName](this.onstr+"dragleave",function(e){return e.preventDefault?e.preventDefault():e.cancelBubble=!0,e.stopPropagation?e.stopPropagation():e.returnValue=!1,!1},!1),this.mydoc[this.methodName](this.onstr+"dragover",function(e){e.preventDefault?e.preventDefault():e.cancelBubble=!0,e.stopPropagation?e.stopPropagation():e.returnValue=!1},!1))},initializeRangeForDropEvent:function(e,t){var n=r(e.target),i=new s.Selection.SelectionRange(!0);i.update(),n.textNodes().length==0?(i.startContainer=n[0].childNodes[0],i.endContainer=n[0].childNodes[0]):(i.startContainer=n.textNodes()[0],i.endContainer=n.textNodes()[0]),i.startOffset=0,i.endOffset=0;try{i.select()}catch(o){s.Log.error(this,o)}return i}})});