/**
 * Aloha Editor
 * Drag and Drop files plugin for Aloha Editor
 * copyright (c) 2010 Nicolas Karageuzian - http://nka.me/
 * Copyright (c) 2010 Gentics Software GmbH
 *
 * Handles drag and drop for files
 *
 */
//(function(window, undefined) {
//    var
//        $ = jQuery = window.alohaQuery || window.jQuery,
//        GENTICS = window.GENTICS,
//        Aloha = GENTICS.Aloha;
define(["aloha/jquery","aloha/plugin","draganddropfiles/dropfilesrepository"],function(a,b,c){var d=a,e=window.GENTICS,f=window.Aloha;return b.create("draganddropfiles",{languages:["en","fr"],config:{max_file_size:3e5,max_file_count:2,upload:{uploader_instance:new c("draganddropfilesrepository","Dropped Files"),config:{callback:function(a){return a},method:"POST",url:"",accept:"application/json",file_name_param:"filename",file_name_header:"X-File-Name",extra_headers:{},extra_post_data:{},send_multipart_form:!1,image:{max_width:800,max_height:800},www_encoded:!1}}},init:function(){var a=this;a.setBodyDropHandler(),a.settings===undefined?a.settings=a.config:a.settings=d.extend(!0,a.config,a.settings);try{a.uploader=a.initUploader(a.settings)}catch(b){f.Log.warn(a,b),f.Log.warn(a,"Error creating uploader, no upload will be processed")}f.bind("aloha-file-upload-prepared",function(b,c){a.droppedFilesCount>=a.processedFiles&&f.trigger("aloha-allfiles-upload-prepared")}),f.bind("aloha-allfiles-upload-prepared",function(b,c){var d=a.filesObjs.length;if(a.dropInEditable){f.trigger("aloha-drop-files-in-editable",{filesObjs:a.filesObjs,range:a.targetRange,editable:a.targetEditable});var e=a.getEditableConfig(a.targetEditable);while(--d>=0)a.uploader.startFileUpload(a.filesObjs[d].id,e.upload.config)}else{f.trigger("aloha-drop-files-in-page",a.filesObjs);while(--d>=0)a.uploader.startFileUpload(a.filesObjs[d].id,a.config.upload.config)}})},initUploader:function(a){var b;try{b=a.upload.uploader_instance}catch(d){f.Log.info(this,"Custom class loading error or not specified, using default"),b=new c("draganddropfilesrepository","Dropped Files")}return b},prepareFileUpload:function(a){var b=new FileReader,c,d=this;b.file=a,b.onloadend=function(){var a={name:this.file.name,type:this.file.type,fileSize:this.file.fileSize,fileName:this.file.fileName,data:b.result};d.filesObjs.push(d.uploader.addFileUpload(a)),d.processedFiles++,f.trigger("aloha-file-upload-prepared",c)},b.readAsDataURL(a)},dropEventHandler:function(a){var b=this,c,e,g,h=a.dataTransfer.files,i;this.targetEditable=undefined,this.droppedFilesCount=h.length,this.processedFiles=0,f.Log.info(b,this.droppedFilesCount+" files have been dropped on the page");if(!a.dataTransfer&&!a.dataTransfer.files)return a.sink=!1,!0;if(this.droppedFilesCount<1)return a.sink=!1,!0;a.preventDefault?a.preventDefault():a.cancelBubble=!0;if(this.droppedFilesCount>b.settings.max_file_count)return f.Log.warn(b,"too much files dropped"),a.stopPropagation?a.stopPropagation():a.returnValue=!1,!0;g=d(a.target),g.hasClass("aloha-editable")?(this.targetEditable=g,g=this.targetEditable.children(":last"),g.hasClass("aloha-editable")&&(this.targetEditable.append("<span> </span>"),g=this.targetEditable.children(":last"))):this.targetEditable=g.parents(".aloha-editable"),this.filesObjs=[],this.dropInEditable=!1,e=this.droppedFilesCount;if(this.targetEditable[0]===null)while(--e>=0)!document.createElement("canvas").getContext||!h[e].type.match(/image\//)||!c.upload.config.image?h[e].size<=b.settings.max_file_size?b.prepareFileUpload(h[e]):(this.processedFiles++,f.Log.warn(b,"max_file_size exeeded, upload of "+h[e].name+" aborted")):b.prepareFileUpload(h[e]);else{f.getEditableById(this.targetEditable.attr("id")).activate(),b.targetRange=b.initializeRangeForDropEvent(a,this.targetEditable),c=b.getEditableConfig(this.targetEditable),c&&(b.dropInEditable=!0);while(--e>=0){try{i=c.upload.config.image}catch(j){i=!1}!document.createElement("canvas").getContext||!h[e].type.match(/image\//)||!i?h[e].size<=c.max_file_size?b.prepareFileUpload(h[e]):(this.processedFiles++,f.Log.warn(b,"max_file_size exeeded, upload of "+h[e].name+" aborted")):b.prepareFileUpload(h[e])}}return a.stopPropagation?a.stopPropagation():a.returnValue=!1,!1},setBodyDropHandler:function(){var a=this;document.body.BodyDragSinker||(document.body.BodyDragSinker=!0,this.onstr="",this.mydoc=document,this.methodName="addEventListener",d.browser.msie&&(this.onstr="on",this.methodName="attachEvent",this.mydoc=document.body),this.mydoc[this.methodName](this.onstr+"drop",function(b){a.dropEventHandler(b)},!1),this.mydoc[this.methodName](this.onstr+"dragenter",function(a){return a.preventDefault?a.preventDefault():a.cancelBubble=!0,a.stopPropagation?a.stopPropagation():a.returnValue=!1,!1},!1),this.mydoc[this.methodName](this.onstr+"dragleave",function(a){return a.preventDefault?a.preventDefault():a.cancelBubble=!0,a.stopPropagation?a.stopPropagation():a.returnValue=!1,!1},!1),this.mydoc[this.methodName](this.onstr+"dragover",function(a){a.preventDefault?a.preventDefault():a.cancelBubble=!0,a.stopPropagation?a.stopPropagation():a.returnValue=!1},!1))},initializeRangeForDropEvent:function(a,b){var c=d(a.target),e=new f.Selection.SelectionRange(!0);e.update(),c.textNodes().length==0?(e.startContainer=c[0].childNodes[0],e.endContainer=c[0].childNodes[0]):(e.startContainer=c.textNodes()[0],e.endContainer=c.textNodes()[0]),e.startOffset=0,e.endOffset=0;try{e.select()}catch(g){f.Log.error(this,g)}return e}})});