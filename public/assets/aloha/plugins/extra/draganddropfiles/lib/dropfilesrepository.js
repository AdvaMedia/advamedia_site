/*
 * Repository
 * Copyright (c) 2010 Nicolas Karageuzian - http://nka.me
 */
define(["aloha/jquery","aloha/repository","aloha/repository","i18n!aloha/nls/i18n"],function(e,t,n){var r=e,i=window.GENTICS,s=window.Aloha,o={_constructor:function(e,t){var n=new this.UploadFolder({id:"Uploads",name:"Uploads",displayName:"Uploads",parentId:"/",path:"Uploads",objectType:"folder",type:"folder",repositoryId:e});s.Log.info(s,"_constructor : Initializing default uploader"),this._super(e,t),this.uploadFolder=n,this.objects=[n];var r=this;this.uploadQueue={queue:[],push:function(e){this.queue.push(e)},pop:function(){var e=this.queue[0];return this.queue=this.queue.splice(1),e},processQueue:function(){var e;if(!this.processUpload){this.processUpload=!0;while(this.queue.length>0)e=this.pop(),e.startUpload();this.processUpload=!1}}}},config:{method:"POST",callback:function(e){return e},url:"",accept:"application/json",file_name_param:"filename",file_name_header:"X-File-Name",extra_headers:{},extra_post_data:{},send_multipart_form:!1,www_encoded:!1,image:{max_width:800,max_height:800},fieldName:function(){return"filename"}},query:function(e,t){s.Log.info(this,"Query Uploader");var n=[];e.inFolderId==this.repositoryId&&e.queryString==null?n=this.objects:n=this.objects.filter(function(t,n,r){var i=new RegExp(e.queryString,"i"),s=!1;try{(!e.queryString||t.url.match(i))&&e.inFolderId==t.parentId&&(s=!0)}catch(o){}return s}),t.call(this,n)},getChildren:function(e,t){d=[];var n=e.inFolderId.split("")[0];n==""&&(n="/"),d=this.objects.filter(function(e,t,r){return e.parentId==n?!0:!1}),t.call(this,d)},addFileUpload:function(e){var t="",n=this.objects.filter(function(t,n,r){return t.name==e.name?!0:!1});if(n.length>0)return n[0];var i=this.objects.length,s="ALOHA_idx_file"+i,o={};return r.extend(!0,o,this.config),this.objects.push(new this.UploadFile({file:e,id:s,name:e.name,displayName:e.name,parentId:"Uploads",path:"Uploads",url:"Uploads",objectType:"file",type:"file",ulProgress:0,parent:this.uploadFolder,repositoryId:this.repositoryId})),this.objects[i]},startFileUpload:function(e,t){var n="",i=this.objects.filter(function(t,n,r){return t.id==e?!0:!1});i.length>0?(r.extend(!0,t,this.upload_conf),i[0].upload_config=t,this.uploadQueue.push(i[0]),this.uploadQueue.processQueue()):s.Log.error(this,"No file with that id")},UploadFolder:s.RepositoryFolder.extend({_constructor:function(e){this._super(e)},getDataObject:function(e){return repo=s.RepositoryManager.getRepository(e.data.repositoryId),d=repo.objects.filter(function(t,n,r){return t.id==e.data.id&&t.file?!0:!1}),d.length>0?d[0]:null}}),UploadFile:s.RepositoryDocument.extend({_constructor:function(e){var t=this.xhr,n=this;this._super(e),t.upload.onprogress=function(e){n.loaded=e.loaded,n.total=e.total,n.ulProgress=e.loaded/e.total,s.trigger("aloha-upload-progress",n),t.onload=function(e){try{n.src=n.upload_config.callback(t.responseText),s.trigger("aloha-upload-success",n)}catch(r){s.trigger("aloha-upload-failure",n)}},t.onabort=function(){s.trigger("aloha-upload-abort",n)},t.onerror=function(e){s.trigger("aloha-upload-error",n)}}},xhr:new XMLHttpRequest,contentTypeHeader:"text/plain; charset=x-user-defined-binary",startUpload:function(){var t=this.xhr,n=this.upload_config,r=this,i;t.open(n.method,typeof n.url=="function"?n.url(number):n.url,!0),t.setRequestHeader("Cache-Control","no-cache"),t.setRequestHeader("X-Requested-With","XMLHttpRequest"),t.setRequestHeader(n.file_name_header,this.file.fileName),t.setRequestHeader("X-File-Size",this.file.fileSize),t.setRequestHeader("Accept",n.accept);if(!n.send_multipart_form){t.setRequestHeader("Content-Type",this.file.type+";base64"),t.overrideMimeType(this.file.type);var o=e("<canvas>").first(),u={},a=new Image;s.Log.debug(s,"Original Data (length:"+this.file.data.length+") = "+this.file.data.substring(0,30)),a.onload=function(){u={height:a.height,width:a.width},a.width>a.height?a.width>n.image.max_width&&(u.width=n.image.max_width,u.height=a.height*n.image.max_width/a.width):a.height>n.image.max_height&&(u.height=n.image.max_height,u.width=a.width*n.image.max_height/a.height);var e=document.createElement("canvas");e.setAttribute("width",u.width),e.setAttribute("height",u.height),e.getContext("2d").drawImage(a,0,0,a.width,a.height,0,0,u.width,u.height),i=e.toDataURL(r.file.type),s.Log.debug(s,"Sent Data (length:"+i.length+") = "+i.substring(0,30)),t.send(i)},a.src=this.file.data}else if(window.FormData){var f=new FormData;f.append(typeof n.fieldName=="function"?n.fieldName():n.fieldName,this.file),t.send(f)}else if(this.file.getAsBinary){var l=(1e12+Math.floor(Math.random()*8999999999998)).toString(),c="--",h="\r\n",p="";p+=c,p+=l,p+=h,p+='Content-Disposition: form-data; name="'+(typeof n.fieldName=="function"?n.fieldName():n.fieldName)+'"',p+='; filename="'+this.file.fileName+'"',p+=h,p+="Content-Type: application/octet-stream",p+=h,p+=h,p+=this.file.getAsBinary(),p+=h,p+=c,p+=l,p+=c,p+=h,t.setRequestHeader("content-type","multipart/form-data; boundary="+l),t.sendAsBinary(p)}else n.onBrowserIncompatible()}})};return t.extend(o)});